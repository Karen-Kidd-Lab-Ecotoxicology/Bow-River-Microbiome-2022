---
title: "NutrientExcretionR2022"
author: "Emilie Diesbourg"
date: "16/05/2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Loading Packages and Data}
#rm(list=ls()) #clears R environment

#setwd("Nutrient_excretion_ED")
library(dplyr)
library(FSA)
library(ggplot2)
library(tidyverse)
library(car)
library(lme4)
library(lmerTest)
library(multcomp)
library(AICcmodavg)
library(ggbreak)
library(emmeans)
library(ggsignif)
library(ggpubr)

Nut_data<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\nutrient_excretion_analysis\\NutrientExcretionR2022.csv")

Nut_data$Site <- factor(Nut_data$Site, levels = c("Cochrane", "Sunalta", "Graves Bridge", "Policeman Flats", "BBR2", "PCR1", "PCR3"), labels=c("Cochrane", "Sunalta", "Graves Bridge", "Policeman Flats", "REF", "EXP5", "EXP15"))
Nut_data$Type<-factor(Nut_data$Type, levels = c("Bow River", "ACWA Stream"))
Nut_data$Length<-as.numeric(Nut_data$Length)
Nut_data$Mass<-as.numeric(Nut_data$Mass)
Nut_data$P_Mass<-as.numeric(Nut_data$P_Mass)
Nut_data$NH3_Mass<-as.numeric(Nut_data$NH3_Mass)
Nut_data$Excr_rate_P<-as.numeric(Nut_data$Excr_rate_P)
Nut_data$Excr_rate_NH3<-as.numeric(Nut_data$Excr_rate_NH3)
Nut_data$Water_Temp<-as.factor(Nut_data$Water_Temp)
Nut_data$Dissolved_oxygen<-as.numeric(Nut_data$Dissolved_oxygen)
Nut_data$TP<-as.numeric(Nut_data$TP)
Nut_data$TDS<-as.numeric(Nut_data$TDS)
Nut_data$TSS<-as.numeric(Nut_data$TSS)
Nut_data$Ammonia.1<-as.numeric(Nut_data$Ammonia.1)
Nut_data$Site<-as.factor(Nut_data$Site)
Nut_data$Month<-as.factor(Nut_data$Month)
str(Nut_data)

Nut_samples<-filter(Nut_data, Sample_Type=="Sample")


July<-filter(Nut_samples, Month=="July")
September<-filter(Nut_samples, Month=="September")

Cochrane<-filter(Nut_samples, Site=="Cochrane")
Cochjuly<-filter(July, Site=="Cochrane")
Cochsept<-filter(September, Site=="Cochrane")

Sunalta<-filter(Nut_samples, Site=="Sunalta")
Sunjuly<-filter(July, Site=="Sunalta")
Sunsept<-filter(September, Site=="Sunalta")

pmf<-filter(Nut_samples, Site=="Policeman Flats")
pmfjuly<-filter(July, Site=="Policeman Flats")
pmfsept<-filter(September, Site=="Policeman Flats")

nut_Bow<-subset(Nut_samples, Type=="Bow River")
nut_ACWA<-subset(Nut_samples, Type=="ACWA Stream")
```

# Phosphorus Data {.tabset}

```{r Preliminary plots and Wilcoxon tests of PO4-P excretion across sites}
#Total phosphorus concentration (- blank phosphorus concentration) divided by the total mass 
#of organisms in each tube at each site, divided by the time the organisms were in each tube. 
#(Rate of excretion) 

#Mass normalized excretion rate across sites (boxplot)

ggplot(Nut_samples, aes(x=Site, y=Excr_rate_P, colour=Month))+ 
  geom_boxplot()+
  theme_classic()+
  ylab("Phosphorus (ug/L/mg/min)")+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  facet_grid(~Type, scales = "free")
#Looks like not much difference across sampling months but a difference at Policeman Flats compared to other sites

#Not mass normalized excretion rate across sites (boxplot)
ggplot(Nut_samples, aes(x=Site, y=org_rate_P, colour=Month))+ 
  geom_boxplot()+
  theme_classic()+
  ylab("Phosphorus (ug/L/min)")+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  facet_grid(~Type, scales = "free")
#Looks like less of a difference across sites when not mass normalized

#Excretion rate across dry mass of Hydropsychdiae larvae (regression across dry mass)
ggplot(Nut_samples, aes(x=Mass, y=org_rate_P, colour=Site))+ 
  geom_point()+
  theme_classic()+
  ylab("Phosphorus (ug/L/min)")+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  geom_smooth(method="glm", se=F)+
  facet_grid(~Type, scales="free")

#Testing whether the mean excretion rate differs at each site between sampling timepoints

#COCHRANE
#Testing whether excretion rate is different across sampling time points
shapiro.test(Cochjuly$Excr_rate_P) #Normal
shapiro.test(Cochsept$Excr_rate_P) #Not normal

#Have to use non-parametric test to test differences between excretion rates
wilcox.test(Excr_rate_P ~ Month, data=Cochrane) #p=0.7394. Not sig. different between July and September.

#SUNALTA
shapiro.test(Sunjuly$Excr_rate_P) #Normal
shapiro.test(Sunsept$Excr_rate_P) #Not normal

#Have to use non-parametric test
wilcox.test(Excr_rate_P ~ Month, data=Sunalta) #p=0.8392. Not sig. different between July and Septemeber.

#POLICEMAN FLATS
shapiro.test(pmfjuly$Excr_rate_P) #Normal
shapiro.test(pmfsept$Excr_rate_P) #Normal

#Can use a t-test. 
wilcox.test(Excr_rate_P ~ Month, data=pmf) #p=0.9654. Not sig. different.
t.test(Excr_rate_P~Month, data=pmf) #p=0.7646 Not sig. different between July and September.

#Testing normality of mass normalized excretion data
hist(Nut_samples$Excr_rate_P) #Data are heavily right skewed
shapiro.test(Nut_samples$Excr_rate_P) #Not normal
hist(log(Nut_samples$Excr_rate_P)) #Looks much better when log transformed

logPExcr<-log(Nut_samples$Excr_rate_P)
Nut_samples_1<-cbind(logPExcr, Nut_samples)
shapiro.test(Nut_samples_1$logPExcr) #Normal when log transformed

#Looking for outliers

ggplot(Nut_samples, aes(x=Mass, y=org_rate_P))+
  geom_point()+
  geom_smooth(method="glm", se=T)+
  geom_point(data=Nut_samples %>% filter(Phosphorus>600), pch=21,size=10, colour="purple")

#2 potential outliers: COCH_NUT_H2O_4, SUN_NUT_H2O_8
```

```{r Mean excretion rate across sites}

#Mass normalized excretion rate

coch_P<-subset(Nut_samples, Site=="Cochrane")
mean(coch_P$Excr_rate_P) #0.099
sd(coch_P$Excr_rate_P) #0.10

sun_P<-subset(Nut_samples, Site=="Sunalta")
mean(sun_P$Excr_rate_P) #0.223
sd(sun_P$Excr_rate_P)#0.24

grvbr_P<-subset(Nut_samples, Site=="Graves Bridge")
mean(grvbr_P$Excr_rate_P) #0.154
sd(grvbr_P$Excr_rate_P) #0.17

pmf_P<-subset(Nut_samples, Site=="Policeman Flats")
mean(pmf_P$Excr_rate_P) #0.0265
sd(pmf_P$Excr_rate_P) #0.018


BRR2_P<-subset(Nut_samples, Site=="BBR2")
mean(BRR2_P$Excr_rate_P) #0.124
sd(BRR2_P$Excr_rate_P) #0.108

PCR1_P<-subset(Nut_samples, Site=="PCR1")
mean(PCR1_P$Excr_rate_P) #0.291
sd(PCR1_P$Excr_rate_P) #0.229

PCR3_P<-subset(Nut_samples, Site=="PCR3")
mean(PCR3_P$Excr_rate_P) #0.172
sd(PCR3_P$Excr_rate_P) #0.095
```

```{r ANOVA (P excretion across sites - Bow and ACWA separated)}
# Bow River 

hist(nut_Bow$Excr_rate_P) #Right skewed
hist(log(nut_Bow$Excr_rate_P)) #Looks normal when log transformed

logPrate<-log(nut_Bow$Excr_rate_P)
nut_Bow<-cbind(logPrate, nut_Bow)
shapiro.test(nut_Bow$logPrate) #Normal

#ANOVA across sites
summary(bowP<-aov(data=nut_Bow, logPrate~Site)) #F(3,53) = 12.3, P < 0.001
TukeyHSD(bowP)
#Policeman Flats significantly lower in P excretion compared to all other sites


# ACWA

hist(nut_ACWA$Excr_rate_P) #Right skewed
hist(log(nut_ACWA$Excr_rate_P)) #Looks normal when log transformed

logPrate<-log(nut_ACWA$Excr_rate_P)
nut_ACWA<-cbind(logPrate, nut_ACWA)
shapiro.test(nut_ACWA$logPrate) #Not normal, use Kruskal-Wallis test instead

#KW across sites
kruskal.test(data=nut_ACWA, Excr_rate_P ~ Site) #chi-squared = 4.66, df = 2, p = 0.0971
dunnTest(data=nut_ACWA, Excr_rate_P ~ Site) #no significant differences

```

# NH3 Data {.tabset}

```{r Preliminary plots and Wilcoxon tests of NH3-N excretion across sites}

#Total nitrogen concentration (- blank nitrogen concentration) divided by the total mass 
#of organisms in each tube at each site, divided by the time the organisms were in each tube. 
#(Rate of excretion) 

#Mass normalized excretion rate across sites (boxplot)

ggplot(Nut_samples, aes(x=Site, y=Excr_rate_NH3, colour=Month))+ 
  geom_boxplot()+
  theme_classic()+
  ylab("Phosphorus (ug/L/mg/min)")+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  facet_grid(~Type, scales = "free")
#Looks like some difference between sampling months but not much difference across sites

#Not mass normalized excretion rate across sites (boxplot)
ggplot(Nut_samples, aes(x=Site, y=org_rate_NH3, colour=Month))+ 
  geom_boxplot()+
  theme_classic()+
  ylab("Phosphorus (ug/L/min)")+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  facet_grid(~Type, scales = "free")

#Excretion rate across dry mass of Hydropsychdiae larvae (regression across dry mass)
ggplot(Nut_samples, aes(x=Mass, y=org_rate_NH3, colour=Site))+ 
  geom_point()+
  theme_classic()+
  ylab("Phosphorus (ug/L/min)")+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  geom_smooth(method="glm", se=F)+
  facet_grid(~Type, scales="free")

#Testing whether the mean excretion rate differs at each site between sampling timepoints

#COCHRANE
#Testing whether excretion rate is different across sampling time points
shapiro.test(Cochjuly$org_rate_NH3) #Normal
shapiro.test(Cochsept$org_rate_NH3) #Not normal

#Have to use non-parametric test to test differences between excretion rates
wilcox.test(org_rate_NH3 ~ Month, data=Cochrane) #p=0.015. Sig. different between July and September.

#SUNALTA
shapiro.test(Sunjuly$org_rate_NH3) #Normal
shapiro.test(Sunsept$org_rate_NH3) #Normal

#Have to use non-parametric test
t.test(org_rate_NH3 ~ Month, data=Sunalta) #p=0.068. Not sig. different between July and Septemeber.

#POLICEMAN FLATS
shapiro.test(pmfjuly$org_rate_NH3) #Not normal
shapiro.test(pmfsept$org_rate_NH3) #Not normal

#Can use a t-test. 
wilcox.test(org_rate_NH3 ~ Month, data=pmf) #p=0.9654. Not sig. different.
t.test(org_rate_NH3~Month, data=pmf) #p=0.043 Sig. different between July and September.

#Testing normality of mass normalized excretion data
hist(Nut_samples$org_rate_NH3) #Data are right skewed with some missing data
shapiro.test(Nut_samples$org_rate_NH3) #Not normal
hist(log(Nut_samples$org_rate_NH3)) #Looks much better when log transformed

logNH3Excr<-log(Nut_samples$org_rate_NH3)
Nut_samples_1<-cbind(logNH3Excr, Nut_samples)
shapiro.test(Nut_samples_1$logNH3Excr) #Still not normal when log transformed but looks good enough


#Looking for outliers

ggplot(Nut_samples_1, aes(x=Mass, y=logNH3Excr))+
  geom_point()+
  geom_smooth(method="glm", se=T)


ggplot(Nut_samples, aes(x=Site, y=org_rate_NH3, colour=Month))+ 
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste("Excretion Rate" ~NH[3]~"-N ("~mu~"g/L/minute)")))+
  labs(colour="Sampling Month")+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))
#Looks like there are differences in nitrogen excretion across sampling months 

#Log transforming y axis, will remove all negative values (16 of them). 
ggplot(Nut_samples, aes(x=Site, y=org_rate_NH3, colour=Month))+ 
  geom_boxplot()+
  theme_classic()+
  ylab("Nitrogen Excretion Rate (ug/L/mg caddis/min)")+
  labs(colour="Sampling Month")+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  scale_y_log10()


summary(lm1<-lm(data=Nut_samples, Excr_rate_P~Excr_rate_NH3)) 
cor(Nut_samples$Excr_rate_P, Nut_samples$Excr_rate_NH3) #0.018. Not a high correlation between these variables
#Phosphorus excretion does not predict ammonia excretion
plot(lm1) #One very large outlier


#Nitrogen excretion rate at each site, individual sampling month. 
ggplot(Nut_samples, aes(x=Mass, y=org_rate_NH3, colour=Site))+ 
  geom_point()+
  geom_smooth(method="glm", se=F)+
  scale_y_log10()+
  facet_grid(.~Month)+
  theme_bw()+
  ylab(expression(paste("Excretion Rate" ~NH[3]~"-N ("~mu~"g/L/minute)")))+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))

#Combined by sampling month, across Bow River and ACWA streams
ggplot(Nut_samples, aes(x=Mass, y=org_rate_NH3, colour=Site))+ 
  geom_point()+
  geom_smooth(method="glm", se=F)+
  scale_y_log10()+
  facet_grid(.~Type, scales="free_x")+
  theme_bw()+
  rremove("grid")+
  ylab(expression(paste("Excretion Rate" ~NH[3]~"-N ("~mu~"g/L/minute)")))+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))

#Combined by sampling month, across Bow River and ACWA streams
ggplot(Nut_samples, aes(x=Mass, y=org_rate_NH3, colour=Site))+ 
  geom_point()+
  geom_smooth(method="glm", se=F)+
  scale_y_log10()+
  facet_nested_wrap(~Type + Month, scales="free_x")+
  theme_bw()+
  rremove("grid")+
  ylab(expression(paste("Excretion Rate" ~NH[3]~"-N ("~mu~"g/L/min)")))+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  guides(nrow=1)+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+
  xlab("Hydropsychidae Dry Mass (mg)")

#ggsave(file="Nutrient_excretion_ED/Figures/NH3-N excretion across Month and Dry mass Bow river and ACWA.png", height=6, width=8)
```

```{r Mean excretion rate across sites}
#Mass normalized excretion rate

coch_NH3<-subset(Nut_samples, Site=="Cochrane")
mean(coch_NH3$Excr_rate_NH3) #0.185
sd(coch_NH3$Excr_rate_NH3) #0.312

sun_NH3<-subset(Nut_samples, Site=="Sunalta")
mean(sun_NH3$Excr_rate_NH3) #0.0043
sd(sun_NH3$Excr_rate_NH3)#0.022

grvbr_NH3<-subset(Nut_samples, Site=="Graves Bridge")
mean(grvbr_NH3$Excr_rate_NH3) #0.049
sd(grvbr_NH3$Excr_rate_NH3) #0.015

pmf_NH3<-subset(Nut_samples, Site=="Policeman Flats")
mean(pmf_NH3$Excr_rate_NH3) #0.0093
sd(pmf_NH3$Excr_rate_NH3) #0.065

BRR2_NH3<-subset(Nut_samples, Site=="REF")
mean(BRR2_NH3$Excr_rate_NH3) #0.062
sd(BRR2_NH3$Excr_rate_NH3) #0.082

PCR1_NH3<-subset(Nut_samples, Site=="EXP5")
mean(PCR1_NH3$Excr_rate_NH3) #0.112
sd(PCR1_NH3$Excr_rate_NH3) #0.096

PCR3_NH3<-subset(Nut_samples, Site=="EXP15")
mean(PCR3_NH3$Excr_rate_NH3) #0.0505
sd(PCR3_NH3$Excr_rate_NH3) #0.0323
```

```{r ANOVA across sites (N excretion - Bow and ACWA separated)}
# Bow River

hist(nut_Bow$Excr_rate_NH3) #Right skewed
hist(log(nut_Bow$Excr_rate_NH3)) #Looks normal when log transformed

logNrate<-log(nut_Bow$Excr_rate_NH3)
nut_Bow<-cbind(logNrate, nut_Bow)
shapiro.test(nut_Bow$logNrate) #Normal

#ANOVA across sites
summary(bowN<-aov(data=nut_Bow, logNrate~Site)) #F(3,39) = 5.68, P = 0.00251
plot(bowN) #Meets assumptions of ANOVA
TukeyHSD(bowN)
#Sunalta has significantly lower ammonia excretion compared to Cochrane. 


# ACWA

hist(nut_ACWA$Excr_rate_NH3) 
hist(log(nut_ACWA$Excr_rate_NH3)) #Looks more normal when log transformed

logNrate<-log(nut_ACWA$Excr_rate_NH3)
nut_ACWA<-cbind(logNrate, nut_ACWA)
shapiro.test(nut_ACWA$logNrate) #Normal

#ANOVA across sites
summary(ACWAN<-aov(data=nut_ACWA, logNrate~Site)) #F(2,25) = 3.76, P = 0.0375
plot(ACWAN) #Meets assumptions of ANOVA
TukeyHSD(ACWAN)
#EXP15 has significantly lower ammonia excretion than EXP5 p = 0.0367 
```

# Combining P and N plots
```{r 2 panel plot with N and P}
## All sites together (Bow and ACWA)
#PO4-P excretion rate normalized by mass of organism 

excr_P_plot_all<-ggplot(Nut_samples, aes(x=factor(Site, labels=c("COCH", "SUN", "GRVBR", "PMF", "REF", "EXP5", "EXP15")), y=Excr_rate_P))+ 
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste("Excretion Rate" ~PO[4]~"-P ("~mu~"g/L/mg caddis/minute)")))+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(size =16, angle = 40, vjust = 1, hjust=1, color="black"),
        axis.text.y = element_text(size =16, color="black"))


excr_P_plot2_all<-excr_P_plot_all + theme(axis.title.y = element_blank(), axis.title.x = element_blank())

#NH3-N excretion rate normalized by mass of organism (just Bow River samples)
excr_NH3_plot_all<-ggplot(Nut_samples, aes(x=factor(Site, labels=c("COCH", "SUN", "GRVBR", "PMF", "REF", "EXP5", "EXP15")), y=Excr_rate_NH3))+ 
  geom_boxplot()+
  scale_y_log10()+
  theme_classic()+
  ylab(expression(paste("Excretion Rate" ~NH[3]~"-N ("~mu~"g/L/mg caddis/minute)")))+
  labs(colour="Sampling Month")+
  scale_y_log10()+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(size=16, angle = 40, vjust = 1, hjust=1, color="black"),
        axis.text.y = element_text(size=16, color="black"))

excr_NH3_plot_all

excr_NH3_plot2_all<-excr_NH3_plot_all + theme(axis.title.y = element_blank(), axis.title.x = element_blank())

excr_rate_nutrient_all<-ggarrange(excr_P_plot2_all, excr_NH3_plot2_all, ncol=1, nrow=2, align = "v")

annotate_figure(excr_rate_nutrient_all, bottom = text_grob("Site", size = 18))

#ggsave(filename="nutrient_excretion_analysis/Figures/Nutrient excretion rate per mg caddis P and N.png", height=10, width=12, bg="white")

```
