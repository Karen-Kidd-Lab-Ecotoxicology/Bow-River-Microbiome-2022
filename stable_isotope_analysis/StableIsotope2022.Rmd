---
title: "StableIsotope2022"
author: "Emilie Diesbourg"
date: "14/03/2023"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Loading packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
par(mar = c(1, 1, 1, 1))
```

```{r Packages/Data}
library(rjags)
library(MixSIAR)
library(plyr)
library(dplyr)
library(ggpubr)
library(ggplot2)
library(R2WinBUGS)
library(FSA)
library(splancs)
library(devtools)
library(emmeans)
library(vegan)
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", force=TRUE)
library(pairwiseAdonis)
library(ggpubr)
library(ggh4x)
library(car)
library(grid)

isotope<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_1.csv")
isotope$Site<-factor(isotope$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))
```

# Sample sizes

```{r}
#Larvae across sites
coch_lar<-subset(inverts, Site=="Cochrane" & Stage=="Larvae") #5
sun_lar<-subset(inverts, Site=="Sunalta" & Stage=="Larvae") #14
cushbr_lar<-subset(inverts, Site=="Cushing Bridge" & Stage=="Larvae") #6
grvbr_lar<-subset(inverts, Site=="Graves Bridge" & Stage=="Larvae") #15
pmf_lar<-subset(inverts, Site=="Policeman Flats" & Stage=="Larvae") #14

#Adults across sites
coch_ad<-subset(inverts, Site=="Cochrane" & Stage=="Adult") #12
sun_ad<-subset(inverts, Site=="Sunalta" & Stage=="Adult") #14
cushbr_ad<-subset(inverts, Site=="Cushing Bridge" & Stage=="Adult") #11
grvbr_ad<-subset(inverts, Site=="Graves Bridge" & Stage=="Adult") #18
pmf_ad<-subset(inverts, Site=="Policeman Flats" & Stage=="Adult")#14

#Spiders n = 3/family/site



summary_taxa<-isotope %>% 
  dplyr::select("Taxa", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(Taxa, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_taxa)


#Combine taxa by larvae, adults, spiders, biofilm, leaves, and by functional feeding group

summary_FFG<-isotope %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG)

```

# Preliminary data checks (carbonates/lipid effect/HCl treated biofilm)

```{r}
#### Carbonate effect ####

ggplot(isotope, aes(x=X.C, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks like there's a negative relationship between %C and d13C indicating no carbonates (inorganic carbon) in the samples since the correlation should be positive if there was an effect (Brian Hayden)

#Mostly an issue for biofilm so we will look at those samples individually
biofilm<-filter(isotope, Taxa=="Biofilm")

ggplot(biofilm, aes(x=X.C, y=d13C))+ 
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#No effect of carbonates. Seems like there is one data point driving the others. 


#### Lipid effect ####
#We only look at inverts since plants don't have much lipid
inverts<-subset(isotope, Tissue.Type=="Whole Invertebrate")

ggplot(inverts, aes(x=C.N, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks depleted across all sites. Could potentially be an issue.

ggplot(inverts, aes(x=Taxa, y=C.N))+
  geom_boxplot()+
  geom_hline(aes(yintercept=4), colour="red")

#Could potentially indicate a lipid effect since C:N ratio shouldn't be above 3.5 but if we correct it, it won't make a difference since all the insects besides spiders are at approximately the same level. This is usually more of an issue in fattier animals such as fish.  

#### Plotting biofilm duplicates with high variability ####


rawdata<-read.csv("C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\Isotopes\\SIN Lab Data\\Stable_Isotope_Raw_Data.csv")

biofilm_raw<-filter(rawdata, Tissue_Type=="Biofilm") #34 obs 

#Remove the HCl treated samples since those did not differ in C values from the non-treated ones

biofilm_raw_no_HCl<-filter(biofilm_raw, Notes!="Acid treated") #17 obs 

biofilm_raw_no_HCl$Site <-factor(biofilm_raw_no_HCl$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

#plotting variation in carbon values in replicates and duplicates

ggplot(biofilm_raw_no_HCl, aes(x=Site, y=d13C, label=SampleName))+ 
  geom_point()+
 geom_text(hjust=-0.1)+
  theme_bw()

#plotting variation in nitrogen values in replicates and duplicates
  
ggplot(biofilm_raw_no_HCl, aes(x=Site, y=d15N, label=SampleName))+ 
  geom_point()+
 geom_text(hjust=-0.1)+
  theme_bw()

#### HCl treated biofilm ####

#Averaged duplicates
HCl_isotope<-read.csv("C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\Isotopes\\SIN Lab Data\\StableIsotopeAvg.csv")

HCl_biofilm<-subset(HCl_isotope, Stage=="Acid treated")

#d13C versus C/N ratio with HCl treated biofilm

ggplot(HCl_biofilm, aes(x=d13C, y=C.N))+
  geom_point()

#d13C versus C/N ratio with non HCl treated biofilm

no_HCl_biofilm<-subset(HCl_isotope, Stage=="Not acid treated")

ggplot(no_HCl_biofilm, aes(x=d13C, y=C.N))+
  geom_point()


all_biofilm<-subset(HCl_isotope, Taxa=="Biofilm")

#Plotting all biofilm together coloured by whether they were acid treated or not

ggplot(all_biofilm, aes(x=d13C, y=C.N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  rremove("grid")

#Faceted across sites

all_biofilm$Site<-factor(all_biofilm$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

ggplot(all_biofilm, aes(x=d13C, y=C.N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")


ggplot(all_biofilm, aes(x=d13C, y=d15N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")



#Are the acid treated biofilm carbon values different from the non acid treated ones? Potentially indicates presence of carbonates if they are different. 

shapiro.test(all_biofilm$d13C) #not normal p=0.003
leveneTest(data=all_biofilm, d13C ~ Site*Stage) #Homogeneity p=0.327
hist(all_biofilm$d13C) #not normal looking

#Use Kruskal Wallis tests for each site individually

#Cochrane
coch_biofilm<-subset(all_biofilm, Site=="Cochrane")
shapiro.test(coch_biofilm$d13C) #p=0.26, normal
t.test(d13C~Stage, data=coch_biofilm) #0.36, not sig diff
kruskal.test(d13C ~ Stage, data=coch_biofilm) #p=0.49, not sig different

#Sunalta
sun_biofilm<-subset(all_biofilm, Site=="Sunalta")
shapiro.test(sun_biofilm$d13C) #p=0.38, normal
t.test(d13C~Stage, data=sun_biofilm) #p=0.47, not sig diff
kruskal.test(d13C ~ Stage, data=sun_biofilm) #p=0.51, not sig. different

#Cushing Bridge
cushbr_biofilm<-subset(all_biofilm, Site=="Cushing Bridge")
shapiro.test(cushbr_biofilm$d13C) #p=0.303. Normal
t.test(d13C~Stage, data=cushbr_biofilm) #p=0.65, not sig diff. 
kruskal.test(d13C ~ Stage, data=cushbr_biofilm) #p=0.83, not sig. different

#Graves Bridge
grvbr_biofilm<-subset(all_biofilm, Site=="Graves Bridge")
shapiro.test(grvbr_biofilm$d13C) #p=0.0047 not normal
wilcox.test(grvbr_biofilm$d13C ~ grvbr_biofilm$Stage) #p=0.1. Not sig.
kruskal.test(d13C ~ Stage, data=grvbr_biofilm) #p=0.05, not sig. different

#Policeman Flats
pmf_biofilm<-subset(all_biofilm, Site=="Policeman Flats")
shapiro.test(pmf_biofilm$d13C) #p=0.11, normal dist.
t.test(d13C~Stage, data=pmf_biofilm) #p=0.039. Sig. different
kruskal.test(d13C ~ Stage, data=pmf_biofilm) #p=0.04, Sig. different

#Policeman Flats was the only site that had significantly different carbon values for acid vs not acid treated biofilm samples but they look very similar when graphed



#Are the acid treated biofilm nitrogen values different from the non acid treated ones?  

shapiro.test(all_biofilm$d15N) #normal p=0.121
leveneTest(data=all_biofilm, d15N ~ Site*Stage) #Homogeneity p=0.626
hist(all_biofilm$d15N) #not very normal looking but passes the normality test

summary(N_aov<-aov(data=all_biofilm, d15N ~ Site*Stage))

emmeans(N_aov, pairwise ~ Site|Stage)
#Acid treated data has significant differences in nitrogen between COCH - GRVBR and PMF - GRVBR however, non acid treated data have no significant comparisons. 

emmeans(N_aov, pairwise ~ Stage|Site)
#Nitrogen values don't differ between acid treated and non-acid treated data at all sites



#Raw duplicates

raw_data<-read.csv("C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\Isotopes\\SIN Lab Data\\Stable_Isotope_Raw_Data.csv")


HCl_biofilm_raw<-subset(raw_data, Stage=="Acid treated")

#d13C versus C/N ratio with HCl treated biofilm

ggplot(HCl_biofilm_raw, aes(x=d13C, y=C.N))+
  geom_point()

#d13C versus C/N ratio with non HCl treated biofilm

no_HCl_biofilm_raw<-subset(raw_data, Stage=="Non acid treated")

ggplot(no_HCl_biofilm_raw, aes(x=d13C, y=C.N))+
  geom_point()


all_biofilm_raw<-subset(raw_data, Tissue_Type=="Biofilm")

#Plotting all biofilm together coloured by whether they were acid treated or not

ggplot(all_biofilm_raw, aes(x=d13C, y=C.N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  rremove("grid")

#Faceted across sites

all_biofilm_raw$Site<-factor(all_biofilm_raw$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

ggplot(all_biofilm_raw, aes(x=d13C, y=C.N, label=SampleName))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  geom_text_repel(aes(label=SampleName), size=2)+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")

library(ggrepel)
ggplot(all_biofilm_raw, aes(x=d13C, y=d15N, label=SampleName))+
  theme_bw()+
  geom_text_repel(aes(label=SampleName), size=2)+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")


```

# Biplots of individual data points

```{r}
# d13C vs d15N at all sites
ggplot(isotope, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()+
  facet_grid(.~Site)

# Sites plotted individually
Cochrane<-filter(isotope, Site=="Cochrane")
ggplot(Cochrane, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Sunalta<-filter(isotope, Site=="Sunalta")
ggplot(Sunalta, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()

Cushbr<-filter(isotope, Site=="Cushing Bridge")
ggplot(Cushbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Grvbr<-filter(isotope, Site=="Graves Bridge")
ggplot(Grvbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs and biofilm are high in nitrogen as well as invertebrates. Biofilm is variable on the x axis.

Polflt<-filter(isotope, Site=="Policeman Flats")
ggplot(Polflt, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs still high in nitrogen but biofilm is not. All taxa are very variable on both x and y axes. 
```

# Biplots of averaged /median data

```{r}

#Summarizing a dataframe with mean and sd C and N values

data.sum<-ddply(isotope, c("Site_Code", "Taxa", "FFG"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

#All sites together

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme_classic()

#Sites faceted

data.sum$Taxa<-factor(data.sum$Taxa, levels= c("Terrestrial Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"), labels=c("Riparian Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"))

data.sum$Site_Code<-factor(data.sum$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type", shape="Functional Feeding Group")+
  rremove("grid")


#ggsave(filename="stable_isotope_analysis/Figures/Mean SD biplot d13C d15N faceted by site.png", height=7, width=12)



data.sum.1<-ddply(isotope, c("Site_Code", "Taxa"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims.1<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims.1<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

data.sum.1$Aqu_Terr<-factor(data.sum.1$Aqu_Terr, levels=c("Biofilm", "Riparian Leaves", "Aquatic Larvae", "Aquatic Adults", "Terrestrial Prey", "Spiders"), labels=c("Biofilm", "Riparian leaves", "Aquatic larval insects", "Aquatic adult insects", "Terrestrial adult insects", "Spiders"))

data.sum.1$Site_Code<-factor(data.sum.1$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))


ggplot(data.sum.1, aes(x=d13Cmn, y=d15Nmn, colour=Taxa))+
  geom_point(size=3)+
  geom_errorbar(Ylims.1, width=0.2)+
  geom_errorbarh(Xlims.1, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type")+
  rremove("grid")

```

# Nitrogen isotope {.tabset}

## ANOVA/Kruskal tests across individual invertebrate families
```{r}
#### N plot across sites ####

colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

isotope$Taxa<-factor(isotope$Taxa, levels=c("Biofilm", "Terrestrial Leaves", "Heptageniidae", "Hydropsychidae", "Chironomidae", "Ephemerellidae", "Leptoceridae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Rhyacophilidae", "Coleoptera", "Araneidae", "Tetragnathidae"))

isotope$FFG<-factor(isotope$FFG, levels=c("Basal food source", "Scraper", "Filterer-Collector", "Gatherer-Collector", "Piercer", "Predator"))

isotope$Site_Code<-factor(isotope$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

#Plotting by individual taxa
N_plot_taxa<-ggplot(isotope, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), strip.text.x = element_text(size=6), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Taxa_Specific, scales="free_x", nrow=1)
N_plot_taxa

#If analyzing by individual taxa, remove these samples due to low sample size (2 replicates or less per site):
#-Heptageniidae Adult
#-Heptageniidae larvae at Cushing Bridge
#-Hydropsychidae Adult at Cochrane
#-Hydropsychidae larvae
#-Chironomidae Adult
#-Chiornomidae Larvae
#-Ephemerellidae Adult
#-Leptoceridae Adult
#-Chloroperlidae adult
#-Coleoptera
#-Perlidae Larvae
#Rhyacophilidae Adult


N_plot_FFG<-ggplot(isotope, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Stage, scales="free_x", nrow=1)
N_plot_FFG

#If analyzing by functional feeding group, remove these samples due to low sample size (2 replicates or less per site):
#-Heptageniidae Adults
#-Heptageniidae larvae at Cushing Bridge 
#-Hydropsychidae Adults at Cochrane
#-Hydropsychidae larvae at Cochrane and Sunalta (Potentially all of them)
#-Chironomidae larvae at Cushing Bridge 
#-Rhyacophilidae Adult at Cushing Bridge


#Subset samples with low replicates so that we can group by functional feeding group

isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")
isotope_subset$Site<-factor(isotope_subset$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

isotope_subset_no_food_sources<-subset(isotope_subset, Stage!="Biofilm" & Stage!="Terrestrial leaves")

isotope_subset_no_food_sources$Stage<-factor(isotope_subset_no_food_sources$Stage, levels=c("Aquatic larvae", "Aquatic adult","Terrestrial adult","Spider"))

isotope_subset_no_food_sources$Site_Code<-factor(isotope_subset_no_food_sources$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

isotope_subset_no_food_sources$FFG<-factor(isotope_subset_no_food_sources$FFG, levels=c("Scraper", "Gatherer-Collector", "Filterer-Collector", "Predator", "Piercer"))

N_plot_taxa_subset_no_food_sources<-ggplot(isotope_subset_no_food_sources, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
N_plot_taxa_subset_no_food_sources

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\N plot across FFG and stage subsetted data.png", height=10, width=26)


#Just larvae and spiders
isotope_subset_lar_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Aquatic larvae" | Stage=="Spider")

N_plot_taxa_subset_lar<-ggplot(isotope_subset_lar_no_food_sources, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
N_plot_taxa_subset_lar

summary_FFG_lar<-isotope_subset_lar %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG_lar)


#Just adults and spiders

isotope_subset_ad<-subset(isotope_subset, Stage=="Aquatic adult" | Stage=="Terrestrial adult" | Stage=="Spider")

N_plot_taxa_subset_ad<-ggplot(isotope_subset_ad, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
N_plot_taxa_subset_ad

summary_FFG_ad<-isotope_subset_ad %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG_ad)


#### ANOVA across sites and FFGs ####

#All stages and FFGs together

shapiro.test(isotope_subset_no_food_sources$d15N) #0.112
leveneTest(data=isotope_subset_no_food_sources, d15N~Site*FFG*Stage) #0.082
plot(isotope_subset_no_food_sources$d15N)

summary(N_FFG<-aov(data=isotope_subset_no_food_sources, d15N~Site+FFG+Stage))
emmeans(N_FFG, pairwise ~ Site | FFG)
emmeans(N_FFG, pairwise ~ Site | Stage)
emmeans(N_FFG, pairwise ~ Stage | FFG)

#Aquatic larvae

isotope_subset_only_lar_no_food_sources<-subset(isotope_subset_lar_no_food_sources, Stage=="Aquatic larvae")

shapiro.test(isotope_subset_only_lar_no_food_sources$d15N)  #Normal, p = 0.165
leveneTest(data=isotope_subset_only_lar_no_food_sources, d15N~Site*FFG) #homogeneity p = 0.053
hist(isotope_subset_only_lar_no_food_sources$d15N) #looks bimodel 


#Parametric test

summary(N_lar_FFG<-aov(data=isotope_subset_only_lar_no_food_sources, d15N~Site+FFG))
emmeans(N_lar_FFG, pairwise ~ Site | FFG)

plot(N_lar_FFG) #Scale-Location plot isn't the best but there is no clear pattern in residual variance


#Aquatic adults

isotope_subset_only_ad_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Aquatic adult")

shapiro.test(isotope_subset_only_ad_no_food_sources$d15N)  #Normal, p = 0.166
leveneTest(data=isotope_subset_only_ad_no_food_sources, d15N~Site*Taxa) #homogeneity p = 0.89
hist(isotope_subset_only_ad_no_food_sources$d15N) #looks decently normal

#Parametric test

summary(N_ad_FFG<-aov(data=isotope_subset_only_ad_no_food_sources, d15N~Site*FFG))
emmeans(N_ad_FFG, pairwise ~ Site | FFG)

plot(N_ad_FFG) #Scale-Location plot isn't great


#Terrestrial Adults

isotope_subset_only_terr_ad_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Terrestrial adult")

shapiro.test(isotope_subset_only_terr_ad_no_food_sources$d15N)  #Normal, p = 0.3559
leveneTest(data=isotope_subset_only_terr_ad_no_food_sources, d15N~Site*Taxa) #homogeneity p = 0.95
hist(isotope_subset_only_terr_ad_no_food_sources$d15N) #looks decently normal, possibly uniform-ish

#Parametric test

summary(N_terr_ad_FFG<-aov(data=isotope_subset_only_terr_ad_no_food_sources, d15N~Site))
emmeans(N_terr_ad_FFG, pairwise ~ Site) #Policeman Flats lower than all other sites

plot(N_terr_ad_FFG) #Fits assumptions of normality


#Spiders

isotope_subset_only_spiders_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Spider")

shapiro.test(isotope_subset_only_spiders_no_food_sources$d15N)  #Not normal, p < 0.001
leveneTest(data=isotope_subset_only_spiders_no_food_sources, d15N~Site) #homogeneity p = 0.234
hist(isotope_subset_only_spiders_no_food_sources$d15N) #looks right skewed

#Non-parametric test

kruskal.test(data=isotope_subset_only_spiders_no_food_sources, d15N~Site) #p=0.005
dunnTest(data=isotope_subset_only_spiders_no_food_sources, d15N~Site) #Graves Bridge diff from all other sites


#### Araneidae ####
araneidae<-subset(inverts, Taxa=="Araneidae")
ggplot(araneidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge. 

shapiro.test(araneidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=araneidae) #p=0.061. Probably due to small sample size
dunnTest(d15N~Site, data=araneidae)
#GRVBR - PMF p=0.034

#### Tetragnathidae ####
tetragnathidae<-subset(inverts, Taxa=="Tetragnathidae")
ggplot(tetragnathidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge.

shapiro.test(tetragnathidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=tetragnathidae) #p=0.136
dunnTest(d15N~Site, data=tetragnathidae)
#No diff, probably because of the small sample size. 


#### Hydropsychidae ####

#Larvae

hydro_lar<-subset(isotope, Taxa_num=="2" & Stage=="Larvae")
hydro_lar_d15N_plot<-ggplot(hydro_lar, aes(x=factor(Site, labels=c("COCH", "SUN", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))

hydro_lar_d15N_plot

shapiro.test(hydro_lar$d15N)  #Not normal
hist(hydro_lar$d15N) #not normal looking dist

kruskal.test(d15N~Site, data=hydro_lar) #p=0.052
dunnTest(d15N~Site, data=hydro_lar)
#only diff btw graves bridge and sunalta

#Adults

hydro_ad<-subset(inverts, Taxa_num=="2" & Stage=="Adult")
hydro_ad_d15N_plot<-ggplot(hydro_ad, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
hydro_ad_d15N_plot

shapiro.test(hydro_ad$d15N)  #Not normal
hist(log(hydro_ad$d15N)) #normal looking dist.

kruskal.test(d15N~Site, data=hydro_ad) #p=0.044
dunnTest(d15N~Site, data=hydro_ad)
#Diff btw GRVBR - PMF


#### Heptageniidae ####
#Larvae
larhep<-filter(inverts, Taxa=="Heptageniidae" & Stage=="Larvae")
ggplot(larhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Graves Bridge is much higher in d15N

shapiro.test(larhep$d15N)  #Normal
hist(larhep$d15N) #normal looking dist.

summary(hep_lm1<-lm(d15N~Site, data=larhep))
emmeans(hep_lm1, specs = pairwise ~ Site)
#Diff btw:
#COCH - GRVBR
#COCH - PMF
#SUN - GRVBR
#SUN - PMF
#CUSHBR - GRVBR
#CUSHBR - PMF
#GRVBR - PMF


#Adults
adhep<-filter(inverts, Taxa=="Heptageniidae" &  Stage=="Adult")
ggplot(adhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

#Not a large enough sample size to run stats

#### Chironomidae ####
#Larvae
larchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Larvae")
ggplot(larchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not a large enough sample size to run stats

#Adult
adchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Adult")
ggplot(adchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough to really compare at Graves Bridge but might not be significantly higher than the other sites

#### Chloroperlidae ####
#larvae
larchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Larvae")

ggplot(larchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

shapiro.test(larchloro$d15N)  #Normal
hist(larchloro$d15N) #Not normal looking.

summary(chloro_lm1<-lm(d15N~Site, data=larchloro))
emmeans(chloro_lm1, specs = pairwise ~ Site)
#SUN - GRVBR p=0.0006
#CUSHBR - GRVBR p < 0.001

#adults
adchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Adult")
ggplot(adchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough samples for statistical comparison

#### Perlidae ####

#larvae
larchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Larvae")

ggplot(larchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

shapiro.test(larchloro$d15N)  #Normal
hist(larchloro$d15N) #Not normal looking.

summary(chloro_lm1<-lm(d15N~Site, data=larchloro))
emmeans(chloro_lm1, specs = pairwise ~ Site)
#SUN - GRVBR p=0.0006
#CUSHBR - GRVBR p < 0.001

#adults
adchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Adult")
ggplot(adchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough samples for statistical comparison

#### Ephemerellidae ####
#Larvae
larephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Larvae")
ggplot(larephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

shapiro.test(larephem$d15N)  #Normal
hist(larephem$d15N) #Not normal looking.

kruskal.test(d15N~Site, data=larephem) #p=0.066
dunnTest(d15N~Site, data=larephem) #no diff

#Adults
adephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Adult")
ggplot(adephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

#Not enough samples to run stats


```

# Carbon isotope

```{r}
#### C plot across sites ####

isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")
isotope_subset$Site<-factor(isotope_subset$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

isotope_subset_no_food_sources<-subset(isotope_subset, Stage!="Biofilm" & Stage!="Terrestrial leaves")

isotope_subset_no_food_sources$Stage<-factor(isotope_subset_no_food_sources$Stage, levels=c("Aquatic larvae", "Aquatic adult","Terrestrial adult","Spider"))

isotope_subset_no_food_sources$Site_Code<-factor(isotope_subset_no_food_sources$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

isotope_subset_no_food_sources$FFG<-factor(isotope_subset_no_food_sources$FFG, levels=c("Scraper", "Gatherer-Collector", "Filterer-Collector", "Predator", "Piercer"))


C_plot_taxa_subset_no_food_sources<-ggplot(isotope_subset_no_food_sources, aes(x=Site_Code, y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope_subset_no_food_sources$Site_Code, c("GRVBR", "PMF"))))+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
C_plot_taxa_subset_no_food_sources

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\C plot across FFG and stage subsetted data.png", height=10, width=26)

#### ANOVA across sites and individual taxa ####

#All stages and FFGs together

shapiro.test(isotope_subset_no_food_sources$d13C) #0.169
leveneTest(data=isotope_subset_no_food_sources, d13C~Site*FFG*Stage) #0.334
plot(isotope_subset_no_food_sources$d13C)

summary(C_FFG<-aov(data=isotope_subset_no_food_sources, d13C~Site+FFG+Stage))
emmeans(C_FFG, pairwise ~ Site | FFG)
emmeans(C_FFG, pairwise ~ Site | Stage)
emmeans(C_FFG, pairwise ~ Stage | FFG)

#Aquatic larvae

isotope_subset_only_lar_no_food_sources<-subset(isotope_subset_lar_no_food_sources, Stage=="Aquatic larvae")

shapiro.test(isotope_subset_only_lar_no_food_sources$d13C)  #Normal, p = 0.087
leveneTest(data=isotope_subset_only_lar_no_food_sources, d13C~Site*FFG) #homogeneity p = 0.653
hist(isotope_subset_only_lar_no_food_sources$d13C) #decently normal 


#Parametric test

summary(C_lar_FFG<-aov(data=isotope_subset_only_lar_no_food_sources, d13C~Site+FFG))
emmeans(C_lar_FFG, pairwise ~ Site | FFG)

plot(C_lar_FFG) #Not completely normal but only slightly deviates from QQ-plot


#Aquatic adults

isotope_subset_only_ad_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Aquatic adult")

shapiro.test(isotope_subset_only_ad_no_food_sources$d13C)  #Normal, p = 0.435
leveneTest(data=isotope_subset_only_ad_no_food_sources, d13C~Site*Taxa) #homogeneity p = 0.07
hist(isotope_subset_only_ad_no_food_sources$d13C) #looks decently normal, uniform-ish

#Parametric test

summary(C_ad_FFG<-aov(data=isotope_subset_only_ad_no_food_sources, d13C~Site+FFG))
emmeans(C_ad_FFG, pairwise ~ Site | FFG)

plot(C_ad_FFG) #Not completely normal but only slightly deviates from QQ-plot


#Terrestrial Adults

isotope_subset_only_terr_ad_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Terrestrial adult")

shapiro.test(isotope_subset_only_terr_ad_no_food_sources$d13C)  #Normal, p = 0.43
leveneTest(data=isotope_subset_only_terr_ad_no_food_sources, d13C~Site) #homogeneity p = 0.88
hist(isotope_subset_only_terr_ad_no_food_sources$d13C) #looks uniform

#Parametric test

summary(C_terr_ad_FFG<-aov(data=isotope_subset_only_terr_ad_no_food_sources, d13C~Site))
emmeans(C_terr_ad_FFG, pairwise ~ Site) #No differences

plot(C_terr_ad_FFG) #Fits assumptions of normality


#Spiders

isotope_subset_only_spiders_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Spider")

shapiro.test(isotope_subset_only_spiders_no_food_sources$d13C)  #Not normal, p = 0.27
leveneTest(data=isotope_subset_only_spiders_no_food_sources, d13C~Site) #homogeneity p = 0.13
hist(isotope_subset_only_spiders_no_food_sources$d13C) #looks decently normal

#Non-parametric test

summary(C_spiders_FFG<-aov(data=isotope_subset_only_spiders_no_food_sources, d13C~Site))
emmeans(C_spiders_FFG, pairwise ~ Site) #Cochrane more negative than all other sites

plot(C_spiders_FFG) #Fits assumptions of normality

#### Araneidae ####
araneidae<-subset(inverts, Taxa=="Araneidae")
ggplot(araneidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge. 

shapiro.test(araneidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=araneidae) #p=0.061. Probably due to small sample size
dunnTest(d15N~Site, data=araneidae)
#GRVBR - PMF p=0.034

#### Tetragnathidae ####
tetragnathidae<-subset(inverts, Taxa=="Tetragnathidae")
ggplot(tetragnathidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge.

shapiro.test(tetragnathidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=tetragnathidae) #p=0.136
dunnTest(d15N~Site, data=tetragnathidae)
#No diff, probably because of the small sample size. 


#### Hydropsychidae ####

#Larvae

hydro_lar<-subset(isotope, Taxa_num=="2" & Stage=="Larvae")
hydro_lar_d15N_plot<-ggplot(hydro_lar, aes(x=factor(Site, labels=c("COCH", "SUN", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))

hydro_lar_d15N_plot

shapiro.test(hydro_lar$d15N)  #Not normal
hist(hydro_lar$d15N) #not normal looking dist

kruskal.test(d15N~Site, data=hydro_lar) #p=0.052
dunnTest(d15N~Site, data=hydro_lar)
#only diff btw graves bridge and sunalta

#Adults

hydro_ad<-subset(inverts, Taxa_num=="2" & Stage=="Adult")
hydro_ad_d15N_plot<-ggplot(hydro_ad, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
hydro_ad_d15N_plot

shapiro.test(hydro_ad$d15N)  #Not normal
hist(log(hydro_ad$d15N)) #normal looking dist.

kruskal.test(d15N~Site, data=hydro_ad) #p=0.044
dunnTest(d15N~Site, data=hydro_ad)
#Diff btw GRVBR - PMF


#### Heptageniidae ####
#Larvae
larhep<-filter(inverts, Taxa=="Heptageniidae" & Stage=="Larvae")
ggplot(larhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Graves Bridge is much higher in d15N

shapiro.test(larhep$d15N)  #Normal
hist(larhep$d15N) #normal looking dist.

summary(hep_lm1<-lm(d15N~Site, data=larhep))
emmeans(hep_lm1, specs = pairwise ~ Site)
#Diff btw:
#COCH - GRVBR
#COCH - PMF
#SUN - GRVBR
#SUN - PMF
#CUSHBR - GRVBR
#CUSHBR - PMF
#GRVBR - PMF


#Adults
adhep<-filter(inverts, Taxa=="Heptageniidae" &  Stage=="Adult")
ggplot(adhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

#Not a large enough sample size to run stats

#### Chironomidae ####
#Larvae
larchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Larvae")
ggplot(larchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not a large enough sample size to run stats

#Adult
adchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Adult")
ggplot(adchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough to really compare at Graves Bridge but might not be significantly higher than the other sites

#### Chloroperlidae ####
#larvae
larchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Larvae")

ggplot(larchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

shapiro.test(larchloro$d15N)  #Normal
hist(larchloro$d15N) #Not normal looking.

summary(chloro_lm1<-lm(d15N~Site, data=larchloro))
emmeans(chloro_lm1, specs = pairwise ~ Site)
#SUN - GRVBR p=0.0006
#CUSHBR - GRVBR p < 0.001

#adults
adchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Adult")
ggplot(adchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough samples for statistical comparison

#### Perlidae ####

#larvae
larchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Larvae")

ggplot(larchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

shapiro.test(larchloro$d15N)  #Normal
hist(larchloro$d15N) #Not normal looking.

summary(chloro_lm1<-lm(d15N~Site, data=larchloro))
emmeans(chloro_lm1, specs = pairwise ~ Site)
#SUN - GRVBR p=0.0006
#CUSHBR - GRVBR p < 0.001

#adults
adchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Adult")
ggplot(adchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough samples for statistical comparison

#### Ephemerellidae ####
#Larvae
larephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Larvae")
ggplot(larephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

shapiro.test(larephem$d15N)  #Normal
hist(larephem$d15N) #Not normal looking.

kruskal.test(d15N~Site, data=larephem) #p=0.066
dunnTest(d15N~Site, data=larephem) #no diff

#Adults
adephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Adult")
ggplot(adephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

#Not enough samples to run stats



```

# Combining C and N boxplot across sites 

```{r}
C_plot_lar<-C_plot_taxa_subset_no_food_sources + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank())
N_plot_lar<-N_plot_taxa_subset_no_food_sources + theme(axis.title.x = element_blank())

C_N_combined<-ggarrange(C_plot_lar, N_plot_lar, nrow=2, ncol=1, align="v")

annotate_figure(C_N_combined, bottom = textGrob("Site", gp = gpar(cex = 1.6)))

#ggsave(filename="stable_isotope_analysis/Figures/C and N across FFG and sites no food sources.png", height=14, width=26, bg="white")
```


# Food source reliance graph

```{r}

isotope_subset<-subset(isotope, FFG!="Basal food source")%>%
  dplyr::select("Site_Code", "Taxa","d13C", "FFG")%>%
  group_by(Site_Code, Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

Ylims<-aes(ymax=MeanC +sdC, ymin=MeanC-sdC)

isotope_subset$Site_Code<-factor(isotope_subset$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

ggplot(isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  facet_grid(~Site_Code)+
  theme_bw() +
  rremove("grid")+
  geom_errorbar(Ylims)+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_blank(), axis.ticks.x = element_blank(), axis.title = element_text(size=18, color="black"))+
  ylim(-33, -6)


# Cochrane #

coch_biofilm<-subset(biofilm, Site=="COCH")
mean(coch_biofilm$d13C) #-14.57

coch_shrub<-subset(shrub, Site=="Cochrane")
mean(coch_shrub$d13C) #-29.07

cochrane_isotope_subset<-subset(isotope, Site=="COCH" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))
View(cochrane_isotope_subset) 

Ylims<-aes(ymax=MeanC +sdC, ymin=MeanC-sdC)

coch_food_source<-ggplot(cochrane_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -14.57, linetype = 2, color = "red")+
  geom_hline(yintercept = -29.07, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))

# Sunalta #

sun_biofilm<-subset(biofilm, Site=="SUN")
mean(sun_biofilm$d13C) #-13.23

sun_shrub<-subset(shrub, Site=="Sunalta")
mean(sun_shrub$d13C) #-28.4

sunalta_isotope_subset<-subset(isotope, Site=="SUN" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))
View(sunalta_isotope_subset) 

sun_food_source<-ggplot(sunalta_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -13.23, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.4, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))


# Cushing Bridge #

cush_biofilm<-subset(biofilm, Site=="CUSHBR")
mean(cush_biofilm$d13C) #-8.47

cush_shrub<-subset(shrub, Site=="Cushing Bridge")
mean(cush_shrub$d13C) #-28.67

cush_isotope_subset<-subset(isotope, Site=="CUSHBR" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

cush_food_source<-ggplot(cush_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -8.47, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.67, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
cush_food_source


# Graves Bridge

grvbr_biofilm<-subset(biofilm, Site=="GRVBR")
mean(grvbr_biofilm$d13C) #-18.27

grvbr_shrub<-subset(shrub, Site=="Graves Bridge")
mean(grvbr_shrub$d13C) #-28.83

grvbr_isotope_subset<-subset(isotope, Site=="GRVBR" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

grvbr_food_source<-ggplot(grvbr_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -18.27, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.83, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
grvbr_food_source

# Policeman Flats

pmf_biofilm<-subset(biofilm, Site=="PMF")
mean(pmf_biofilm$d13C) #-25.7

pmf_shrub<-subset(shrub, Site=="Policeman Flats")
mean(pmf_shrub$d13C) #-27.52

pmf_isotope_subset<-subset(isotope, Site=="PMF" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

pmf_food_source<-ggplot(pmf_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -25.7, linetype = 2, color = "red")+
  geom_hline(yintercept = -27.52, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
pmf_food_source

#ggarrange(coch_food_source, sun_food_source, cush_food_source, grvbr_food_source, pmf_food_source, nrow=1)


#### Only primary consumers ####



```


# Table of mean d13C and d15N values (+/- SD) across sites and sample type 

```{r}
#Grouped by individual taxa and sample type

C_N_sum_tab<-isotope_subset_no_food_sources %>% 
  dplyr::select("Taxa", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(Taxa, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(C_N_sum_tab)
#Some taxa don't have enough replicates

#Grouped by Functional Feeding Group and sample type

summary_FFG<-isotope_subset_no_food_sources %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG)
```

# Running MixSIAR model

```{r}
#Running model with primary consumers and basal food sources

#Make sure the data is a comma delimited file because it gets very fussy about the file type
mix<-load_mix_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\primary_consumers.csv", 
                   iso_names=c("d13C","d15N"), 
                   factors=c("Site","Taxa"), 
                   fac_random=c(FALSE,FALSE), 
                   fac_nested = c(FALSE, FALSE),
                   cont_effects=NULL)

source<-load_source_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_sources.csv",
                         source_factors = "Site",
                         conc_dep = FALSE, 
                         data_type = "means",
                         mix)

discr<-load_discr_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_tef.csv", mix)

#isospace plot
plot_data(filename="isospace_plot", plot_save_pdf = F, plot_save_png = F, mix, source, discr)

#default uninformative/generalist prior (alpha=1)
plot_prior(alpha.prior = c(1), source)

#Informative prior
plot_prior(alpha.prior = c(0.5, 1), source)

#How do you know which weighting to use? Seems like the inverts consume a more terrestrial source so should I weight it higher?

#JAGS model file
model_filename<-"MixSIAR_model.txt"
resid_err<-TRUE
process_err<-TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)
output_options = list(summary_save = FALSE, summary_name = "summary_statistics.txt",
    sup_post = FALSE, plot_post_save_pdf = FALSE, plot_post_name = "posterior_density",
    sup_pairs = FALSE, plot_pairs_save_pdf = FALSE, plot_pairs_name = "pairs_plot", sup_xy
    = FALSE, plot_xy_save_pdf = FALSE, plot_xy_name = "xy_plot", gelman = TRUE, heidel =
    FALSE, geweke = TRUE, diag_save = FALSE, diag_name = "diagnostics.txt", indiv_effect =
    FALSE, plot_post_save_png = FALSE, plot_pairs_save_png = FALSE, plot_xy_save_png =
    FALSE, diag_save_ggmcmc = FALSE)

#Running real model with 'normal' chain length and burn-in.
run<-list(chainLength=100000, burn=50000, thin=50, chains=3, calcDIC=TRUE)
jags<-run_model(run, mix, source, discr, model_filename, alpha.prior = 1, resid_err, process_err)
output_JAGS(jags, mix, source, output_options)


#Running model with secondary consumers and primary consumers as the food source

```
