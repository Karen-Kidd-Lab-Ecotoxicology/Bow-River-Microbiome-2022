---
title: "StableIsotope2022"
author: "Emilie Diesbourg"
date: "14/03/2023"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Loading packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
par(mar = c(1, 1, 1, 1))
```

```{r Packages/Data}
library(rjags)
library(MixSIAR)
library(plyr)
library(dplyr)
library(ggpubr)
library(ggplot2)
library(R2WinBUGS)
library(FSA)
library(splancs)
library(devtools)
library(emmeans)
library(vegan)
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", force=TRUE)
library(pairwiseAdonis)
library(ggpubr)
library(ggh4x)


isotope<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022.csv")
isotope$Site<-factor(isotope$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

#isotope$Aqu_Terr<-factor(isotope$Aqu_Terr, levels=c("Leaves", "biofilm", "lar_aquatic", "Ad_aquatic", "Terrestrial", "Spider"), labels=c("Riparian Leaves", "Biofilm", "Aquatic Larvae", "Aquatic Adults", "Terrestrial Prey", "Spiders"))

inverts<-subset(isotope, Tissue.Type=="Whole Invertebrate")
```

# Sample sizes

```{r}
#Larvae across sites
coch_lar<-subset(inverts, Site=="Cochrane" & Stage=="Larvae") #5
sun_lar<-subset(inverts, Site=="Sunalta" & Stage=="Larvae") #14
cushbr_lar<-subset(inverts, Site=="Cushing Bridge" & Stage=="Larvae") #6
grvbr_lar<-subset(inverts, Site=="Graves Bridge" & Stage=="Larvae") #15
pmf_lar<-subset(inverts, Site=="Policeman Flats" & Stage=="Larvae") #14

#Adults across sites
coch_ad<-subset(inverts, Site=="Cochrane" & Stage=="Adult") #12
sun_ad<-subset(inverts, Site=="Sunalta" & Stage=="Adult") #14
cushbr_ad<-subset(inverts, Site=="Cushing Bridge" & Stage=="Adult") #11
grvbr_ad<-subset(inverts, Site=="Graves Bridge" & Stage=="Adult") #18
pmf_ad<-subset(inverts, Site=="Policeman Flats" & Stage=="Adult")#14

#Spiders n = 3/family/site

#### Cochrane ####

#FFG

filt_collec_coch<-subset(inverts, Site=="Cochrane" & FFG=="Filterer-Collector") #4

gath_collec_coch<-subset(inverts, Site=="Cochrane" & FFG=="Gatherer-Collector") #3

piercer_coch<-subset(inverts, Site=="Cochrane" & FFG=="Piercer") #3

scraper_coch<-subset(inverts, Site=="Cochrane" & FFG=="Scraper") #3

pred_coch<-subset(inverts, Site=="Cochrane" & FFG=="Predator") #10

#Family

hydro_coch<-subset(inverts, Taxa=="Hydropsychidae" & Site=="Cochrane") #4
ephem_coch<-subset(inverts, Taxa=="Ephemerellidae" & Site=="Cochrane") #0
chiro_coch<-subset(inverts, Taxa=="Chironomidae" & Site=="Cochrane") #3
lepto_coch<-subset(inverts, Taxa=="Leptoceridae" & Site=="Cochrane") #0
lepidop_coch<-subset(inverts, Taxa=="Lepidoptera" & Site=="Cochrane") #3
tetra_coch<-subset(inverts, Taxa=="Tetragnathidae" & Site=="Cochrane") #3
aran_coch<-subset(inverts, Taxa=="Araneidae" & Site=="Cochrane") #3
perl_coch<-subset(inverts, Taxa=="Perlidae" & Site=="Cochrane") #0
chloro_coch<-subset(inverts, Taxa=="Chloroperlidae" & Site=="Cochrane") #1
rhya_coch<-subset(inverts, Taxa=="Rhyacophilidae" & Site=="Cochrane") #3
coleop_coch<-subset(inverts, Taxa=="Coleoptera" & Site=="Cochrane") #0
hep_coch<-subset(inverts, Taxa=="Heptageniidae" & Site=="Cochrane") #3
biofilm_coch<-subset(isotope, Taxa=="Biofilm" & Site=="Cochrane") #3
leaves_coch<-subset(isotope, Taxa=="Terrestrial Leaves" & Site=="Cochrane") #3


#### Sunalta ####

#FFG

filt_collec_sun<-subset(inverts, Site=="Sunalta" & FFG=="Filterer-Collector") #5

gath_collec_sun<-subset(inverts, Site=="Sunalta" & FFG=="Gatherer-Collector") #7

piercer_sun<-subset(inverts, Site=="Sunalta" & FFG=="Piercer") #3

scraper_sun<-subset(inverts, Site=="Sunalta" & FFG=="Scraper") #4

pred_sun<-subset(inverts, Site=="Sunalta" & FFG=="Predator") #15

#Family

hydro_sun<-subset(inverts, Taxa=="Hydropsychidae" & Site=="Sunalta") #5
ephem_sun<-subset(inverts, Taxa=="Ephemerellidae" & Site=="Sunalta") #4
chiro_sun<-subset(inverts, Taxa=="Chironomidae" & Site=="Sunalta") #3
lepto_sun<-subset(inverts, Taxa=="Leptoceridae" & Site=="Sunalta") #0
lepidop_sun<-subset(inverts, Taxa=="Lepidoptera" & Site=="Sunalta") #3
tetra_sun<-subset(inverts, Taxa=="Tetragnathidae" & Site=="Sunalta") #3
aran_sun<-subset(inverts, Taxa=="Araneidae" & Site=="Sunalta") #3
perl_sun<-subset(inverts, Taxa=="Perlidae" & Site=="Sunalta") #3
chloro_sun<-subset(inverts, Taxa=="Chloroperlidae" & Site=="Sunalta") #3
rhya_sun<-subset(inverts, Taxa=="Rhyacophilidae" & Site=="Sunalta") #3
coleop_sun<-subset(inverts, Taxa=="Coleoptera" & Site=="Sunalta") #0
hep_sun<-subset(inverts, Taxa=="Heptageniidae" & Site=="Sunalta") #4
biofilm_sun<-subset(isotope, Taxa=="Biofilm" & Site=="Sunalta") #3
leaves_sun<-subset(isotope, Taxa=="Terrestrial Leaves" & Site=="Sunalta") #3


#### Cushing Bridge ####

#FFG

filt_collec_cush<-subset(inverts, Site=="Cushing Bridge" & FFG=="Filterer-Collector") #3

gath_collec_cush<-subset(inverts, Site=="Cushing Bridge" & FFG=="Gatherer-Collector") #7

piercer_cush<-subset(inverts, Site=="Cushing Bridge" & FFG=="Piercer") #0

scraper_cush<-subset(inverts, Site=="Cushing Bridge" & FFG=="Scraper") #3

pred_cush<-subset(inverts, Site=="Cushing Bridge" & FFG=="Predator") #10

#Family

hydro_cush<-subset(inverts, Taxa=="Hydropsychidae" & Site=="Cushing Bridge") #3
ephem_cush<-subset(inverts, Taxa=="Ephemerellidae" & Site=="Cushing Bridge") #2
chiro_cush<-subset(inverts, Taxa=="Chironomidae" & Site=="Cushing Bridge") #4
lepto_cush<-subset(inverts, Taxa=="Leptoceridae" & Site=="Cushing Bridge") #1
lepidop_cush<-subset(inverts, Taxa=="Lepidoptera" & Site=="Cushing Bridge") #0
tetra_cush<-subset(inverts, Taxa=="Tetragnathidae" & Site=="Cushing Bridge") #3
aran_cush<-subset(inverts, Taxa=="Araneidae" & Site=="Cushing Bridge") #3
perl_cush<-subset(inverts, Taxa=="Perlidae" & Site=="Cushing Bridge") #0
chloro_cush<-subset(inverts, Taxa=="Chloroperlidae" & Site=="Cushing Bridge") #3
rhya_cush<-subset(inverts, Taxa=="Rhyacophilidae" & Site=="Cushing Bridge") #1
coleop_cush<-subset(inverts, Taxa=="Coleoptera" & Site=="Cushing Bridge") #0
hep_cush<-subset(inverts, Taxa=="Heptageniidae" & Site=="Cushing Bridge") #3
biofilm_cush<-subset(isotope, Taxa=="Biofilm" & Site=="Cushing Bridge") #3
leaves_cush<-subset(isotope, Taxa=="Terrestrial Leaves" & Site=="Cushing Bridge") #3


#### Graves Bridge ####

#FFG

filt_collec_grvbr<-subset(inverts, Site=="Graves Bridge" & FFG=="Filterer-Collector") #6

gath_collec_grvbr<-subset(inverts, Site=="Graves Bridge" & FFG=="Gatherer-Collector") #10

piercer_grvbr<-subset(inverts, Site=="Graves Bridge" & FFG=="Piercer") #3

scraper_grvbr<-subset(inverts, Site=="Graves Bridge" & FFG=="Scraper") #4

pred_grvbr<-subset(inverts, Site=="Graves Bridge" & FFG=="Predator") #16

#Family

hydro_grvbr<-subset(inverts, Taxa=="Hydropsychidae" & Site=="Graves Bridge") #6
ephem_grvbr<-subset(inverts, Taxa=="Ephemerellidae" & Site=="Graves Bridge") #6
chiro_grvbr<-subset(inverts, Taxa=="Chironomidae" & Site=="Graves Bridge") #4
lepto_grvbr<-subset(inverts, Taxa=="Leptoceridae" & Site=="Graves Bridge") #0
lepidop_grvbr<-subset(inverts, Taxa=="Lepidoptera" & Site=="Graves Bridge") #3
tetra_grvbr<-subset(inverts, Taxa=="Tetragnathidae" & Site=="Graves Bridge") #3
aran_grvbr<-subset(inverts, Taxa=="Araneidae" & Site=="Graves Bridge") #3
perl_grvbr<-subset(inverts, Taxa=="Perlidae" & Site=="Graves Bridge") #0
chloro_grvbr<-subset(inverts, Taxa=="Chloroperlidae" & Site=="Graves Bridge") #6
rhya_grvbr<-subset(inverts, Taxa=="Rhyacophilidae" & Site=="Graves Bridge") #1
coleop_grvbr<-subset(inverts, Taxa=="Coleoptera" & Site=="Graves Bridge") #3
hep_grvbr<-subset(inverts, Taxa=="Heptageniidae" & Site=="Graves Bridge") #4
biofilm_grvbr<-subset(isotope, Taxa=="Biofilm" & Site=="Graves Bridge") #3
leaves_grvbr<-subset(isotope, Taxa=="Terrestrial Leaves" & Site=="Graves Bridge") #3



#### Policeman Flats ####

#FFG

filt_collec_pmf<-subset(inverts, Site=="Policeman Flats" & FFG=="Filterer-Collector") #6

gath_collec_pmf<-subset(inverts, Site=="Policeman Flats" & FFG=="Gatherer-Collector") #11

piercer_pmf<-subset(inverts, Site=="Policeman Flats" & FFG=="Piercer") #3

scraper_pmf<-subset(inverts, Site=="Policeman Flats" & FFG=="Scraper") #4

pred_pmf<-subset(inverts, Site=="Policeman Flats" & FFG=="Predator") #12


#Family

hydro_pmf<-subset(inverts, Taxa=="Hydropsychidae" & Site=="Policeman Flats") #6
ephem_pmf<-subset(inverts, Taxa=="Ephemerellidae" & Site=="Policeman Flats") #5
chiro_pmf<-subset(inverts, Taxa=="Chironomidae" & Site=="Policeman Flats") #3
lepto_pmf<-subset(inverts, Taxa=="Leptoceridae" & Site=="Policeman Flats") #3
lepidop_pmf<-subset(inverts, Taxa=="Lepidoptera" & Site=="Policeman Flats") #3
tetra_pmf<-subset(inverts, Taxa=="Tetragnathidae" & Site=="Policeman Flats") #3
aran_pmf<-subset(inverts, Taxa=="Araneidae" & Site=="Policeman Flats") #3
perl_pmf<-subset(inverts, Taxa=="Perlidae" & Site=="Policeman Flats") #4
chloro_pmf<-subset(inverts, Taxa=="Chloroperlidae" & Site=="Policeman Flats") #0
rhya_pmf<-subset(inverts, Taxa=="Rhyacophilidae" & Site=="Policeman Flats") #1
coleop_pmf<-subset(inverts, Taxa=="Coleoptera" & Site=="Policeman Flats") #1
hep_pmf<-subset(inverts, Taxa=="Heptageniidae" & Site=="Policeman Flats") #4
biofilm_pmf<-subset(isotope, Taxa=="Biofilm" & Site=="Policeman Flats") #3
leaves_pmf<-subset(isotope, Taxa=="Terrestrial Leaves" & Site=="Policeman Flats") #3
```

# Preliminary data checks (carbonates/lipid effect)

```{r}
#### Carbonate effect ####

ggplot(isotope, aes(x=X.C, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks like there's a negative relationship between %C and d13C indicating no carbonates (inorganic carbon) in the samples since the correlation should be positive if there was an effect (Brian Hayden)

#Mostly an issue for biofilm so we will look at those samples individually
biofilm<-filter(isotope, Taxa=="Biofilm")

ggplot(biofilm, aes(x=X.C, y=d13C))+ 
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#No effect of carbonates. Seems like there is one data point driving the others. 


#### Lipid effect ####
#We only look at inverts since plants don't have much lipid
inverts<-subset(isotope, Tissue.Type=="Whole Invertebrate")

ggplot(inverts, aes(x=C.N, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks depleted across all sites. Could potentially be an issue.

ggplot(inverts, aes(x=Taxa, y=C.N))+
  geom_boxplot()+
  geom_hline(aes(yintercept=4), colour="red")

#Could potentially indicate a lipid effect since C:N ratio shouldn't be above 3.5 but if we correct it, it won't make a difference since all the insects besides spiders are at approximately the same level. This is usually more of an issue in fattier animals such as fish.  

#### Plotting biofilm duplicates with high variability ####


rawdata<-read.csv("C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\Isotopes\\SIN Lab Data\\Stable_Isotope_Raw_Data.csv")

biofilm_raw<-filter(rawdata, Tissue_Type=="Biofilm") #34 obs 

#Remove the HCl treated samples since those did not differ in C values from the non-treated ones

biofilm_raw_no_HCl<-filter(biofilm_raw, Notes!="Acid treated") #17 obs 

biofilm_raw_no_HCl$Site <-factor(biofilm_raw_no_HCl$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

#plotting variation in carbon values in replicates and duplicates

ggplot(biofilm_raw_no_HCl, aes(x=Site, y=d13C, label=SampleName))+ 
  geom_point()+
 geom_text(hjust=-0.1)+
  theme_bw()

#plotting variation in nitrogen values in replicates and duplicates
  
ggplot(biofilm_raw_no_HCl, aes(x=Site, y=d15N, label=SampleName))+ 
  geom_point()+
 geom_text(hjust=-0.1)+
  theme_bw()

```

# Biplots of individual data points

```{r}
# d13C vs d15N at all sites
ggplot(isotope, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()+
  facet_grid(.~Site)

# Sites plotted individually
Cochrane<-filter(isotope, Site=="Cochrane")
ggplot(Cochrane, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Sunalta<-filter(isotope, Site=="Sunalta")
ggplot(Sunalta, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()

Cushbr<-filter(isotope, Site=="Cushing Bridge")
ggplot(Cushbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Grvbr<-filter(isotope, Site=="Graves Bridge")
ggplot(Grvbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs and biofilm are high in nitrogen as well as invertebrates. Biofilm is variable on the x axis.

Polflt<-filter(isotope, Site=="Policeman Flats")
ggplot(Polflt, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs still high in nitrogen but biofilm is not. All taxa are very variable on both x and y axes. 
```

# Biplots of averaged /median data

```{r}

#Summarizing a dataframe with mean and sd C and N values

data.sum<-ddply(isotope, c("Site_Code", "Taxa", "FFG"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

#All sites together

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme_classic()

#Sites faceted

data.sum$Taxa<-factor(data.sum$Taxa, levels= c("Terrestrial Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"), labels=c("Riparian Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"))

data.sum$Site_Code<-factor(data.sum$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type", shape="Functional Feeding Group")+
  rremove("grid")


#ggsave(filename="stable_isotope_analysis/Figures/Mean SD biplot d13C d15N faceted by site.png", height=7, width=12)



data.sum.1<-ddply(isotope, c("Site_Code", "Taxa"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims.1<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims.1<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

data.sum.1$Aqu_Terr<-factor(data.sum.1$Aqu_Terr, levels=c("Biofilm", "Riparian Leaves", "Aquatic Larvae", "Aquatic Adults", "Terrestrial Prey", "Spiders"), labels=c("Biofilm", "Riparian leaves", "Aquatic larval insects", "Aquatic adult insects", "Terrestrial adult insects", "Spiders"))

data.sum.1$Site_Code<-factor(data.sum.1$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))


ggplot(data.sum.1, aes(x=d13Cmn, y=d15Nmn, colour=Taxa))+
  geom_point(size=3)+
  geom_errorbar(Ylims.1, width=0.2)+
  geom_errorbarh(Xlims.1, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type")+
  rremove("grid")

```

# N across sites {.tabset}

## ANOVA/Kruskal tests across sample types
```{r}
#### N plot across sites ####

N_plot<-ggplot(isotope, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black"))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~Aqu_Terr, scales="free_x")
N_plot

#ggsave(filename="Stable_isotope_ED/Figures/Nitrogen enrichment of basal food source and organisms across sites no terrestrial prey.png", height=7, width=12)

colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

isotope$Taxa<-factor(isotope$Taxa, levels=c("Biofilm", "Terrestrial Leaves", "Heptageniidae", "Hydropsychidae", "Chironomidae", "Ephemerellidae", "Leptoceridae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Rhyacophilidae", "Coleoptera", "Araneidae", "Tetragnathidae"))

isotope$FFG<-factor(isotope$FFG, levels=c("Basal food source", "Scraper", "Filterer-Collector", "Gatherer-Collector", "Piercer", "Predator"))

isotope$Site_Code<-factor(isotope$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

N_plot_taxa<-ggplot(isotope, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), strip.text.x = element_text(size=16), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Taxa, scales="free_x", nrow=1)
N_plot_taxa

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\Nitrogen enrichment of taxa and FFG across sites.png", height=10, width=26)

isotope_subset<-subset(isotope, Taxa!="Perlidae" & Taxa!="Coleoptera" & Taxa!="Leptoceridae")

isotope_subset$Taxa<-factor(isotope_subset$Taxa, levels=c("Biofilm", "Terrestrial Leaves", "Heptageniidae", "Hydropsychidae", "Chironomidae", "Ephemerellidae", "Lepidoptera", "Chloroperlidae", "Rhyacophilidae", "Araneidae", "Tetragnathidae"))

isotope_subset$FFG<-factor(isotope_subset$FFG, levels=c("Basal food source", "Scraper", "Filterer-Collector", "Gatherer-Collector", "Piercer", "Predator"))

isotope_subset$Site_Code<-factor(isotope_subset$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

N_plot_taxa_subset<-ggplot(isotope_subset, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope_subset$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Taxa, scales="free_x", nrow=1)
N_plot_taxa_subset

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\Nitrogen enrichment of taxa and FFG across sites subset.png", height=10, width=26)



#### Riparian Leaves (Shrub) ####
shrub<-subset(isotope, Stage=="Shrub")
shrub_d15N_plot<-ggplot(shrub, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
shrub_d15N_plot

shapiro.test(shrub$d15N) #normal
hist(shrub$d15N) #Normal dist.

summary(shrublm1<-aov(d15N~Site, data=shrub)) #F(4,10) = 9.23, p = 0.0022
emmeans(shrublm1, specs = pairwise~Site)
#GRVBR diff from COCH
#PMF diff from COCH

#### Biofilm ####
biofilm<-subset(isotope, Taxa=="Biofilm")
biofilm_d15N_plot<-ggplot(biofilm, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
biofilm_d15N_plot

hist(biofilm$d15N) #Normal -ish distribution
shapiro.test(biofilm$d15N) #Normal dist. 
library(car)
leveneTest(d15N~Site, data=biofilm) #homogeneity

summary(biofilm1<-aov(d15N~Site, data=biofilm)) #F(4,10) = 1.17, p=0.379
emmeans(biofilm1, specs = pairwise~Site)
#No diff. 

#Do we get a different result if we use a non-parametric test? No, there are still no differences.
kruskal.test(d15N~Site, data=biofilm) #p=0.2642
dunnTest(d15N~Site, data=biofilm)
#No diff


#### Aquatic larvae ####
aq_lar<-subset(isotope, Aqu_Terr=="Aquatic Larvae")
shapiro.test(aq_lar$d15N) #normal dist. 
hist(aq_lar$d15N) 

summary(aq_lar_lm<-aov(d15N~Site, data=aq_lar)) #F(4,49) = 18.5, p < 0.001
emmeans(aq_lar_lm, specs = pairwise ~ Site)
#GRVBR different from all other sites

#### Aquatic adults ####
aq_ad<-subset(isotope, Aqu_Terr=="Aquatic Adults")
shapiro.test(aq_ad$d15N) #normal dist. 
hist(aq_ad$d15N) 

summary(aq_ad_lm<-aov(d15N~Site, data=aq_ad)) #F(4,50) = 7.9, p < 0.001
emmeans(aq_ad_lm, specs = pairwise ~ Site)
#GRVBR different from all other sites

#### Terrestrial Adults ####
terr_ad<-subset(isotope, Aqu_Terr=="Terrestrial Prey")
shapiro.test(terr_ad$d15N) #normal dist. 
hist(terr_ad$d15N) 

summary(terr_ad_lm<-aov(d15N~Site, data=terr_ad)) #F(3,12) = 2.62, p=0.099
emmeans(terr_ad_lm, specs = pairwise ~ Site) 
#No differences across sites

#See if non-parametric test gives the same result

kruskal.test(data=terr_ad, d15N ~ Site) #p=0.405
dunnTest(data=terr_ad, d15N ~ Site)
#No differences across sites

#### Spiders ####
spiders<-subset(isotope, Aqu_Terr=="Spiders")
shapiro.test(spiders$d15N) #not normal dist. 
hist(spiders$d15N) 
leveneTest(d15N~Site, data=spiders) #homogeneity

summary(spi_lm<-aov(d15N~Site, data=spiders)) #F(4,25) = 48.1, p<0.001
emmeans(spi_lm, specs = pairwise ~ Site) 
#GRVBR different from all other sites

kruskal.test(d15N~Site, data=spiders) #p=0.0054
dunnTest(d15N~Site, data=spiders)
#GRVBR different from all other sites


#### Plotting basal food sources, Hydropsychidae, and spiders across sites ####


colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

hydro_subset<-subset(isotope, Taxa == "Tetragnathidae" | Taxa== "Araneidae" | Taxa=="Terrestrial Leaves" | Taxa=="Hydropsychidae" | Taxa=="Biofilm")

hydro_subset$Taxa <- factor(hydro_subset$Taxa, levels=c("Terrestrial Leaves", "Biofilm", "Hydropsychidae", "Araneidae", "Tetragnathidae"))

hydro_subset$Site_Code <- factor(hydro_subset$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

N_plot_hydro<-ggplot(hydro_subset, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.title.x = element_text(size=18), axis.text.x=element_text(angle=45, hjust=1, size=16, color="black", face=colorado(hydro_subset$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_wrap(~Aqu_Terr+Taxa, scales="free_x", nrow=1)
N_plot_hydro

#ggsave(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Conferences and Presentations\\Graduate Research Day 2024\\nitrogen_across_taxa.png", height=7, width=12)
```

## ANOVA/Kruskal tests across individual invertebrate families
```{r}

#Remove Perlidae, Leptoceridae, Coleoptera because there aren't enough sites to compare for those inverts.

isotope_subset<-subset(isotope, Taxa!= "Perlidae" & Taxa!= "Leptoceridae" & Taxa!= "Coleoptera") 

library(car)
shapiro.test(isotope_subset$d15N)  #Not normal, p = 0.01. 
leveneTest(data=isotope_subset, d15N~Site*Taxa) #homogeneity p = 0.633
hist(isotope_subset$d15N) #looks normal

#Parametric test

summary(N_all_taxa<-aov(data=isotope_subset, d15N~Site*Taxa))
emmeans(N_all_taxa, pairwise ~ Site | Taxa)
plot(N_all_taxa) #Not normal but other plots look good

#Non-parametric test

if(!require(psych)){install.packages("psych")}
if(!require(FSA)){install.packages("FSA")}
if(!require(lattice)){install.packages("lattice")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(ordinal)){install.packages("ordinal")}
if(!require(car)){install.packages("car")}
if(!require(RVAideMemoire)){install.packages("RVAideMemoire")}
if(!require(rcompanion)){install.packages("rcompanion")}
if(!require(multcomp)){install.packages("multcomp")}
if(!require(emmeans)){install.packages("emmeans")}

isotope_subset$Likert = factor(isotope_subset$d15N, ordered = TRUE)

xtabs( ~ Taxa + Likert, data = isotope_subset)

xtabs( ~ Site + Likert, data = isotope_subset)

xtabs( ~ Taxa + Likert + Site, data = isotope_subset)


Summarize(d15N ~ Site,
          data=isotope_subset,
          digits=3)

Summarize(d15N ~ Taxa,
          data=isotope_subset,
          digits=3)

Summarize(d15N ~ Site + Taxa,
          data=isotope_subset,
          digits=3)


isotope_subset$Site<-factor(isotope_subset$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

Sum = Summarize(d15N ~ Site + Taxa,
                data=isotope_subset,
                digits=3)


pd = position_dodge(.2)

ggplot(Sum, aes(x=Taxa,
                y=median,
                color=Site)) +
    geom_errorbar(aes(ymin=Q1,
                      ymax=Q3),
                   width=.2, linewidth=0.7, position=pd) +
    geom_point(shape=15, size=4, position=pd) +
    theme_bw() +
    theme(axis.title = element_text(face = "bold"))+
    ylab("Median Likert score")

#Two-way ordinal regression


model = clm(Likert ~ Site + Taxa + Site:Taxa,
            data = isotope_subset,
            threshold="symmetric")

anova(model, type="3") #All significant


marginal = emmeans(model, ~ Site | Taxa)

ord_reg<-as.data.frame(pairs(marginal, adjust="tukey"))


#Testing assumptions
nominal_test(model)

scale_test(model)


#Regression with a Skew-Normal distribution

install.packages("sn")
library(sn)
fit_sn <- sn.mle(y = isotope_subset)



#### Araneidae ####
araneidae<-subset(inverts, Taxa=="Araneidae")
ggplot(araneidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge. 

shapiro.test(araneidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=araneidae) #p=0.061. Probably due to small sample size
dunnTest(d15N~Site, data=araneidae)
#GRVBR - PMF p=0.034

#### Tetragnathidae ####
tetragnathidae<-subset(inverts, Taxa=="Tetragnathidae")
ggplot(tetragnathidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge.

shapiro.test(tetragnathidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=tetragnathidae) #p=0.136
dunnTest(d15N~Site, data=tetragnathidae)
#No diff, probably because of the small sample size. 


#### Hydropsychidae ####

#Larvae

hydro_lar<-subset(isotope, Taxa_num=="2" & Stage=="Larvae")
hydro_lar_d15N_plot<-ggplot(hydro_lar, aes(x=factor(Site, labels=c("COCH", "SUN", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))

hydro_lar_d15N_plot

shapiro.test(hydro_lar$d15N)  #Not normal
hist(hydro_lar$d15N) #not normal looking dist

kruskal.test(d15N~Site, data=hydro_lar) #p=0.052
dunnTest(d15N~Site, data=hydro_lar)
#only diff btw graves bridge and sunalta

#Adults

hydro_ad<-subset(inverts, Taxa_num=="2" & Stage=="Adult")
hydro_ad_d15N_plot<-ggplot(hydro_ad, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
hydro_ad_d15N_plot

shapiro.test(hydro_ad$d15N)  #Not normal
hist(log(hydro_ad$d15N)) #normal looking dist.

kruskal.test(d15N~Site, data=hydro_ad) #p=0.044
dunnTest(d15N~Site, data=hydro_ad)
#Diff btw GRVBR - PMF


#### Heptageniidae ####
#Larvae
larhep<-filter(inverts, Taxa=="Heptageniidae" & Stage=="Larvae")
ggplot(larhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Graves Bridge is much higher in d15N

shapiro.test(larhep$d15N)  #Normal
hist(larhep$d15N) #normal looking dist.

summary(hep_lm1<-lm(d15N~Site, data=larhep))
emmeans(hep_lm1, specs = pairwise ~ Site)
#Diff btw:
#COCH - GRVBR
#COCH - PMF
#SUN - GRVBR
#SUN - PMF
#CUSHBR - GRVBR
#CUSHBR - PMF
#GRVBR - PMF


#Adults
adhep<-filter(inverts, Taxa=="Heptageniidae" &  Stage=="Adult")
ggplot(adhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

#Not a large enough sample size to run stats

#### Chironomidae ####
#Larvae
larchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Larvae")
ggplot(larchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not a large enough sample size to run stats

#Adult
adchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Adult")
ggplot(adchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough to really compare at Graves Bridge but might not be significantly higher than the other sites

#### Chloroperlidae ####
#larvae
larchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Larvae")

ggplot(larchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

shapiro.test(larchloro$d15N)  #Normal
hist(larchloro$d15N) #Not normal looking.

summary(chloro_lm1<-lm(d15N~Site, data=larchloro))
emmeans(chloro_lm1, specs = pairwise ~ Site)
#SUN - GRVBR p=0.0006
#CUSHBR - GRVBR p < 0.001

#adults
adchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Adult")
ggplot(adchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough samples for statistical comparison

#### Perlidae ####

#larvae
larchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Larvae")

ggplot(larchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

shapiro.test(larchloro$d15N)  #Normal
hist(larchloro$d15N) #Not normal looking.

summary(chloro_lm1<-lm(d15N~Site, data=larchloro))
emmeans(chloro_lm1, specs = pairwise ~ Site)
#SUN - GRVBR p=0.0006
#CUSHBR - GRVBR p < 0.001

#adults
adchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Adult")
ggplot(adchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough samples for statistical comparison

#### Ephemerellidae ####
#Larvae
larephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Larvae")
ggplot(larephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

shapiro.test(larephem$d15N)  #Normal
hist(larephem$d15N) #Not normal looking.

kruskal.test(d15N~Site, data=larephem) #p=0.066
dunnTest(d15N~Site, data=larephem) #no diff

#Adults
adephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Adult")
ggplot(adephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

#Not enough samples to run stats



```

# C across sites

```{r}
#### C plot across sites ####

colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

isotope$Taxa<-factor(isotope$Taxa, levels=c("Biofilm", "Terrestrial Leaves", "Heptageniidae", "Hydropsychidae", "Chironomidae", "Ephemerellidae", "Leptoceridae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Rhyacophilidae", "Coleoptera", "Araneidae", "Tetragnathidae"))

isotope$FFG<-factor(isotope$FFG, levels=c("Basal food source", "Scraper", "Filterer-Collector", "Gatherer-Collector", "Piercer", "Predator"))

isotope$Site_Code<-factor(isotope$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

C_plot_taxa<-ggplot(isotope, aes(x=Site_Code, y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), strip.text.x = element_text(size=16), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  #ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Taxa, scales="free_x", nrow=1)
C_plot_taxa

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\Carbon across taxa,FFG and sites.png", height=10, width=26)

isotope_subset<-subset(isotope, Taxa!="Perlidae" & Taxa!="Leptoceridae" & Taxa!="Coleoptera")

isotope_subset$Taxa<-factor(isotope_subset$Taxa, levels=c("Biofilm", "Terrestrial Leaves", "Heptageniidae", "Hydropsychidae", "Chironomidae", "Ephemerellidae", "Lepidoptera", "Chloroperlidae","Rhyacophilidae", "Araneidae", "Tetragnathidae"))

isotope_subset$FFG<-factor(isotope_subset$FFG, levels=c("Basal food source", "Scraper", "Filterer-Collector", "Gatherer-Collector", "Piercer", "Predator"))

isotope_subset$Site_Code<-factor(isotope_subset$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

C_plot_taxa_subset<-ggplot(isotope_subset, aes(x=Site_Code, y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope_subset$Site_Code, c("GRVBR", "PMF"))))+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Taxa, scales="free_x", nrow=1)
C_plot_taxa_subset

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\Carbon across taxa, FFG and sites subset.png", height=10, width=26)



#### Testing for differences in invertebrate groups ####

# Aquatic Larvae
larvae<-subset(isotope, Aqu_Terr=="Aquatic Larvae")

ggplot(larvae, aes(x=Taxa, y=d13C))+
  geom_boxplot()+
  facet_grid(~Site)

shapiro.test(larvae$d13C) #Normal dist. p =0.098
leveneTest(d13C~Taxa, data=larvae) #p=0.10

with(larvae,
     table(Taxa, Site)) #Unbalanced, need to use Type 2 or 3 ANOVA from car package

library(car)

larvae_C<-aov(d13C~Taxa*Site, data=larvae) 
Anova(larvae_C, type=2) #p<0.001 for Taxa and for Site but not their interaction
emmeans(larvae_C, pairwise ~ Taxa | Site) #Some differences between larvae at Policeman Flats

emmeans(larvae_C, pairwise ~ Site | Taxa) #most larvae have similar trends between sites (Policeman Flats and Graves Bridge have higher carbon isotope values) but not all taxa are the same


# Aquatic Adults
aqu_adults<-subset(isotope, Aqu_Terr=="Aquatic Adults")

ggplot(aqu_adults, aes(x=Taxa, y=d13C))+
  geom_boxplot()+
  facet_grid(~Site)

shapiro.test(aqu_adults$d13C) #Normal dist. p =0.372
leveneTest(d13C~Taxa, data=aqu_adults) #p=0.209

with(aqu_adults, table(Taxa, Site)) #Unbalanced, need to use Type 2 or 3 ANOVA from car package

aqu_adults_C<-aov(d13C~Taxa*Site, data=aqu_adults) 
Anova(aqu_adults_C, type=2) #p<0.001 for Site but not Taxa or their interaction
emmeans(aqu_adults_C, pairwise ~ Taxa | Site) #No differences between taxa at any site. Can combine them.

emmeans(aqu_adults_C, pairwise ~ Site | Taxa) #Seems like only Hydropsychidae has changes in carbon across sites...maybe shouldn't combine them


# Terrestrial Adults
terr_adults<-subset(isotope, Aqu_Terr=="Terrestrial Prey")

ggplot(terr_adults, aes(x=Taxa, y=d13C))+
  geom_boxplot()+
  facet_grid(~Site)

shapiro.test(terr_adults$d13C) #Normal dist. p =0.419
leveneTest(d13C~Taxa, data=terr_adults) #p=0.33

with(terr_adults, table(Taxa, Site)) #Unbalanced, need to use Type 2 or 3 ANOVA from car package

terr_adults_C<-aov(d13C~Taxa*Site, data=terr_adults) 
Anova(terr_adults_C, type=2) #No differences
emmeans(terr_adults_C, pairwise ~ Taxa | Site) #No differences between taxa at any site. Can combine them.

emmeans(terr_adults_C, pairwise ~ Site | Taxa) #No differences between sites


# Spiders
spiders<-subset(isotope, Aqu_Terr=="Spiders")

ggplot(spiders, aes(x=Taxa, y=d13C))+
  geom_boxplot()+
  facet_grid(~Site)

shapiro.test(spiders$d13C) #Normal dist. p =0.27
leveneTest(d13C~Taxa, data=spiders) #p=0.43

with(spiders, table(Taxa, Site)) #Balanced, can use type 1 anova

spiders_C<-aov(d13C~Taxa*Site, data=spiders) 
emmeans(spiders_C, pairwise ~ Taxa | Site) #No differences between spiders at any site. Can combine them.

emmeans(spiders_C, pairwise ~ Site | Taxa) #Both spiders show the same trend across sites

# Plotting all samples grouped by sample type #

colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

isotope$Aqu_Terr<-factor(isotope$Aqu_Terr, levels=c("Biofilm", "Riparian Leaves", "Aquatic Larvae", "Aquatic Adults", "Terrestrial Prey", "Spiders"), labels=c("Biofilm", "Riparian leaves", "Aquatic larval insects", "Aquatic adult insects", "Terrestrial adult insects", "Spiders"))

isotope$Site_Code<-factor(isotope$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))


C_plot<-ggplot(isotope, aes(x=Site_Code, y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black"))+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~Aqu_Terr, scales="free_x")
C_plot


isotope$Aqu_Terr<-factor(isotope$Aqu_Terr, levels=c("biofilm", "Leaves", "lar_aquatic", "Ad_aquatic", "Terrestrial", "Spider"), labels = c("Biofilm", "Riparian Leaves", "Aquatic Larval Insects", "Aquatic Adult Insects", "Terrestrial Adult Insects", "Spiders"))
isotope$Site_Code<-factor(isotope$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))
isotope$Taxa<-factor(isotope$Taxa, levels=c("Biofilm", "Terrestrial Leaves", "Chironomidae", "Chloroperlidae", "Coleoptera", "Ephemerellidae", "Heptageniidae", "Hydropsychidae", "Lepidoptera", "Leptoceridae", "Perlidae", "Rhyacophilidae", "Araneidae", "Tetragnathidae"))

ggplot(isotope, aes(x=Site_Code, y=d13C, fill=Taxa))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black"))+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~Aqu_Terr, scales="free_x")


#### Riparian Leaves ####
shrub<-subset(isotope, Stage=="Shrub")
shapiro.test(shrub$d13C) #normal
hist(shrub$d13C) #Normal dist.
leveneTest(d13C~Site, data=shrub) #homogeneity

with(shrub, table(Site)) #Balanced

summary(shrublm1<-aov(d13C~Site, data=shrub)) #F(4,10) = 1.34, p = 0.323 no diff.
emmeans(shrublm1, specs = pairwise~Site) # no differences across sites

#### Biofilm ####
biofilm<-subset(isotope, Taxa=="Biofilm")
hist(biofilm$d13C) #Normal -ish distribution
shapiro.test(biofilm$d13C) #Normal dist. p =0.06
leveneTest(d13C~Site, data=biofilm) #homogeneity

with(biofilm, table(Site)) #Balanced

summary(biofilm1<-aov(d13C~Site, data=biofilm)) #F(4,10) = 7.59, p=0.00445
plot(biofilm1) #Doesn't fit linear assumptions very well. But the results match the data more closely using ANOVA...
emmeans(biofilm1, specs = pairwise~Site)
#COCH - PMF
#SUN - PMF
#CUSH - PMF


logC<- log1p(biofilm$d13C - min(biofilm$d13C))
biofilm<-cbind(logC, biofilm)
summary(biofilm2<-aov(logC~Site, data=biofilm)) #p=0.000202
plot(biofilm1)
emmeans(biofilm2, specs = pairwise~Site)
#COCH - PMF
#SUN - PMF
#PMF - CUSHBR
#PMF - GRVBR

sqrtC <- sqrt(abs(biofilm$d13C))
biofilm<-cbind(sqrtC, biofilm)
summary(biofilm3<-aov(sqrtC~Site, data=biofilm)) #p=0.0066
plot(biofilm3)
emmeans(biofilm3, specs = pairwise~Site)
#SUN - PMF
#CUSHBR - PMF


kruskal.test(data=biofilm, d13C ~ Site) #p=0.033
dunnTest(data=biofilm, d13C ~ Site)
#CUSHBR - PMF


#### Aquatic larvae ####

aq_lar<-subset(isotope, Aqu_Terr=="Aquatic Larval Insects")
shapiro.test(aq_lar$d13C) #normal dist. 
hist(aq_lar$d13C) 
leveneTest(d13C~Site, data=aq_lar) #homogeneity

with(aq_lar, table(Taxa, Site)) #Unbalanced, use type 2 or 3 anova

aq_lar_lm<-aov(d13C~Site, data=aq_lar) 
Anova(aq_lar_lm, type=2) #F(4,49) = 11.8, p < 0.001
plot(aq_lar_lm)
emmeans(aq_lar_lm, specs = pairwise ~ Site)
#COCH - SUN
#COCH - GRVBR
#COCH - PMF
#SUN - PMF
#CUSHBR - PMF
#GRVBR - PMF

#### Aquatic Adults ####

aq_ad<-subset(isotope, Aqu_Terr=="Aquatic adult insects")
shapiro.test(aq_ad$d13C) #normal dist. 
hist(aq_ad$d13C) 
leveneTest(d13C~Site, data=aq_ad) #homogeneity

summary(aq_ad_aov<-aov(d13C~Site, data=aq_ad)) #F(4,50) = 10.6, p<0.001
plot(aq_ad_aov)
emmeans(aq_ad_aov, specs = pairwise ~ Site)
#COCH - GRVBR
#COCH - PMF
#SUN - GRVBR
#SUN - PMF
#CUSH - PMF

#### Terrestrial Insects ####

terr_ad<-subset(isotope, Aqu_Terr=="Terrestrial adult insects")
shapiro.test(terr_ad$d13C) #normal dist. p=0.419
hist(terr_ad$d13C) 
leveneTest(d13C~Site, data=terr_ad) #homogeneity

summary(terr_ad_aov<-aov(d13C~Site, data=terr_ad)) #F(3,12)=4.50, p=0.0247
emmeans(terr_ad_aov, specs = pairwise ~ Site)
#SUN - GRVBR
#SUN - PMF

#### Spiders ####

spiders<-subset(isotope, Aqu_Terr=="Spiders")
shapiro.test(spiders$d13C) #Normal 
hist(spiders$d13C) 
leveneTest(d13C~Site, data=spiders) #homogeneity

summary(spiders_lm<-aov(d13C~Site, data=spiders)) #F(4,25) = 43.3, p<0.001
emmeans(spiders_lm, specs = pairwise ~ Site)
#COCH diff from all other sites
#SUN - GRVBR
#SUN - PMF
#CUSHBR - GRVBR
#CUSHBR - PMF

#PMF and GRVBR different from all sites except each other

```

# Food source reliance graph

```{r}

isotope_subset<-subset(isotope, FFG!="Basal food source")%>%
  dplyr::select("Site_Code", "Taxa","d13C", "FFG")%>%
  group_by(Site_Code, Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

Ylims<-aes(ymax=MeanC +sdC, ymin=MeanC-sdC)

isotope_subset$Site_Code<-factor(isotope_subset$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

ggplot(isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  facet_grid(~Site_Code)+
  theme_bw() +
  rremove("grid")+
  geom_errorbar(Ylims)+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_blank(), axis.ticks.x = element_blank(), axis.title = element_text(size=18, color="black"))+
  ylim(-33, -6)


# Cochrane #

coch_biofilm<-subset(biofilm, Site=="COCH")
mean(coch_biofilm$d13C) #-14.57

coch_shrub<-subset(shrub, Site=="Cochrane")
mean(coch_shrub$d13C) #-29.07

cochrane_isotope_subset<-subset(isotope, Site=="COCH" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))
View(cochrane_isotope_subset) 

Ylims<-aes(ymax=MeanC +sdC, ymin=MeanC-sdC)

coch_food_source<-ggplot(cochrane_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -14.57, linetype = 2, color = "red")+
  geom_hline(yintercept = -29.07, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))

# Sunalta #

sun_biofilm<-subset(biofilm, Site=="SUN")
mean(sun_biofilm$d13C) #-13.23

sun_shrub<-subset(shrub, Site=="Sunalta")
mean(sun_shrub$d13C) #-28.4

sunalta_isotope_subset<-subset(isotope, Site=="SUN" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))
View(sunalta_isotope_subset) 

sun_food_source<-ggplot(sunalta_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -13.23, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.4, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))


# Cushing Bridge #

cush_biofilm<-subset(biofilm, Site=="CUSHBR")
mean(cush_biofilm$d13C) #-8.47

cush_shrub<-subset(shrub, Site=="Cushing Bridge")
mean(cush_shrub$d13C) #-28.67

cush_isotope_subset<-subset(isotope, Site=="CUSHBR" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

cush_food_source<-ggplot(cush_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -8.47, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.67, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
cush_food_source


# Graves Bridge

grvbr_biofilm<-subset(biofilm, Site=="GRVBR")
mean(grvbr_biofilm$d13C) #-18.27

grvbr_shrub<-subset(shrub, Site=="Graves Bridge")
mean(grvbr_shrub$d13C) #-28.83

grvbr_isotope_subset<-subset(isotope, Site=="GRVBR" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

grvbr_food_source<-ggplot(grvbr_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -18.27, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.83, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
grvbr_food_source

# Policeman Flats

pmf_biofilm<-subset(biofilm, Site=="PMF")
mean(pmf_biofilm$d13C) #-25.7

pmf_shrub<-subset(shrub, Site=="Policeman Flats")
mean(pmf_shrub$d13C) #-27.52

pmf_isotope_subset<-subset(isotope, Site=="PMF" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

pmf_food_source<-ggplot(pmf_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -25.7, linetype = 2, color = "red")+
  geom_hline(yintercept = -27.52, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
pmf_food_source

#ggarrange(coch_food_source, sun_food_source, cush_food_source, grvbr_food_source, pmf_food_source, nrow=1)


#### Only primary consumers ####



```

# Combining C and N boxplot across sites 

```{r}
colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

isotope$Site<-factor(isotope$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

isotope$Site_Code<-factor(isotope$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

C_plot<-ggplot(isotope, aes(x=Site_Code, y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.text.y = element_text(size=18, color="black"), strip.text.x = element_text(size=18, color="black"), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site, c("GRVBR", "PMF"))))+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~ Aqu_Terr, scales="free_x")
C_plot

#ggsave(filename="stable_isotope_analysis/Figures/C across taxa groups and sites.png", height=10, width=18, bg="white")


N_plot<-ggplot(isotope, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.text.y = element_text(size=18, color="black"), strip.text.x = element_text(size=18, color="black"), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black",  face=colorado(isotope$Site, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~Aqu_Terr, scales="free_x")
N_plot

#ggsave(filename="stable_isotope_analysis/Figures/N across taxa groups and sites.png", height=10, width=18, bg="white")


C_plot_1<-C_plot_taxa_subset + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank())
N_plot_1<-N_plot_taxa_subset + theme(axis.title.x = element_blank())

C_N_combined<-ggarrange(C_plot_1, N_plot_1, nrow=2, ncol=1, align="v")

annotate_figure(C_N_combined, bottom = textGrob("Site", gp = gpar(cex = 1.6)))

#ggsave(filename="stable_isotope_analysis/Figures/C and N across taxa groups and sites subset.png", height=14, width=26, bg="white")
```

# Table of mean d13C and d15N values (+/- SD) across sites and sample type 

```{r}
C_N_sum_tab<-isotope %>% 
  dplyr::select("Aqu_Terr", "d13C", "d15N", "Site")%>%
  dplyr::group_by(Aqu_Terr, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(C_N_sum_tab)
```

# Running MixSIAR model

```{r}
#Running model with primary consumers and basal food sources

#Make sure the data is a comma delimited file because it gets very fussy about the file type
mix<-load_mix_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\primary_consumers.csv", 
                   iso_names=c("d13C","d15N"), 
                   factors=c("Site","Taxa"), 
                   fac_random=c(FALSE,FALSE), 
                   fac_nested = c(FALSE, FALSE),
                   cont_effects=NULL)

source<-load_source_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_sources.csv",
                         source_factors = "Site",
                         conc_dep = FALSE, 
                         data_type = "means",
                         mix)

discr<-load_discr_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_tef.csv", mix)

#isospace plot
plot_data(filename="isospace_plot", plot_save_pdf = F, plot_save_png = F, mix, source, discr)

#default uninformative/generalist prior (alpha=1)
plot_prior(alpha.prior = c(1), source)

#Informative prior
plot_prior(alpha.prior = c(0.5, 1), source)

#How do you know which weighting to use? Seems like the inverts consume a more terrestrial source so should I weight it higher?

#JAGS model file
model_filename<-"MixSIAR_model.txt"
resid_err<-TRUE
process_err<-TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)
output_options = list(summary_save = FALSE, summary_name = "summary_statistics.txt",
    sup_post = FALSE, plot_post_save_pdf = FALSE, plot_post_name = "posterior_density",
    sup_pairs = FALSE, plot_pairs_save_pdf = FALSE, plot_pairs_name = "pairs_plot", sup_xy
    = FALSE, plot_xy_save_pdf = FALSE, plot_xy_name = "xy_plot", gelman = TRUE, heidel =
    FALSE, geweke = TRUE, diag_save = FALSE, diag_name = "diagnostics.txt", indiv_effect =
    FALSE, plot_post_save_png = FALSE, plot_pairs_save_png = FALSE, plot_xy_save_png =
    FALSE, diag_save_ggmcmc = FALSE)

#Running real model with 'normal' chain length and burn-in.
run<-list(chainLength=100000, burn=50000, thin=50, chains=3, calcDIC=TRUE)
jags<-run_model(run, mix, source, discr, model_filename, alpha.prior = 1, resid_err, process_err)
output_JAGS(jags, mix, source, output_options)


#Running model with secondary consumers and primary consumers as the food source

```
