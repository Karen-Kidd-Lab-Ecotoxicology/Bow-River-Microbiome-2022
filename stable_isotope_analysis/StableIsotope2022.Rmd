---
title: "StableIsotope2022"
author: "Emilie Diesbourg"
date: "14/03/2023"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Loading packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
par(mar = c(1, 1, 1, 1))
```

```{r Packages/Data}
library(rjags)
library(MixSIAR)
library(plyr)
library(dplyr)
library(ggpubr)
library(ggplot2)
library(R2WinBUGS)
library(FSA)
library(splancs)
library(devtools)
library(emmeans)
library(vegan)
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", force=TRUE)
library(pairwiseAdonis)
library(ggpubr)


isotope<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022.csv")
isotope$Site<-factor(isotope$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

isotope$Aqu_Terr<-factor(isotope$Aqu_Terr, levels=c("Leaves", "biofilm", "lar_aquatic", "Ad_aquatic", "Terrestrial", "Spider"), labels=c("Riparian Leaves", "Biofilm", "Aquatic Larvae", "Aquatic Adults", "Terrestrial Prey", "Spiders"))

inverts<-subset(isotope, Tissue.Type=="Whole Invertebrate")
```

# Sample sizes

```{r}
#Larvae across sites
coch_lar<-subset(inverts, Site=="Cochrane" & Stage=="Larvae") #5
sun_lar<-subset(inverts, Site=="Sunalta" & Stage=="Larvae") #14
cushbr_lar<-subset(inverts, Site=="Cushing Bridge" & Stage=="Larvae") #6
grvbr_lar<-subset(inverts, Site=="Graves Bridge" & Stage=="Larvae") #15
pmf_lar<-subset(inverts, Site=="Policeman Flats" & Stage=="Larvae") #14

#Adults across sites
coch_ad<-subset(inverts, Site=="Cochrane" & Stage=="Adult") #12
sun_ad<-subset(inverts, Site=="Sunalta" & Stage=="Adult") #14
cushbr_ad<-subset(inverts, Site=="Cushing Bridge" & Stage=="Adult") #11
grvbr_ad<-subset(inverts, Site=="Graves Bridge" & Stage=="Adult") #18
pmf_ad<-subset(inverts, Site=="Policeman Flats" & Stage=="Adult")#14

#Spiders n = 3/family/site
```

# Preliminary data checks (carbonates/lipid effect)

```{r}
#### Carbonate effect ####

ggplot(isotope, aes(x=X.C, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks like there's a negative relationship between %C and d13C indicating no carbonates (inorganic carbon) in the samples since the correlation should be positive if there was an effect (Brian Hayden)

#Mostly an issue for biofilm so we will look at those samples individually
biofilm<-filter(isotope, Taxa=="Biofilm")

ggplot(biofilm, aes(x=X.C, y=d13C))+ 
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#No effect of carbonates. Seems like there is one data point driving the others. 


#### Lipid effect ####
#We only look at inverts since plants don't have much lipid
inverts<-subset(isotope, Tissue.Type=="Whole Invertebrate")

ggplot(inverts, aes(x=C.N, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks depleted across all sites. Could potentially be an issue.

ggplot(inverts, aes(x=Taxa, y=C.N))+
  geom_boxplot()+
  geom_hline(aes(yintercept=4), colour="red")

#Could potentially indicate a lipid effect since C:N ratio shouldn't be above 3.5 but if we correct it, it won't make a difference since all the insects besides spiders are at approximately the same level. This is usually more of an issue in fattier animals such as fish.  
```

# Biplots of individual data points

```{r}
# %C vs %N at all sites
ggplot(isotope, aes(x=X.C, y=X.N, color=Taxa, shape=Tissue.Type))+
  geom_point()+
  facet_grid(.~Site)

# d13C vs d15N at all sites
ggplot(isotope, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()+
  facet_grid(.~Site)

# Sites plotted individually
Cochrane<-filter(isotope, Site=="Cochrane")
ggplot(Cochrane, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Sunalta<-filter(isotope, Site=="Sunalta")
ggplot(Sunalta, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()

Cushbr<-filter(isotope, Site=="Cushing Bridge")
ggplot(Cushbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Grvbr<-filter(isotope, Site=="Graves Bridge")
ggplot(Grvbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs and biofilm are high in nitrogen as well as invertebrates. Biofilm is variable on the x axis.

Polflt<-filter(isotope, Site=="Policeman Flats")
ggplot(Polflt, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs still high in nitrogen but biofilm is not. All taxa are very variable on both x and y axes. 
```

# Biplots of averaged /median data

```{r}

#Summarizing a dataframe with mean and sd C and N values

data.sum<-ddply(isotope, c("Site_Code", "Taxa", "FFG"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

#All sites together

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme_classic()

#Sites faceted

data.sum$Taxa<-factor(data.sum$Taxa, levels= c("Terrestrial Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"), labels=c("Riparian Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"))

data.sum$Site_Code<-factor(data.sum$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type", shape="Functional Feeding Group")+
  rremove("grid")


#ggsave(filename="stable_isotope_analysis/Figures/Mean SD biplot d13C d15N faceted by site.png", height=7, width=12)



data.sum.1<-ddply(isotope, c("Site_Code", "Aqu_Terr"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims.1<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims.1<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

data.sum.1$Aqu_Terr<-factor(data.sum.1$Aqu_Terr, )


ggplot(data.sum.1, aes(x=d13Cmn, y=d15Nmn, colour=Aqu_Terr))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type", shape="Functional Feeding Group")+
  rremove("grid")

```

# N across sites {.tabset}

## ANOVA/Kruskal tests across sample types
```{r}
#### N plot across sites ####

N_plot<-ggplot(isotope, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black"))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~Aqu_Terr, scales="free_x")
N_plot

#ggsave(filename="Stable_isotope_ED/Figures/Nitrogen enrichment of basal food source and organisms across sites no terrestrial prey.png", height=7, width=12)
  

#### Riparian Leaves (Shrub) ####
shrub<-subset(isotope, Stage=="Shrub")
shrub_d15N_plot<-ggplot(shrub, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
shrub_d15N_plot

shapiro.test(shrub$d15N) #normal
hist(shrub$d15N) #Normal dist.

summary(shrublm1<-aov(d15N~Site, data=shrub))
emmeans(shrublm1, specs = pairwise~Site)
#GRVBR diff from COCH
#PMF diff from COCH

#### Biofilm ####
biofilm<-subset(isotope, Taxa=="Biofilm")
biofilm_d15N_plot<-ggplot(biofilm, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
biofilm_d15N_plot

hist(biofilm$d15N) #Normal -ish distribution
shapiro.test(biofilm$d15N) #Normal dist. 

summary(biofilm1<-aov(d15N~Site, data=biofilm)) #p=0.379
emmeans(biofilm1, specs = pairwise~Site)
#No diff. 

#Do we get a different result if we use a non-parametric test? No, there are still no differences.
kruskal.test(d15N~Site, data=biofilm) #p=0.2642
dunnTest(d15N~Site, data=biofilm)
#No diff


#### Aquatic larvae ####
aq_lar<-subset(isotope, Aqu_Terr=="Aquatic Larvae")
shapiro.test(aq_lar$d15N) #normal dist. 
hist(aq_lar$d15N) 

summary(aq_lar_lm<-aov(d15N~Site, data=aq_lar))
emmeans(aq_lar_lm, specs = pairwise ~ Site)
#GRVBR different from all other sites

#### Aquatic adults ####
aq_ad<-subset(isotope, Aqu_Terr=="Aquatic Adults")
shapiro.test(aq_ad$d15N) #normal dist. 
hist(aq_ad$d15N) 

summary(aq_ad_lm<-aov(d15N~Site, data=aq_ad))
emmeans(aq_ad_lm, specs = pairwise ~ Site)
#GRVBR different from all other sites

#### Terrestrial Adults ####
terr_ad<-subset(isotope, Aqu_Terr=="Terrestrial Prey")
shapiro.test(terr_ad$d15N) #normal dist. 
hist(terr_ad$d15N) 

summary(terr_ad_lm<-aov(d15N~Site, data=terr_ad)) #p=0.099
emmeans(terr_ad_lm, specs = pairwise ~ Site) 
#No differences across sites

#See if non-parametric test gives the same result

kruskal.test(data=terr_ad, d15N ~ Site) #p=0.405
dunnTest(data=terr_ad, d15N ~ Site)
#No differences across sites

#### Spiders ####
spiders<-subset(isotope, Aqu_Terr=="Spiders")
shapiro.test(spiders$d15N) #not normal dist. 
hist(spiders$d15N) 

kruskal.test(d15N~Site, data=spiders) #p=0.0054
dunnTest(d15N~Site, data=spiders)
#GRVBR different from all other sites


#### Plotting basal food sources, Hydropsychidae, and spiders across sites ####


colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

hydro_subset<-subset(isotope, Taxa == "Tetragnathidae" | Taxa== "Araneidae" | Taxa=="Terrestrial Leaves" | Taxa=="Hydropsychidae" | Taxa=="Biofilm")

hydro_subset$Taxa <- factor(hydro_subset$Taxa, levels=c("Terrestrial Leaves", "Biofilm", "Hydropsychidae", "Araneidae", "Tetragnathidae"))

hydro_subset$Site_Code <- factor(hydro_subset$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

N_plot_hydro<-ggplot(hydro_subset, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.title.x = element_text(size=18), axis.text.x=element_text(angle=45, hjust=1, size=16, color="black", face=colorado(hydro_subset$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_wrap(~Aqu_Terr+Taxa, scales="free_x", nrow=1)
N_plot_hydro

#ggsave(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Conferences and Presentations\\Graduate Research Day 2024\\nitrogen_across_taxa.png", height=7, width=12)
```

## ANOVA/Kruskal tests across individual invertebrate families
```{r}
#### Araneidae ####
araneidae<-subset(inverts, Taxa=="Araneidae")
ggplot(araneidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge. 

shapiro.test(araneidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=araneidae) #p=0.061. Probably due to small sample size
dunnTest(d15N~Site, data=araneidae)
#GRVBR - PMF p=0.034

#### Tetragnathidae ####
tetragnathidae<-subset(inverts, Taxa=="Tetragnathidae")
ggplot(tetragnathidae, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Much higher in d15N at Graves Bridge.

shapiro.test(tetragnathidae$d15N)  #Not normal

kruskal.test(d15N~Site, data=tetragnathidae) #p=0.136
dunnTest(d15N~Site, data=tetragnathidae)
#No diff, probably because of the small sample size. 


#### Hydropsychidae ####

#Larvae

hydro_lar<-subset(isotope, Taxa_num=="2" & Stage=="Larvae")
hydro_lar_d15N_plot<-ggplot(hydro_lar, aes(x=factor(Site, labels=c("COCH", "SUN", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))

hydro_lar_d15N_plot

shapiro.test(hydro_lar$d15N)  #Not normal
hist(hydro_lar$d15N) #not normal looking dist

kruskal.test(d15N~Site, data=hydro_lar) #p=0.052
dunnTest(d15N~Site, data=hydro_lar)
#only diff btw graves bridge and sunalta

#Adults

hydro_ad<-subset(inverts, Taxa_num=="2" & Stage=="Adult")
hydro_ad_d15N_plot<-ggplot(hydro_ad, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d15N))+
  geom_boxplot()+
  theme_classic()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab("Site")+
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10, color="black", angle=45, vjust=0.8, hjust=0.9),
                        axis.title=element_text(size=16))
hydro_ad_d15N_plot

shapiro.test(hydro_ad$d15N)  #Not normal
hist(log(hydro_ad$d15N)) #normal looking dist.

kruskal.test(d15N~Site, data=hydro_ad) #p=0.044
dunnTest(d15N~Site, data=hydro_ad)
#Diff btw GRVBR - PMF


#### Heptageniidae ####
#Larvae
larhep<-filter(inverts, Taxa=="Heptageniidae" & Stage=="Larvae")
ggplot(larhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Graves Bridge is much higher in d15N

shapiro.test(larhep$d15N)  #Normal
hist(larhep$d15N) #normal looking dist.

summary(hep_lm1<-lm(d15N~Site, data=larhep))
emmeans(hep_lm1, specs = pairwise ~ Site)
#Diff btw:
#COCH - GRVBR
#COCH - PMF
#SUN - GRVBR
#SUN - PMF
#CUSHBR - GRVBR
#CUSHBR - PMF
#GRVBR - PMF


#Adults
adhep<-filter(inverts, Taxa=="Heptageniidae" &  Stage=="Adult")
ggplot(adhep, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

#Not a large enough sample size to run stats

#### Chironomidae ####
#Larvae
larchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Larvae")
ggplot(larchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not a large enough sample size to run stats

#Adult
adchiro<-filter(inverts, Taxa=="Chironomidae" & Stage=="Adult")
ggplot(adchiro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough to really compare at Graves Bridge but might not be significantly higher than the other sites

#### Chloroperlidae ####
#larvae
larchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Larvae")

ggplot(larchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()

shapiro.test(larchloro$d15N)  #Normal
hist(larchloro$d15N) #Not normal looking.

summary(chloro_lm1<-lm(d15N~Site, data=larchloro))
emmeans(chloro_lm1, specs = pairwise ~ Site)
#SUN - GRVBR p=0.0006
#CUSHBR - GRVBR p < 0.001

#adults
adchloro<-filter(inverts, Taxa=="Chloroperlidae" & Stage=="Adult")
ggplot(adchloro, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Not enough samples for statistical comparison

#### Ephemerellidae ####
#Larvae
larephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Larvae")
ggplot(larephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

shapiro.test(larephem$d15N)  #Normal
hist(larephem$d15N) #Not normal looking.

kruskal.test(d15N~Site, data=larephem) #p=0.066
dunnTest(d15N~Site, data=larephem) #no diff

#Adults
adephem<-subset(inverts, Taxa=="Ephemerellidae" & Stage=="Adult")
ggplot(adephem, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_classic()
#Higher at Graves Bridge

#Not enough samples to run stats


```

# C across sites

```{r}
C_plot<-ggplot(isotope, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black"))+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~Aqu_Terr, scales="free_x")
C_plot

#### Comparing carbon values of sample groups (all sites combined) ####

shapiro.test(isotope$d13C) #not normal

kruskal.test(data=biofilm, d13C ~ Site) #p=0.033
dunnTest(data=biofilm, d13C ~ Site)
#CUSHBR - PMF

summary(C_taxa<-aov(d13C~Taxa_Specific*Site, data=isotope)) #F(50,112) =4.83, P < 0.001
taxa_res<-data.frame(pairs(emmeans(C_taxa, ~ Taxa_Specific*Site), combine = TRUE, adjust = "bonferroni"))
taxa_res<-na.omit(taxa_res)

#### Cochrane ####

coch<-subset(isotope, Site=="Cochrane")
shapiro.test(coch$d13C) #Not normal
#library(car)
leveneTest(d13C~Taxa_Specific, data=coch) #homogeneity p=0.336

summary(coch_taxa<-aov(d13C~Taxa_Specific, data=coch))
coch_res<-data.frame(pairs(emmeans(coch_taxa, ~ Taxa_Specific), combine = TRUE, adjust = "bonferroni"))
coch_res<-na.omit(coch_res)

kruskal.test(d13C~Taxa_Specific, data=coch)
dunnTest(d13C~Taxa_Specific, data=coch)

#### Sunalta ####

sun<-subset(isotope, Site=="Sunalta")
shapiro.test(sun$d13C) #Not normal
#library(car)
leveneTest(d13C~Taxa_Specific, data=sun) #homogeneity p=0.555

summary(sun_taxa<-aov(d13C~Taxa_Specific, data=sun))
sun_res<-data.frame(pairs(emmeans(sun_taxa, ~ Taxa_Specific), combine = TRUE, adjust = "bonferroni"))
sun_res<-na.omit(sun_res)

kruskal.test(d13C~Taxa_Specific, data=sun)
dunnTest(d13C~Taxa_Specific, data=sun)

#### Cushing Bridge ####

cush<-subset(isotope, Site=="Cushing Bridge")
shapiro.test(cush$d13C) #Not normal
#library(car)
leveneTest(d13C~Taxa_Specific, data=cush) #homogeneity p=0.497

summary(cush_taxa<-aov(d13C~Taxa_Specific, data=cush))
cush_res<-data.frame(pairs(emmeans(cush_taxa, ~ Taxa_Specific), combine = TRUE, adjust = "bonferroni"))
cush_res<-na.omit(cush_res)

kruskal.test(d13C~Taxa_Specific, data=cush)
dunnTest(d13C~Taxa_Specific, data=cush)

#### Graves Bridge ####

grvbr<-subset(isotope, Site=="Graves Bridge")
shapiro.test(grvbr$d13C) #Not normal
#library(car)
leveneTest(d13C~Taxa_Specific, data=grvbr) #homogeneity p=0.343

summary(grvbr_taxa<-aov(d13C~Taxa_Specific, data=grvbr))
grvbr_res<-data.frame(pairs(emmeans(grvbr_taxa, ~ Taxa_Specific), combine = TRUE, adjust = "bonferroni"))
grvbr_res<-na.omit(grvbr_res)

kruskal.test(d13C~Taxa_Specific, data=grvbr)
dunnTest(d13C~Taxa_Specific, data=grvbr)

#### Policeman Flats ####

pmf<-subset(isotope, Site=="Policeman Flats")
shapiro.test(pmf$d13C) #Not normal
#library(car)
leveneTest(d13C~Taxa_Specific, data=pmf) #homogeneity p=0.322

summary(pmf_taxa<-aov(d13C~Taxa_Specific, data=pmf))
pmf_res<-data.frame(pairs(emmeans(pmf_taxa, ~ Taxa_Specific), combine = TRUE, adjust = "bonferroni"))
pmf_res<-na.omit(pmf_res)

kruskal.test(d13C~Taxa_Specific, data=pmf)
dunnTest(d13C~Taxa_Specific, data=pmf)


#### Riparian Leaves ####
shrub<-subset(isotope, Stage=="Shrub")
shapiro.test(shrub$d13C) #normal
hist(shrub$d13C) #Normal dist.

summary(shrublm1<-aov(d13C~Site, data=shrub)) #p =0.323 no diff.
emmeans(shrublm1, specs = pairwise~Site) # no differences across sites

#### Biofilm ####
biofilm<-subset(isotope, Taxa=="Biofilm")
hist(biofilm$d13C) #Normal -ish distribution
shapiro.test(biofilm$d13C) #Normal dist. p =0.06

summary(biofilm1<-aov(d13C~Site, data=biofilm)) #p=0.00445
plot(biofilm1) #Doesn't fit linear assumptions very well. But the results match the data more closely using ANOVA...
emmeans(biofilm1, specs = pairwise~Site)
#COCH - PMF
#SUN - PMF
#CUSH - PMF

kruskal.test(data=biofilm, d13C ~ Site) #p=0.033
dunnTest(data=biofilm, d13C ~ Site)
#CUSHBR - PMF


#### Aquatic larvae ####

aq_lar<-subset(isotope, Aqu_Terr=="Aquatic Larvae")
shapiro.test(aq_lar$d13C) #normal dist. 
hist(aq_lar$d13C) 

summary(aq_lar_lm<-aov(d13C~Site, data=aq_lar)) #p < 0.001
plot(aq_lar_lm)
emmeans(aq_lar_lm, specs = pairwise ~ Site)
#COCH - SUN
#COCH - GRVBR
#COCH - PMF
#SUN - PMF
#CUSHBR - PMF
#GRVBR - PMF

#### Aquatic Adults ####

aq_ad<-subset(isotope, Aqu_Terr=="Aquatic Adults")
shapiro.test(aq_ad$d13C) #normal dist. 
hist(aq_ad$d13C) 

summary(aq_ad_aov<-aov(d13C~Site, data=aq_ad)) #p<0.001
plot(aq_ad_aov)
emmeans(aq_ad_aov, specs = pairwise ~ Site)
#COCH - GRVBR
#COCH - PMF
#SUN - GRVBR
#SUN - PMF
#CUSH - PMF

#### Terrestrial Insects ####

terr_ad<-subset(isotope, Aqu_Terr=="Terrestrial Prey")
shapiro.test(terr_ad$d13C) #normal dist. p=0.419
hist(terr_ad$d13C) 

summary(terr_ad_aov<-aov(d13C~Site, data=terr_ad)) #F(3,12)=4.50, p=0.0247
emmeans(terr_ad_aov, specs = pairwise ~ Site)
#SUN - GRVBR
#SUN - PMF

#### Spiders ####

spiders<-subset(isotope, Aqu_Terr=="Spiders")
shapiro.test(spiders$d13C) #Normal 
hist(spiders$d13C) 

summary(spiders_lm<-aov(d13C~Site, data=spiders)) #p<0.001
emmeans(spiders_lm, specs = pairwise ~ Site)
#COCH diff from all other sites
#SUN - GRVBR
#SUN - PMF
#CUSHBR - GRVBR
#CUSHBR - PMF

#PMF and GRVBR different from all sites except each other
```

# Food source reliance graph

```{r}

isotope_subset<-subset(isotope, FFG!="Basal food source")%>%
  dplyr::select("Site_Code", "Taxa","d13C", "FFG")%>%
  group_by(Site_Code, Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

Ylims<-aes(ymax=MeanC +sdC, ymin=MeanC-sdC)

isotope_subset$Site_Code<-factor(isotope_subset$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

ggplot(isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  facet_grid(~Site_Code)+
  theme_bw() +
  rremove("grid")+
  geom_errorbar(Ylims)+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_blank(), axis.ticks.x = element_blank(), axis.title = element_text(size=18, color="black"))+
  ylim(-33, -6)


# Cochrane #

coch_biofilm<-subset(biofilm, Site=="COCH")
mean(coch_biofilm$d13C) #-14.57

coch_shrub<-subset(shrub, Site=="Cochrane")
mean(coch_shrub$d13C) #-29.07

cochrane_isotope_subset<-subset(isotope, Site=="COCH" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))
View(cochrane_isotope_subset) 

Ylims<-aes(ymax=MeanC +sdC, ymin=MeanC-sdC)

coch_food_source<-ggplot(cochrane_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -14.57, linetype = 2, color = "red")+
  geom_hline(yintercept = -29.07, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))

# Sunalta #

sun_biofilm<-subset(biofilm, Site=="SUN")
mean(sun_biofilm$d13C) #-13.23

sun_shrub<-subset(shrub, Site=="Sunalta")
mean(sun_shrub$d13C) #-28.4

sunalta_isotope_subset<-subset(isotope, Site=="SUN" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))
View(sunalta_isotope_subset) 

sun_food_source<-ggplot(sunalta_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -13.23, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.4, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))


# Cushing Bridge #

cush_biofilm<-subset(biofilm, Site=="CUSHBR")
mean(cush_biofilm$d13C) #-8.47

cush_shrub<-subset(shrub, Site=="Cushing Bridge")
mean(cush_shrub$d13C) #-28.67

cush_isotope_subset<-subset(isotope, Site=="CUSHBR" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

cush_food_source<-ggplot(cush_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -8.47, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.67, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
cush_food_source


# Graves Bridge

grvbr_biofilm<-subset(biofilm, Site=="GRVBR")
mean(grvbr_biofilm$d13C) #-18.27

grvbr_shrub<-subset(shrub, Site=="Graves Bridge")
mean(grvbr_shrub$d13C) #-28.83

grvbr_isotope_subset<-subset(isotope, Site=="GRVBR" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

grvbr_food_source<-ggplot(grvbr_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -18.27, linetype = 2, color = "red")+
  geom_hline(yintercept = -28.83, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
grvbr_food_source

# Policeman Flats

pmf_biofilm<-subset(biofilm, Site=="PMF")
mean(pmf_biofilm$d13C) #-25.7

pmf_shrub<-subset(shrub, Site=="Policeman Flats")
mean(pmf_shrub$d13C) #-27.52

pmf_isotope_subset<-subset(isotope, Site=="PMF" & FFG!="Basal food source")%>%
  dplyr::select("Taxa","d13C", "FFG")%>%
  group_by(Taxa, FFG)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

pmf_food_source<-ggplot(pmf_isotope_subset, aes(x=Taxa, y=MeanC, color=Taxa, shape=FFG))+
  geom_point(size=4)+
  theme_bw() +
  rremove("grid")+
  geom_hline(yintercept = -25.7, linetype = 2, color = "red")+
  geom_hline(yintercept = -27.52, linetype = 2, color = "blue")+
  geom_errorbar(Ylims)+
  xlab("Invertebrate Taxa")+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=16, color="black"), axis.text.x=element_text(size=16, color="black", angle=45, vjust=1, hjust=1), axis.title = element_text(size=18, color="black"))
pmf_food_source

#ggarrange(coch_food_source, sun_food_source, cush_food_source, grvbr_food_source, pmf_food_source, nrow=1)


#### Only primary consumers ####



```

# Combining C and N boxplot across sites 

```{r}
colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

isotope$Site<-factor(isotope$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

C_plot<-ggplot(isotope, aes(x=Site, y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.text.y = element_text(size=18, color="black"), strip.text.x = element_text(size=18, color="black"), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site, c("GRVBR", "PMF"))))+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~ Aqu_Terr, scales="free_x")
C_plot


N_plot<-ggplot(isotope, aes(x=Site, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), axis.text.y = element_text(size=18, color="black"), strip.text.x = element_text(size=18, color="black"), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black",  face=colorado(isotope$Site, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_grid(~Aqu_Terr, scales="free_x")
N_plot



C_plot_1<-C_plot + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank())
N_plot_1<-N_plot + theme(axis.title.x = element_blank())

C_N_combined<-ggarrange(C_plot_1, N_plot_1, nrow=2, ncol=1)

annotate_figure(C_N_combined, bottom = textGrob("Site", gp = gpar(cex = 1.6)))

ggsave(filename="stable_isotope_analysis/Figures/C and N across taxa groups and sites.png", height=10, width=14, bg="white")
```

# Table of mean d13C and d15N values (+/- SD) across sites and sample type 

```{r}
C_N_sum_tab<-isotope %>% 
  dplyr::select("Aqu_Terr", "d13C", "d15N", "Site")%>%
  dplyr::group_by(Aqu_Terr, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(C_N_sum_tab)
```

# Running MixSIAR model

```{r}
#Running model with primary consumers and basal food sources

#Make sure the data is a comma delimited file because it gets very fussy about the file type
mix<-load_mix_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\primary_consumers.csv", 
                   iso_names=c("d13C","d15N"), 
                   factors=c("Site","Taxa"), 
                   fac_random=c(FALSE,FALSE), 
                   fac_nested = c(FALSE, FALSE),
                   cont_effects=NULL)

source<-load_source_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_sources.csv",
                         source_factors = "Site",
                         conc_dep = FALSE, 
                         data_type = "means",
                         mix)

discr<-load_discr_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_tef.csv", mix)

#isospace plot
plot_data(filename="isospace_plot", plot_save_pdf = F, plot_save_png = F, mix, source, discr)

#default uninformative/generalist prior (alpha=1)
plot_prior(alpha.prior = c(1), source)

#Informative prior
plot_prior(alpha.prior = c(0.5, 1), source)

#How do you know which weighting to use? Seems like the inverts consume a more terrestrial source so should I weight it higher?

#JAGS model file
model_filename<-"MixSIAR_model.txt"
resid_err<-TRUE
process_err<-TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)
output_options = list(summary_save = FALSE, summary_name = "summary_statistics.txt",
    sup_post = FALSE, plot_post_save_pdf = FALSE, plot_post_name = "posterior_density",
    sup_pairs = FALSE, plot_pairs_save_pdf = FALSE, plot_pairs_name = "pairs_plot", sup_xy
    = FALSE, plot_xy_save_pdf = FALSE, plot_xy_name = "xy_plot", gelman = TRUE, heidel =
    FALSE, geweke = TRUE, diag_save = FALSE, diag_name = "diagnostics.txt", indiv_effect =
    FALSE, plot_post_save_png = FALSE, plot_pairs_save_png = FALSE, plot_xy_save_png =
    FALSE, diag_save_ggmcmc = FALSE)

#Running real model with 'normal' chain length and burn-in.
run<-list(chainLength=100000, burn=50000, thin=50, chains=3, calcDIC=TRUE)
jags<-run_model(run, mix, source, discr, model_filename, alpha.prior = 1, resid_err, process_err)
output_JAGS(jags, mix, source, output_options)


#Running model with secondary consumers and primary consumers as the food source

```
