---
title: "StableIsotope2022"
author: "Emilie Diesbourg"
date: "14/03/2023"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Loading packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
par(mar = c(1, 1, 1, 1))
```

```{r Packages/Data}
library(rjags)
library(MixSIAR)
library(plyr)
library(dplyr)
library(ggpubr)
library(ggplot2)
library(R2WinBUGS)
library(FSA)
library(splancs)
library(devtools)
library(emmeans)
library(vegan)
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", force=TRUE)
library(pairwiseAdonis)
library(ggpubr)
library(ggh4x)
library(car)
library(grid)

isotope<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_1.csv")
isotope$Site<-factor(isotope$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))
```

# Sample sizes

```{r}
#Larvae across sites
coch_lar<-subset(inverts, Site=="Cochrane" & Stage=="Larvae") #5
sun_lar<-subset(inverts, Site=="Sunalta" & Stage=="Larvae") #14
cushbr_lar<-subset(inverts, Site=="Cushing Bridge" & Stage=="Larvae") #6
grvbr_lar<-subset(inverts, Site=="Graves Bridge" & Stage=="Larvae") #15
pmf_lar<-subset(inverts, Site=="Policeman Flats" & Stage=="Larvae") #14

#Adults across sites
coch_ad<-subset(inverts, Site=="Cochrane" & Stage=="Adult") #12
sun_ad<-subset(inverts, Site=="Sunalta" & Stage=="Adult") #14
cushbr_ad<-subset(inverts, Site=="Cushing Bridge" & Stage=="Adult") #11
grvbr_ad<-subset(inverts, Site=="Graves Bridge" & Stage=="Adult") #18
pmf_ad<-subset(inverts, Site=="Policeman Flats" & Stage=="Adult")#14

#Spiders n = 3/family/site



summary_taxa<-isotope %>% 
  dplyr::select("Taxa", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(Taxa, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_taxa)


#Combine taxa by larvae, adults, spiders, biofilm, leaves, and by functional feeding group

summary_FFG<-isotope %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG)

```

# Preliminary data checks (carbonates/lipid effect/HCl treated biofilm)

```{r}
#### Carbonate effect ####

ggplot(isotope, aes(x=X.C, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks like there's a negative relationship between %C and d13C indicating no carbonates (inorganic carbon) in the samples since the correlation should be positive if there was an effect (Brian Hayden)

#Mostly an issue for biofilm so we will look at those samples individually
biofilm<-filter(isotope, Taxa=="Biofilm")

ggplot(biofilm, aes(x=X.C, y=d13C))+ 
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#No effect of carbonates. Seems like there is one data point driving the others. 


#### Lipid effect ####
#We only look at inverts since plants don't have much lipid
inverts<-subset(isotope, Tissue.Type=="Whole Invertebrate")

ggplot(inverts, aes(x=C.N, y=d13C))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(.~Site)
#Looks depleted across all sites. Could potentially be an issue.

ggplot(inverts, aes(x=Taxa, y=C.N))+
  geom_boxplot()+
  geom_hline(aes(yintercept=4), colour="red")

#Could potentially indicate a lipid effect since C:N ratio shouldn't be above 3.5 but if we correct it, it won't make a difference since all the insects besides spiders are at approximately the same level. This is usually more of an issue in fattier animals such as fish.  

#### Plotting biofilm duplicates with high variability ####


rawdata<-read.csv("C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\Isotopes\\SIN Lab Data\\Stable_Isotope_Raw_Data.csv")

biofilm_raw<-filter(rawdata, Tissue_Type=="Biofilm") #34 obs 

#Remove the HCl treated samples since those did not differ in C values from the non-treated ones

biofilm_raw_no_HCl<-filter(biofilm_raw, Notes!="Acid treated") #17 obs 

biofilm_raw_no_HCl$Site <-factor(biofilm_raw_no_HCl$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

#plotting variation in carbon values in replicates and duplicates

ggplot(biofilm_raw_no_HCl, aes(x=Site, y=d13C, label=SampleName))+ 
  geom_point()+
 geom_text(hjust=-0.1)+
  theme_bw()

#plotting variation in nitrogen values in replicates and duplicates
  
ggplot(biofilm_raw_no_HCl, aes(x=Site, y=d15N, label=SampleName))+ 
  geom_point()+
 geom_text(hjust=-0.1)+
  theme_bw()

#### HCl treated biofilm ####

#Averaged duplicates
HCl_isotope<-read.csv("C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\Isotopes\\SIN Lab Data\\StableIsotopeAvg.csv")

HCl_biofilm<-subset(HCl_isotope, Stage=="Acid treated")

#d13C versus C/N ratio with HCl treated biofilm

ggplot(HCl_biofilm, aes(x=d13C, y=C.N))+
  geom_point()

#d13C versus C/N ratio with non HCl treated biofilm

no_HCl_biofilm<-subset(HCl_isotope, Stage=="Not acid treated")

ggplot(no_HCl_biofilm, aes(x=d13C, y=C.N))+
  geom_point()


all_biofilm<-subset(HCl_isotope, Taxa=="Biofilm")

#Plotting all biofilm together coloured by whether they were acid treated or not

ggplot(all_biofilm, aes(x=d13C, y=C.N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  rremove("grid")

#Faceted across sites

all_biofilm$Site<-factor(all_biofilm$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

ggplot(all_biofilm, aes(x=d13C, y=C.N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")


ggplot(all_biofilm, aes(x=d13C, y=d15N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")



#Are the acid treated biofilm carbon values different from the non acid treated ones? Potentially indicates presence of carbonates if they are different. 

shapiro.test(all_biofilm$d13C) #not normal p=0.003
leveneTest(data=all_biofilm, d13C ~ Site*Stage) #Homogeneity p=0.327
hist(all_biofilm$d13C) #not normal looking

#Use Kruskal Wallis tests for each site individually

#Cochrane
coch_biofilm<-subset(all_biofilm, Site=="Cochrane")
shapiro.test(coch_biofilm$d13C) #p=0.26, normal
t.test(d13C~Stage, data=coch_biofilm) #0.36, not sig diff
kruskal.test(d13C ~ Stage, data=coch_biofilm) #p=0.49, not sig different

#Sunalta
sun_biofilm<-subset(all_biofilm, Site=="Sunalta")
shapiro.test(sun_biofilm$d13C) #p=0.38, normal
t.test(d13C~Stage, data=sun_biofilm) #p=0.47, not sig diff
kruskal.test(d13C ~ Stage, data=sun_biofilm) #p=0.51, not sig. different

#Cushing Bridge
cushbr_biofilm<-subset(all_biofilm, Site=="Cushing Bridge")
shapiro.test(cushbr_biofilm$d13C) #p=0.303. Normal
t.test(d13C~Stage, data=cushbr_biofilm) #p=0.65, not sig diff. 
kruskal.test(d13C ~ Stage, data=cushbr_biofilm) #p=0.83, not sig. different

#Graves Bridge
grvbr_biofilm<-subset(all_biofilm, Site=="Graves Bridge")
shapiro.test(grvbr_biofilm$d13C) #p=0.0047 not normal
wilcox.test(grvbr_biofilm$d13C ~ grvbr_biofilm$Stage) #p=0.1. Not sig.
kruskal.test(d13C ~ Stage, data=grvbr_biofilm) #p=0.05, not sig. different

#Policeman Flats
pmf_biofilm<-subset(all_biofilm, Site=="Policeman Flats")
shapiro.test(pmf_biofilm$d13C) #p=0.11, normal dist.
t.test(d13C~Stage, data=pmf_biofilm) #p=0.039. Sig. different
kruskal.test(d13C ~ Stage, data=pmf_biofilm) #p=0.04, Sig. different

#Policeman Flats was the only site that had significantly different carbon values for acid vs not acid treated biofilm samples but they look very similar when graphed



#Are the acid treated biofilm nitrogen values different from the non acid treated ones?  

shapiro.test(all_biofilm$d15N) #normal p=0.121
leveneTest(data=all_biofilm, d15N ~ Site*Stage) #Homogeneity p=0.626
hist(all_biofilm$d15N) #not very normal looking but passes the normality test

summary(N_aov<-aov(data=all_biofilm, d15N ~ Site*Stage))

emmeans(N_aov, pairwise ~ Site|Stage)
#Acid treated data has significant differences in nitrogen between COCH - GRVBR and PMF - GRVBR however, non acid treated data have no significant comparisons. 

emmeans(N_aov, pairwise ~ Stage|Site)
#Nitrogen values don't differ between acid treated and non-acid treated data at all sites



#Raw duplicates

raw_data<-read.csv("C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\Isotopes\\SIN Lab Data\\Stable_Isotope_Raw_Data.csv")


HCl_biofilm_raw<-subset(raw_data, Stage=="Acid treated")

#d13C versus C/N ratio with HCl treated biofilm

ggplot(HCl_biofilm_raw, aes(x=d13C, y=C.N))+
  geom_point()

#d13C versus C/N ratio with non HCl treated biofilm

no_HCl_biofilm_raw<-subset(raw_data, Stage=="Non acid treated")

ggplot(no_HCl_biofilm_raw, aes(x=d13C, y=C.N))+
  geom_point()


all_biofilm_raw<-subset(raw_data, Tissue_Type=="Biofilm")

#Plotting all biofilm together coloured by whether they were acid treated or not

ggplot(all_biofilm_raw, aes(x=d13C, y=C.N))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  rremove("grid")

#Faceted across sites

all_biofilm_raw$Site<-factor(all_biofilm_raw$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

ggplot(all_biofilm_raw, aes(x=d13C, y=C.N, label=SampleName))+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  geom_text_repel(aes(label=SampleName), size=2)+
  ylab("C/N ratio")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")

library(ggrepel)
ggplot(all_biofilm_raw, aes(x=d13C, y=d15N, label=SampleName))+
  theme_bw()+
  geom_text_repel(aes(label=SampleName), size=2)+
  geom_point(aes(color=Stage)) +
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(legend.title = element_blank())+
  facet_grid(~Site)+
  rremove("grid")


```

# Biplots of individual data points

```{r}
# d13C vs d15N at all sites
ggplot(isotope, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()+
  facet_grid(.~Site)

# Sites plotted individually
Cochrane<-filter(isotope, Site=="Cochrane")
ggplot(Cochrane, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Sunalta<-filter(isotope, Site=="Sunalta")
ggplot(Sunalta, aes(x=d13C, y=d15N, color=Taxa, shape=Tissue.Type))+
  geom_point()

Cushbr<-filter(isotope, Site=="Cushing Bridge")
ggplot(Cushbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()

Grvbr<-filter(isotope, Site=="Graves Bridge")
ggplot(Grvbr, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs and biofilm are high in nitrogen as well as invertebrates. Biofilm is variable on the x axis.

Polflt<-filter(isotope, Site=="Policeman Flats")
ggplot(Polflt, aes(x=d13C, y=d15N, color=Taxa))+
  geom_point()
#Shrubs still high in nitrogen but biofilm is not. All taxa are very variable on both x and y axes. 
```

# Biplots of averaged /median data

```{r}

#Summarizing a dataframe with mean and sd C and N values

data.sum<-ddply(isotope, c("Site_Code", "Taxa", "FFG"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

#All sites together

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme_classic()

#Sites faceted

data.sum$Taxa<-factor(data.sum$Taxa, levels= c("Terrestrial Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"), labels=c("Riparian Leaves", "Biofilm", "Hydropsychidae", "Leptoceridae", "Ephemerellidae", "Chironomidae", "Heptageniidae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Coleoptera", "Rhyacophilidae", "Araneidae", "Tetragnathidae"))

data.sum$Site_Code<-factor(data.sum$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

ggplot(data.sum, aes(x=d13Cmn, y=d15Nmn, colour=Taxa, shape=FFG))+
  geom_point(size=3)+
  geom_errorbar(Ylims, width=0.2)+
  geom_errorbarh(Xlims, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type", shape="Functional Feeding Group")+
  rremove("grid")


#ggsave(filename="stable_isotope_analysis/Figures/Mean SD biplot d13C d15N faceted by site.png", height=7, width=12)



data.sum.1<-ddply(isotope, c("Site_Code", "Taxa"), summarise,
                d13Cmn=mean(d13C), #mean
                d13Csd=sd(d13C), #standard deviation
                d15Nmn=mean(d15N), #mean
                d15Nsd=sd(d15N)) #standard deviation

#Making errorbars
Ylims.1<-aes(ymax=d15Nmn +d15Nsd, ymin=d15Nmn-d15Nsd)
Xlims.1<-aes(xmax=d13Cmn+d13Csd, xmin=d13Cmn-d13Csd)

data.sum.1$Aqu_Terr<-factor(data.sum.1$Aqu_Terr, levels=c("Biofilm", "Riparian Leaves", "Aquatic Larvae", "Aquatic Adults", "Terrestrial Prey", "Spiders"), labels=c("Biofilm", "Riparian leaves", "Aquatic larval insects", "Aquatic adult insects", "Terrestrial adult insects", "Spiders"))

data.sum.1$Site_Code<-factor(data.sum.1$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))


ggplot(data.sum.1, aes(x=d13Cmn, y=d15Nmn, colour=Taxa))+
  geom_point(size=3)+
  geom_errorbar(Ylims.1, width=0.2)+
  geom_errorbarh(Xlims.1, height=0.2)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  xlab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  facet_grid(.~Site_Code)+
  theme_bw()+
  theme(axis.text = element_text(size=12, color="black"), axis.title = element_text(size=16), strip.text = element_text(size=16, color="black"), legend.title = element_text(size=14), legend.text = element_text(size=12))+
  labs(color="Sample Type")+
  rremove("grid")

```


# Nitrogen isotope plots and ANOVAs across sites

```{r}
#### N plot across sites ####

colorado <- function(src, boulder) {
  if (!is.factor(src)) src <- factor(src)                   # make sure it's a factor
  src_levels <- levels(src)                                 # retrieve the levels in their order
  brave <- boulder %in% src_levels                          # make sure everything we want to make bold is actually in the factor levels
   if (any(brave)){
      b_pos <- which(src_levels == boulder[1])
    for(i in 2:length(boulder)){# if so
       # then find out where they are
      b_pos <- append(b_pos, which(src_levels == boulder[i]))
    }
      b_vec <- rep("plain", length(src_levels))               # make'm all plain first
      b_vec[b_pos] <- "bold"# make our targets bold
      b_vec
    # return the new vector
  }
}

isotope$Taxa<-factor(isotope$Taxa, levels=c("Biofilm", "Terrestrial Leaves", "Heptageniidae", "Hydropsychidae", "Chironomidae", "Ephemerellidae", "Leptoceridae", "Lepidoptera", "Chloroperlidae", "Perlidae", "Rhyacophilidae", "Coleoptera", "Araneidae", "Tetragnathidae"))

isotope$FFG<-factor(isotope$FFG, levels=c("Basal food source", "Scraper", "Filterer-Collector", "Gatherer-Collector", "Piercer", "Predator"))

isotope$Site_Code<-factor(isotope$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

#Plotting by individual taxa
N_plot_taxa<-ggplot(isotope, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=18), strip.text.x = element_text(size=6), axis.title.x = element_text(size=18), axis.text.x = element_text(size=16, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Taxa_Specific, scales="free_x", nrow=1)
N_plot_taxa

#If analyzing by individual taxa, remove these samples due to low sample size (2 replicates or less per site):
#-Heptageniidae Adult
#-Heptageniidae larvae at Cushing Bridge
#-Hydropsychidae Adult at Cochrane
#-Hydropsychidae larvae
#-Chironomidae Adult
#-Chiornomidae Larvae
#-Ephemerellidae Adult
#-Leptoceridae Adult
#-Chloroperlidae adult
#-Coleoptera
#-Perlidae Larvae
#Rhyacophilidae Adult


N_plot_FFG<-ggplot(isotope, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~FFG + Stage, scales="free_x", nrow=1)
N_plot_FFG

#If analyzing by functional feeding group, remove these samples due to low sample size (2 replicates or less per site):
#-Heptageniidae Adults
#-Heptageniidae larvae at Cushing Bridge 
#-Hydropsychidae Adults at Cochrane
#-Hydropsychidae larvae at Cochrane and Sunalta (Potentially all of them)
#-Chironomidae larvae at Cushing Bridge 
#-Rhyacophilidae Adult at Cushing Bridge


#Subset samples with low replicates so that we can group by functional feeding group

isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")
isotope_subset$Site<-factor(isotope_subset$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

isotope_subset_no_food_sources<-subset(isotope_subset, Stage!="Biofilm" & Stage!="Terrestrial leaves")

isotope_subset_no_food_sources$Stage<-factor(isotope_subset_no_food_sources$Stage, levels=c("Aquatic larvae", "Aquatic adult","Terrestrial adult","Spider"))

isotope_subset_no_food_sources$Site_Code<-factor(isotope_subset_no_food_sources$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

isotope_subset_no_food_sources$FFG<-factor(isotope_subset_no_food_sources$FFG, levels=c("Scraper", "Gatherer-Collector", "Filterer-Collector", "Predator", "Piercer"))

N_plot_taxa_subset_no_food_sources<-ggplot(isotope_subset_no_food_sources, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
N_plot_taxa_subset_no_food_sources

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\N plot across FFG and stage subsetted data.png", height=10, width=26)


#Just larvae and spiders
isotope_subset_lar_no_food_sources<-subset(isotope_subset_no_food_sources, Stage=="Aquatic larvae" | Stage=="Spider")

N_plot_taxa_subset_lar<-ggplot(isotope_subset_lar_no_food_sources, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
N_plot_taxa_subset_lar

summary_FFG_lar<-isotope_subset_lar %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG_lar)


#Just adults and spiders

isotope_subset_ad<-subset(isotope_subset, Stage=="Aquatic adult" | Stage=="Terrestrial adult" | Stage=="Spider")

N_plot_taxa_subset_ad<-ggplot(isotope_subset_ad, aes(x=Site_Code, y=d15N))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope$Site_Code, c("GRVBR", "PMF"))))+
  ylim(-1, 17)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
N_plot_taxa_subset_ad

summary_FFG_ad<-isotope_subset_ad %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG_ad)


#### ANOVA across all FFGs and sites ####

isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")

isotope_subset_no_food_sources<-subset(isotope_subset, Stage!="Biofilm" & Stage!="Terrestrial leaves")

isotope_subset_no_food_sources$Stage<-factor(isotope_subset_no_food_sources$Stage, levels=c("Aquatic larvae", "Aquatic adult","Terrestrial adult","Spider"))

isotope_subset_no_food_sources$Site_Code<-factor(isotope_subset_no_food_sources$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

isotope_subset_no_food_sources$FFG<-factor(isotope_subset_no_food_sources$FFG, levels=c("Scraper", "Gatherer-Collector", "Filterer-Collector", "Predator", "Piercer"))


#All stages and FFGs together

shapiro.test(isotope_subset_no_food_sources$d15N) #0.112
leveneTest(data=isotope_subset_no_food_sources, d15N~Site*FFG*Stage) #0.082
hist(isotope_subset_no_food_sources$d15N) #looks normal
plot(isotope_subset_no_food_sources$d15N) #looks evenly spread

summary(N_FFG_1<-aov(data=isotope_subset_no_food_sources, d15N~Site*FFG*Stage))
Anova(N_FFG_1, type=3) #aliased coefficients, run FFGs separately

emmeans(N_FFG_1, pairwise ~ Site | FFG | Stage)

#### Aquatic Larvae ####

isotope_aq_lar<-subset(isotope_subset_no_food_sources, Stage=="Aquatic larvae")
shapiro.test(isotope_aq_lar$d15N) #0.165 #normal distribution
leveneTest(data=isotope_aq_lar, d15N~Site*FFG) #0.053, homogeneity of variance
hist(isotope_aq_lar$d15N) #looks potentially bimodel
plot(isotope_aq_lar$d15N) #data looks evenly spread

summary(N_lar_FFG_1<-lm(data=isotope_aq_lar, d15N~FFG*Site, na.action = na.exclude)) #Some interactions btw FFG and Site
Anova(N_lar_FFG_1, type=3) #Aliased coefficients, run FFG separately

# Scrapers 

isotope_lar_scrapers<-subset(isotope_aq_lar, FFG=="Scraper")

shapiro.test(isotope_lar_scrapers$d15N) #0.303 normal distribution
leveneTest(data=isotope_lar_scrapers, d15N~Site) #0.183, homogeneity of variance
hist(isotope_lar_scrapers$d15N) #looks uniform
plot(isotope_lar_scrapers$d15N) #data looks evenly spread

summary(N_lar_scraper<-aov(data=isotope_lar_scrapers, d15N~Site, na.action = na.exclude)) #p<0.001
Anova(N_lar_scraper, type=3) #p<0.001

emmeans(N_lar_scraper, pairwise ~ Site)

plot(N_lar_scraper) #Adheres to assumptions

# Gatherer - Collector

isotope_lar_gath<-subset(isotope_aq_lar, FFG=="Gatherer-Collector")

shapiro.test(isotope_lar_gath$d15N) #0.147 normal distribution
leveneTest(data=isotope_lar_gath, d15N~Site) #0.08, homogeneity of variance
hist(isotope_lar_gath$d15N) #looks potentially uniform
plot(isotope_lar_gath$d15N) #data not evenly spread

summary(N_lar_gath<-aov(data=isotope_lar_gath, d15N~Site, na.action = na.exclude)) #p < 0.001
Anova(N_lar_gath, type=3) #p<0.001

emmeans(N_lar_gath, pairwise ~ Site)

plot(N_lar_gath) #Adheres to assumptions


# Predator

isotope_lar_pred<-subset(isotope_aq_lar, FFG=="Predator")

shapiro.test(isotope_lar_pred$d15N) #0.72 normal distribution
leveneTest(data=isotope_lar_pred, d15N~Site) #0.187, homogeneity of variance
hist(isotope_lar_pred$d15N) #uniform ish
plot(isotope_lar_pred$d15N) #evenly spread

summary(N_lar_pred<-aov(data=isotope_lar_pred, d15N~Site, na.action = na.exclude)) #p = 0.004
Anova(N_lar_pred, type=3) #p=0.004

emmeans(N_lar_pred, pairwise ~ Site) 

plot(N_lar_pred) #Adheres to assumptions

#### Aquatic Adults ####

isotope_aq_ad<-subset(isotope_subset_no_food_sources, Stage=="Aquatic adult")
shapiro.test(isotope_aq_ad$d15N) #0.166 normal distribution
leveneTest(data=isotope_aq_ad, d15N~Site*FFG) #0.163, homogeneity of variance
hist(isotope_aq_ad$d15N) #looks decently normal
plot(isotope_aq_ad$d15N) #data looks evenly spread

summary(N_ad_FFG_1<-aov(data=isotope_aq_ad, d15N~FFG*Site, na.action = na.exclude)) #some interactions with FFG and site
Anova(N_ad_FFG_1, type=3) #Error in Anova.III.lm(mod, error, singular.ok = singular.ok, ...) : there are aliased coefficients in the model. Run FFGs separately

# Gatherer - Collector

isotope_ad_gath<-subset(isotope_aq_ad, FFG=="Gatherer-Collector")
shapiro.test(isotope_ad_gath$d15N) #0.193 normal distribution
leveneTest(data=isotope_ad_gath, d15N~Site) #0.435, homogeneity of variance
hist(isotope_ad_gath$d15N) #slightly left skewed
plot(isotope_ad_gath$d15N) #data looks evenly spread

summary(N_ad_gath<-aov(data=isotope_ad_gath, d15N~Site, na.action = na.exclude)) #p=0.207
Anova(N_ad_gath, type=3) #p=0.207
emmeans(N_ad_gath, pairwise ~ Site) #no differences

# Filterer - Collector

isotope_ad_filt<-subset(isotope_aq_ad, FFG=="Filterer-Collector")
shapiro.test(isotope_ad_filt$d15N) #0.071 normal distribution
leveneTest(data=isotope_ad_filt, d15N~Site) #0.655, homogeneity of variance
hist(isotope_ad_filt$d15N) #Doesn't really look normal
plot(isotope_ad_filt$d15N) #data not evenly spread

summary(N_ad_filt<-aov(data=isotope_ad_filt, d15N~Site, na.action = na.exclude)) #p < 0.001
Anova(N_ad_filt, type=3) #p<0.001
emmeans(N_ad_filt, pairwise ~ Site)


# Predator

isotope_ad_pred<-subset(isotope_aq_ad, FFG=="Predator")
shapiro.test(isotope_ad_pred$d15N) #0.575 normal distribution
leveneTest(data=isotope_ad_pred, d15N~Site) #0.303, homogeneity of variance
hist(isotope_ad_pred$d15N) 
plot(isotope_ad_pred$d15N) #data evenly spread

summary(N_ad_pred<-aov(data=isotope_ad_pred, d15N~Site, na.action = na.exclude)) #p = 0.004
Anova(N_ad_pred, type=3) #p = 0.004
emmeans(N_ad_pred, pairwise ~ Site)

plot(C_ad_pred)


#### Terrestrial adults ####

isotope_terr_ad<-subset(isotope_subset_no_food_sources, Stage=="Terrestrial adult")
shapiro.test(isotope_terr_ad$d15N) #0.356 normal distribution
leveneTest(data=isotope_terr_ad, d15N~Site) #0.953, homogeneity of variance
hist(isotope_terr_ad$d15N) #looks uniform
plot(isotope_terr_ad$d15N) #data looks evenly spread

summary(N_terr_ad<-lm(data=isotope_terr_ad, d15N~Site, na.action = na.exclude))
Anova(N_terr_ad, type=3) #p=0.011

plot(N_terr_ad) #Fits assumptions of ANOVA/lm pretty well

pairs(emmeans(N_terr_ad, ~Site)) 


#### Spiders ####

isotope_spiders<-subset(isotope_subset_no_food_sources, Stage=="Spider")
shapiro.test(isotope_spiders$d15N) #p<0.001 not normal distribution
leveneTest(data=isotope_spiders, d15N~Site) #0.234, homogeneity of variance
hist(isotope_spiders$d15N) #looks right skewed
plot(isotope_spiders$d15N) #data have a non-random pattern

kruskal.test(data=isotope_spiders, d15N~Site) #p=0.0054
dunnTest(data=isotope_spiders, d15N~Site)

plot(C_spiders) #Fits assumptions of ANOVA/lm pretty well
```

# Carbon isotope plots and ANOVAs across sites

```{r}
#### C plot across sites ####

isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")
isotope_subset$Site<-factor(isotope_subset$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

isotope_subset_no_food_sources<-subset(isotope_subset, Stage!="Biofilm" & Stage!="Terrestrial leaves")

isotope_subset_no_food_sources$Stage<-factor(isotope_subset_no_food_sources$Stage, levels=c("Aquatic larvae", "Aquatic adult","Terrestrial adult","Spider"))

isotope_subset_no_food_sources$Site_Code<-factor(isotope_subset_no_food_sources$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

isotope_subset_no_food_sources$FFG<-factor(isotope_subset_no_food_sources$FFG, levels=c("Scraper", "Gatherer-Collector", "Filterer-Collector", "Predator", "Piercer"))


C_plot_taxa_subset_no_food_sources<-ggplot(isotope_subset_no_food_sources, aes(x=Site_Code, y=d13C))+
  geom_boxplot()+
  theme_bw()+
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.title.y.left = element_text(size=22), strip.text.x = element_text(size=20), axis.title.x = element_text(size=22), axis.text.y = element_text(size=20, color="black"), axis.text.x = element_text(size=20, angle = 45, vjust=1.0, hjust=1, color="black", face=colorado(isotope_subset_no_food_sources$Site_Code, c("GRVBR", "PMF"))))+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage + FFG, scales="free_x", nrow=1)
C_plot_taxa_subset_no_food_sources

#ggsave(filename="C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\Figures\\C plot across FFG and stage subsetted data.png", height=10, width=26)

#### ANOVA across all FFGs and sites ####


isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")

isotope_subset_no_food_sources<-subset(isotope_subset, Stage!="Biofilm" & Stage!="Terrestrial leaves")

isotope_subset_no_food_sources$Stage<-factor(isotope_subset_no_food_sources$Stage, levels=c("Aquatic larvae", "Aquatic adult","Terrestrial adult","Spider"))

isotope_subset_no_food_sources$Site_Code<-factor(isotope_subset_no_food_sources$Site_Code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

isotope_subset_no_food_sources$FFG<-factor(isotope_subset_no_food_sources$FFG, levels=c("Scraper", "Gatherer-Collector", "Filterer-Collector", "Predator", "Piercer"))

str(isotope_subset_no_food_sources)


#All stages and FFGs together

shapiro.test(isotope_subset_no_food_sources$d13C) #0.169
leveneTest(data=isotope_subset_no_food_sources, d13C~Site*FFG*Stage) #0.334
hist(isotope_subset_no_food_sources$d13C) #looks normal
plot(isotope_subset_no_food_sources$d13C) #looks evenly spread

C_FFG_1<-lm(data=isotope_subset_no_food_sources, d13C~Site*FFG*Stage)
Anova(C_FFG_1, type=3) #Error in Anova.III.lm(mod, error, singular.ok = singular.ok, ...) : there are aliased coefficients in the model. Probably due to 2 of the stages only having one FFG level?

plot(C_FFG_1)

C_FFG_1_emm<-emmeans(C_FFG_1, ~ Site | Stage | FFG)
pairs(C_FFG_1_emm, simple="each")


#### Aquatic Larvae ####

isotope_aq_lar<-subset(isotope_subset_no_food_sources, Stage=="Aquatic larvae")
shapiro.test(isotope_aq_lar$d13C) #0.087 #normal distribution
leveneTest(data=isotope_aq_lar, d13C~Site*FFG) #0.653, homogeneity of variance
hist(isotope_aq_lar$d13C) #looks decently normal, slightly right skewed
plot(isotope_aq_lar$d13C) #data looks evenly spread

summary(C_lar_FFG_1<-lm(data=isotope_aq_lar, d13C~FFG*Site, na.action = na.exclude)) #No interactions btw FFG and Site, run each FFG separately
Anova(C_lar_FFG_1, type=3) #Aliased coefficients, run FFG separately

# Scrapers 

isotope_lar_scrapers<-subset(isotope_aq_lar, FFG=="Scraper")

shapiro.test(isotope_lar_scrapers$d13C) #0.890 normal distribution
leveneTest(data=isotope_lar_scrapers, d13C~Site) #0.935, homogeneity of variance
hist(isotope_lar_scrapers$d13C) #looks normal-ish
plot(isotope_lar_scrapers$d13C) #data looks evenly spread

summary(C_lar_scraper<-aov(data=isotope_lar_scrapers, d13C~Site, na.action = na.exclude)) #p=0.005
Anova(C_lar_scraper, type=3) #p=0.005

emmeans(C_lar_scraper, pairwise ~ Site)

plot(C_lar_scraper) #Adheres to assumptions

# Gatherer - Collector

isotope_lar_gath<-subset(isotope_aq_lar, FFG=="Gatherer-Collector")

shapiro.test(isotope_lar_gath$d13C) #0.188 normal distribution
leveneTest(data=isotope_lar_gath, d13C~Site) #0.344, homogeneity of variance
hist(isotope_lar_gath$d13C) #looks potentially a bit right skewed
plot(isotope_lar_gath$d13C) #data looks evenly spread

summary(C_lar_gath<-aov(data=isotope_lar_gath, d13C~Site, na.action = na.exclude)) #p < 0.001
Anova(C_lar_gath, type=3) #p<0.001

emmeans(C_lar_gath, pairwise ~ Site)

plot(C_lar_gath) #Adheres to assumptions


# Predator

isotope_lar_pred<-subset(isotope_aq_lar, FFG=="Predator")

shapiro.test(isotope_lar_pred$d13C) #0.0071 not normal distribution
leveneTest(data=isotope_lar_pred, d13C~Site) #0.396, homogeneity of variance
hist(isotope_lar_pred$d13C) #not very normal
plot(isotope_lar_pred$d13C) #not evenly spread

kruskal.test(data=isotope_lar_pred, d13C~Site) #p=0.068
dunnTest(data=isotope_lar_pred, d13C~Site) #no differences

summary(C_lar_pred<-aov(data=isotope_lar_pred, d13C~Site, na.action = na.exclude)) #p = 0.111
Anova(C_lar_pred, type=3) #p=0.111

emmeans(C_lar_pred, pairwise ~ Site) #no diff

plot(C_lar_pred) #Adheres to assumptions

#### Aquatic Adults ####

isotope_aq_ad<-subset(isotope_subset_no_food_sources, Stage=="Aquatic adult")
shapiro.test(isotope_aq_ad$d13C) #0.435 normal distribution
leveneTest(data=isotope_aq_ad, d13C~Site*FFG) #0.535, homogeneity of variance
hist(isotope_aq_ad$d13C) #looks decently normal, potentially uniform-ish?
plot(isotope_aq_ad$d13C) #data looks evenly spread

summary(C_ad_FFG_1<-aov(data=isotope_aq_ad, d13C~FFG*Site, na.action = na.exclude)) #No interactions btw FFG and Site, run FFGs separately
Anova(C_ad_FFG_1, type=3) #Error in Anova.III.lm(mod, error, singular.ok = singular.ok, ...) : there are aliased coefficients in the model. Run FFGs separately

# Gatherer - Collector

isotope_ad_gath<-subset(isotope_aq_ad, FFG=="Gatherer-Collector")
shapiro.test(isotope_ad_gath$d13C) #0.755 normal distribution
leveneTest(data=isotope_ad_gath, d13C~Site) #0.959, homogeneity of variance
hist(isotope_ad_gath$d13C) #looks normal
plot(isotope_ad_gath$d13C) #data looks evenly spread

summary(C_ad_gath<-aov(data=isotope_ad_gath, d13C~Site, na.action = na.exclude)) #p=0.14
Anova(C_ad_gath, type=3) #p=0.14
emmeans(C_ad_gath, pairwise ~ Site) #no differences

# Filterer - Collector

isotope_ad_filt<-subset(isotope_aq_ad, FFG=="Filterer-Collector")
shapiro.test(isotope_ad_filt$d13C) #0.285 normal distribution
leveneTest(data=isotope_ad_filt, d13C~Site) #0.242, homogeneity of variance
hist(isotope_ad_filt$d13C) #Doesn't really look normal
plot(isotope_ad_filt$d13C) #data not evenly spread

summary(C_ad_filt<-aov(data=isotope_ad_filt, d13C~Site, na.action = na.exclude)) #p < 0.001
Anova(C_ad_filt, type=3) #p<0.001
emmeans(C_ad_filt, pairwise ~ Site) #no differences


# Predator

isotope_ad_pred<-subset(isotope_aq_ad, FFG=="Predator")
shapiro.test(isotope_ad_pred$d13C) #0.943 normal distribution
leveneTest(data=isotope_ad_pred, d13C~Site) #0.255, homogeneity of variance
hist(isotope_ad_pred$d13C) #Sort of normal
plot(isotope_ad_pred$d13C) #data evenly spread

summary(C_ad_pred<-aov(data=isotope_ad_pred, d13C~Site, na.action = na.exclude)) #p = 0.066
Anova(C_ad_pred, type=3) #p = 0.066
emmeans(C_ad_pred, pairwise ~ Site) #no differences

plot(C_ad_pred)


#### Terrestrial adults ####

isotope_terr_ad<-subset(isotope_subset_no_food_sources, Stage=="Terrestrial adult")
shapiro.test(isotope_terr_ad$d13C) #0.431 normal distribution
leveneTest(data=isotope_terr_ad, d13C~Site*FFG) #0.877, homogeneity of variance
hist(isotope_terr_ad$d13C) #looks uniform
plot(isotope_terr_ad$d13C) #data looks evenly spread

summary(C_terr_ad<-lm(data=isotope_terr_ad, d13C~Site, na.action = na.exclude))
Anova(C_terr_ad, type=3) #Not significantly different

plot(C_terr_ad) #Fits assumptions of ANOVA/lm pretty well

pairs(emmeans(C_terr_ad, ~Site)) #No differences


#### Spiders ####

isotope_spiders<-subset(isotope_subset_no_food_sources, Stage=="Spider")
shapiro.test(isotope_spiders$d13C) #0.275 normal distribution
leveneTest(data=isotope_spiders, d13C~Site*FFG) #0.130, homogeneity of variance
hist(isotope_spiders$d13C) #looks decently normal
plot(isotope_spiders$d13C) #data have a non-random pattern

summary(C_spiders<-lm(data=isotope_spiders, d13C~Site, na.action = na.exclude))
Anova(C_spiders, type=3)

plot(C_spiders) #Fits assumptions of ANOVA/lm pretty well


emm.spiders.c<-emmeans(C_spiders, ~ Site)
pairs(emm.spiders.c, simple="each")

```

# Combining C and N boxplot across sites 

```{r}
C_plot_lar<-C_plot_taxa_subset_no_food_sources + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank())
N_plot_lar<-N_plot_taxa_subset_no_food_sources + theme(axis.title.x = element_blank())

C_N_combined<-ggarrange(C_plot_lar, N_plot_lar, nrow=2, ncol=1, align="v")

annotate_figure(C_N_combined, bottom = textGrob("Site", gp = gpar(cex = 1.6)))

#ggsave(filename="stable_isotope_analysis/Figures/C and N across FFG and sites no food sources.png", height=14, width=26, bg="white")
```


# Mean +/- SD C vs N of inverts across sites with basal food source median values graph

```{r}
#### Carbon ####

isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")

isotope_subset$Site<-factor(isotope_subset$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

isotope_biofilm<-subset(isotope_subset, Taxa=="Biofilm")

isotope_biofilm_C<-isotope_biofilm %>%
  dplyr::select("Site", "d13C")%>%
  group_by(Site)%>%
  summarise(MedianC = median(d13C))

isotope_leaves<-subset(isotope_subset, Taxa=="Terrestrial Leaves")

isotope_leaves_C<-isotope_leaves %>%
  dplyr::select("Site", "d13C")%>%
  group_by(Site)%>%
  summarise(MedianC = median(d13C))


isotope_subset_no_food_sources_C<-isotope_subset_no_food_sources%>%
  dplyr::select("Site", "FFG","Taxa_Specific", "d13C")%>%
  group_by(Site, FFG, Taxa_Specific)%>%
  summarise(MeanC = mean(d13C), sdC = sd(d13C))

Ylims_C<-aes(ymax=MeanC + sdC, ymin=MeanC-sdC)

isotope_subset_no_food_sources_C$Taxa_Specific<-factor(isotope_subset_no_food_sources_C$Taxa_Specific, levels=c("Chironomidae Larvae", "Chloroperlidae Larvae", "Ephemerellidae Larvae", "Heptageniidae Larvae", "Perlidae Larvae", "Chironomidae Adult", "Chloroperlidae Adult", "Ephemerellidae Adult", "Hydropsychidae Adult", "Lepidoptera Adult", "Leptoceridae Adult", "Rhyacophilidae Adult", "Araneidae", "Tetragnathidae"))

C_reliance_graph<-ggplot(isotope_subset_no_food_sources_C, aes(x=FFG, y=MeanC, shape=FFG, color=Taxa_Specific))+
  geom_point(size=6)+
  facet_grid(~Site)+
  theme_bw() +
  rremove("grid")+
  geom_errorbar(Ylims_C)+
   labs(shape="Functional Feeding Group", colour="Invertebrate Taxa")+
  geom_hline(data=isotope_biofilm_C, aes(yintercept=MedianC), linetype='dashed', color='red', linewidth=1)+ #Biofilm
  geom_hline(data=isotope_leaves_C, aes(yintercept=MedianC), linetype='dashed', color='blue', linewidth=1)+ #leaves
  ylab(expression(paste(delta^13, "C (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=20, color="black"), axis.text.x=element_blank(), axis.ticks.x = element_blank(), axis.title = element_text(size=22, color="black"), strip.text.x = element_text(size=20, color="black"), legend.text = element_text(size=20), legend.title = element_text(size=22, color="black"))+
  scale_color_manual(values=c( '#800000', '#e6194B', '#f58231','#ffe119', '#aaffc3', '#3cb44b', '#469990', '#42d4f4', '#4363d8', '#000075', '#dcbeff', '#f032e6', '#fabed4', '#9A6324'))+
  scale_shape_manual(values=c(16, 17, 15, 18, 7))
C_reliance_graph


#### Nitrogen ####

isotope_subset<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\stable_isotope_analysis\\StableIsotope2022_subset.csv")

isotope_subset$Site<-factor(isotope_subset$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

isotope_biofilm<-subset(isotope_subset, Taxa=="Biofilm")

isotope_biofilm_N<-isotope_biofilm %>%
  dplyr::select("Site", "d15N")%>%
  group_by(Site)%>%
  summarise(MedianN = median(d15N))

isotope_leaves<-subset(isotope_subset, Taxa=="Terrestrial Leaves")

isotope_leaves_N<-isotope_leaves %>%
  dplyr::select("Site", "d15N")%>%
  group_by(Site)%>%
  summarise(MedianN = median(d15N))


isotope_subset_no_food_sources_N<-isotope_subset_no_food_sources%>%
  dplyr::select("Site", "FFG","Taxa_Specific", "d15N")%>%
  group_by(Site, FFG, Taxa_Specific)%>%
  summarise(MeanN = mean(d15N), sdN = sd(d15N))

Ylims_N<-aes(ymax=MeanN + sdN, ymin=MeanN-sdN)

isotope_subset_no_food_sources_N$Taxa_Specific<-factor(isotope_subset_no_food_sources_N$Taxa_Specific, levels=c("Chironomidae Larvae", "Chloroperlidae Larvae", "Ephemerellidae Larvae", "Heptageniidae Larvae", "Perlidae Larvae", "Chironomidae Adult", "Chloroperlidae Adult", "Ephemerellidae Adult", "Hydropsychidae Adult", "Lepidoptera Adult", "Leptoceridae Adult", "Rhyacophilidae Adult", "Araneidae", "Tetragnathidae"))


N_reliance_graph<-ggplot(isotope_subset_no_food_sources_N, aes(x=FFG, y=MeanN, shape=FFG, color=Taxa_Specific))+
  geom_point(size=6)+
  facet_grid(~Site)+
  theme_bw() +
  rremove("grid")+
  geom_errorbar(Ylims_N)+
   labs(shape="Functional Feeding Group", colour="Invertebrate Taxa")+
  geom_hline(data=isotope_biofilm_N, aes(yintercept=MedianN), linetype='dashed', color='red', linewidth=1)+ #Biofilm
  geom_hline(data=isotope_leaves_N, aes(yintercept=MedianN), linetype='dashed', color='blue', linewidth=1)+ #leaves
  ylab(expression(paste(delta^15, "N (\u2030)", sep="")))+
  theme(axis.text.y = element_text(size=20, color="black"), axis.text.x=element_blank(), axis.ticks.x = element_blank(), axis.title = element_text(size=22, color="black"), strip.text.x = element_text(size=20, color="black"), legend.text = element_text(size=20), legend.title = element_text(size=22, color="black"))+
  scale_color_manual(values=c( '#800000', '#e6194B', '#f58231','#ffe119', '#aaffc3', '#3cb44b', '#469990', '#42d4f4', '#4363d8', '#000075', '#dcbeff', '#f032e6', '#fabed4', '#9A6324'))+
scale_shape_manual(values=c(16, 17, 15, 18, 7))
 
N_reliance_graph


#### Combining C and N graphs ####

C_reliance<-C_reliance_graph + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) + theme(legend.position="none")
N_reliance<-N_reliance_graph + theme(axis.title.x = element_blank(), legend.position="right")

C_N_combined_reliance<-ggarrange(C_reliance, N_reliance, nrow=2, ncol=1, align="v", common.legend = T, legend = "right")

C_N_combined_reliance 

#ggsave(filename="stable_isotope_analysis/Figures/C and N reliance graph.png", height=12, width=20, bg="white")
```


# Table of mean d13C and d15N values (+/- SD) across sites and sample type 

```{r}
#Grouped by individual taxa and sample type

C_N_sum_tab<-isotope_subset_no_food_sources %>% 
  dplyr::select("Taxa", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(Taxa, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(C_N_sum_tab)
#Some taxa don't have enough replicates

#Grouped by Functional Feeding Group and sample type

summary_FFG<-isotope_subset_no_food_sources %>% 
  dplyr::select("FFG", "Stage", "d13C", "d15N", "Site")%>%
  dplyr::group_by(FFG, Stage, Site) %>%
  dplyr::summarise(MeanC = mean(d13C), sdC = sd(d13C), MeanN = mean(d15N), sdN = sd(d15N), n = n())

View(summary_FFG)
```

# Running MixSIAR model

```{r}
#Running model with primary consumers and basal food sources

#Make sure the data is a comma delimited file because it gets very fussy about the file type
mix<-load_mix_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\primary_consumers.csv", 
                   iso_names=c("d13C","d15N"), 
                   factors=c("Site","Taxa"), 
                   fac_random=c(FALSE,FALSE), 
                   fac_nested = c(FALSE, FALSE),
                   cont_effects=NULL)

source<-load_source_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_sources.csv",
                         source_factors = "Site",
                         conc_dep = FALSE, 
                         data_type = "means",
                         mix)

discr<-load_discr_data(filename="C:\\Users\\Emilie\\Documents\\McMaster University 2022-2024\\Bow River Thesis\\BowRiverRProject\\Stable_isotope_ED\\isotope_tef.csv", mix)

#isospace plot
plot_data(filename="isospace_plot", plot_save_pdf = F, plot_save_png = F, mix, source, discr)

#default uninformative/generalist prior (alpha=1)
plot_prior(alpha.prior = c(1), source)

#Informative prior
plot_prior(alpha.prior = c(0.5, 1), source)

#How do you know which weighting to use? Seems like the inverts consume a more terrestrial source so should I weight it higher?

#JAGS model file
model_filename<-"MixSIAR_model.txt"
resid_err<-TRUE
process_err<-TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)
output_options = list(summary_save = FALSE, summary_name = "summary_statistics.txt",
    sup_post = FALSE, plot_post_save_pdf = FALSE, plot_post_name = "posterior_density",
    sup_pairs = FALSE, plot_pairs_save_pdf = FALSE, plot_pairs_name = "pairs_plot", sup_xy
    = FALSE, plot_xy_save_pdf = FALSE, plot_xy_name = "xy_plot", gelman = TRUE, heidel =
    FALSE, geweke = TRUE, diag_save = FALSE, diag_name = "diagnostics.txt", indiv_effect =
    FALSE, plot_post_save_png = FALSE, plot_pairs_save_png = FALSE, plot_xy_save_png =
    FALSE, diag_save_ggmcmc = FALSE)

#Running real model with 'normal' chain length and burn-in.
run<-list(chainLength=100000, burn=50000, thin=50, chains=3, calcDIC=TRUE)
jags<-run_model(run, mix, source, discr, model_filename, alpha.prior = 1, resid_err, process_err)
output_JAGS(jags, mix, source, output_options)


#Running model with secondary consumers and primary consumers as the food source

```
