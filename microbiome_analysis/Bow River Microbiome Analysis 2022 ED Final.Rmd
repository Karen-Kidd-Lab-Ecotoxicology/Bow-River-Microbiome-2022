---
title: "Bow River Microbiome Analysis 2022"
author: "Emilie Diesbourg"
date: "26/05/2023"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Introduction {.tabset}

This data comes from a study done in 2022 across 5 sites on the Bow River, Calgary AB and 3 microcosm streams from Pine Creek wastewater treatment plant with varying municipal wastewater effluent exposures (mesocosm streams: 0, 5, or 15% effluent additions). The objective of this study is to determine whether there are changes to the microbiome of freshwater macroinvertebrates and riparian Spiders with increased exposure to wastewater as well as any differences across taxa or whether the microbiome is retained across metamorphosis. 

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
#Change margin size to be smaller so graphs fit in the plot panel
par(mar = c(2, 2, 2, 2)) # Set the margin on all sides to 2
```

## Loading Packages
```{r Load packages}
library(rlang)
library(glue)
library(ggh4x)
#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")
#BiocManager::install("phyloseq")
library(phyloseq) #phyloseq will be the main package used for structuring microbiome data and diversity comparisons
#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")
#install.packages("viridis")
library(viridis)

#BiocManager::install("apeglm")
library(apeglm)
library(geosphere)
library(car)
library(ggplot2) #For creating graphs
#install.packages("ggtext")
library(ggtext)
library(dplyr) #Helps with data wrangling 
library(cluster) #Used for cluster analyses
library(grid)
library(ape)
library(pals)
library(FSA)
library(multcomp)
library(MASS)
library(glmmTMB)
library(gridExtra)
library(vegan)
library(tidyverse) #data wrangling
#if (!require("BiocManager", quietly = TRUE)) #Installing microbiome package
  #install.packages("BiocManager")
#BiocManager::install("microbiome")
library(microbiome) #For microbiome analyses
#if(!requireNamespace("BiocManager", quietly = TRUE))
  #install.packages("BiocManager")
#BiocManager::install("PERFect")
library(PERFect) #Permutation filtration for microbiome data. Used when comparing beta diversities across sites/locations. 
library(knitr) #For R Markdown knitting
library(kableExtra)
#if (!requireNamespace("remotes", quietly = TRUE))
  #install.packages("remotes")
#remotes::install_github("mikemc/speedyseq")
library(speedyseq)
library(colorspace)
library(RColorBrewer)
library(picante)
library(ggpubr)
library(data.table)
library(AICcmodavg)
#devtools::install_github("microsud/microbiomeutilities")
library(microbiomeutilities)
library(imsig)
library(phangorn) #For phylogenetic tree
library(metacoder) 
library(tibble)
#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")

#BiocManager::install("DESeq2")
library(DESeq2)
library(emmeans)
library(devtools)
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", force=TRUE)
library(pairwiseAdonis)
#library(plyr) apparently if you load this after dpylr it messes up the summarize function?

#if( !require(NbClust) ){install.packages("NbClust"); library(NbClust)}
#if( !require(cobiclust) ){install.packages("cobiclust"); library(cobiclust)}
library(NbClust)
library(cobiclust)
#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")

#BiocManager::install("mia")
library(mia)
library(factoextra)
#install.packages("microViz", repos = c(davidbarnett = "https://david-barnett.r-universe.dev", getOption("repos")))
library(microViz)
library(dendextend) #Formatting dendrograms
#remotes::install_github("vmikk/metagMisc")
library(metagMisc)
#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")

#BiocManager::install("decontam")
library(decontam)
#if (!requireNamespace("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")
#BiocManager::install("dada2", version = "3.17")
library(dada2)
library(forcats)
#install.packages(c("dbplyr", "dplyr", "dtplyr", "haven", "httr", "jsonlite", "readr", 
#"readxl", "rvest", "tibble", "tidyr", "xml2"))
library(ggpubr)
#install.packages("remotes")
#remotes::install_github("kstagaman/phyloseqCompanion")
library(phyloseqCompanion)
#if (!requireNamespace("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")
#BiocManager::install("ANCOMBC")
library(ANCOMBC)
#devtools::install_github("Russel88/DAtest")
library(DAtest)
#remotes::install_github("Russel88/MicEco")
library(MicEco)
library(readxl)
```

# Phyloseq object

For a phyloseq object you need 3 pieces of data: 

1. The ASV table with the genetic barcode identifier (the ASV) of each identified bacterial taxa within each insect sample ran (ex. KK100)

2. The taxa table with the genetic barcode of each unique ASV and the respective bacterial classification "Kingdom", "Phylum", "Class", "Order", "Family", "Genus".

3. A metadata file with the sample names (ex. KK100) and any other variables that were measured. Ex. the family of insect or fish organism collected, the site the organism was collected at, the water temperature, the distance to waste water treatment plant, the weight and length of organism, etc.

The phyloseq object will merge all this data together in one object that can be called in by various functions in the phyloseq and microbiome packages. 

```{r Load data and phyloseq object}
#Importing ASV table
ASVseq<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\microbiome_analysis\\Raw data\\ASV_data_2022_ED_fulldataset_samplesordered.csv")

#The row names have to be the ASV identifier (genetic barcode) in order for it to be read. The following lines of code are to re-organize the row names
n1 <- ASVseq$X #Currently the ASVs are being called "X" in the first column. We want them to be unnamed in the row names column
ASVseq <- ASVseq[,-1] #This removes the first column of the ASV dataframe
rownames(ASVseq) <- n1 #This moves the ASVs to the rownames column of the dataframe

ASVtable <- as.matrix(ASVseq) #must be a matrix so we convert to a matrix
#View(ASVtable) #The ASVs are now the row names

#Importing taxa table
taxonomy <-read.csv ("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\microbiome_analysis\\Raw data\\Taxonomy_ED_2022_fulldataset.csv")

#Using the same steps as above with the ASV table to make the genetic barcode the rowname
n2 <- taxonomy$X
taxonomy <- taxonomy[,-1]
rownames(taxonomy) <- n2

taxa_table<-as.matrix(taxonomy) #Turn into a matrix
#View(taxa_table) #ASVs are now the row names

#Importing metadata file
metadata<-read.csv("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\microbiome_analysis\\Raw data\\metadata_noKK2078_samples_ordered.csv")

metadata$Site<-factor(metadata$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats", "BRR2", "PCR1", "PCR3")) #Order sites
metadata$Site_code<-factor(metadata$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF", "BRR2", "PCR1", "PCR3")) #Order sites
metadata$Stage<-factor(metadata$Stage, levels=c("Larvae", "Adults", "Spiders"))

#Need to make sample names as row names so we follow the same steps as above. 
n3 <- metadata$Study_ID

# move names to row headings
metadata <- metadata[,-1]
rownames(metadata) <- n3

#View(metadata) #sample names are now row names

#Combining phyloseq object
ASVtable = otu_table(ASVtable, taxa_are_rows = TRUE) #Taxa are rows means that the ASVs of each identified microbe are the row names which we made sure was true
taxa_table = tax_table(taxa_table)

#Make sure the ASV table and taxa table are both matricies before trying to turn into phyloseq object
ps <- phyloseq(ASVtable, sample_data(metadata), taxa_table)
```


# Filtering/pre-processing steps {.tabset}

Experimental samples:

Removing low confidence data: I removed all ASVs identified as Eukaryota and phyla that were identified as <NA>. This removed 39 and 403 taxa respectively. 

Removing low abundance taxa (including singletons and doubletons): I removed taxa whose sums of reads were less than or equal to 6 across all samples.  

Removing low prevalence taxa: I removed taxa that were only found in less than 4 samples. 

Removing low read samples: I removed all samples whose total reads were less than 2000. 

Rarefying: Results from statistical analysis (alpha and beta diversity) will be compared before and after rarefying to the minimum sampling depth. The minimum even sampling depth is 2283 reads (the lowest read count after filtering). If there is no difference in results, other methods of normalization will be used (i.e., transform to relative abundances or log transformation) besides rarefaction since it removes a large portion of the data. 

In total, ~85 % of the taxa (ASVs) were filtered out but only 0.32 % of the entire dataset (reads) were filtered out from the original decontaminated dataset. This may have consequences for diversity measures but ensures sequencing errors and potential contaminants are removed. 

### Decontamination Steps using 'Decontam'
```{r}
## Subsetting the blanks from each invert collection method and decontaminating with a threshold of 0.1 and merging them back together ##

ps #31,556 taxa, 380 samples

## Adult mayfly from ACWA ##

ad_mesh_bl<-subset_samples(ps, Blank_collection_method=="Mesh") #Subsets all mayflies and blanks that were collected from the floating emergence traps
ad_mesh_bl<-prune_taxa(taxa_sums(ad_mesh_bl) > 0, ad_mesh_bl)
ad_mesh_bl #837 taxa, 19 samples

#Decontam steps for removing floating emergence trap contaminants from ACWA adult mayflies
ad_mesh_bl_df <- as.data.frame(sample_data(ad_mesh_bl))

sample_data(ad_mesh_bl)$is.neg <- sample_data(ad_mesh_bl)$Sample_Type == "Blank" #Specifies that the negative control are the blank samples
contamdf.prev.ad.mesh <- isContaminant(ad_mesh_bl, method="prevalence", neg="is.neg", threshold=0.1)
#Runs the decontamination with a threshold of 0.1. 
hist(contamdf.prev.ad.mesh$p) 
table(contamdf.prev.ad.mesh$contaminant)
#FALSE = 822, TRUE=15. Identifies 15 potential contaminants.

#Prune samples to get rid of contaminants and continue with filtering steps
ps.noncontam.ad.mesh <- prune_taxa(!contamdf.prev.ad.mesh$contaminant, ad_mesh_bl) #Keeps the 822 taxa that were not ID as contaminants
ps.noncontam.ad.mesh 


## Larvae from ACWA ##

lar_ACWA_bl<-subset_samples(ps, Blank_collection_method=="Water September")
lar_ACWA_bl<-prune_taxa(taxa_sums(lar_ACWA_bl) > 0, lar_ACWA_bl)
lar_ACWA_bl #6556 taxa, 42 samples

#Decontam steps for removing floating emergence trap contaminants from ACWA adult mayflies
lar_ACWA_bl_df <- as.data.frame(sample_data(lar_ACWA_bl))

sample_data(lar_ACWA_bl)$is.neg <- sample_data(lar_ACWA_bl)$Sample_Type == "Blank" 
contamdf.prev.lar.ACWA <- isContaminant(lar_ACWA_bl, method="prevalence", neg="is.neg", threshold=0.1)
 
table(contamdf.prev.lar.ACWA$contaminant)
#Threshold of 0.1: FALSE = 6517, TRUE=39

#Prune samples to get rid of contaminants and continue with filtering steps
ps.noncontam.lar.ACWA <- prune_taxa(!contamdf.prev.lar.ACWA$contaminant, lar_ACWA_bl)
ps.noncontam.lar.ACWA #6517 taxa and 42 samples


## Adults from Bow River ##

ad_Bow_bl<-subset_samples(ps, Blank_collection_method=="Sheet")
ad_Bow_bl<-prune_taxa(taxa_sums(ad_Bow_bl) > 0, ad_Bow_bl)
ad_Bow_bl #9877 taxa, 107 samples

#Decontam steps for removing floating emergence trap contaminants from ACWA adult mayflies
ad_Bow_bl_df <- as.data.frame(sample_data(ad_Bow_bl))

sample_data(ad_Bow_bl)$is.neg <- sample_data(ad_Bow_bl)$Sample_Type == "Blank" 
contamdf.prev.ad.Bow <- isContaminant(ad_Bow_bl, method="prevalence", neg="is.neg", threshold=0.1)
 
table(contamdf.prev.ad.Bow$contaminant)
# FALSE = 9552, TRUE=325

#Prune samples to get rid of contaminants and continue with filtering steps
ps.noncontam.ad.Bow <- prune_taxa(!contamdf.prev.ad.Bow$contaminant, ad_Bow_bl)
ps.noncontam.ad.Bow #9552 taxa and 107 samples

#Adult caddis at Policeman Flats need to be decontaminated with extraction reagents too since they were on the last extraction plate that was contaminated from the lab
contam.caddis<-subset_samples(ps.noncontam.ad.Bow, Sample_ID %in% c("POLFLT_1_Ad_Caddis_MB_2", "POLFLT_1_Ad_Caddis_MB_3", "POLFLT_1_Ad_Caddis_MB_4", "POLFLT_1_Ad_Caddis_MB_5", "POLFLT_1_Ad_Caddis_MB_6", "POLFLT_1_Ad_Caddis_MB_7", "POLFLT_1_Ad_Caddis_MB_8"))

#Separate extraction reagents so I can combine the POLFLT caddis dataframe together
ext.reag<-subset_samples(ps, Blank_collection_method=="Extraction_neg_4")
#Merge them together
polflt.caddis<-merge_phyloseq(contam.caddis, ext.reag)

sample_data(polflt.caddis)$is.neg <- sample_data(polflt.caddis)$Sample_Type == "Blank"
contamdf.prev.caddis <- isContaminant(polflt.caddis, method="prevalence", neg="is.neg", threshold=0.1)

table(contamdf.prev.caddis$contaminant)
#Threshold of 0.1: FALSE = 31,523, TRUE=33

#Prune samples to get rid of contaminants and continue with filtering steps
ps.noncontam.caddis <- prune_taxa(!contamdf.prev.caddis$contaminant, polflt.caddis)
ps.noncontam.caddis #31,523 taxa and 9 samples

ps.noncontam.caddis<-subset_samples(ps.noncontam.caddis, Sample_Type!="Blank")
nsamples(ps.noncontam.caddis) #7

ps.noncontam.ad.Bow <- subset_samples(ps.noncontam.ad.Bow, Sample_ID != "POLFLT_1_Ad_Caddis_MB_2" & Sample_ID != "POLFLT_1_Ad_Caddis_MB_3" & Sample_ID !="POLFLT_1_Ad_Caddis_MB_4" & Sample_ID != "POLFLT_1_Ad_Caddis_MB_5" & Sample_ID !="POLFLT_1_Ad_Caddis_MB_6" & Sample_ID !="POLFLT_1_Ad_Caddis_MB_7" & Sample_ID != "POLFLT_1_Ad_Caddis_MB_8")


## Larvae Bow River ##

lar_Bow_bl<-subset_samples(ps, Blank_collection_method=="Water July")
lar_Bow_bl<-prune_taxa(taxa_sums(lar_Bow_bl) > 0, lar_Bow_bl)
lar_Bow_bl #16688 taxa, 122 samples

#Decontam steps for removing floating emergence trap contaminants from ACWA adult mayflies
lar_Bow_bl_df <- as.data.frame(sample_data(lar_Bow_bl))

sample_data(lar_Bow_bl)$is.neg <- sample_data(lar_Bow_bl)$Sample_Type == "Blank" 
contamdf.prev.lar.Bow <- isContaminant(lar_Bow_bl, method="prevalence", neg="is.neg", threshold=0.1)
 
table(contamdf.prev.lar.Bow$contaminant)
#Threshold of 0.1: FALSE = 16629, TRUE=59

#Prune samples to get rid of contaminants and continue with filtering steps
ps.noncontam.lar.Bow <- prune_taxa(!contamdf.prev.lar.Bow$contaminant, lar_Bow_bl)
ps.noncontam.lar.Bow 


## All data merged back together ##

#Rest of data that wasn't decontaminated
rest_of_data<-subset_samples(ps, Blank_collection_method == "No_blank")
rest_of_data<-prune_taxa(taxa_sums(rest_of_data) > 0, rest_of_data)
rest_of_data #4026 taxa, 80 samples (spiders)
#Merge back together
final_merge<-merge_phyloseq(ps.noncontam.ad.mesh, ps.noncontam.ad.Bow, ps.noncontam.lar.ACWA, ps.noncontam.lar.Bow, rest_of_data)

decontam_sample_ps<-subset_samples(final_merge, Sample_Type == "Sample") 

decontam_sample_ps_0 <- subset_taxa(decontam_sample_ps, Kingdom != "Eukaryota")

decontam_sample_ps_1<-subset_taxa(decontam_sample_ps_0, !is.na(Phylum) & !Phylum %in% c("","uncharacterized")) 

decontam_sample_ps_2<-ps_prune(decontam_sample_ps_1, min.samples = 4, min.reads = 6)

decontam_ps <- subset_samples(decontam_sample_ps_2, sample_sums(decontam_sample_ps_2) > 2000) 
decontam_ps #4521 taxa, 339 samples. 
#Removed 43 potential contaminants from original dataset.
```

### Removing low confidence taxa
```{r}
#Need to remove PMF adult caddis because they were contaminated with contaminated laboratory reagents.
samples_to_remove<-c("POLFLT_1_Ad_Caddis_MB_1", "POLFLT_1_Ad_Caddis_MB_2", "POLFLT_1_Ad_Caddis_MB_3", "POLFLT_1_Ad_Caddis_MB_4", "POLFLT_1_Ad_Caddis_MB_5", "POLFLT_1_Ad_Caddis_MB_6", "POLFLT_1_Ad_Caddis_MB_7", "POLFLT_1_Ad_Caddis_MB_8")

ps_pruned<-subset_samples(ps, !(Sample_ID %in% samples_to_remove))
ps_pruned<-prune_taxa(taxa_sums(ps_pruned) > 0, ps_pruned)
ps_pruned #31,185 taxa, 372 samples


#Subsetting experimental samples only from the decontaminanted phyloseq object
psexp<-subset_samples(ps_pruned, Sample_Type == "Sample") #Removing ASVs where the abundance is 0 (after removing the blank samples)
psexp<-prune_taxa(taxa_sums(psexp) > 0, psexp)
psexp #30,218 taxa and 349 samples

#Removing Eukaryotes
ps0 <- subset_taxa(psexp, Kingdom != "Eukaryota")
ntaxa(psexp)-ntaxa(ps0) #Got rid of 39 ASVs

#Removing low confidence data (where phylum could not be assigned)
table(tax_table(ps0)[,"Phylum"],exclude=NULL)
ps1<-subset_taxa(ps0, !is.na(Phylum) & !Phylum %in% c("","uncharacterized")) #Removes the phyla characterized as NA
ntaxa(ps0) - ntaxa(ps1) #Got rid of 403 ASVs
ps1 #29,776 taxa, 349 samples
sort(sample_sums(ps1)) #Reads/sample range from 59 - 222,956
```

### Finding a good prevalence threshold
```{r}

##Prevalence threshold pruning ##
#Define prevalence of each taxa (in how many samples did each taxa appear at least once)
#2%
prev0 = apply(X = otu_table(sample_ps),
                MARGIN = ifelse(taxa_are_rows(sample_ps), yes = 1, no = 2),
                FUN = function(x){sum(x > 0)})
prevdf = data.frame(Prevalence = prev0,
                      TotalAbundance = taxa_sums(sample_ps),
                      tax_table(sample_ps))
keepPhyla = table(prevdf$Phylum)[(table(prevdf$Phylum) > 2)] #Keeping phyla with a prevalence greater than 2
prevdf1 = subset(prevdf, Phylum %in% names(keepPhyla))
# Define prevalence threshold as 2% of total samples
prevalenceThreshold = 0.02 * nsamples(sample_ps)
prevalenceThreshold #We are keeping phyla that occur at least 6.78 samples (2% of samples) with a prevalence of 2 or greater 

psprune = prune_taxa((prev0 > prevalenceThreshold), sample_ps)
psprune #2811 taxa. Cut out a very large portion of the data. Probably too high of a threshold.  

reads_pruned <- taxa_sums(psprune)
print(sum(reads_pruned)) #12,297,605 total reads left after pruning
(1-(sum(reads_pruned))/(sum(reads_per_OTU)))*100 #6.27% of the total read data was removed by pruning. A decently large portion of the data was cut out from additional pruning

#Graphs prevalence of each bacterial Phylum with dotted line indicating the prevalence threshold so you get an idea of how much data would be lost.
ggplot(prevdf1, aes(TotalAbundance, Prevalence, color = Phylum)) +
  geom_hline(yintercept = prevalenceThreshold, alpha = 0.5, linetype = 2) +
  geom_point(size = 2, alpha = 0.7) +
  scale_y_log10() + scale_x_log10() +
  xlab("Total Abundance") +
  facet_wrap(~Phylum)
#Prevalence threshold looks too high, cutting out a lot of the variation in microbial communities. I will try a lower threshold value. 


#Lowering the prevalence threshold to 1%

# Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev1 = apply(X = otu_table(sample_ps),
                MARGIN = ifelse(taxa_are_rows(sample_ps), yes = 1, no = 2),
                FUN = function(x){sum(x > 0)})
prevdf2 = data.frame(Prevalence = prev1,
                      TotalAbundance = taxa_sums(sample_ps),
                      tax_table(sample_ps))
keepPhyla1 = table(prevdf2$Phylum)[(table(prevdf2$Phylum) > 2)]
prevdf3 = subset(prevdf2, Phylum %in% names(keepPhyla))
# Define prevalence threshold as 5% of total samples
prevalenceThreshold1 = 0.01 * nsamples(sample_ps)
prevalenceThreshold1 #3.39. Present in at least 3.39 samples (round up to 4)

psprune1 = prune_taxa((prev1 > prevalenceThreshold1), sample_ps)
psprune1 #4556 taxa. Still a very large percentage of taxa removed but we need to look at the amount of total reads removed to understand the implications to the data.

reads_pruned1 <- taxa_sums(psprune1)
print(sum(reads_pruned1)) #13 ,024,528 total reads left after pruning
(1-(sum(reads_pruned1))/(sum(reads_per_OTU)))*100 #0.73% of the total data was removed. Very small percentage 

#Plot prevalence of each Phylum
ggplot(prevdf2, aes(TotalAbundance, Prevalence, color = Phylum)) +
  geom_hline(yintercept = prevalenceThreshold1, alpha = 0.5, linetype = 2) +
  geom_point(size = 2, alpha = 0.7) +
  scale_y_log10() + scale_x_log10() +
  xlab("Total Abundance") +
  facet_wrap(~Phylum)
#This threshold of filtering looks a lot better and I can be more confidence that we are not removing true taxa from samples. Looks like the ones that are removed are just artifacts of sampling or sequencing errors. 
```

### Filtering by abundance and prevalence threshold
```{r}
prevdf=apply(X=otu_table(ps1),MARGIN=ifelse(taxa_are_rows(ps1),yes=1,no=2),FUN = function(x){sum(x > 0)})
# Add taxonomy and total read counts to this data.frame
prevdf= data.frame(Prevalence= prevdf,TotalAbundance=taxa_sums(ps1),tax_table(ps1))

plyr::ddply(prevdf,"Phylum",function(df1){cbind(mean(df1$Prevalence),sum(df1$TotalAbundance))}) 
#Shows mean and total prevalence of taxa within each phylum. The ones that are only prevalent once in each phylum might be worth removing. This means they only showed up in one sample across all samples but might have a high abundance (total number of reads).  

#There are a couple of phyla with only a prevalence sum of one or two so these might be worth removing. 

ps1.dt.taxa = data.table(tax_table(ps1), OTUabundance = taxa_sums(ps1), OTU = taxa_names(ps1)) 
ps1.cumsum = ps1.dt.taxa[, .N, by = OTUabundance]
setkey(ps1.cumsum, OTUabundance)
ps1.cumsum[, CumSum := cumsum(N)]
# Define the plot
ps1.cumsum.plot = ggplot(ps1.cumsum, aes(OTUabundance, CumSum)) + 
  geom_point() +
  xlab("Filtering Threshold, Minimum Total Counts") +
  ylab("OTUs Filtered") +
  ggtitle("OTUs that would be filtered vs. the minimum count threshold") + theme_bw()

print(ps1.cumsum.plot) #Difficult to see the smaller values so we need to zoom in

ps1.cumsum.plot.zoom <- ps1.cumsum.plot + xlim(0, 50) + theme_bw() 

print(ps1.cumsum.plot.zoom) 
#Could maybe remove taxa with an abundance of less than 5-6 across all samples however if I go higher than that it filters out a ton of taxa (about 1/3 of all of them)

#I will filter out taxa that are only prevalent in 1% of all samples (has to be in at least 4/357 samples) and at least 6 reads across all samples
ps2<-ps_prune(ps1, min.samples = 4, min.reads = 6)
ps2 #4564 taxa, 349 samples. 
any(taxa_sums(ps2) <6) #FALSE. Means it did a good job of getting rid of them. 
sort(sample_sums(ps2))
#Should remove samples with less than 2000 reads. Will remove about 10 samples.
```

### Filtering by a minimum total sample count (at least 2000 reads/sample)
```{r}
#Creating a rarefaction curve
tab <- otu_table(ps2)
class(tab) <- "matrix" # as.matrix() will do nothing
## you get a warning here, but this is what we need to have
tab <- t(tab) # transpose observations to rows
rare <- rarecurve(tab, step=5000, lwd=2, ylab="OTU",  label=F) 
#The rarefaction curves are very spread out. This means that there are different sequencing depths and standardizing the data might be needed prior to analysis. 

sort(sample_sums(ps2)) #minimum is 59, maximum is 222,956
mean(sample_sums(ps2)) #37504.7

#Final dataset
sample_ps <- subset_samples(ps2, sample_sums(ps2) > 2000) 
sort(sample_sums(sample_ps)) #Minimum sampling depth is now 2283 reads. 
sample_ps #4564 taxa, 339 samples. 

#Create excel file with samples that were subset out
pruned_df<-psmelt(subset_samples(ps2, sample_sums(ps2) < 2000))

write.csv(pruned_df, file="Microbiome_Analysis/Final analysis/Filtering phyloseq/Samples pruned from 2000 reads per sample.csv")
```

### Amount of data that was filtered out from the original phyloseq object
```{r}
ntaxa(psexp)-ntaxa(sample_ps) #filtered 25,654 total taxa (ASVs)
(1-ntaxa(sample_ps)/ntaxa(psexp))*100 #84.9% of the taxa were removed from the original decontaminated dataset. 

reads_per_OTU <- taxa_sums(psexp) #Original ps with no filtering done.
print(sum(reads_per_OTU)) #Total number of reads is 13,120,090.

reads_per_OTU_filtered <- taxa_sums(sample_ps) #Original ps with no filtering done.
print(sum(reads_per_OTU_filtered)) #Total number of reads is now 13,078,305.

(1-13078305/13120090)*100 #0.32%. Filtered out a very small percentage of the total data (reads). 

#From this we can conclude that a small part of the data can have a big impact on downstream analyses.


#Creating a distribution of reads per sample versus the sample counts. 
ps1_df= data.table(as(sample_data(sample_ps), "data.frame"), Reads_per_sample = sample_sums(sample_ps), keep.rownames = TRUE)
ps1_df_plot = ggplot(ps1_df, aes(Reads_per_sample)) + geom_histogram() + ggtitle("Distribution of reads per sample") + ylab("Sample counts") 

print(ps1_df_plot) #Looks right skewed. A couple of very large reads per sample. Probably the Perlidae individuals because they are so big compared to some of the other samples like chironomids. Most are around 20,000 - 40,000 reads per sample though.

#Now we need to observe the counts of abundance of unique sequences across samples
ps1.dt.taxa = data.table(tax_table(sample_ps), OTUabundance = taxa_sums(sample_ps), OTU = taxa_names(sample_ps)) 
#makes a data table of the sum of abundance of each taxa vs the total number of taxa (ASVs)
ps1.dt.tax.plot<- ggplot(ps1.dt.taxa, aes(OTUabundance)) + geom_histogram() + ggtitle("Histogram of OTU (unique sequence) counts") + theme_bw() #Plots the number of times an ASV is repeated from the reads (abundance) on the x axis and the number of taxa on the y axis
print(ps1.dt.tax.plot)
#You can"t see much on the plots panel in R. Save it as an image to see more. 

#write.table(ps1.dt.taxa, "Filtering phyloseq/ps1_dt_tax_plot.txt", sep = "\t") #makes a table that can open in excel

#ggsave("Filtering phyloseq/Histogram of OTU counts.pdf", height = 6, width = 7) #pdf of the plot

#This plot shows that there is a very small proportion of ASVs with a really high abundance and most have relatively low abundance. Highly right skewed. We want to see how many have very low abundance because this may indicate that further processing/filtering should be done. 

#Zoom in on the lower abundance counts to get a better idea of its distribution
plot.zoom1 <- ggplot(ps1.dt.taxa, aes(OTUabundance)) + geom_histogram(breaks=seq(0, 100, by =10)) + ggtitle("Histogram of Total Counts") + theme_bw()
print(plot.zoom1)
#ggsave("Filtering phyloseq/Histogram of OTU counts 1 to 100.pdf", height = 6, width = 7)
#A very high proportion of ASVs have an abundance of less than 10. This may indicate that they should be filtered out. 

plot.zoom2 <- ggplot(ps1.dt.taxa, aes(OTUabundance)) + geom_histogram(breaks=seq(0, 10, by =2)) + ggtitle("Histogram of Total Counts") + theme_bw()
print(plot.zoom2)
#ggsave("Filtering phyloseq/Histogram of OTU counts 1 to 10.pdf", height = 6, width = 7)
```

### Simplified filtering steps (experimental and blanks) for reloading data quickly
```{r}
#Need to remove PMF adult caddis because they were contaminated with contaminated laboratory reagents.
samples_to_remove<-c("POLFLT_1_Ad_Caddis_MB_1", "POLFLT_1_Ad_Caddis_MB_2", "POLFLT_1_Ad_Caddis_MB_3", "POLFLT_1_Ad_Caddis_MB_4", "POLFLT_1_Ad_Caddis_MB_5", "POLFLT_1_Ad_Caddis_MB_6", "POLFLT_1_Ad_Caddis_MB_7", "POLFLT_1_Ad_Caddis_MB_8")

ps_pruned<-subset_samples(ps, !(Sample_ID %in% samples_to_remove))
ps_pruned<-prune_taxa(taxa_sums(ps_pruned) > 0, ps_pruned)
ps_pruned #31,185 taxa, 372 samples

#Removing low confidence data
psexp<-subset_samples(ps_pruned, Sample_Type == "Sample") #Removing ASVs where the abundance is 0 (after removing the blank samples)
psexp<-prune_taxa(taxa_sums(psexp) > 0, psexp)
psexp #30,218 taxa and 349 samples

#Removing Eukaryotes
ps0 <- subset_taxa(psexp, Kingdom != "Eukaryota")
ntaxa(psexp)-ntaxa(ps0) #Got rid of 39 ASVs

#Removing low confidence data (where phylum could not be assigned)
ps1<-subset_taxa(ps0, !is.na(Phylum) & !Phylum %in% c("","uncharacterized")) #Removes the phyla characterized as NA
ntaxa(ps0) - ntaxa(ps1) #Got rid of 403 ASVs

ps2<-ps_prune(ps1, min.samples = 4, min.reads = 6)
ps2 #4564 taxa, 349 samples. 
any(taxa_sums(ps2) <6) #FALSE. Means it did a good job of getting rid of them. 

sample_ps <- subset_samples(ps2, sample_sums(ps2) > 2000) 
sort(sample_sums(sample_ps)) #Minimum sampling depth is now 2283 reads.
sample_ps #4564 taxa, 339 samples.
```

### Re-frame filtered data to work as a data frame
```{r}
#Metadata (from filtered phyloseq) back into a useable data frame

sample_data_ps<-as.data.frame(sample_data(sample_ps))
row_names<-row.names(sample_data_ps) 
sample_data_ps_1<-cbind(row_names, sample_data_ps)
sample_data_ps_1<-sample_data_ps_1 %>% dplyr::rename(Study_ID = row_names)
sample_data_ps_2<-sample_data_ps_1[ , c("Study_ID",  "Site", "Family", "Stream_Type")]
sample_data_3<-sample_data_ps_2 %>% dplyr::rename(sample_Family = Family)
sample_data_4<-sample_data_3 %>% drop_na(Site, sample_Family)


#ASV table from filtered phyloseq
ASVseq_ps<- as.data.frame(otu_table(sample_ps))
Sequences<-row.names(ASVseq_ps) 
ASVseq_ps_1<-cbind(Sequences, ASVseq_ps)
 
ASVseq_ps_2<-ASVseq_ps_1 %>% pivot_longer(-Sequences, names_to="Study_ID", values_to = "count")

#Taxonomy table
taxonomy_modified<-as.data.frame(tax_table(sample_ps)) %>% rownames_to_column(var="Sequences")

nseqs_per_sample <- ASVseq_ps_2 %>%
  dplyr::group_by(Study_ID) %>%
  dplyr::summarize(N = sum(count), .groups="drop") %>% 
  dplyr::count(N) %>%
  dplyr::pull(N)

lod <- 100* 1/max(nseqs_per_sample) #Determines the limit of detection (0.000449)
```

# Data diagnostics

In this section I filter out different taxonomic organizations of bacteria to see their abundance at different levels of organization. Ex. how many phyla per site, what are the top phyla, families, genera and their percentage of the total. 

## Blank Samples
```{r}
blank_ps<-subset_samples(ps, Sample_Type=="Blank")
blank_ps<-prune_taxa(taxa_sums(blank_ps) > 0, blank_ps)
nsamples(blank_ps) #23
ntaxa(blank_ps) #1809

sum(sample_sums(blank_ps)) #503,506 total reads
mean(sample_sums(blank_ps)) #21,891 average reads/sample
sort(sample_sums(blank_ps)) #Reads/sample ranges from 16 - 63,500 counts

#The extraction reagent blanks from the first 4 plates are relatively low (16 - 629 counts)
#The extraction reagent blanks from the last plate are very high from lab contamination (44,645 and 57,629 counts)
#Buffer tube blanks were run on the last (contaminated) plate and have counts of 56,500 and 63,500 
#Field blanks range from 7,949 - 49,817 counts. Could have high counts due to dead bacteria from the tweezers or bug sheet being picked up and amplified in PCR. 

#Total abundance of each blank sample
blank_ps_glom<-tax_glom(blank_ps, taxrank="Phylum")
plot_bar(blank_ps_glom, fill="Phylum", "Blank_Type", "Abundance") + theme(legend.position = "bottom") + theme_bw() + rremove("grid")

#Relative abundance of top 5 most abundant classification of bacteria. 
#Percent of each phyla to the total bacteria
sort((table(tax_table(blank_ps)[,2]))/ntaxa(blank_ps)*100)
#Firmicutes (42.3 %), Proteobacteria (19.6 %), Bacteroidota (13.4 %), Actinobacteriota (11.0 %), Cyanobacteria (5.25 %)

#Percent of each class to the total bacteria
sort((table(tax_table(blank_ps)[,3]))/ntaxa(blank_ps)*100)
#Clostridia (35.2 %), Bacteroidia (13.3 %), Alphaproteobacteria (10.1)

#Percent of each order to the total bacteria
sort((table(tax_table(blank_ps)[,4]))/ntaxa(blank_ps)*100)
#Lachnospirales (15.0 %), Oscillospirales (14.2 %), Burkholderiales (6.5 %)

#Percent of each family to the total bacteria
sort((table(tax_table(blank_ps)[,5]))/ntaxa(blank_ps)*100)
#Lachnospiraceae (14.9 %), Ruminococcaceae (6.9 %), Oscillospiraceae (5.5 %)

#Percent of each genus to the total bacteria
sort((table(tax_table(blank_ps)[,6]))/ntaxa(blank_ps)*100)
#Faecalibacterium (1.99 %), [Ruminococcus] torques group (1.82 %), Blautia (1.60 %), Bacteroides (1.55 %), Alistipes (1.55 %)

#Percent of each species to the total bacteria
sort((table(tax_table(blank_ps)[,7]))/ntaxa(blank_ps)*100)
#prausnitzii (1.0 %), bacterium (0.44%), hadrus (0.39%)

## Get total numbers of ASVs at each level
get_taxa_unique(blank_ps, "Phylum") #26 phyla total
get_taxa_unique(blank_ps, "Class") #57 Classes total
get_taxa_unique(blank_ps, "Order") #136 orders total
get_taxa_unique(blank_ps, "Family") #199 families total
get_taxa_unique(blank_ps, "Genus") #400 genera total

# Get total number of ASVs within each blank type

## Water July
water_july<-subset_samples(blank_ps, Blank_collection_method=="Water July")
water_july<-prune_taxa(taxa_sums(water_july)>0, water_july)
water_july #153 taxa, 3 samples

get_taxa_unique(water_july, "Phylum") #11 phyla total
get_taxa_unique(water_july, "Class") #21 Classes total
get_taxa_unique(water_july, "Order") #54 orders total
get_taxa_unique(water_july, "Family") #63 families total
get_taxa_unique(water_july, "Genus") #76 genera total

## Water September

water_sept<-subset_samples(blank_ps, Blank_collection_method=="Water September")
water_sept<-prune_taxa(taxa_sums(water_sept)>0, water_sept)
water_sept #286 taxa, 3 samples

get_taxa_unique(water_sept, "Phylum") #19 phyla total
get_taxa_unique(water_sept, "Class") #32 Classes total
get_taxa_unique(water_sept, "Order") #73 orders total
get_taxa_unique(water_sept, "Family") #95 families total
get_taxa_unique(water_sept, "Genus") #126 genera total

## Bedsheet July

bedsheet<-subset_samples(blank_ps, Blank_collection_method=="Sheet")
bedsheet<-prune_taxa(taxa_sums(bedsheet)>0, bedsheet)
bedsheet #749 taxa, 4 samples

get_taxa_unique(bedsheet, "Phylum") #17 phyla total
get_taxa_unique(bedsheet, "Class") #37 Classes total
get_taxa_unique(bedsheet, "Order") #92 orders total
get_taxa_unique(bedsheet, "Family") #133 families total
get_taxa_unique(bedsheet, "Genus") #249 genera total

## Floating emergence traps September

mesh_trap<-subset_samples(blank_ps, Blank_collection_method=="Mesh")
mesh_trap<-prune_taxa(taxa_sums(mesh_trap)>0, mesh_trap)
mesh_trap #242 taxa, 3 samples

get_taxa_unique(mesh_trap, "Phylum") #18 phyla total
get_taxa_unique(mesh_trap, "Class") #34 Classes total
get_taxa_unique(mesh_trap, "Order") #63 orders total
get_taxa_unique(mesh_trap, "Family") #86 families total
get_taxa_unique(mesh_trap, "Genus") #101 genera total

## DNA extraction reagents (plate 4)

DNAext4<-subset_samples(blank_ps, Blank_collection_method=="Extraction_neg_4")
DNAext4<-prune_taxa(taxa_sums(DNAext4)>0, DNAext4)
DNAext4 #382 taxa, 2 samples

get_taxa_unique(DNAext4, "Phylum") #9 phyla total
get_taxa_unique(DNAext4, "Class") #13 Classes total
get_taxa_unique(DNAext4, "Order") #31 orders total
get_taxa_unique(DNAext4, "Family") #45 families total
get_taxa_unique(DNAext4, "Genus") #92 genera total

## DNA extraction reagents (plates 1-3)

DNAext<-subset_samples(blank_ps, Blank_collection_method=="Extraction_neg")
DNAext<-prune_taxa(taxa_sums(DNAext)>0, DNAext)
DNAext #23 taxa, 6 samples

get_taxa_unique(DNAext, "Phylum") #3 phyla total
get_taxa_unique(DNAext, "Class") #5 Classes total
get_taxa_unique(DNAext, "Order") #10 orders total
get_taxa_unique(DNAext, "Family") #10 families total
get_taxa_unique(DNAext, "Genus") #15 genera total

## Lysis Buffer tubes

buffer<-subset_samples(blank_ps, Blank_collection_method=="Buffer")
buffer<-prune_taxa(taxa_sums(buffer)>0, buffer)
buffer #447 taxa, 2 samples

get_taxa_unique(buffer, "Phylum") #11 phyla total
get_taxa_unique(buffer, "Class") #17 Classes total
get_taxa_unique(buffer, "Order") #48 orders total
get_taxa_unique(buffer, "Family") #64 families total
get_taxa_unique(buffer, "Genus") #114 genera total



## Plotting composition of blanks
#Phylum 
blank_phy <- tax_glom(blank_ps, taxrank="Phylum")
blank_rel_phy <- microbiome::transform(blank_phy, "compositional")

blank_rel_phy_df <- psmelt(blank_rel_phy)

blank_phy_agg <- aggregate(Abundance ~ Phylum + Blank_Type, data = blank_rel_phy_df, FUN = mean) 

blank_phy_plot <- ggplot(blank_phy_agg, aes(x=Blank_Type, y=Abundance, fill=Phylum)) + geom_bar(stat="identity", color="black")+
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label=scales::percent)+
  scale_fill_manual(name="Bacterial Class", values = c(brewer.pal(12, "Paired"), "darkolivegreen4", "#43464B", "lightcoral", "palevioletred2", brewer.pal(8, "Set3")))+
  rremove("grid")
blank_phy_plot

#Family
blank_fam <- tax_glom(blank_ps, taxrank="Family")
blank_rel_fam <- microbiome::transform(blank_fam, "compositional")
blank_rel_fam_prune = prune_taxa(taxa_sums(blank_rel_fam) > 0.05, blank_rel_fam)

blank_rel_fam_df <- psmelt(blank_rel_fam_prune)

blank_fam_agg <- aggregate(Abundance ~ Family + Blank_Type, data = blank_rel_fam_df, FUN = mean) 

blank_fam_plot <- ggplot(blank_fam_agg, aes(x=Blank_Type, y=Abundance, fill=Family)) + geom_bar(stat="identity")+
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6), legend.title=element_text(size=8)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label=scales::percent)
blank_fam_plot

#Genus
blank_genus <- tax_glom(blank_ps, taxrank="Genus")
blank_rel_genus <- microbiome::transform(blank_genus, "compositional")
blank_rel_genus_prune = prune_taxa(taxa_sums(blank_rel_genus) > 0.1, blank_rel_genus)

blank_rel_genus_df <- psmelt(blank_rel_genus_prune)

blank_genus_agg <- aggregate(Abundance ~ Genus + Blank_Type, data = blank_rel_genus_df, FUN = mean) 

blank_genus_plot <- ggplot(blank_genus_agg, aes(x=Blank_Type, y=Abundance, fill=Genus)) + geom_bar(stat="identity")+
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6), legend.title=element_text(size=8)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label=scales::percent)
blank_genus_plot
```

## Experimental samples {.tabset}

### Relative abundance at different taxonomic levels (all samples combined)
```{r}
#Total number of reads
print(sum(sample_sums(sample_ps))) #13,078,305 
#Average # of reads per sample
mean(sample_sums(sample_ps)) #38,579 average reads/sample
sort(sample_sums(sample_ps)) # reads/sample ranges from 2283 - 222,956 counts

#All phyla combined
sort((table(tax_table(sample_ps)[,2]))/sum(ntaxa(sample_ps))*100)
#Top 5 abundant phyla are Proteobacteria (37.4 %), Bacteroidota (31.0 %), Firmicutes (10.4 %), Cyanobacteria (6.03 %), Actinobacteria (5.41 %)
sort((table(tax_table(sample_ps)[,5])/sum(ntaxa(sample_ps))*100))
#Top 5 families are Comamonadaceae (7.89 %), Saprospiraceae (6.57 %), Flavobacteriaceae (4.76 %), Rhodobacteraceae (4.23 %), and Sphingomonadaceae (3.51 %)
sort((table(tax_table(sample_ps)[,6])/ntaxa(sample_ps)*100))
#top 5 genera: Flavobacterium (4.51 %), Rhodoferax (2.19 %), Tyzzerella (1.47 %), Pseudorhodobacter (1.34), Limnohabitans (1.21 %)

#Sort by proteobacteria
proteo <- subset_taxa(sample_ps, Phylum=="Proteobacteria")
ntaxa(proteo) #1705
(sort(table(tax_table(proteo)[,3])/ntaxa(proteo)*100)) #class. Only 2 classes. Alphaproteobacteria (48.7%) and Gammaproteobacteria (51.1%)
(sort(table(tax_table(proteo)[,5])/ntaxa(proteo)*100)) #family Top 3: Comamonadaceae (21.1 %), Rhodobacteraceae (11.3 %), Sphingomonadaceae (9.4 %) 
(sort(table(tax_table(proteo)[,6])/ntaxa(proteo)*100)) #genera Top 3: Rhodoferax (5.9 %), Pseudorhodobacter (3.6 %), Limnohabitans (3.2 %)

#Sort by Bacteroidota
bactero <- subset_taxa(sample_ps, Phylum=="Bacteroidota")
ntaxa(bactero) #1417
(sort(table(tax_table(bactero)[,3])/ntaxa(bactero)*100)) #class. Top class: Bacteroidia (97.5 %)
(sort(table(tax_table(bactero)[,5])/ntaxa(bactero)*100)) #family Top 3: Saprospiraceae (21.2 %), Flavobacteriaceae (15.3 %), Chitinophagaceae (10.5 %)  
(sort(table(tax_table(bactero)[,6])/ntaxa(bactero)*100)) #genera Top 3: Flavobacterium (14.5 %), Hymenobacter (2.8 %), Ferruginibacter (2.8 %)

#Sort by Firmicutes
firm <- subset_taxa(sample_ps, Phylum=="Firmicutes")
ntaxa(firm) #476
(sort(table(tax_table(firm)[,3])/ntaxa(firm)*100)) #class. Top 2: Clostridia (67.9 %), Bacilli (29.4 %) 
(sort(table(tax_table(firm)[,5])/ntaxa(firm)*100)) #family Top 2: Lachnospiraceae (29.0 %), Ruminococcaceae (15.1 %) 
(sort(table(tax_table(firm)[,6])/ntaxa(firm)*100)) #genera Top 3: Tyzzerella (14.1 %), Candidatus Soleaferrea (4.0 %), Staphylococcus (3.6 %)


##Get total numbers of ASVs at each level
get_taxa_unique(sample_ps, "Phylum") #32 phyla total
get_taxa_unique(sample_ps, "Class") #70 Classes total
get_taxa_unique(sample_ps, "Order") #171 orders total
get_taxa_unique(sample_ps, "Family") #243 families total
get_taxa_unique(sample_ps, "Genus") #493 genera total
```

### Number of ASVs per invertebrate taxa

```{r}
#Bow River sample breakdown
#Hydropsychidae larvae
hydro_lar_Bow<-subset_samples(sample_ps, Stage=="Larvae" & Family=="Hydropsychidae" & Stream_Type=="Bow River")
nsamples(hydro_lar_Bow) #36

#Heptageniidae larvae
hep_lar_Bow<-subset_samples(sample_ps, Stage=="Larvae" & Family=="Heptageniidae" & Stream_Type=="Bow River")
nsamples(hep_lar_Bow) #40

#Perlidae larvae
perl_Bow<-subset_samples(sample_ps, Stage=="Larvae" & Family=="Perlidae" & Stream_Type=="Bow River")
nsamples(perl_Bow) #21

#Chironomidae larvae
chiro_lar_Bow<-subset_samples(sample_ps, Stage=="Larvae" & Family=="Chironomidae" & Stream_Type=="Bow River")
nsamples(chiro_lar_Bow) #16

#Araneidae 
araneid_Bow<-subset_samples(sample_ps, Family=="Araneidae")
nsamples(araneid_Bow) #38

#Tetragnathidae
tetra_Bow<-subset_samples(sample_ps, Family=="Tetragnathidae")
nsamples(tetra_Bow) #40

#Adult caddisfly
ad_caddis_Bow<-subset_samples(sample_ps, Stage=="Adults" & Order=="Trichoptera" & Stream_Type=="Bow River")
nsamples(ad_caddis_Bow) #31

#Adult mayfly
mayfly_ad_Bow<-subset_samples(sample_ps, Stage=="Adults" & Order=="Ephemeroptera" & Stream_Type=="Bow River")
nsamples(mayfly_ad_Bow) #40

#Adult Chironomidae 
chiro_ad_Bow<-subset_samples(sample_ps, Stage=="Adults" & Order=="Diptera" & Stream_Type=="Bow River")
nsamples(chiro_ad_Bow) #22


#Hydropsychidae
hydro<-subset_samples(sample_ps, Family=="Hydropsychidae")
hydro<-prune_taxa(taxa_sums(hydro) > 0, hydro)
ntaxa(hydro) #2553
nsamples(hydro) #60

#Heptageniidae
hep<-subset_samples(sample_ps, Family=="Heptageniidae")
hep<-prune_taxa(taxa_sums(hep) > 0, hep)
ntaxa(hep) #2644
nsamples(hep) #40

#Baetidae
baetid<-subset_samples(sample_ps, Family=="Baetidae")
baetid<-prune_taxa(taxa_sums(baetid) > 0, baetid)
ntaxa(baetid) #1451
nsamples(baetid) #15

#Perlidae
perlid<-subset_samples(sample_ps, Family=="Perlidae")
perlid<-prune_taxa(taxa_sums(perlid) > 0, perlid)
ntaxa(perlid) #1714
nsamples(perlid) #21

#Chironomidae
chiro<-subset_samples(sample_ps, Family=="Chironomidae")
chiro<-prune_taxa(taxa_sums(chiro) > 0, chiro)
ntaxa(chiro) #1180
nsamples(chiro) #16

#Araneidae
aran<-subset_samples(sample_ps, Family=="Araneidae")
aran<-prune_taxa(taxa_sums(aran) > 0, aran)
ntaxa(aran) #689
nsamples(aran) #38

#Tetragnathidae
tetra<-subset_samples(sample_ps, Family=="Tetragnathidae")
tetra<-prune_taxa(taxa_sums(tetra) > 0, tetra)
ntaxa(tetra) #572
nsamples(tetra) #40

#Ephemeroptera
ephem<-subset_samples(sample_ps, Order=="Ephemeroptera")
ephem<-prune_taxa(taxa_sums(ephem) > 0, ephem)
ntaxa(ephem) #3502
nsamples(ephem) #111

#Trichoptera
tricop<-subset_samples(sample_ps, Order=="Trichoptera")
tricop<-prune_taxa(taxa_sums(tricop) > 0, tricop)
ntaxa(tricop) #3408
nsamples(tricop) #91


#Plecoptera
plec<-subset_samples(sample_ps, Order=="Plecoptera")
plec<-prune_taxa(taxa_sums(plec) > 0, plec)
ntaxa(plec) #1714
nsamples(plec) #21

#Araneae
Spiders<-subset_samples(sample_ps, Order=="Araneae")
Spiders<-prune_taxa(taxa_sums(Spiders) > 0, Spiders)
ntaxa(Spiders) #818
nsamples(Spiders) #78
```

### Total ASVs per site and invertebrate taxa 

```{r}
#Total samples
nsamples(sample_ps) #339
ntaxa(sample_ps) #4,564

#Cochrane, n = 65
coch<-subset_samples(sample_ps, Site=="Cochrane")
coch<-prune_taxa(taxa_sums(coch) > 0, coch)
nsamples(coch) #67
ntaxa(coch) #2480

get_taxa_unique(coch, "Phylum") #25 phyla total
get_taxa_unique(coch, "Class") #54 Classes total
get_taxa_unique(coch, "Order") #129 orders total
get_taxa_unique(coch, "Family") #188 families total
get_taxa_unique(coch, "Genus") #364 genera total

sort((table(tax_table(coch)[,2]))/ntaxa(coch)*100)

#Trichoptera at Cochrane
tricoch<-subset_samples(coch, Order=="Trichoptera")
tricoch<-prune_taxa(taxa_sums(tricoch)>0, tricoch)
ntaxa(tricoch) #1250
nsamples(tricoch) #16

get_taxa_unique(tricoch, "Phylum") #19 phyla total
get_taxa_unique(tricoch, "Class") #38 Classes total
get_taxa_unique(tricoch, "Order") #90 orders total
get_taxa_unique(tricoch, "Family") #130 families total
get_taxa_unique(tricoch, "Genus") #214 genera total

#ephemeroptera at Cochrane
ephcoch<-subset_samples(coch, Order=="Ephemeroptera")
ephcoch<-prune_taxa(taxa_sums(ephcoch)>0, ephcoch)
ntaxa(ephcoch) #1278
nsamples(ephcoch) #16

get_taxa_unique(ephcoch, "Phylum") #19 phyla total
get_taxa_unique(ephcoch, "Class") #41 Classes total
get_taxa_unique(ephcoch, "Order") #91 orders total
get_taxa_unique(ephcoch, "Family") #150 families total
get_taxa_unique(ephcoch, "Genus") #244 genera total

#Diptera at Cochrane
dipcoch<-subset_samples(coch, Order=="Diptera")
dipcoch<-prune_taxa(taxa_sums(dipcoch)>0, dipcoch)
ntaxa(dipcoch) #555
nsamples(dipcoch) #11

get_taxa_unique(dipcoch, "Phylum") #12 phyla total
get_taxa_unique(dipcoch, "Class") #28 Classes total
get_taxa_unique(dipcoch, "Order") #81 orders total
get_taxa_unique(dipcoch, "Family") #113 families total
get_taxa_unique(dipcoch, "Genus") #185 genera total

#Plecoptera at Cochrane
pleccoch<-subset_samples(coch, Order=="Plecoptera")
pleccoch<-prune_taxa(taxa_sums(pleccoch)>0, pleccoch)
ntaxa(pleccoch) #571
nsamples(pleccoch) #8

get_taxa_unique(pleccoch, "Phylum") #12 phyla total
get_taxa_unique(pleccoch, "Class") #21 Classes total
get_taxa_unique(pleccoch, "Order") #50 orders total
get_taxa_unique(pleccoch, "Family") #80 families total
get_taxa_unique(pleccoch, "Genus") #108 genera total

#Spiders at Cochrane
arancoch<-subset_samples(coch, Order=="Araneae")
arancoch<-prune_taxa(taxa_sums(arancoch)>0, arancoch)
ntaxa(arancoch) #341
nsamples(arancoch) #16

get_taxa_unique(arancoch, "Phylum") #9 phyla total
get_taxa_unique(arancoch, "Class") #14 Classes total
get_taxa_unique(arancoch, "Order") #49 orders total
get_taxa_unique(arancoch, "Family") #77 families total
get_taxa_unique(arancoch, "Genus") #136 genera total

#Sunalta, n = 47
sun<-subset_samples(sample_ps, Site=="Sunalta")
sun<-prune_taxa(taxa_sums(sun) > 0, sun)
ntaxa(sun) #2174
nsamples(sun) #47

get_taxa_unique(sun, "Phylum") #25 phyla total
get_taxa_unique(sun, "Class") #55 Classes total
get_taxa_unique(sun, "Order") #121 orders total
get_taxa_unique(sun, "Family") #179 families total
get_taxa_unique(sun, "Genus") #332 genera total

sort((table(tax_table(sun)[,2]))/ntaxa(sun)*100)

#Trichoptera at sunalta
trisun<-subset_samples(sun, Order=="Trichoptera")
trisun<-prune_taxa(taxa_sums(trisun) > 0, trisun)
ntaxa(trisun) #997
nsamples(trisun) #15

get_taxa_unique(trisun, "Phylum") #20 phyla total
get_taxa_unique(trisun, "Class") #33 Classes total
get_taxa_unique(trisun, "Order") #76 orders total
get_taxa_unique(trisun, "Family") #122 families total
get_taxa_unique(trisun, "Genus") #199 genera total

#Ephem in sunalta
ephsun<-subset_samples(sun, Order=="Ephemeroptera")
ephsun<-prune_taxa(taxa_sums(ephsun) > 0, ephsun)
ntaxa(ephsun) #1481
nsamples(ephsun) #16

get_taxa_unique(ephsun, "Phylum") #19 phyla total
get_taxa_unique(ephsun, "Class") #44 Classes total
get_taxa_unique(ephsun, "Order") #100 orders total
get_taxa_unique(ephsun, "Family") #149 families total
get_taxa_unique(ephsun, "Genus") #260 genera total

#Araneae in sunalta
aransun<-subset_samples(sun, Order=="Araneae")
aransun<-prune_taxa(taxa_sums(aransun) > 0, aransun)
ntaxa(aransun) #363
nsamples(aransun) #16

get_taxa_unique(aransun, "Phylum") #8 phyla total
get_taxa_unique(aransun, "Class") #15 Classes total
get_taxa_unique(aransun, "Order") #50 orders total
get_taxa_unique(aransun, "Family") #74 families total
get_taxa_unique(aransun, "Genus") #133 genera total

#Cushing Bridge, n = 63
cushbr<-subset_samples(sample_ps, Site=="Cushing Bridge")
cushbr<-prune_taxa(taxa_sums(cushbr) > 0, cushbr)
ntaxa(cushbr) #2762
nsamples(cushbr) #63

get_taxa_unique(cushbr, "Phylum") #29 phyla total
get_taxa_unique(cushbr, "Class") #58 Classes total
get_taxa_unique(cushbr, "Order") #140 orders total
get_taxa_unique(cushbr, "Family") #203 families total
get_taxa_unique(cushbr, "Genus") #400 genera total

sort((table(tax_table(cushbr)[,2]))/ntaxa(cushbr)*100)

#Trichoptera in cushing bridge
tricush<-subset_samples(cushbr, Order=="Trichoptera")
tricush<-prune_taxa(taxa_sums(tricush) > 0, tricush)
ntaxa(tricush) #1100
nsamples(tricush) #13

get_taxa_unique(tricush, "Phylum") #20 phyla total
get_taxa_unique(tricush, "Class") #34 Classes total
get_taxa_unique(tricush, "Order") #80 orders total
get_taxa_unique(tricush, "Family") #132 families total
get_taxa_unique(tricush, "Genus") #218 genera total

#Ephemeroptera in cushing bridge
ephcush<-subset_samples(cushbr, Order=="Ephemeroptera")
ephcush<-prune_taxa(taxa_sums(ephcush) > 0, ephcush)
ntaxa(ephcush) #1277
nsamples(ephcush) #16

get_taxa_unique(ephcush, "Phylum") #20 phyla total
get_taxa_unique(ephcush, "Class") #42 Classes total
get_taxa_unique(ephcush, "Order") #102 orders total
get_taxa_unique(ephcush, "Family") #148 families total
get_taxa_unique(ephcush, "Genus") #256 genera total

#Diptera in cushbr
dipcush<-subset_samples(cushbr, Order=="Diptera")
dipcush<-prune_taxa(taxa_sums(dipcush) > 0, dipcush)
ntaxa(dipcush) #688
nsamples(dipcush) #14

get_taxa_unique(dipcush, "Phylum") #16 phyla total
get_taxa_unique(dipcush, "Class") #32 Classes total
get_taxa_unique(dipcush, "Order") #81 orders total
get_taxa_unique(dipcush, "Family") #129 families total
get_taxa_unique(dipcush, "Genus") #183 genera total

#plecoptera in cush br
pleccush<-subset_samples(cushbr, Order=="Plecoptera")
pleccush<-prune_taxa(taxa_sums(pleccush) > 0, pleccush)
ntaxa(pleccush) #1191
nsamples(pleccush) #5

get_taxa_unique(pleccush, "Phylum") #20 phyla total
get_taxa_unique(pleccush, "Class") #39 Classes total
get_taxa_unique(pleccush, "Order") #90 orders total
get_taxa_unique(pleccush, "Family") #125 families total
get_taxa_unique(pleccush, "Genus") #202 genera total

#araneae in cush br
arancush<-subset_samples(cushbr, Order=="Araneae")
arancush<-prune_taxa(taxa_sums(arancush) > 0, arancush)
ntaxa(arancush) #469
nsamples(arancush) #15

get_taxa_unique(arancush, "Phylum") #12 phyla total
get_taxa_unique(arancush, "Class") #23 Classes total
get_taxa_unique(arancush, "Order") #68 orders total
get_taxa_unique(arancush, "Family") #96 families total
get_taxa_unique(arancush, "Genus") #172 genera total

#Graves Bridge, n = 47
grvbr<-subset_samples(sample_ps, Site=="Graves Bridge")
grvbr<-prune_taxa(taxa_sums(grvbr) > 0, grvbr)
ntaxa(grvbr) #2663
nsamples(grvbr) #47

get_taxa_unique(grvbr, "Phylum") #25 phyla total
get_taxa_unique(grvbr, "Class") #54 Classes total
get_taxa_unique(grvbr, "Order") #136 orders total
get_taxa_unique(grvbr, "Family") #199 families total
get_taxa_unique(grvbr, "Genus") #379 genera total

sort((table(tax_table(grvbr)[,2]))/ntaxa(grvbr)*100)

#Trichoptera at graves bridge
trigrvbr<-subset_samples(grvbr, Order=="Trichoptera")
trigrvbr<-prune_taxa(taxa_sums(trigrvbr) > 0, trigrvbr)
ntaxa(trigrvbr) #1595
nsamples(trigrvbr) #15

get_taxa_unique(trigrvbr, "Phylum") #22 phyla total
get_taxa_unique(trigrvbr, "Class") #42 Classes total
get_taxa_unique(trigrvbr, "Order") #101 orders total
get_taxa_unique(trigrvbr, "Family") #147 families total
get_taxa_unique(trigrvbr, "Genus") #245 genera total

ephgrvbr<-subset_samples(grvbr, Order=="Ephemeroptera")
ephgrvbr<-prune_taxa(taxa_sums(ephgrvbr) > 0, ephgrvbr)
ntaxa(ephgrvbr) #1473
nsamples(ephgrvbr) #16

get_taxa_unique(ephgrvbr, "Phylum") #20 phyla total
get_taxa_unique(ephgrvbr, "Class") #44 Classes total
get_taxa_unique(ephgrvbr, "Order") #98 orders total
get_taxa_unique(ephgrvbr, "Family") #153 families total
get_taxa_unique(ephgrvbr, "Genus") #269 genera total

arangrvbr<-subset_samples(grvbr, Order=="Araneae")
arangrvbr<-prune_taxa(taxa_sums(arangrvbr) > 0, arangrvbr)
ntaxa(arangrvbr) #376
nsamples(arangrvbr) #16

get_taxa_unique(arangrvbr, "Phylum") #9 phyla total
get_taxa_unique(arangrvbr, "Class") #17 Classes total
get_taxa_unique(arangrvbr, "Order") #53 orders total
get_taxa_unique(arangrvbr, "Family") #84 families total
get_taxa_unique(arangrvbr, "Genus") #148 genera total


#Policeman Flats, n = 58
pmf<-subset_samples(sample_ps, Site=="Policeman Flats")
pmf<-prune_taxa(taxa_sums(pmf) > 0, pmf)
ntaxa(pmf) #3175
nsamples(pmf) #60

get_taxa_unique(pmf, "Phylum") #27 phyla total
get_taxa_unique(pmf, "Class") #61 Classes total
get_taxa_unique(pmf, "Order") #153 orders total
get_taxa_unique(pmf, "Family") #218 families total
get_taxa_unique(pmf, "Genus") #418 genera total

sort((table(tax_table(pmf)[,2]))/ntaxa(pmf)*100)

tripmf<-subset_samples(pmf, Order=="Trichoptera")
tripmf<-prune_taxa(taxa_sums(tripmf) > 0, tripmf)
ntaxa(tripmf) #1196
nsamples(tripmf) #8

get_taxa_unique(tripmf, "Phylum") #21 phyla total
get_taxa_unique(tripmf, "Class") #41 Classes total
get_taxa_unique(tripmf, "Order") #85 orders total
get_taxa_unique(tripmf, "Family") #107 families total
get_taxa_unique(tripmf, "Genus") #139 genera total

ephpmf<-subset_samples(pmf, Order=="Ephemeroptera")
ephpmf<-prune_taxa(taxa_sums(ephpmf) > 0, ephpmf)
ntaxa(ephpmf) #1813
nsamples(ephpmf) #16

get_taxa_unique(ephpmf, "Phylum") #22 phyla total
get_taxa_unique(ephpmf, "Class") #49 Classes total
get_taxa_unique(ephpmf, "Order") #113 orders total
get_taxa_unique(ephpmf, "Family") #173 families total
get_taxa_unique(ephpmf, "Genus") #296 genera total

dippmf<-subset_samples(pmf, Order=="Diptera")
dippmf<-prune_taxa(taxa_sums(dippmf) > 0, dippmf)
ntaxa(dippmf) #890
nsamples(dippmf) #13

get_taxa_unique(dippmf, "Phylum") #16 phyla total
get_taxa_unique(dippmf, "Class") #35 Classes total
get_taxa_unique(dippmf, "Order") #87 orders total
get_taxa_unique(dippmf, "Family") #134 families total
get_taxa_unique(dippmf, "Genus") #211 genera total

plecpmf<-subset_samples(pmf, Order=="Plecoptera")
plecpmf<-prune_taxa(taxa_sums(plecpmf) > 0, plecpmf)
ntaxa(plecpmf) #754
nsamples(plecpmf) #8

get_taxa_unique(plecpmf, "Phylum") #17 phyla total
get_taxa_unique(plecpmf, "Class") #30 Classes total
get_taxa_unique(plecpmf, "Order") #71 orders total
get_taxa_unique(plecpmf, "Family") #96 families total
get_taxa_unique(plecpmf, "Genus") #133 genera total

aranpmf<-subset_samples(pmf, Order=="Araneae")
aranpmf<-prune_taxa(taxa_sums(aranpmf) > 0, aranpmf)
ntaxa(aranpmf) #524
nsamples(aranpmf) #15

get_taxa_unique(aranpmf, "Phylum") #11 phyla total
get_taxa_unique(aranpmf, "Class") #19 Classes total
get_taxa_unique(aranpmf, "Order") #67 orders total
get_taxa_unique(aranpmf, "Family") #103 families total
get_taxa_unique(aranpmf, "Genus") #187 genera total

#BRR2 (ACWA control), n = 8
BRR2<-subset_samples(sample_ps, Site=="BRR2")
BRR2<-prune_taxa(taxa_sums(BRR2) > 0, BRR2)
ntaxa(BRR2) #1325
nsamples(BRR2) #8

get_taxa_unique(BRR2, "Phylum") #22 phyla total
get_taxa_unique(BRR2, "Class") #48 Classes total
get_taxa_unique(BRR2, "Order") #113 orders total
get_taxa_unique(BRR2, "Family") #132 families total
get_taxa_unique(BRR2, "Genus") #172 genera total

sort((table(tax_table(BRR2)[,2]))/ntaxa(BRR2)*100)

#PCR1 (ACWA 5% effluent stream), n = 20
PCR1<-subset_samples(sample_ps, Site=="PCR1")
PCR1<-prune_taxa(taxa_sums(PCR1) > 0, PCR1)
ntaxa(PCR1) #2180
nsamples(PCR1) #24

get_taxa_unique(PCR1, "Phylum") #26 phyla total
get_taxa_unique(PCR1, "Class") #59 Classes total
get_taxa_unique(PCR1, "Order") #139 orders total
get_taxa_unique(PCR1, "Family") #178 families total
get_taxa_unique(PCR1, "Genus") #284 genera total

sort((table(tax_table(PCR1)[,2]))/ntaxa(PCR1)*100)

triPCR1<-subset_samples(PCR1, Order=="Trichoptera")
triPCR1<-prune_taxa(taxa_sums(triPCR1) > 0, triPCR1)
ntaxa(triPCR1) #1585
nsamples(triPCR1) #8

get_taxa_unique(triPCR1, "Phylum") #25 phyla total
get_taxa_unique(triPCR1, "Class") #54 Classes total
get_taxa_unique(triPCR1, "Order") #122 orders total
get_taxa_unique(triPCR1, "Family") #143 families total
get_taxa_unique(triPCR1, "Genus") #205 genera total

ephPCR1<-subset_samples(PCR1, Order=="Ephemeroptera")
ephPCR1<-prune_taxa(taxa_sums(ephPCR1) > 0, ephPCR1)
ntaxa(ephPCR1) #1272
nsamples(ephPCR1) #16

get_taxa_unique(ephPCR1, "Phylum") #21 phyla total
get_taxa_unique(ephPCR1, "Class") #48 Classes total
get_taxa_unique(ephPCR1, "Order") #111 orders total
get_taxa_unique(ephPCR1, "Family") #153 families total
get_taxa_unique(ephPCR1, "Genus") #237 genera total


#PCR3 (ACWA 15% effluent stream), n = 15
PCR3<-subset_samples(sample_ps, Site=="PCR3")
PCR3<-prune_taxa(taxa_sums(PCR3) > 0, PCR3)
ntaxa(PCR3) #2037
nsamples(PCR3) #23

get_taxa_unique(PCR3, "Phylum") #27 phyla total
get_taxa_unique(PCR3, "Class") #55 Classes total
get_taxa_unique(PCR3, "Order") #130 orders total
get_taxa_unique(PCR3, "Family") #178 families total
get_taxa_unique(PCR3, "Genus") #295 genera total

sort((table(tax_table(PCR3)[,2]))/ntaxa(PCR3)*100)

triPCR3<-subset_samples(PCR3, Order=="Trichoptera")
triPCR3<-prune_taxa(taxa_sums(triPCR3) > 0, triPCR3)
ntaxa(triPCR3) #1349
nsamples(triPCR3) #8

get_taxa_unique(triPCR3, "Phylum") #24 phyla total
get_taxa_unique(triPCR3, "Class") #48 Classes total
get_taxa_unique(triPCR3, "Order") #110 orders total
get_taxa_unique(triPCR3, "Family") #134 families total
get_taxa_unique(triPCR3, "Genus") #182 genera total

ephPCR3<-subset_samples(PCR3, Order=="Ephemeroptera")
ephPCR3<-prune_taxa(taxa_sums(ephPCR3) > 0, ephPCR3)
ntaxa(ephPCR3) #1141
nsamples(ephPCR3) #15

get_taxa_unique(ephPCR3, "Phylum") #24 phyla total
get_taxa_unique(ephPCR3, "Class") #45 Classes total
get_taxa_unique(ephPCR3, "Order") #104 orders total
get_taxa_unique(ephPCR3, "Family") #144 families total
get_taxa_unique(ephPCR3, "Genus") #244 genera total

#Larvae
larvae<-subset_samples(sample_ps, Stage=="Larvae")
larvae<-prune_taxa(taxa_sums(larvae) > 0, larvae)
nsamples(larvae) #152

#Adults
Adults<-subset_samples(sample_ps, Stage=="Adults")
Adults<-prune_taxa(taxa_sums(Adults) > 0, Adults)
nsamples(Adults) #109

#Spiders
spiders<-subset_samples(sample_ps, Stage=="Spiders")
spiders<-prune_taxa(taxa_sums(spiders) > 0, spiders)
nsamples(spiders)
#78 Spiders samples
```

#### Relative abundance across sites 
```{r}
#Cochrane
#Larvae
cochlar<-subset_samples(coch, Stage=="Larvae")
cochlar<-prune_taxa(taxa_sums(cochlar) > 0, cochlar)
sort((table(tax_table(cochlar)[,2]))/ntaxa(cochlar)*100)
#Adults
cochad<-subset_samples(coch, Stage=="Adults")
cochad<-prune_taxa(taxa_sums(cochad) > 0, cochad)
sort((table(tax_table(cochad)[,2]))/ntaxa(cochad)*100)
#Spiders
cochSpiders<-subset_samples(coch, Stage=="Spiderss")
cochSpiders<-prune_taxa(taxa_sums(cochSpiders) > 0, cochSpiders)
sort((table(tax_table(cochSpiders)[,2]))/ntaxa(cochSpiders)*100)
#Hydropsychidae larvae
coch_hydro_lar<-subset_samples(sample_ps, Site=="Cochrane" & Stage=="Larvae" & Family=="Hydropsychidae")
coch_hydro_lar<-prune_taxa(taxa_sums(coch_hydro_lar)> 0, coch_hydro_lar)
sort((table(tax_table(coch_hydro_lar)[,2]))/ntaxa(coch_hydro_lar)*100)

#Heptageniidae larvae
coch_hep_lar<-subset_samples(sample_ps, Site=="Cochrane" & Stage=="Larvae" & Family=="Heptageniidae")
coch_hep_lar<-prune_taxa(taxa_sums(coch_hep_lar)> 0, coch_hep_lar)
sort((table(tax_table(coch_hep_lar)[,2]))/ntaxa(coch_hep_lar)*100)

#Perlidae larvae
coch_perl_lar<-subset_samples(sample_ps, Site=="Cochrane" & Stage=="Larvae" & Family=="Perlidae")
coch_perl_lar<-prune_taxa(taxa_sums(coch_perl_lar)> 0, coch_perl_lar)
sort((table(tax_table(coch_perl_lar)[,2]))/sum(ntaxa(coch_perl_lar))*100)



hydro_lar_bow_rel_abun <- tax_glom(hydro_lar_Bow, "Phylum")
hydro_lar_bow_rel_abun_top <- merge_samples(hydro_lar_bow_rel_abun, top=5)
ps4 <- merge_samples(ps3.top, "Sex")


hydro_lar_Bow_df<-psmelt(hydro_lar_Bow)
hydro_lar_Bow_df$Phylum <- as.character(hydro_lar_Bow_df$Phylum)
hydro_lar_Bow_df <- hydro_lar_Bow_df %>%
group_by(Phylum, Site, sample_Family) %>%
mutate(median=median(Abundance))

#to get the same rows together
hydro_lar_Bow_df_sum <- hydro_lar_Bow_df %>%
group_by(Site, Phylum) %>%
summarise(Abundance=mean(Abundance))

mean(hydro_lar_Bow_df_sum$Site)




summarize_taxa(ps4)
#Heptageniidae larvae
sort((table(tax_table(hep_lar_Bow)[,2]))/ntaxa(hep_lar_Bow)*100)
#Chironomid larvae
sort((table(tax_table(chiro_lar_Bow)[,2]))/ntaxa(chiro_lar_Bow)*100)

#Sunalta
#Larvae
sunlar<-subset_samples(sun, Stage=="Larvae")
sunlar<-prune_taxa(taxa_sums(sunlar) > 0, sunlar)
sort((table(tax_table(sunlar)[,2]))/ntaxa(sunlar)*100)
#Adultss
sunad<-subset_samples(sun, Stage=="Adultss")
sunad<-prune_taxa(taxa_sums(sunad) > 0, sunad)
sort((table(tax_table(sunad)[,2]))/ntaxa(sunad)*100)
#Spiders
sunSpiders<-subset_samples(sun, Stage=="Spiders")
sunSpiders<-prune_taxa(taxa_sums(sunSpiders) > 0, sunSpiders)
sort((table(tax_table(sunSpiders)[,2]))/ntaxa(sunSpiders)*100)

#Cushing Bridge
#Larvae
cushbrlar<-subset_samples(sample_ps, Stage=="Larvae" & Site=="Cushing Bridge")
cushbrlar<-prune_taxa(taxa_sums(cushbrlar) > 0, cushbrlar)
sort((table(tax_table(cushbrlar)[,2]))/ntaxa(cushbrlar)*100)
#Adults
cushbrad<-subset_samples(cushbr, Stage=="Adults")
cushbrad<-prune_taxa(taxa_sums(cushbrad) > 0, cushbrad)
sort((table(tax_table(cushbrad)[,2]))/ntaxa(cushbrad)*100)
#Spiders
cushbrSpiders<-subset_samples(cushbr, Stage=="Spiders")
cushbrSpiders<-prune_taxa(taxa_sums(cushbrSpiders) > 0, cushbrSpiders)
sort((table(tax_table(cushbrSpiders)[,2]))/ntaxa(cushbrSpiders)*100)

#Graves Bridge
#Larvae
grvbrlar<-subset_samples(sample_ps, Stage=="Larvae" & Site=="Graves Bridge")
grvbrlar<-prune_taxa(taxa_sums(grvbrlar) > 0, grvbrlar)
sort((table(tax_table(grvbrlar)[,2]))/ntaxa(grvbrlar)*100)
#Adults
grvbrad<-subset_samples(grvbr, Stage=="Adults")
grvbrad<-prune_taxa(taxa_sums(grvbrad) > 0, grvbrad)
sort((table(tax_table(grvbrad)[,2]))/ntaxa(grvbrad)*100)
#Spiders
grvbrSpiders<-subset_samples(grvbr, Stage=="Spiders")
grvbrSpiders<-prune_taxa(taxa_sums(grvbrSpiders) > 0, grvbrSpiders)
sort((table(tax_table(grvbrSpiders)[,2]))/ntaxa(grvbrSpiders)*100)

#Policeman Flats
#Larvae
pmflar<-subset_samples(sample_ps, Stage=="Larvae" & Site=="Policeman Flats")
pmflar<-prune_taxa(taxa_sums(pmflar) > 0, pmflar)
sort((table(tax_table(pmflar)[,2]))/ntaxa(pmflar)*100)
#Adults
pmfad<-subset_samples(pmf, Stage=="Adults")
pmfad<-prune_taxa(taxa_sums(pmfad) > 0, pmfad)
sort((table(tax_table(pmfad)[,2]))/ntaxa(pmfad)*100)
#Spiders
pmfSpiders<-subset_samples(pmf, Stage=="Spiders")
pmfSpiders<-prune_taxa(taxa_sums(pmfSpiders) > 0, pmfSpiders)
sort((table(tax_table(pmfSpiders)[,2]))/ntaxa(pmfSpiders)*100)

#BRR2
#Larvae
sort((table(tax_table(BRR2)[,2]))/ntaxa(BRR2)*100)

#PCR1
#Larvae
PCR1lar<-subset_samples(sample_ps, Stage=="Larvae" & Site=="PCR1")
PCR1lar<-prune_taxa(taxa_sums(PCR1lar) > 0, PCR1lar)
sort((table(tax_table(PCR1lar)[,2]))/ntaxa(PCR1lar)*100)
#Adults
PCR1ad<-subset_samples(PCR1, Stage=="Adults")
PCR1ad<-prune_taxa(taxa_sums(PCR1ad) > 0, PCR1ad)
sort((table(tax_table(PCR1ad)[,2]))/ntaxa(PCR1ad)*100)

#PCR3
#Larvae
PCR3lar<-subset_samples(sample_ps, Stage=="Larvae" & Site=="PCR3")
PCR3lar<-prune_taxa(taxa_sums(PCR3lar) > 0, PCR3lar)
sort((table(tax_table(PCR3lar)[,2]))/ntaxa(PCR3lar)*100)
```

### Sample sizes 
```{r}
#### Hydropsychidae ####
#Bow River
hydro_lar_Bow<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Hydropsychidae")
nsamples(hydro_lar_Bow) #36; 5-8/site
#Cochrane
hydro_coch<-subset_samples(hydro_lar_Bow, Site=="Cochrane")
nsamples(hydro_coch) #8
#Sunalta
hydro_sun<-subset_samples(hydro_lar_Bow, Site=="Sunalta")
nsamples(hydro_sun) #7
#Cushing Bridge
hydro_cush<-subset_samples(hydro_lar_Bow, Site=="Cushing Bridge")
nsamples(hydro_cush) #5
#Graves Bridge
hydro_grv<-subset_samples(hydro_lar_Bow, Site=="Graves Bridge")
nsamples(hydro_grv) #8
#Policeman Flats
hydro_pmf<-subset_samples(hydro_lar_Bow, Site=="Policeman Flats")
nsamples(hydro_pmf) #8

#ACWA
hydro_lar_ACWA<-subset_samples(sample_ps, Stream_Type!="Bow River" & Family=="Hydropsychidae")
nsamples(hydro_lar_ACWA) #24; 8/site

#### Heptageniidae ####

hep_lar_Bow<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Heptageniidae")
nsamples(hep_lar_Bow) #40; 8/site
#Cochrane
hep_coch<-subset_samples(hep_lar_Bow, Site=="Cochrane")
nsamples(hep_coch) #8
#Sunalta
hep_sun<-subset_samples(hep_lar_Bow, Site=="Sunalta")
nsamples(hep_sun) #8
#Cushing Bridge
hep_cush<-subset_samples(hep_lar_Bow, Site=="Cushing Bridge")
nsamples(hep_cush) #8
#Graves Bridge
hep_grv<-subset_samples(hep_lar_Bow, Site=="Graves Bridge")
nsamples(hep_grv) #8
#Policeman Flats
hep_pmf<-subset_samples(hep_lar_Bow, Site=="Policeman Flats")
nsamples(hep_pmf) #8


#### Chironomidae ####

chiro_lar_Bow<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Chironomidae")
nsamples(chiro_lar_Bow) #16; 5-6/site
#Cochrane
chiro_coch<-subset_samples(chiro_lar_Bow, Site=="Cochrane")
nsamples(chiro_coch) #5

#Cushing Bridge
chiro_cush<-subset_samples(chiro_lar_Bow, Site=="Cushing Bridge")
nsamples(chiro_cush) #6

#Policeman Flats
chiro_pmf<-subset_samples(chiro_lar_Bow, Site=="Policeman Flats")
nsamples(chiro_pmf) #5

#### Perlidae ####

perl_lar_Bow<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Perlidae")
nsamples(perl_lar_Bow) #21; 5-8/site
#Cochrane
perl_coch<-subset_samples(perl_lar_Bow, Site=="Cochrane")
nsamples(perl_coch) #8

#Cushing Bridge
perl_cush<-subset_samples(perl_lar_Bow, Site=="Cushing Bridge")
nsamples(perl_cush) #5

#Policeman Flats
perl_pmf<-subset_samples(perl_lar_Bow, Site=="Policeman Flats")
nsamples(perl_pmf) #8

#### Baetidae ####
baetid_ACWA<-subset_samples(sample_ps, Stream_Type=="ACWA Streams" & Family=="Baetidae")
nsamples(baetid_ACWA) #15

#EXP5
baetid_EXP5<-subset_samples(baetid_ACWA, Site=="PCR1")
baetid_EXP5 #8

#EXP15
baetid_EXP15<-subset_samples(baetid_ACWA, Site=="PCR3")
baetid_EXP15 #7

#### Trichoptera ####
trichop<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Trichoptera")
nsamples(trichop) #31; 7-8/site
#Cochrane
trichop_coch<-subset_samples(trichop, Site=="Cochrane")
nsamples(trichop_coch) #8
#Sunalta
trichop_sun<-subset_samples(trichop, Site=="Sunalta")
nsamples(trichop_sun) #8
#Cushing Bridge
trichop_cush<-subset_samples(trichop, Site=="Cushing Bridge")
nsamples(trichop_cush) #8
#Graves Bridge
trichop_grv<-subset_samples(trichop, Site=="Graves Bridge")
nsamples(trichop_grv) #7

#### Ephemeroptera ####
ephem<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Ephemeroptera")
nsamples(ephem) #40; 8/site
#Cochrane
ephem_coch<-subset_samples(ephem, Site=="Cochrane")
nsamples(ephem_coch) #8
#Sunalta
ephem_sun<-subset_samples(ephem, Site=="Sunalta")
nsamples(ephem_sun) #8
#Cushing Bridge
ephem_cush<-subset_samples(ephem, Site=="Cushing Bridge")
nsamples(ephem_cush) #8
#Graves Bridge
ephem_grv<-subset_samples(ephem, Site=="Graves Bridge")
nsamples(ephem_grv) #8
#Policeman Flats
ephem_pmf<-subset_samples(ephem, Site=="Policeman Flats")
nsamples(ephem_pmf) #8


#### Diptera ####
dip<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Diptera")
nsamples(dip) #22; 6-8/site
#Cochrane
dip_coch<-subset_samples(dip, Site=="Cochrane")
nsamples(dip_coch) #6

#Cushing Bridge
dip_cush<-subset_samples(dip, Site=="Cushing Bridge")
nsamples(dip_cush) #8

#Policeman Flats
dip_pmf<-subset_samples(dip, Site=="Policeman Flats")
nsamples(dip_pmf) #8

#### Araneidae ####
aran<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Araneidae")
nsamples(aran) #38; 7-8/site
#Cochrane
aran_coch<-subset_samples(aran, Site=="Cochrane")
nsamples(aran_coch) #8
#Sunalta
aran_sun<-subset_samples(aran, Site=="Sunalta")
nsamples(aran_sun) #8
#Cushing Bridge
aran_cush<-subset_samples(aran, Site=="Cushing Bridge")
nsamples(aran_cush) #7
#Graves Bridge
aran_grv<-subset_samples(aran, Site=="Graves Bridge")
nsamples(aran_grv) #8
#Policeman Flats
aran_pmf<-subset_samples(aran, Site=="Policeman Flats")
nsamples(aran_pmf) #7

#### Tetragnathidae ####
tetra<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Tetragnathidae")
nsamples(tetra) #40; 8/site
#Cochrane
tetra_coch<-subset_samples(tetra, Site=="Cochrane")
nsamples(tetra_coch) #8
#Sunalta
tetra_sun<-subset_samples(tetra, Site=="Sunalta")
nsamples(tetra_sun) #8
#Cushing Bridge
tetra_cush<-subset_samples(tetra, Site=="Cushing Bridge")
nsamples(tetra_cush) #8
#Graves Bridge
tetra_grv<-subset_samples(tetra, Site=="Graves Bridge")
nsamples(tetra_grv) #8
#Policeman Flats
tetra_pmf<-subset_samples(tetra, Site=="Policeman Flats")
nsamples(tetra_pmf) #8

```

# Relative Abundance 

Mean relative abundance is beneficial for displaying the composition of taxonomic levels at different sites/across taxa in an easy to understand way (unlike absolute abundance) but has some drawbacks including:

-Difficulty in comparing the absolute abundance across studies because most literature doesn't usually put the sample size of bacteria or samples. The percent abundance isn't very useful to compare if you don't know the total sample size. 
-Difficulty in interpreting the percent abundance across groups because of a lack of a baseline. 
-No error bars, can't get an idea of the variability in the data
-Hard to decipher between small abundance groups because of the colour limitation and sometimes uneven bars

The following graphs display mean relative abundance post filtering of very low counts (all pre-processing steps are done, but rarefying was not done). 

## Blank samples 
```{r}
#Phylum level

bl_rel_abun_phylum <- tax_glom(blank_ps, taxrank="Phylum")
bl_comp_rel_abun_phylum <- microbiome::transform(bl_rel_abun_phylum, "compositional")
bl_rel_abun_all_prune_phylum = prune_taxa(taxa_sums(bl_comp_rel_abun_phylum) > 0.02, bl_comp_rel_abun_phylum) 

bl_rel_abun_prune_sample_phylum <- psmelt(bl_rel_abun_all_prune_phylum)

bl.sample.df.agg.phylum <- aggregate(Abundance ~ Phylum + Blank_Type, data = bl_rel_abun_prune_sample_phylum, FUN = mean) #aggregate to Phylum level, take the mean

bl.sample.df.agg.phylum$Blank_Type<-factor(bl.sample.df.agg.phylum$Blank_Type, levels=c("Bedsheet", "Floating emergence trap", "Tweezer water rinse", "Buffer tube", "DNA extraction reagent", "Nested PCR negative"))

bl_rel_abun_plot_phylum <- ggplot(bl.sample.df.agg.phylum, aes(x=Blank_Type, y=Abundance, fill=Phylum)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance \n >2% ASVs") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label=scales::percent)+
  rremove("grid")
bl_rel_abun_plot_phylum



bl_glom_df = data.frame(Phylum = tax_table(bl_comp_rel_abun_phylum)[,"Phylum"], Abundance = rowSums(otu_table(bl_comp_rel_abun_phylum)), row.names = NULL)
bow_glom_df = bow_glom_df[order(-bow_glom_df$Mean),]

ggplot(bl.sample.df.agg.phylum, aes(y=Phylum, x=Abundance, color=Blank_Type))+
  stat_summary(fun.data=median_hilow, geom = "pointrange", fun.args=list(conf.int=0.95), position = position_dodge(width=0.8))+
  xlab("Relative Abundance (%)")+
  scale_x_log10()



#Family Level

bl_rel_abun_fam <- tax_glom(blank_ps, taxrank="Family")
bl_comp_rel_abun_fam <- microbiome::transform(bl_rel_abun_fam, "compositional")
bl_rel_abun_all_prune_fam = prune_taxa(taxa_sums(bl_comp_rel_abun_fam) > 0.05, bl_comp_rel_abun_fam) 

bl_rel_abun_prune_sample_fam <- psmelt(bl_rel_abun_all_prune_fam)

bl.sample.df.agg.fam <- aggregate(Abundance ~ Family + Blank_Type, data = bl_rel_abun_prune_sample_fam, FUN = mean) #aggregate to Phylum level, take the mean

bl.sample.df.agg.fam$Blank_Type<-factor(bl.sample.df.agg.fam$Blank_Type, levels=c("Bedsheet ", "Floating emergence trap", "Tweezer water rinse", "Buffer tube", "DNA extraction reagent"))

top_fam_bl <- bl.sample.df.agg.fam %>%
    group_by(Blank_Type, Family) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_fam_bl
top5fambl <- top_fam_bl$Family[1:10]
top5fambl <- bl.sample.df.agg.fam %>%
    mutate(Family = fct_other(Family, top5fambl))


top5famplotbl<-ggplot(top5fambl, aes(x=Blank_Type, y=Abundance, fill=Family)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_fill_manual(name="Bacterial Family", values = c(brewer.pal(5, "Paired"), "#43464B"))+
  scale_y_continuous(label = scales::percent)

top5famplotbl



#Genus

bl_rel_abun_genus <- tax_glom(blank_ps, taxrank="Genus")
bl_comp_rel_abun_genus <- microbiome::transform(bl_rel_abun_genus, "compositional")

bl_rel_abun_genus_df <- psmelt(bl_comp_rel_abun_genus)

bl.sample.df.agg.genus <- aggregate(Abundance ~ Genus + Blank_Type, data = bl_rel_abun_genus_df, FUN = mean) 

bl.sample.df.agg.genus$Blank_Type<-factor(bl.sample.df.agg.genus$Blank_Type, levels=c("Bedsheet ", "Floating emergence trap", "Tweezer water rinse", "Buffer tube", "DNA extraction reagent"))


top_genus_bl <- bl.sample.df.agg.genus %>%
    group_by(Blank_Type, Genus) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_genus_bl
top5genusbl <- top_genus_bl$Genus[1:21]
top5genusbl <- bl.sample.df.agg.genus %>%
    mutate(Genus = fct_other(Genus, top5genusbl))


topgenusplotbl<-ggplot(top5genusbl, aes(x=Blank_Type, y=Abundance, fill=Genus)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.7, "cm"),
        legend.text=element_text(size=14, face="italic"), legend.title=element_text(size=14)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_fill_manual(name="Bacterial Genus", values = c(brewer.pal(11, "Paired"), "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Blank Type")+
  rremove("grid")

topgenusplotbl

#ggsave(filename = "Microbiome_ED/Final analysis/Relative abundance/Blank samples/Relative abundance of bacterial genera in blank samples.png", height=10, width=12)
```

## Experimental {.tabset}

### Calculating relative abundance of top 5 phyla  (Table 4 and 5)
```{r}
#### All Bow sites combined ####

Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")

bow_glom = tax_glom(Bow_ps, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

bow_glom_df = data.frame(Phylum = tax_table(bow_glom)[,"Phylum"], Mean = rowMeans(otu_table(bow_glom)), row.names = NULL)
bow_glom_df = bow_glom_df[order(-bow_glom_df$Mean),]

top3_bow_glom <- bow_glom_df$Phylum[1:5]
bow_glom_df_2 <- bow_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_bow_glom))

bow_glom_df_3<-aggregate(data=bow_glom_df_2, Mean ~ Phylum, FUN=sum)

head(bow_glom_df_3)
#Proteobacteria (42.4%), Cyanobacteria (20.8%), Bacteroidota (18.5%)


#Larval Hydropsychidae
hydro<-subset_samples(Bow_ps, Family=="Hydropsychidae")

hydro_glom = tax_glom(hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

# The taxa orders are the same in tax_table() and otu_table()
# Use 'rowMeans(otu_table(GPf))' to calculate per-row average in the OTU table
hydro_glom_df = data.frame(Phylum = tax_table(hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(hydro_glom)), row.names = NULL)
hydro_glom_df = hydro_glom_df[order(-hydro_glom_df$Mean),]

top3_hydro_glom <- hydro_glom_df$Phylum[1:3]
hydro_glom_df_2 <- hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_hydro_glom))

hydro_glom_df_3<-aggregate(data=hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(hydro_glom_df_3)
#Bacteroidota (44.0%), Proteobacteria (31.7%), Firmicutes (14.1%)


#Larval Heptageniidae
hep<-subset_samples(Bow_ps, Family=="Heptageniidae")

hep_glom = tax_glom(hep, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


hep_glom_df = data.frame(Phylum = tax_table(hep_glom)[,"Phylum"], Mean = rowMeans(otu_table(hep_glom)), row.names = NULL)
hep_glom_df = hep_glom_df[order(-hep_glom_df$Mean),]

top3_hep_glom <- hep_glom_df$Phylum[1:3]
hep_glom_df_2 <- hep_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_hep_glom)) 

hep_glom_df_3<-aggregate(data=hep_glom_df_2, Mean ~ Phylum, FUN=sum)

head(hep_glom_df_3)
#Proteobacteria (31.0%), Cyanobacteria (29.5%), Firmicutes (28.5%)

#Larval Chironomidae
chiro<-subset_samples(Bow_ps, Family=="Chironomidae")

chiro_glom = tax_glom(chiro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

chiro_glom_df = data.frame(Phylum = tax_table(chiro_glom)[,"Phylum"], Mean = rowMeans(otu_table(chiro_glom)), row.names = NULL)
chiro_glom_df = chiro_glom_df[order(-chiro_glom_df$Mean),]

top3_chiro_glom <- chiro_glom_df$Phylum[1:3]

chiro_glom_df_2 <- chiro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_chiro_glom)) 

chiro_glom_df_3<-aggregate(data=chiro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(chiro_glom_df_3)
#Cyanobacteria (45.5%), Proteobacteria (28.6%), Bacteroidota (13.2%)

#Larval Perlidae
perl<-subset_samples(Bow_ps, Family=="Perlidae")

perl_glom = tax_glom(perl, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

perl_glom_df = data.frame(Phylum = tax_table(perl_glom)[,"Phylum"], Mean = rowMeans(otu_table(perl_glom)), row.names = NULL)
perl_glom_df = perl_glom_df[order(-perl_glom_df$Mean),]

top3_perl_glom <- perl_glom_df$Phylum[1:3]

perl_glom_df_2 <- perl_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_perl_glom)) 

perl_glom_df_3<-aggregate(data=perl_glom_df_2, Mean ~ Phylum, FUN=sum)

head(perl_glom_df_3)
#Proteobacteria (63.2%), Bacteroidota (20.3%), Cyanobacteria (13.4%)

#Adult Tricoptera
tricho<-subset_samples(Bow_ps, Family=="Trichoptera")

tricho_glom = tax_glom(tricho, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

tricho_glom_df = data.frame(Phylum = tax_table(tricho_glom)[,"Phylum"], Mean = rowMeans(otu_table(tricho_glom)), row.names = NULL)
tricho_glom_df = tricho_glom_df[order(-tricho_glom_df$Mean),]

top3_tricho_glom <- tricho_glom_df$Phylum[1:3]
tricho_glom_df_2 <- tricho_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_tricho_glom))

tricho_glom_df_3<-aggregate(data=tricho_glom_df_2, Mean ~ Phylum, FUN=sum)

head(tricho_glom_df_3)
#Proteobacteria (49.2%), Cyanobacteria (19.4%), Bacteroidota (14.4%)

#Adult Ephemperoptera
ephem<-subset_samples(Bow_ps, Family=="Ephemeroptera")

ephem_glom = tax_glom(ephem, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

ephem_glom_df = data.frame(Phylum = tax_table(ephem_glom)[,"Phylum"], Mean = rowMeans(otu_table(ephem_glom)), row.names = NULL)
ephem_glom_df = ephem_glom_df[order(-ephem_glom_df$Mean),]

top3_ephem_glom <- ephem_glom_df$Phylum[1:3]
ephem_glom_df_2 <- ephem_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_ephem_glom))

ephem_glom_df_3<-aggregate(data=ephem_glom_df_2, Mean ~ Phylum, FUN=sum)

head(ephem_glom_df_3)
#Proteobacteria (40.2%), Firmicutes (23.7%), Cyanobacteria (22.6%)

#Adult Chironomidae
dip<-subset_samples(Bow_ps, Family=="Diptera")

dip_glom = tax_glom(dip, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


dip_glom_df = data.frame(Phylum = tax_table(dip_glom)[,"Phylum"], Mean = rowMeans(otu_table(dip_glom)), row.names = NULL)
dip_glom_df = dip_glom_df[order(-dip_glom_df$Mean),]

top3_dip_glom <- dip_glom_df$Phylum[1:3]
dip_glom_df_2 <- dip_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_dip_glom))

dip_glom_df_3<-aggregate(data=dip_glom_df_2, Mean ~ Phylum, FUN=sum)

head(dip_glom_df_3)
#Proteobacteria (45.2%), Firmicutes (26.4%), Cyanobacteria (17.8%)

#Araneidae
aran<-subset_samples(sample_ps, Family=="Araneidae")

aran_glom = tax_glom(aran, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

aran_glom_df = data.frame(Phylum = tax_table(aran_glom)[,"Phylum"], Mean = rowMeans(otu_table(aran_glom)), row.names = NULL)
aran_glom_df = aran_glom_df[order(-aran_glom_df$Mean),]

top3_aran_glom <- aran_glom_df$Phylum[1:3]
aran_glom_df_2 <- aran_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_aran_glom))

aran_glom_df_3<-aggregate(data=aran_glom_df_2, Mean ~ Phylum, FUN=sum)

head(aran_glom_df_3)
#Cyanobacteria (38.8%), Bacteroidota (37.5%), Proteobacteria (12.1%)

#Tetragnathidae
tetra<-subset_samples(sample_ps,  Family=="Tetragnathidae")

tetra_glom = tax_glom(tetra, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

tetra_glom_df = data.frame(Phylum = tax_table(tetra_glom)[,"Phylum"], Mean = rowMeans(otu_table(tetra_glom)), row.names = NULL)
tetra_glom_df = tetra_glom_df[order(-tetra_glom_df$Mean),]

top3_tetra_glom <- tetra_glom_df$Phylum[1:3]
tetra_glom_df_2 <- tetra_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_tetra_glom))

tetra_glom_df_3<-aggregate(data=tetra_glom_df_2, Mean ~ Phylum, FUN=sum)

head(tetra_glom_df_3)
#Proteobacteria (81.8%), Bacteroidota (6.59%), Cyanobacteria (5.98%)

#### Cochrane ####

cochrane<-subset_samples(sample_ps, Site=="Cochrane")

coch_glom = tax_glom(cochrane, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_glom_df = data.frame(Phylum = tax_table(coch_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_glom)), row.names = NULL)
coch_glom_df = coch_glom_df[order(-coch_glom_df$Mean),]

top3_coch_glom <- coch_glom_df$Phylum[1:5]
coch_glom_df_2 <- coch_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_glom))

coch_glom_df_3<-aggregate(data=coch_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_glom_df_3)

#Larval Hydropsychidae
coch_hydro<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Hydropsychidae")

coch_hydro_glom = tax_glom(coch_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_hydro_glom_df = data.frame(Phylum = tax_table(coch_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_hydro_glom)), row.names = NULL)
coch_hydro_glom_df = coch_hydro_glom_df[order(-coch_hydro_glom_df$Mean),]
head(coch_hydro_glom_df)

top3_coch_hydro_glom <- coch_hydro_glom_df$Phylum[1:3]
coch_hydro_glom_df_2 <- coch_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_hydro_glom))

coch_hydro_glom_df_3<-aggregate(data=coch_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_hydro_glom_df_3)


#Larval Heptageniidae
coch_hep<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Heptageniidae")

coch_hep_glom = tax_glom(coch_hep, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_hep_glom_df = data.frame(Phylum = tax_table(coch_hep_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_hep_glom)), row.names = NULL)
coch_hep_glom_df = coch_hep_glom_df[order(-coch_hep_glom_df$Mean),]
head(coch_hep_glom_df)

top3_coch_hep_glom <- coch_hep_glom_df$Phylum[1:3]
coch_hep_glom_df_2 <- coch_hep_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_hep_glom)) 

coch_hep_glom_df_3<-aggregate(data=coch_hep_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_hep_glom_df_3)


#Larval Chironomidae
coch_chiro<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Chironomidae")

coch_chiro_glom = tax_glom(coch_chiro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_chiro_glom_df = data.frame(Phylum = tax_table(coch_chiro_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_chiro_glom)), row.names = NULL)
coch_chiro_glom_df = coch_chiro_glom_df[order(-coch_chiro_glom_df$Mean),]
head(coch_chiro_glom_df)

top3_coch_chiro_glom <- coch_chiro_glom_df$Phylum[1:5]

coch_chiro_glom_df_2 <- coch_chiro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_chiro_glom)) 

coch_chiro_glom_df_3<-aggregate(data=coch_chiro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_chiro_glom_df_3)

#Larval Perlidae
coch_perl<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Perlidae")

coch_perl_glom = tax_glom(coch_perl, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_perl_glom_df = data.frame(Phylum = tax_table(coch_perl_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_perl_glom)), row.names = NULL)
coch_perl_glom_df = coch_perl_glom_df[order(-coch_perl_glom_df$Mean),]
head(coch_perl_glom_df)

top3_coch_perl_glom <- coch_perl_glom_df$Phylum[1:3]

coch_perl_glom_df_2 <- coch_perl_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_perl_glom)) 

coch_perl_glom_df_3<-aggregate(data=coch_perl_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_perl_glom_df_3)

#Adult Tricoptera
coch_tricho<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Trichoptera")

coch_tricho_glom = tax_glom(coch_tricho, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_tricho_glom_df = data.frame(Phylum = tax_table(coch_tricho_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_tricho_glom)), row.names = NULL)
coch_tricho_glom_df = coch_tricho_glom_df[order(-coch_tricho_glom_df$Mean),]
head(coch_tricho_glom_df)

top3_coch_tricho_glom <- coch_tricho_glom_df$Phylum[1:5]
coch_tricho_glom_df_2 <- coch_tricho_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_tricho_glom))

coch_tricho_glom_df_3<-aggregate(data=coch_tricho_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_tricho_glom_df_3)

#Adult Ephemperoptera
coch_ephem<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Ephemeroptera")

coch_ephem_glom = tax_glom(coch_ephem, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_ephem_glom_df = data.frame(Phylum = tax_table(coch_ephem_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_ephem_glom)), row.names = NULL)
coch_ephem_glom_df = coch_ephem_glom_df[order(-coch_ephem_glom_df$Mean),]

top3_coch_ephem_glom <- coch_ephem_glom_df$Phylum[1:6]
coch_ephem_glom_df_2 <- coch_ephem_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_ephem_glom))

coch_ephem_glom_df_3<-aggregate(data=coch_ephem_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_ephem_glom_df_3)

#Adult Chironomidae
coch_dip<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Diptera")

coch_dip_glom = tax_glom(coch_dip, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_dip_glom_df = data.frame(Phylum = tax_table(coch_dip_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_dip_glom)), row.names = NULL)
coch_dip_glom_df = coch_dip_glom_df[order(-coch_dip_glom_df$Mean),]

top3_coch_dip_glom <- coch_dip_glom_df$Phylum[1:3]
coch_dip_glom_df_2 <- coch_dip_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_dip_glom))

coch_dip_glom_df_3<-aggregate(data=coch_dip_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_dip_glom_df_3)

#Araneidae
coch_aran<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Araneidae")

coch_aran_glom = tax_glom(coch_aran, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_aran_glom_df = data.frame(Phylum = tax_table(coch_aran_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_aran_glom)), row.names = NULL)
coch_aran_glom_df = coch_aran_glom_df[order(-coch_aran_glom_df$Mean),]

top3_coch_aran_glom <- coch_aran_glom_df$Phylum[1:6]
coch_aran_glom_df_2 <- coch_aran_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_aran_glom))

coch_aran_glom_df_3<-aggregate(data=coch_aran_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_aran_glom_df_3)

#Tetragnathidae
coch_tetra<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Tetragnathidae")

coch_tetra_glom = tax_glom(coch_tetra, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

coch_tetra_glom_df = data.frame(Phylum = tax_table(coch_tetra_glom)[,"Phylum"], Mean = rowMeans(otu_table(coch_tetra_glom)), row.names = NULL)
coch_tetra_glom_df = coch_tetra_glom_df[order(-coch_tetra_glom_df$Mean),]

top3_coch_tetra_glom <- coch_tetra_glom_df$Phylum[1:6]
coch_tetra_glom_df_2 <- coch_tetra_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_coch_tetra_glom))

coch_tetra_glom_df_3<-aggregate(data=coch_tetra_glom_df_2, Mean ~ Phylum, FUN=sum)

head(coch_tetra_glom_df_3)


#### Sunalta ####

sun<-subset_samples(sample_ps, Site=="Sunalta")

sun_glom = tax_glom(sun, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

sun_glom_df = data.frame(Phylum = tax_table(sun_glom)[,"Phylum"], Mean = rowMeans(otu_table(sun_glom)), row.names = NULL)
sun_glom_df = sun_glom_df[order(-sun_glom_df$Mean),]

top3_sun_glom <- sun_glom_df$Phylum[1:5]
sun_glom_df_2 <- sun_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_sun_glom))

sun_glom_df_3<-aggregate(data=sun_glom_df_2, Mean ~ Phylum, FUN=sum)

head(sun_glom_df_3)

#Larval Hydropsychidae
sun_hydro<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Hydropsychidae")

sun_hydro_glom = tax_glom(sun_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

sun_hydro_glom_df = data.frame(Phylum = tax_table(sun_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(sun_hydro_glom)), row.names = NULL)
sun_hydro_glom_df = sun_hydro_glom_df[order(-sun_hydro_glom_df$Mean),]
head(sun_hydro_glom_df)

top3_sun_hydro_glom <- sun_hydro_glom_df$Phylum[1:3]
sun_hydro_glom_df_2 <- sun_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_sun_hydro_glom))

sun_hydro_glom_df_3<-aggregate(data=sun_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(sun_hydro_glom_df_3)


#Larval Heptageniidae
sun_hep<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Heptageniidae")

sun_hep_glom = tax_glom(sun_hep, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

sun_hep_glom_df = data.frame(Phylum = tax_table(sun_hep_glom)[,"Phylum"], Mean = rowMeans(otu_table(sun_hep_glom)), row.names = NULL)
sun_hep_glom_df = sun_hep_glom_df[order(-sun_hep_glom_df$Mean),]
head(sun_hep_glom_df)

top3_sun_hep_glom <- sun_hep_glom_df$Phylum[1:3]
sun_hep_glom_df_2 <- sun_hep_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_sun_hep_glom)) 

sun_hep_glom_df_3<-aggregate(data=sun_hep_glom_df_2, Mean ~ Phylum, FUN=sum)

head(sun_hep_glom_df_3)


#Adult Trichoptera
sun_tricho<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Trichoptera")

sun_tricho_glom = tax_glom(sun_tricho, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

sun_tricho_glom_df = data.frame(Phylum = tax_table(sun_tricho_glom)[,"Phylum"], Mean = rowMeans(otu_table(sun_tricho_glom)), row.names = NULL)
sun_tricho_glom_df = sun_tricho_glom_df[order(-sun_tricho_glom_df$Mean),]
head(sun_tricho_glom_df)

top3_sun_tricho_glom <- sun_tricho_glom_df$Phylum[1:6]
sun_tricho_glom_df_2 <- sun_tricho_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_sun_tricho_glom))

sun_tricho_glom_df_3<-aggregate(data=sun_tricho_glom_df_2, Mean ~ Phylum, FUN=sum)

head(sun_tricho_glom_df_3)

#Adult Ephemperoptera
sun_ephem<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Ephemeroptera")

sun_ephem_glom = tax_glom(sun_ephem, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

sun_ephem_glom_df = data.frame(Phylum = tax_table(sun_ephem_glom)[,"Phylum"], Mean = rowMeans(otu_table(sun_ephem_glom)), row.names = NULL)
sun_ephem_glom_df = sun_ephem_glom_df[order(-sun_ephem_glom_df$Mean),]

top3_sun_ephem_glom <- sun_ephem_glom_df$Phylum[1:3]
sun_ephem_glom_df_2 <- sun_ephem_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_sun_ephem_glom))

sun_ephem_glom_df_3<-aggregate(data=sun_ephem_glom_df_2, Mean ~ Phylum, FUN=sum)

head(sun_ephem_glom_df_3)


#Araneidae
sun_aran<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Araneidae")

sun_aran_glom = tax_glom(sun_aran, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


sun_aran_glom_df = data.frame(Phylum = tax_table(sun_aran_glom)[,"Phylum"], Mean = rowMeans(otu_table(sun_aran_glom)), row.names = NULL)
sun_aran_glom_df = sun_aran_glom_df[order(-sun_aran_glom_df$Mean),]

top3_sun_aran_glom <- sun_aran_glom_df$Phylum[1:3]
sun_aran_glom_df_2 <- sun_aran_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_sun_aran_glom))

sun_aran_glom_df_3<-aggregate(data=sun_aran_glom_df_2, Mean ~ Phylum, FUN=sum)

head(sun_aran_glom_df_3)

#Tetragnathidae
sun_tetra<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Tetragnathidae")

sun_tetra_glom = tax_glom(sun_tetra, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

sun_tetra_glom_df = data.frame(Phylum = tax_table(sun_tetra_glom)[,"Phylum"], Mean = rowMeans(otu_table(sun_tetra_glom)), row.names = NULL)
sun_tetra_glom_df = sun_tetra_glom_df[order(-sun_tetra_glom_df$Mean),]

top3_sun_tetra_glom <- sun_tetra_glom_df$Phylum[1:5]
sun_tetra_glom_df_2 <- sun_tetra_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_sun_tetra_glom))

sun_tetra_glom_df_3<-aggregate(data=sun_tetra_glom_df_2, Mean ~ Phylum, FUN=sum)

head(sun_tetra_glom_df_3)

#### Cushing Bridge #### 

cush<-subset_samples(sample_ps, Site=="Cushing Bridge")

cush_glom = tax_glom(cush, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_glom_df = data.frame(Phylum = tax_table(cush_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_glom)), row.names = NULL)
cush_glom_df = cush_glom_df[order(-cush_glom_df$Mean),]

top3_cush_glom <- cush_glom_df$Phylum[1:5]
cush_glom_df_2 <- cush_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_glom))

cush_glom_df_3<-aggregate(data=cush_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_glom_df_3)

#Larval Hydropsychidae
cush_hydro<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Hydropsychidae")

cush_hydro_glom = tax_glom(cush_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_hydro_glom_df = data.frame(Phylum = tax_table(cush_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_hydro_glom)), row.names = NULL)
cush_hydro_glom_df = cush_hydro_glom_df[order(-cush_hydro_glom_df$Mean),]
head(cush_hydro_glom_df)

top3_cush_hydro_glom <- cush_hydro_glom_df$Phylum[1:3]
cush_hydro_glom_df_2 <- cush_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_hydro_glom))

cush_hydro_glom_df_3<-aggregate(data=cush_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_hydro_glom_df_3)


#Larval Heptageniidae
cush_hep<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Heptageniidae")

cush_hep_glom = tax_glom(cush_hep, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_hep_glom_df = data.frame(Phylum = tax_table(cush_hep_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_hep_glom)), row.names = NULL)
cush_hep_glom_df = cush_hep_glom_df[order(-cush_hep_glom_df$Mean),]
head(cush_hep_glom_df)

top3_cush_hep_glom <- cush_hep_glom_df$Phylum[1:3]
cush_hep_glom_df_2 <- cush_hep_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_hep_glom)) 

cush_hep_glom_df_3<-aggregate(data=cush_hep_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_hep_glom_df_3)


#Larval Chironomidae
cush_chiro<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Chironomidae")

cush_chiro_glom = tax_glom(cush_chiro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_chiro_glom_df = data.frame(Phylum = tax_table(cush_chiro_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_chiro_glom)), row.names = NULL)
cush_chiro_glom_df = cush_chiro_glom_df[order(-cush_chiro_glom_df$Mean),]
head(cush_chiro_glom_df)

top3_cush_chiro_glom <- cush_chiro_glom_df$Phylum[1:5]

cush_chiro_glom_df_2 <- cush_chiro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_chiro_glom)) 

cush_chiro_glom_df_3<-aggregate(data=cush_chiro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_chiro_glom_df_3)

#Larval Perlidae
cush_perl<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Perlidae")

cush_perl_glom = tax_glom(cush_perl, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_perl_glom_df = data.frame(Phylum = tax_table(cush_perl_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_perl_glom)), row.names = NULL)
cush_perl_glom_df = cush_perl_glom_df[order(-cush_perl_glom_df$Mean),]
head(cush_perl_glom_df)

top3_cush_perl_glom <- cush_perl_glom_df$Phylum[1:5]

cush_perl_glom_df_2 <- cush_perl_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_perl_glom)) 

cush_perl_glom_df_3<-aggregate(data=cush_perl_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_perl_glom_df_3)

#Adult Trichoptera
cush_tricho<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Trichoptera")

cush_tricho_glom = tax_glom(cush_tricho, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_tricho_glom_df = data.frame(Phylum = tax_table(cush_tricho_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_tricho_glom)), row.names = NULL)
cush_tricho_glom_df = cush_tricho_glom_df[order(-cush_tricho_glom_df$Mean),]
head(cush_tricho_glom_df)

top3_cush_tricho_glom <- cush_tricho_glom_df$Phylum[1:5]
cush_tricho_glom_df_2 <- cush_tricho_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_tricho_glom))

cush_tricho_glom_df_3<-aggregate(data=cush_tricho_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_tricho_glom_df_3)

#Adult Ephemperoptera
cush_ephem<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Ephemeroptera")

cush_ephem_glom = tax_glom(cush_ephem, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_ephem_glom_df = data.frame(Phylum = tax_table(cush_ephem_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_ephem_glom)), row.names = NULL)
cush_ephem_glom_df = cush_ephem_glom_df[order(-cush_ephem_glom_df$Mean),]

top3_cush_ephem_glom <- cush_ephem_glom_df$Phylum[1:6]
cush_ephem_glom_df_2 <- cush_ephem_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_ephem_glom))

cush_ephem_glom_df_3<-aggregate(data=cush_ephem_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_ephem_glom_df_3)

#Adult Chironomidae
cush_dip<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Diptera")

cush_dip_glom = tax_glom(cush_dip, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_dip_glom_df = data.frame(Phylum = tax_table(cush_dip_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_dip_glom)), row.names = NULL)
cush_dip_glom_df = cush_dip_glom_df[order(-cush_dip_glom_df$Mean),]

top3_cush_dip_glom <- cush_dip_glom_df$Phylum[1:3]
cush_dip_glom_df_2 <- cush_dip_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_dip_glom))

cush_dip_glom_df_3<-aggregate(data=cush_dip_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_dip_glom_df_3)

#Araneidae
cush_aran<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Araneidae")

cush_aran_glom = tax_glom(cush_aran, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_aran_glom_df = data.frame(Phylum = tax_table(cush_aran_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_aran_glom)), row.names = NULL)
cush_aran_glom_df = cush_aran_glom_df[order(-cush_aran_glom_df$Mean),]

top3_cush_aran_glom <- cush_aran_glom_df$Phylum[1:3]
cush_aran_glom_df_2 <- cush_aran_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_aran_glom))

cush_aran_glom_df_3<-aggregate(data=cush_aran_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_aran_glom_df_3)

#Tetragnathidae
cush_tetra<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Tetragnathidae")

cush_tetra_glom = tax_glom(cush_tetra, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

cush_tetra_glom_df = data.frame(Phylum = tax_table(cush_tetra_glom)[,"Phylum"], Mean = rowMeans(otu_table(cush_tetra_glom)), row.names = NULL)
cush_tetra_glom_df = cush_tetra_glom_df[order(-cush_tetra_glom_df$Mean),]

top3_cush_tetra_glom <- cush_tetra_glom_df$Phylum[1:3]
cush_tetra_glom_df_2 <- cush_tetra_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_cush_tetra_glom))

cush_tetra_glom_df_3<-aggregate(data=cush_tetra_glom_df_2, Mean ~ Phylum, FUN=sum)

head(cush_tetra_glom_df_3)

#### Graves Bridge ####

grv<-subset_samples(sample_ps, Site=="Graves Bridge")

grv_glom = tax_glom(grv, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

grv_glom_df = data.frame(Phylum = tax_table(grv_glom)[,"Phylum"], Mean = rowMeans(otu_table(grv_glom)), row.names = NULL)
grv_glom_df = grv_glom_df[order(-grv_glom_df$Mean),]

top3_grv_glom <- grv_glom_df$Phylum[1:5]
grv_glom_df_2 <- grv_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_grv_glom))

grv_glom_df_3<-aggregate(data=grv_glom_df_2, Mean ~ Phylum, FUN=sum)

head(grv_glom_df_3)

#Larval Hydropsychidae
grv_hydro<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Hydropsychidae")

grv_hydro_glom = tax_glom(grv_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

grv_hydro_glom_df = data.frame(Phylum = tax_table(grv_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(grv_hydro_glom)), row.names = NULL)
grv_hydro_glom_df = grv_hydro_glom_df[order(-grv_hydro_glom_df$Mean),]

top3_grv_hydro_glom <- grv_hydro_glom_df$Phylum[1:3]
grv_hydro_glom_df_2 <- grv_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_grv_hydro_glom))

grv_hydro_glom_df_3<-aggregate(data=grv_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(grv_hydro_glom_df_3)


#Larval Heptageniidae
grv_hep<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Heptageniidae")

grv_hep_glom = tax_glom(grv_hep, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

grv_hep_glom_df = data.frame(Phylum = tax_table(grv_hep_glom)[,"Phylum"], Mean = rowMeans(otu_table(grv_hep_glom)), row.names = NULL)
grv_hep_glom_df = grv_hep_glom_df[order(-grv_hep_glom_df$Mean),]
head(grv_hep_glom_df)

top3_grv_hep_glom <- grv_hep_glom_df$Phylum[1:3]
grv_hep_glom_df_2 <- grv_hep_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_grv_hep_glom)) 

grv_hep_glom_df_3<-aggregate(data=grv_hep_glom_df_2, Mean ~ Phylum, FUN=sum)

head(grv_hep_glom_df_3)


#Adult Trichoptera
grv_tricho<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Trichoptera")

grv_tricho_glom = tax_glom(grv_tricho, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

grv_tricho_glom_df = data.frame(Phylum = tax_table(grv_tricho_glom)[,"Phylum"], Mean = rowMeans(otu_table(grv_tricho_glom)), row.names = NULL)
grv_tricho_glom_df = grv_tricho_glom_df[order(-grv_tricho_glom_df$Mean),]

top3_grv_tricho_glom <- grv_tricho_glom_df$Phylum[1:3]
grv_tricho_glom_df_2 <- grv_tricho_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_grv_tricho_glom))

grv_tricho_glom_df_3<-aggregate(data=grv_tricho_glom_df_2, Mean ~ Phylum, FUN=sum)

head(grv_tricho_glom_df_3)

#Adult Ephemperoptera
grv_ephem<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Ephemeroptera")

grv_ephem_glom = tax_glom(grv_ephem, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

grv_ephem_glom_df = data.frame(Phylum = tax_table(grv_ephem_glom)[,"Phylum"], Mean = rowMeans(otu_table(grv_ephem_glom)), row.names = NULL)
grv_ephem_glom_df = grv_ephem_glom_df[order(-grv_ephem_glom_df$Mean),]

top3_grv_ephem_glom <- grv_ephem_glom_df$Phylum[1:3]
grv_ephem_glom_df_2 <- grv_ephem_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_grv_ephem_glom))

grv_ephem_glom_df_3<-aggregate(data=grv_ephem_glom_df_2, Mean ~ Phylum, FUN=sum)

head(grv_ephem_glom_df_3)


#Araneidae
grv_aran<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Araneidae")

grv_aran_glom = tax_glom(grv_aran, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

grv_aran_glom_df = data.frame(Phylum = tax_table(grv_aran_glom)[,"Phylum"], Mean = rowMeans(otu_table(grv_aran_glom)), row.names = NULL)
grv_aran_glom_df = grv_aran_glom_df[order(-grv_aran_glom_df$Mean),]

top3_grv_aran_glom <- grv_aran_glom_df$Phylum[1:3]
grv_aran_glom_df_2 <- grv_aran_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_grv_aran_glom))

grv_aran_glom_df_3<-aggregate(data=grv_aran_glom_df_2, Mean ~ Phylum, FUN=sum)

head(grv_aran_glom_df_3)

#Tetragnathidae
grv_tetra<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Tetragnathidae")

grv_tetra_glom = tax_glom(grv_tetra, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

grv_tetra_glom_df = data.frame(Phylum = tax_table(grv_tetra_glom)[,"Phylum"], Mean = rowMeans(otu_table(grv_tetra_glom)), row.names = NULL)
grv_tetra_glom_df = grv_tetra_glom_df[order(-grv_tetra_glom_df$Mean),]

top3_grv_tetra_glom <- grv_tetra_glom_df$Phylum[1:6]
grv_tetra_glom_df_2 <- grv_tetra_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_grv_tetra_glom))

grv_tetra_glom_df_3<-aggregate(data=grv_tetra_glom_df_2, Mean ~ Phylum, FUN=sum)

head(grv_tetra_glom_df_3)


#### Policeman Flats ####

pmf<-subset_samples(sample_ps, Site=="Policeman Flats")

pmf_glom = tax_glom(pmf, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_glom_df = data.frame(Phylum = tax_table(pmf_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_glom)), row.names = NULL)
pmf_glom_df = pmf_glom_df[order(-pmf_glom_df$Mean),]

top3_pmf_glom <- pmf_glom_df$Phylum[1:5]
pmf_glom_df_2 <- pmf_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_glom))

pmf_glom_df_3<-aggregate(data=pmf_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_glom_df_3)

#Larval Hydropsychidae
pmf_hydro<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Hydropsychidae")

pmf_hydro_glom = tax_glom(pmf_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_hydro_glom_df = data.frame(Phylum = tax_table(pmf_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_hydro_glom)), row.names = NULL)
pmf_hydro_glom_df = pmf_hydro_glom_df[order(-pmf_hydro_glom_df$Mean),]
head(pmf_hydro_glom_df)

top3_pmf_hydro_glom <- pmf_hydro_glom_df$Phylum[1:3]
pmf_hydro_glom_df_2 <- pmf_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_hydro_glom))

pmf_hydro_glom_df_3<-aggregate(data=pmf_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_hydro_glom_df_3)


#Larval Heptageniidae
pmf_hep<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Heptageniidae")

pmf_hep_glom = tax_glom(pmf_hep, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_hep_glom_df = data.frame(Phylum = tax_table(pmf_hep_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_hep_glom)), row.names = NULL)
pmf_hep_glom_df = pmf_hep_glom_df[order(-pmf_hep_glom_df$Mean),]
head(pmf_hep_glom_df)

top3_pmf_hep_glom <- pmf_hep_glom_df$Phylum[1:3]
pmf_hep_glom_df_2 <- pmf_hep_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_hep_glom)) 

pmf_hep_glom_df_3<-aggregate(data=pmf_hep_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_hep_glom_df_3)


#Larval Chironomidae
pmf_chiro<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Chironomidae")

pmf_chiro_glom = tax_glom(pmf_chiro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_chiro_glom_df = data.frame(Phylum = tax_table(pmf_chiro_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_chiro_glom)), row.names = NULL)
pmf_chiro_glom_df = pmf_chiro_glom_df[order(-pmf_chiro_glom_df$Mean),]
head(pmf_chiro_glom_df)

top3_pmf_chiro_glom <- pmf_chiro_glom_df$Phylum[1:3]

pmf_chiro_glom_df_2 <- pmf_chiro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_chiro_glom)) 

pmf_chiro_glom_df_3<-aggregate(data=pmf_chiro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_chiro_glom_df_3)

#Larval Perlidae
pmf_perl<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Perlidae")

pmf_perl_glom = tax_glom(pmf_perl, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_perl_glom_df = data.frame(Phylum = tax_table(pmf_perl_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_perl_glom)), row.names = NULL)
pmf_perl_glom_df = pmf_perl_glom_df[order(-pmf_perl_glom_df$Mean),]
head(pmf_perl_glom_df)

top3_pmf_perl_glom <- pmf_perl_glom_df$Phylum[1:3]

pmf_perl_glom_df_2 <- pmf_perl_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_perl_glom)) 

pmf_perl_glom_df_3<-aggregate(data=pmf_perl_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_perl_glom_df_3)


#Adult Ephemperoptera
pmf_ephem<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Ephemeroptera")

pmf_ephem_glom = tax_glom(pmf_ephem, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_ephem_glom_df = data.frame(Phylum = tax_table(pmf_ephem_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_ephem_glom)), row.names = NULL)
pmf_ephem_glom_df = pmf_ephem_glom_df[order(-pmf_ephem_glom_df$Mean),]

top3_pmf_ephem_glom <- pmf_ephem_glom_df$Phylum[1:6]
pmf_ephem_glom_df_2 <- pmf_ephem_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_ephem_glom))

pmf_ephem_glom_df_3<-aggregate(data=pmf_ephem_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_ephem_glom_df_3)

#Adult Chironomidae
pmf_dip<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Diptera")

pmf_dip_glom = tax_glom(pmf_dip, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_dip_glom_df = data.frame(Phylum = tax_table(pmf_dip_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_dip_glom)), row.names = NULL)
pmf_dip_glom_df = pmf_dip_glom_df[order(-pmf_dip_glom_df$Mean),]

top3_pmf_dip_glom <- pmf_dip_glom_df$Phylum[1:3]
pmf_dip_glom_df_2 <- pmf_dip_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_dip_glom))

pmf_dip_glom_df_3<-aggregate(data=pmf_dip_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_dip_glom_df_3)

#Araneidae
pmf_aran<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Araneidae")

pmf_aran_glom = tax_glom(pmf_aran, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_aran_glom_df = data.frame(Phylum = tax_table(pmf_aran_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_aran_glom)), row.names = NULL)
pmf_aran_glom_df = pmf_aran_glom_df[order(-pmf_aran_glom_df$Mean),]

top3_pmf_aran_glom <- pmf_aran_glom_df$Phylum[1:6]
pmf_aran_glom_df_2 <- pmf_aran_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_aran_glom))

pmf_aran_glom_df_3<-aggregate(data=pmf_aran_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_aran_glom_df_3)

#Tetragnathidae
pmf_tetra<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Tetragnathidae")

pmf_tetra_glom = tax_glom(pmf_tetra, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})

pmf_tetra_glom_df = data.frame(Phylum = tax_table(pmf_tetra_glom)[,"Phylum"], Mean = rowMeans(otu_table(pmf_tetra_glom)), row.names = NULL)
pmf_tetra_glom_df = pmf_tetra_glom_df[order(-pmf_tetra_glom_df$Mean),]

top3_pmf_tetra_glom <- pmf_tetra_glom_df$Phylum[1:3]
pmf_tetra_glom_df_2 <- pmf_tetra_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_pmf_tetra_glom))

pmf_tetra_glom_df_3<-aggregate(data=pmf_tetra_glom_df_2, Mean ~ Phylum, FUN=sum)

head(pmf_tetra_glom_df_3)

#### BRR2/REF ####
#Larval Hydropsychidae
BRR2_hydro<-subset_samples(sample_ps, Site=="BRR2" & Family=="Hydropsychidae")

BRR2_hydro_glom = tax_glom(BRR2_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


BRR2_hydro_glom_df = data.frame(Phylum = tax_table(BRR2_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(BRR2_hydro_glom)), row.names = NULL)
BRR2_hydro_glom_df = BRR2_hydro_glom_df[order(-BRR2_hydro_glom_df$Mean),]
head(BRR2_hydro_glom_df)

top3_BRR2_hydro_glom <- BRR2_hydro_glom_df$Phylum[1:3]
BRR2_hydro_glom_df_2 <- BRR2_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_BRR2_hydro_glom))

BRR2_hydro_glom_df_3<-aggregate(data=BRR2_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(BRR2_hydro_glom_df_3)

#### PCR1/EXP5 ####

#Larval Hydropsychidae
PCR1_hydro<-subset_samples(sample_ps, Site=="PCR1" & Family=="Hydropsychidae")

PCR1_hydro_glom = tax_glom(PCR1_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


PCR1_hydro_glom_df = data.frame(Phylum = tax_table(PCR1_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(PCR1_hydro_glom)), row.names = NULL)
PCR1_hydro_glom_df = PCR1_hydro_glom_df[order(-PCR1_hydro_glom_df$Mean),]
head(PCR1_hydro_glom_df)

top3_PCR1_hydro_glom <- PCR1_hydro_glom_df$Phylum[1:3]
PCR1_hydro_glom_df_2 <- PCR1_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_PCR1_hydro_glom))

PCR1_hydro_glom_df_3<-aggregate(data=PCR1_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(PCR1_hydro_glom_df_3)


#Larval Baetidae
PCR1_bae<-subset_samples(sample_ps, Site=="PCR1" & Family=="Baetidae")

PCR1_bae_glom = tax_glom(PCR1_bae, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


PCR1_bae_glom_df = data.frame(Phylum = tax_table(PCR1_bae_glom)[,"Phylum"], Mean = rowMeans(otu_table(PCR1_bae_glom)), row.names = NULL)
PCR1_bae_glom_df = PCR1_bae_glom_df[order(-PCR1_bae_glom_df$Mean),]
head(PCR1_bae_glom_df)

top3_PCR1_bae_glom <- PCR1_bae_glom_df$Phylum[1:3]
PCR1_bae_glom_df_2 <- PCR1_bae_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_PCR1_bae_glom))

PCR1_bae_glom_df_3<-aggregate(data=PCR1_bae_glom_df_2, Mean ~ Phylum, FUN=sum)

head(PCR1_bae_glom_df_3)

#Adult Baetidae

PCR1_bae_ad<-subset_samples(sample_ps, Site=="PCR1" & Family=="Ephemeroptera")

PCR1_bae_ad_glom = tax_glom(PCR1_bae_ad, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


PCR1_bae_ad_glom_df = data.frame(Phylum = tax_table(PCR1_bae_ad_glom)[,"Phylum"], Mean = rowMeans(otu_table(PCR1_bae_ad_glom)), row.names = NULL)
PCR1_bae_ad_glom_df = PCR1_bae_ad_glom_df[order(-PCR1_bae_ad_glom_df$Mean),]
head(PCR1_bae_ad_glom_df)

top3_PCR1_bae_ad_glom <- PCR1_bae_ad_glom_df$Phylum[1:3]
PCR1_bae_ad_glom_df_2 <- PCR1_bae_ad_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_PCR1_bae_ad_glom))

PCR1_bae_ad_glom_df_3<-aggregate(data=PCR1_bae_ad_glom_df_2, Mean ~ Phylum, FUN=sum)

head(PCR1_bae_ad_glom_df_3)

#### PCR3/EXP15 ####

#Larval Hydropsychidae
PCR3_hydro<-subset_samples(sample_ps, Site=="PCR3" & Family=="Hydropsychidae")

PCR3_hydro_glom = tax_glom(PCR3_hydro, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


PCR3_hydro_glom_df = data.frame(Phylum = tax_table(PCR3_hydro_glom)[,"Phylum"], Mean = rowMeans(otu_table(PCR3_hydro_glom)), row.names = NULL)
PCR3_hydro_glom_df = PCR3_hydro_glom_df[order(-PCR3_hydro_glom_df$Mean),]
head(PCR3_hydro_glom_df)

top3_PCR3_hydro_glom <- PCR3_hydro_glom_df$Phylum[1:3]
PCR3_hydro_glom_df_2 <- PCR3_hydro_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_PCR3_hydro_glom))

PCR3_hydro_glom_df_3<-aggregate(data=PCR3_hydro_glom_df_2, Mean ~ Phylum, FUN=sum)

head(PCR3_hydro_glom_df_3)


#Larval Baetidae
PCR3_bae<-subset_samples(sample_ps, Site=="PCR3" & Family=="Baetidae")

PCR3_bae_glom = tax_glom(PCR3_bae, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


PCR3_bae_glom_df = data.frame(Phylum = tax_table(PCR3_bae_glom)[,"Phylum"], Mean = rowMeans(otu_table(PCR3_bae_glom)), row.names = NULL)
PCR3_bae_glom_df = PCR3_bae_glom_df[order(-PCR3_bae_glom_df$Mean),]
head(PCR3_bae_glom_df)

top3_PCR3_bae_glom <- PCR3_bae_glom_df$Phylum[1:3]
PCR3_bae_glom_df_2 <- PCR3_bae_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_PCR3_bae_glom))

PCR3_bae_glom_df_3<-aggregate(data=PCR3_bae_glom_df_2, Mean ~ Phylum, FUN=sum)

head(PCR3_bae_glom_df_3)

#Adult Baetidae

PCR3_bae_ad<-subset_samples(sample_ps, Site=="PCR3" & Family=="Ephemeroptera")

PCR3_bae_ad_glom = tax_glom(PCR3_bae_ad, "Phylum") %>% transform_sample_counts(function(x) {x * 100/sum(x)})


PCR3_bae_ad_glom_df = data.frame(Phylum = tax_table(PCR3_bae_ad_glom)[,"Phylum"], Mean = rowMeans(otu_table(PCR3_bae_ad_glom)), row.names = NULL)
PCR3_bae_ad_glom_df = PCR3_bae_ad_glom_df[order(-PCR3_bae_ad_glom_df$Mean),]
head(PCR3_bae_ad_glom_df)

top3_PCR3_bae_ad_glom <- PCR3_bae_ad_glom_df$Phylum[1:3]
PCR3_bae_ad_glom_df_2 <- PCR3_bae_ad_glom_df %>%
    mutate(Phylum = fct_other(Phylum, top3_PCR3_bae_ad_glom))

PCR3_bae_ad_glom_df_3<-aggregate(data=PCR3_bae_ad_glom_df_2, Mean ~ Phylum, FUN=sum)

head(PCR3_bae_ad_glom_df_3)
```

### Testing significant differences across sites and invert taxa
```{r}
#### Bow River ####

### Phylum level ###

metadata_Bow<-subset(sample_data_4, Stream_Type=="Bow River")

otu_rel_abund_Bow <- dplyr::inner_join(ASVseq_ps_2, metadata_Bow, by="Study_ID") %>%
  dplyr::inner_join(., taxonomy_modified, by="Sequences") %>% #joins taxonomy, abundances, and metadata
  dplyr::group_by(Study_ID) %>%
  dplyr::mutate(rel_abund = count / sum(count)) %>% #transforms to relative abundance
  dplyr::ungroup() %>%
  dplyr::select(-count) %>%
  pivot_longer(
    c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "Sequences"),
    names_to="level",
    values_to="taxon") 

#Phylum
taxon_rel_abund_Phylum_Bow <- otu_rel_abund_Bow %>%
  dplyr::filter(level=="Phylum") %>%
  dplyr::group_by(Site, sample_Family, Study_ID, taxon) %>%
  dplyr::summarize(rel_abund = 100*sum(rel_abund), .groups="drop") %>%
  drop_na(Site, sample_Family, taxon)

taxon_pool_Phylum_Bow <- taxon_rel_abund_Phylum_Bow %>%
  dplyr::group_by(Site, sample_Family, taxon) %>%
  dplyr::summarize(median=median(rel_abund), .groups="drop") %>%
  dplyr::group_by(taxon) %>%
  dplyr::summarize(pool = max(median) < 25,
            median = median(median),
            .groups="drop")

#Graphing pointrange plot with median and 50% quartiles
Phylum_Bow_graphing_df<- dplyr::inner_join(taxon_rel_abund_Phylum_Bow, taxon_pool_Phylum_Bow, by="taxon") %>%
 dplyr::mutate(taxon = if_else(pool, "Other", taxon)) %>%
  dplyr::group_by(Study_ID, Site, sample_Family, taxon) %>%
  dplyr::summarize(rel_abund = sum(rel_abund),
            median = min(median),
            .groups="drop") %>%
  dplyr::mutate(taxon = factor(taxon),
         taxon = fct_reorder(taxon, median, .desc=T)) %>%
  dplyr::mutate(rel_abund = if_else(rel_abund == 0,
                             2/3 * lod,
                             rel_abund))
Phylum_Bow_graphing_df

## Hydropsychidae ##
hydro_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Hydropsychidae")

hydro_phylum_Bow$taxon<-factor(hydro_phylum_Bow$taxon, levels=c("Other", "Cyanobacteria", "Firmicutes", "Proteobacteria", "Bacteroidota"))

hydro_phylum_Bow$Site<-factor(hydro_phylum_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

hydro_rel_abun_plot_Bow <- ggplot(hydro_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), values=c("#66CCFF", "#003399", "#CC9966", "#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

hydro_rel_abun_plot_Bow

#Statistical tests

hist(hydro_phylum_Bow$rel_abund)
shapiro.test(hydro_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

kruskal.test(data=hydro_phylum_Bow, rel_abund ~ Site) #p = 0.9779
dunnTest(data=hydro_phylum_Bow, rel_abund ~ Site) #no sig. diff

#Proteobacteria
proteo_hydro_Bow<-subset(hydro_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_hydro_Bow, rel_abund ~ Site) #p = 0.778 no diff.

#Bacteroidota
bacter_hydro_Bow<-subset(hydro_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_hydro_Bow, rel_abund ~ Site) #p = 0.410 no diff.

#Firmicutes
firm_hydro_Bow<-subset(hydro_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_hydro_Bow, rel_abund ~ Site) #p = 0.0267
dunnTest(data=firm_hydro_Bow, rel_abund ~ Site) #COCH - PMF p=0.0188, z = 3.11
#Policeman Flats has significantly less Firmicutes than Cochrane

#Cyanobacteria
cyano_hydro_Bow<-subset(hydro_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_hydro_Bow, rel_abund ~ Site) #p = 0.000141
dunnTest(data=cyano_hydro_Bow, rel_abund ~ Site) 
#Cochrane sig. lower than all sites except Sunalta
#Sunalta sig. lower than Graves Bridge


## Heptageniidae ##

hep_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Heptageniidae")

hep_phylum_Bow$taxon<-factor(hep_phylum_Bow$taxon, levels=c("Other", "Bacteroidota", "Cyanobacteria", "Firmicutes", "Proteobacteria"))

hep_phylum_Bow$Site<-factor(hep_phylum_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

hep_rel_abun_plot_Bow <- ggplot(hep_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), values=c("#66CCFF", "#003399", "#CC9966", "#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

hep_rel_abun_plot_Bow

#Statistical tests

shapiro.test(hep_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_hep_Bow<-subset(hep_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_hep_Bow, rel_abund ~ Site) #p = 0.013 
dunnTest(data=proteo_hep_Bow, rel_abund ~ Site) 
#CUSHBR - PMF p=0.022
#CUSHBR - GRVBR p=0.0489

#Bacteroidota
bacter_hep_Bow<-subset(hep_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_hep_Bow, rel_abund ~ Site) #p = 0.00687 possible diff
dunnTest(data=bacter_hep_Bow, rel_abund ~ Site) 
#CUSHBR - PMF p = 0.00327

#Firmicutes
firm_hep_Bow<-subset(hep_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_hep_Bow, rel_abund ~ Site) #p = 0.014
dunnTest(data=firm_hep_Bow, rel_abund ~ Site) 
#COCH - CUSHBR p = 0.0295
#COCH - GRVBR p = 0.0350
#Cochrane has higher Firmicutes

#Cyanobacteria
cyano_hep_Bow<-subset(hep_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_hep_Bow, rel_abund ~ Site) #p < 0.001, chi-squared: 24.1 
dunnTest(data=cyano_hep_Bow, rel_abund ~ Site) 
#COCH - CUSHBR p < 0.001
#SUN - CUSHBR p = 0.0015

#GRVBR is very close to being sig. diff from COCH


## Chironomidae ##
chiro_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Chironomidae")

chiro_phylum_Bow$taxon<-factor(chiro_phylum_Bow$taxon, levels=c("Other", "Firmicutes", "Bacteroidota", "Proteobacteria", "Cyanobacteria"))

chiro_phylum_Bow$Site<-factor(chiro_phylum_Bow$Site, levels=c("Cochrane", "Cushing Bridge", "Policeman Flats"))

chiro_rel_abun_plot_Bow <- ggplot(chiro_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Cushing Bridge", "Policeman Flats"), values=c("#66CCFF", "#CC9966", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

chiro_rel_abun_plot_Bow

#Statistical tests

shapiro.test(chiro_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_chiro_Bow<-subset(chiro_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_chiro_Bow, rel_abund ~ Site) #p = 0.074 possible difference
dunnTest(data=proteo_chiro_Bow, rel_abund ~ Site) #no diff. 

#Bacteroidota
bacter_chiro_Bow<-subset(chiro_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_chiro_Bow, rel_abund ~ Site) #p = 0.062
dunnTest(data=bacter_chiro_Bow, rel_abund ~ Site) #no diff. 

#Firmicutes
firm_chiro_Bow<-subset(chiro_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_chiro_Bow, rel_abund ~ Site) #p = 0.054
dunnTest(data=firm_chiro_Bow, rel_abund ~ Site) 
#Very close to sig. between CUSHBR - PMF but no diff. 

#Cyanobacteria
cyano_chiro_Bow<-subset(chiro_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_chiro_Bow, rel_abund ~ Site) #p = 0.034 possible diff. 
dunnTest(data=cyano_chiro_Bow, rel_abund ~ Site) 
#No diff. but close btw CUSHBR - PMF and COCH - CUSHBR


## Perlidae ##

perl_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Perlidae")

perl_phylum_Bow$taxon<-factor(perl_phylum_Bow$taxon, levels=c("Other", "Firmicutes", "Cyanobacteria", "Bacteroidota", "Proteobacteria"))

perl_phylum_Bow$Site<-factor(perl_phylum_Bow$Site, levels=c("Cochrane", "Cushing Bridge", "Policeman Flats"))

perl_rel_abun_plot_Bow <- ggplot(perl_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Cushing Bridge", "Policeman Flats"), values=c("#66CCFF", "#CC9966", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

perl_rel_abun_plot_Bow

#Statistical tests

shapiro.test(perl_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_perl_Bow<-subset(perl_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_perl_Bow, rel_abund ~ Site) #p = 0.0429 possible difference
dunnTest(data=proteo_perl_Bow, rel_abund ~ Site) #COCH - CUSHBR p = 0.049 

#Bacteroidota
bacter_perl_Bow<-subset(perl_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_perl_Bow, rel_abund ~ Site) #p = 0.328 no diff 

#Firmicutes
firm_perl_Bow<-subset(perl_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_perl_Bow, rel_abund ~ Site) #p = 0.11

#Cyanobacteria
cyano_perl_Bow<-subset(perl_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_perl_Bow, rel_abund ~ Site) #p = 0.00186 
dunnTest(data=cyano_perl_Bow, rel_abund ~ Site) 
#COCH - CUSHBR
#CUSHBR - PMF


## Trichoptera ##

trichop_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Trichoptera")

trichop_phylum_Bow$taxon<-factor(trichop_phylum_Bow$taxon, levels=c("Other", "Cyanobacteria", "Firmicutes", "Bacteroidota", "Proteobacteria"))

trichop_phylum_Bow$Site<-factor(trichop_phylum_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge"))

trichop_rel_abun_plot_Bow <- ggplot(trichop_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge"), values=c("#66CCFF", "#003399", "#CC9966", "#FF6666")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

trichop_rel_abun_plot_Bow

#Statistical tests

shapiro.test(trichop_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_trichop_Bow<-subset(trichop_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_trichop_Bow, rel_abund ~ Site) #p = 0.98 

#Bacteroidota
bacter_trichop_Bow<-subset(trichop_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_trichop_Bow, rel_abund ~ Site) #p = 0.638 

#Firmicutes
firm_trichop_Bow<-subset(trichop_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_trichop_Bow, rel_abund ~ Site) #p = 0.605

#Cyanobacteria
cyano_trichop_Bow<-subset(trichop_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_trichop_Bow, rel_abund ~ Site) #p = 0.249
#No diff. in Trichoptera


## Ephemeroptera ##

ephem_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Ephemeroptera")

ephem_phylum_Bow$taxon<-factor(ephem_phylum_Bow$taxon, levels=c("Other", "Bacteroidota", "Firmicutes", "Cyanobacteria", "Proteobacteria"))

ephem_phylum_Bow$Site<-factor(ephem_phylum_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

ephem_rel_abun_plot_Bow <- ggplot(ephem_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), values=c("#66CCFF", "#003399", "#CC9966", "#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

ephem_rel_abun_plot_Bow

#Statistical tests

shapiro.test(ephem_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_ephem_Bow<-subset(ephem_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_ephem_Bow, rel_abund ~ Site) #p = 0.010 
dunnTest(data=proteo_ephem_Bow, rel_abund ~ Site) 
#CUSHBR - GRVBR p = 0.0042

#Bacteroidota
bacter_ephem_Bow<-subset(ephem_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_ephem_Bow, rel_abund ~ Site) #p = 0.010
dunnTest(data=bacter_ephem_Bow, rel_abund ~ Site)
#COCH - CUSHBR p =0.019
#CUSHBR - PMF p = 0.0294
#CUSHBR - SUN p = 0.0434

#Firmicutes
firm_ephem_Bow<-subset(ephem_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_ephem_Bow, rel_abund ~ Site) #p = 0.176

#Cyanobacteria
cyano_ephem_Bow<-subset(ephem_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_ephem_Bow, rel_abund ~ Site) #p = 0.0036
dunnTest(data=cyano_ephem_Bow, rel_abund ~ Site)
#CUSHBR - GRVBR p = 0.0035
#CUSHBR - PMF p = 0.037

#Cushing Bridge had the lowest amount of Cyanobacteria in mayfly adults compared to mayfly larvae which had the most at that site. Interesting.

## Diptera ##

dip_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Diptera")

dip_phylum_Bow$taxon<-factor(dip_phylum_Bow$taxon, levels=c("Other", "Bacteroidota", "Cyanobacteria", "Firmicutes", "Proteobacteria"))

dip_phylum_Bow$Site<-factor(dip_phylum_Bow$Site, levels=c("Cochrane", "Cushing Bridge", "Policeman Flats"))

dip_rel_abun_plot_Bow <- ggplot(dip_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Cushing Bridge", "Policeman Flats"), values=c("#66CCFF", "#CC9966", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

dip_rel_abun_plot_Bow

#Statistical tests

shapiro.test(dip_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_dip_Bow<-subset(dip_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_dip_Bow, rel_abund ~ Site) #p = 0.42 

#Bacteroidota
bacter_dip_Bow<-subset(dip_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_dip_Bow, rel_abund ~ Site) #p = 0.369 

#Firmicutes
firm_dip_Bow<-subset(dip_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_dip_Bow, rel_abund ~ Site) #p = 0.366

#Cyanobacteria
cyano_dip_Bow<-subset(dip_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_dip_Bow, rel_abund ~ Site) #p = 0.843 


## Araneidae ##

aran_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Araneidae")

aran_phylum_Bow$taxon<-factor(aran_phylum_Bow$taxon, levels=c("Other", "Firmicutes", "Proteobacteria", "Cyanobacteria", "Bacteroidota"))

aran_phylum_Bow$Site<-factor(aran_phylum_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

aran_rel_abun_plot_Bow <- ggplot(aran_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), values=c("#66CCFF", "#003399", "#CC9966", "#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

aran_rel_abun_plot_Bow

#Statistical tests

shapiro.test(aran_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_aran_Bow<-subset(aran_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_aran_Bow, rel_abund ~ Site) #p = 0.010 
dunnTest(data=proteo_aran_Bow, rel_abund ~ Site) 
#No sig. differences. CUSHBR - SUN and GRVBR - SUN very close.

#Bacteroidota
bacter_aran_Bow<-subset(aran_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_aran_Bow, rel_abund ~ Site) #p < 0.001
dunnTest(data=bacter_aran_Bow, rel_abund ~ Site)
#COCH - PMF p = 0.0033
#CUSHBR - PMF p = 0.0033
#GRVBR - PMF p = 0.00699

#Firmicutes
firm_aran_Bow<-subset(aran_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_aran_Bow, rel_abund ~ Site) #p = 0.619

#Cyanobacteria
cyano_aran_Bow<-subset(aran_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_aran_Bow, rel_abund ~ Site) #p < 0.001
dunnTest(data=cyano_aran_Bow, rel_abund ~ Site)
#COCH - PMF p = 0.0129
#COCH - SUN p < 0.001
#CUSHBR - SUN p = 0.0208


## Tetragnathidae ##

tetra_phylum_Bow<-subset(Phylum_Bow_graphing_df, sample_Family=="Tetragnathidae")

tetra_phylum_Bow$taxon<-factor(tetra_phylum_Bow$taxon, levels=c("Other", "Firmicutes", "Bacteroidota", "Cyanobacteria", "Proteobacteria"))

tetra_phylum_Bow$Site<-factor(tetra_phylum_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

tetra_rel_abun_plot_Bow <- ggplot(tetra_phylum_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), values=c("#66CCFF", "#003399", "#CC9966", "#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  coord_trans(x="log10")+
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.001, 0.01, 0.1, 1, 10, 100),
                     labels=c(0.001, 0.01, 0.1, 1, 10, 100)) +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

tetra_rel_abun_plot_Bow

#Statistical tests

shapiro.test(tetra_phylum_Bow$rel_abund) #not normal. Right skewed. Use Kruskal Wallis

#Proteobacteria
proteo_tetra_Bow<-subset(tetra_phylum_Bow, taxon=="Proteobacteria")
kruskal.test(data=proteo_tetra_Bow, rel_abund ~ Site) #p = 0.263

#Bacteroidota
bacter_tetra_Bow<-subset(tetra_phylum_Bow, taxon=="Bacteroidota")
kruskal.test(data=bacter_tetra_Bow, rel_abund ~ Site) #p = 0.172

#Firmicutes
firm_tetra_Bow<-subset(tetra_phylum_Bow, taxon=="Firmicutes")
kruskal.test(data=firm_tetra_Bow, rel_abund ~ Site) #p = 0.139

#Cyanobacteria
cyano_tetra_Bow<-subset(tetra_phylum_Bow, taxon=="Cyanobacteria")
kruskal.test(data=cyano_tetra_Bow, rel_abund ~ Site) #p = 0.216


### Genus level ###

taxon_rel_abund_Genus_Bow <- otu_rel_abund_Bow %>%
  dplyr::filter(level=="Genus") %>%
  dplyr::group_by(Site, sample_Family, Study_ID, taxon) %>%
  dplyr::summarize(rel_abund = 100*sum(rel_abund), .groups="drop") %>%
  drop_na(Site, sample_Family, taxon)

taxon_pool_Genus_Bow <- taxon_rel_abund_Genus_Bow %>%
  dplyr::group_by(Site, sample_Family, taxon) %>%
  dplyr::summarize(median=median(rel_abund), .groups="drop") %>%
  dplyr::group_by(taxon) %>%
  dplyr::summarize(pool = max(median) < 3,
            median = median(median),
            .groups="drop")

#Graphing pointrange plot with median and 50% quartiles
Genus_Bow_graphing_df<- dplyr::inner_join(taxon_rel_abund_Genus_Bow, taxon_pool_Genus_Bow, by="taxon") %>%
 dplyr::mutate(taxon = if_else(pool, "Other", taxon)) %>%
  dplyr::group_by(Study_ID, Site, sample_Family, taxon) %>%
  dplyr::summarize(rel_abund = sum(rel_abund),
            median = min(median),
            .groups="drop") %>%
  dplyr::mutate(taxon = factor(taxon),
         taxon = fct_reorder(taxon, median, .desc=F)) %>%
  dplyr::mutate(rel_abund = if_else(rel_abund == 0,
                             2/3 * lod,
                             rel_abund))
Genus_Bow_graphing_df


## Hydropsychidae ##

hydro_genus_Bow<-subset(Genus_Bow_graphing_df, sample_Family=="Hydropsychidae")

hydro_genus_Bow$Site<-factor(hydro_genus_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

hydro_rel_abun_plot_Bow_genus <- ggplot(hydro_genus_Bow, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  scale_color_manual(name="Site", labels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"), values=c("#66CCFF", "#003399", "#CC9966", "#FF6666", "#990000")) +
  labs(y="Genus", x="Relative Abundance (%)") +
  theme_bw() +
  coord_trans(x="log10")+
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

hydro_rel_abun_plot_Bow_genus

#Statistical tests

kruskal.test(data=hydro_genus_Bow, rel_abund ~ Site) #p = 0.98
dunnTest(data=hydro_genus_Bow, rel_abund ~ Site) #no sig. diff

#### Bow River graphs ####

#Phylum level

hydro_plot<-hydro_rel_abun_plot_Bow + rremove("axis.title")
hep_plot<-hep_rel_abun_plot_Bow + rremove("axis.title")
chiro_plot<-chiro_rel_abun_plot_Bow + rremove("axis.title")
perl_plot<-perl_rel_abun_plot_Bow + rremove("axis.title")
trichop_plot<-trichop_rel_abun_plot_Bow + rremove("axis.title")
ephem_plot<-ephem_rel_abun_plot_Bow + rremove("axis.title")
dip_plot<-dip_rel_abun_plot_Bow + rremove("axis.title")
aran_plot<-aran_rel_abun_plot_Bow + rremove("axis.title")
tetra_plot<-tetra_rel_abun_plot_Bow + rremove("axis.title")

rel_abun_fig_Bow<-ggarrange(hydro_plot, hep_plot, chiro_plot, perl_plot, trichop_plot, ephem_plot, dip_plot, aran_plot, tetra_plot, legend = "top", common.legend = T, labels = c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathiade"), font.label=list(size=10), vjust = -0, nrow=3, ncol=3)

annotate_figure(rel_abun_fig_Bow, left = textGrob("Phylum", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Relative Abundance (%)", gp = gpar(cex = 1.3)))


#ggsave(filename="Microbiome_Analysis/Final analysis/Relative abundance/All samples/point range rel abund graph Bow River across taxa.png", height=10, width=10, bg="white")


#### ACWA Streams ####

metadata_ACWA<-subset(sample_data_4, Stream_Type!="Bow River")

otu_rel_abund_ACWA <- dplyr::inner_join(ASVseq_ps_2, metadata_ACWA, by="Study_ID") %>%
  dplyr::inner_join(., taxonomy_modified, by="Sequences") %>% #joins taxonomy, abundances, and metadata
  dplyr::group_by(Study_ID) %>%
  dplyr::mutate(rel_abund = count / sum(count)) %>% #transforms to relative abundance
  dplyr::ungroup() %>%
  dplyr::select(-count) %>%
  pivot_longer(
    c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "Sequences"),
    names_to="level",
    values_to="taxon") 

#Phylum
taxon_rel_abund_Phylum_ACWA <- otu_rel_abund_ACWA %>%
  dplyr::filter(level=="Phylum") %>%
  dplyr::group_by(Site, sample_Family, Study_ID, taxon) %>%
  dplyr::summarize(rel_abund = 100*sum(rel_abund), .groups="drop") %>%
  drop_na(Site, sample_Family, taxon)

taxon_pool_Phylum_ACWA <- taxon_rel_abund_Phylum_ACWA %>%
  dplyr::group_by(Site, sample_Family, taxon) %>%
  dplyr::summarize(median=median(rel_abund), .groups="drop") %>%
  dplyr::group_by(taxon) %>%
  dplyr::summarize(pool = max(median) < 3,
            median = median(median),
            .groups="drop")

#Graphing pointrange plot with median and 50% quartiles
Phylum_ACWA_graphing_df<- dplyr::inner_join(taxon_rel_abund_Phylum_ACWA, taxon_pool_Phylum_ACWA, by="taxon") %>%
 dplyr::mutate(taxon = if_else(pool, "Other", taxon)) %>%
  dplyr::group_by(Study_ID, Site, sample_Family, taxon) %>%
  dplyr::summarize(rel_abund = sum(rel_abund),
            median = min(median),
            .groups="drop") %>%
  dplyr::mutate(taxon = factor(taxon),
         taxon = fct_reorder(taxon, median, .desc=T)) %>%
  dplyr::mutate(rel_abund = if_else(rel_abund == 0,
                             2/3 * lod,
                             rel_abund))
Phylum_ACWA_graphing_df

## Hydropsychidae ##

hydro_ACWA_phylum<-subset(Phylum_ACWA_graphing_df, sample_Family=="Hydropsychidae")

hydro_ACWA_phylum$taxon<-factor(hydro_ACWA_phylum$taxon, levels=c("Other", "Cyanobacteria", "Firmicutes", "Proteobacteria", "Bacteroidota"))

hydro_ACWA_phylum$Site<-factor(hydro_ACWA_phylum$Site, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))

hydro_rel_abun_plot_ACWA <- ggplot(hydro_ACWA_phylum, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", values=c("#CC9966", "#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

hydro_rel_abun_plot_ACWA

#Statistical tests

#Proteobacteria
proteo_hydro_ACWA<-subset(hydro_ACWA_phylum, taxon=="Proteobacteria")
kruskal.test(data=proteo_hydro_ACWA, rel_abund ~ Site) #p = 0.0767 no diff.
dunnTest(data=proteo_hydro_ACWA, rel_abund ~ Site) #no diff

#Bacteroidota
bacter_hydro_ACWA<-subset(hydro_ACWA_phylum, taxon=="Bacteroidota")
kruskal.test(data=bacter_hydro_ACWA, rel_abund ~ Site) #p = 0.117 no diff.

#Firmicutes
firm_hydro_Bow<-subset(hydro_ACWA_phylum, taxon=="Firmicutes")
kruskal.test(data=firm_hydro_Bow, rel_abund ~ Site) #p = 0.0701
dunnTest(data=firm_hydro_Bow, rel_abund ~ Site) #No diff

#Cyanobacteria
cyano_hydro_Bow<-subset(hydro_ACWA_phylum, taxon=="Cyanobacteria")
kruskal.test(data=cyano_hydro_Bow, rel_abund ~ Site) #p = 0.032
dunnTest(data=cyano_hydro_Bow, rel_abund ~ Site) 
#EXP5 has higher compared to REF Z = 2.55, P = 0.0327


## Baetidae ##

baetid_ACWA_phylum<-subset(Phylum_ACWA_graphing_df, sample_Family=="Baetidae")

baetid_ACWA_phylum$taxon<-factor(baetid_ACWA_phylum$taxon, levels=c("Firmicutes", "Other","Cyanobacteria", "Bacteroidota", "Proteobacteria"))

baetid_ACWA_phylum$Site<-factor(baetid_ACWA_phylum$Site, levels=c("PCR1", "PCR3"), labels=c("EXP5", "EXP15"))

baetid_rel_abun_plot_ACWA <- ggplot(baetid_ACWA_phylum, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", values=c("#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

baetid_rel_abun_plot_ACWA

#Statistical tests

#Proteobacteria
proteo_baetid_ACWA<-subset(baetid_ACWA_phylum, taxon=="Proteobacteria")
kruskal.test(data=proteo_baetid_ACWA, rel_abund ~ Site) #p = 0.355

#Bacteroidota
bacter_baetid_ACWA<-subset(baetid_ACWA_phylum, taxon=="Bacteroidota")
kruskal.test(data=bacter_baetid_ACWA, rel_abund ~ Site) #p = 0.488 no diff.

#Firmicutes
firm_baetid_Bow<-subset(baetid_ACWA_phylum, taxon=="Firmicutes")
kruskal.test(data=firm_baetid_Bow, rel_abund ~ Site) #p = 0.563

#Cyanobacteria
cyano_baetid_Bow<-subset(baetid_ACWA_phylum, taxon=="Cyanobacteria")
kruskal.test(data=cyano_baetid_Bow, rel_abund ~ Site) #p = 0.418


## Ephemeroptera ##

ephem_ACWA_phylum<-subset(Phylum_ACWA_graphing_df, sample_Family=="Ephemeroptera")

ephem_ACWA_phylum$taxon<-factor(ephem_ACWA_phylum$taxon, levels=c("Cyanobacteria", "Other", "Firmicutes", "Proteobacteria", "Bacteroidota"))

ephem_ACWA_phylum$Site<-factor(ephem_ACWA_phylum$Site, levels=c("PCR1", "PCR3"), labels=c("EXP5", "EXP15"))

ephem_rel_abun_plot_ACWA <- ggplot(ephem_ACWA_phylum, aes(y=taxon, x=rel_abund, color=Site)) +
  stat_summary(fun.data=median_hilow, geom = "pointrange",
               fun.args=list(conf.int=0.5),
               position = position_dodge(width=1)) +
  coord_trans(x="log10") +
  scale_x_continuous(limits=c(NA, 100),
                     breaks=c(0.01, 0.1, 1, 10, 100),
                     labels=c(0.01, 0.1, 1, 10, 100)) +
  scale_color_manual(name="Site", values=c("#FF6666", "#990000")) +
  labs(y="Phylum", x="Relative Abundance (%)") +
  theme_bw() +
  rremove("grid")+
  theme(axis.text.y = element_text(color="black"), axis.text.x = element_text(color="black"))

ephem_rel_abun_plot_ACWA

#Statistical tests

#Proteobacteria
proteo_ephem_ACWA<-subset(ephem_ACWA_phylum, taxon=="Proteobacteria")
kruskal.test(data=proteo_ephem_ACWA, rel_abund ~ Site) #p = 0.115

#Bacteroidota
bacter_ephem_ACWA<-subset(ephem_ACWA_phylum, taxon=="Bacteroidota")
kruskal.test(data=bacter_ephem_ACWA, rel_abund ~ Site) #p = 0.4008

#Firmicutes
firm_ephem_Bow<-subset(ephem_ACWA_phylum, taxon=="Firmicutes")
kruskal.test(data=firm_ephem_Bow, rel_abund ~ Site) #p = 0.00865

#Cyanobacteria
cyano_ephem_Bow<-subset(ephem_ACWA_phylum, taxon=="Cyanobacteria")
kruskal.test(data=cyano_ephem_Bow, rel_abund ~ Site) #p = 0.916


#### ACWA graphs ####

#Phylum level

hydro_plot_ACWA<-hydro_rel_abun_plot_ACWA + rremove("axis.title")
baetid_plot_ACWA<-baetid_rel_abun_plot_ACWA + rremove("axis.title")
ephem_plot_ACWA<-ephem_rel_abun_plot_ACWA + rremove("axis.title")

rel_abun_fig_ACWA<-ggarrange(hydro_plot_ACWA, baetid_plot_ACWA, ephem_plot_ACWA, legend = "bottom", common.legend = T, labels = c("Hydropsychidae", "Baetidae", "Ephemeroptera"), font.label=list(size=10), vjust = 2, hjust = -1.6, nrow=1, ncol=3)

annotate_figure(rel_abun_fig_ACWA, left = textGrob("Phylum", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Relative Abundance (%)", gp = gpar(cex = 1.3)))


#ggsave(filename="Microbiome_Analysis/Final analysis/Relative abundance/All samples/point range rel abund graph ACWA across taxa.png", height=8, width=10, bg="white")


```

### Plotting relative abundance {.tabset}
#### Bow River - faceted across taxa and sites
```{r}
#### Phylum ####

Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")
rel_abun_phylum_bow <- speedyseq::tax_glom(Bow_ps, taxrank = "Phylum")
comp_rel_abun_phylum_bow <- transform_sample_counts(rel_abun_phylum_bow, function(x) x/sum(x))

rel_abun_prune_sample_bow <- psmelt(comp_rel_abun_phylum_bow)

sample.df.agg_bow <- aggregate(Abundance ~ Phylum + Site_code + sample_Family + Stage, data = rel_abun_prune_sample_bow, FUN = mean) #aggregate to Phylum level, take the mean
sample.df.agg_bow$Site_code <- factor(sample.df.agg_bow$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))
sample.df.agg_bow$sample_Family<-factor(sample.df.agg_bow$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Baetidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))


#Top 5 phyla relative abundance, all inverts included (Bow River and ACWA combined)
top_phyla_bow <- sample.df.agg_bow %>%
    group_by(Site_code, Phylum) %>%
    summarise(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_phyla_bow
top5_bow <- top_phyla_bow$Phylum[1:23]
df0_bow <- sample.df.agg_bow %>%
    mutate(Phylum = fct_other(Phylum, top5_bow))
df0_bow
df0_bow<-aggregate(Abundance~Phylum + Site_code + sample_Family+Stage, data=df0_bow, FUN="sum") #Aggregate again to combine all the 'Other' categories into a single bar on the graph.

df0_bow$Phylum <- factor(df0_bow$Phylum, levels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Actinobacteriota", "Other", "Proteobacteria"), labels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Actinobacteriota", "Other", "Proteobacteria"))

df0_bow$sample_Family<-factor(df0_bow$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Baetidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))

top5phylumplot_bow <- ggplot(df0_bow, aes(x=factor(Site_code, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=Abundance, fill=Phylum)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(1, "cm"),
        legend.text=element_text(size=14), legend.title=element_text(size=14), legend.position = "bottom") +
  guides (fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title.x=element_text(size=22))+
  scale_fill_manual(name="Phylum", values = c("#A6CEE3", "#1F78B4", "#B2DF8A", "#CC9966", "#43464B", "darkolivegreen4"))+
  scale_y_continuous(label = scales::percent)+
  rremove("grid")+
  xlab("Site")+
  facet_nested_wrap(~Stage+sample_Family, scales="free_x", nrow=1)
top5phylumplot_bow

#ggsave(filename="Microbiome_ED/Final Analysis/Relative abundance/All samples/Mean relative abundance of top 5 phyla across invertebrate taxa Bow only.png", height=10, width=22)

#### Class Level ####
rel_abun_class <- speedyseq::tax_glom(sample_ps, taxrank = "Class")
rel_abun_class <- transform_sample_counts(rel_abun_class, function(x){x / sum(x)})
rel_abun_all_prune_class = prune_taxa(taxa_sums(rel_abun_class) > 0.05, rel_abun_class) 

rel_abun_prune_sample_class <- psmelt(rel_abun_all_prune_class)

sample.df.agg.class <- aggregate(Abundance ~ Class + Site_code  + sample_Family+Stage, data = rel_abun_prune_sample_class, FUN = mean) #aggregate to Phylum level, take the mean
sample.df.agg.class$Site <- factor(sample.df.agg.class$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats", "BRR2", "PCR1", "PCR3"))
sample.df.agg.class$Site_code <- factor(sample.df.agg.class$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF", "BRR2", "PCR1", "PCR3"))


rel_abun_plot_class <- ggplot(sample.df.agg.class, aes(x=Site_code, y=Abundance, fill=Class)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_wrap(.~sample_Family, scale="free_x", nrow=2) + 
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_discrete(name="Bacterial Class")

rel_abun_plot_class #Too many classes

top_class <- sample.df.agg.class %>%
    group_by(Site_code, Class) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_class
top5class <- top_class$Class[1:30]
top5classdf <- sample.df.agg.class %>%
    mutate(Class = fct_other(Class, top5class))
top5classdf <- aggregate(Abundance ~ Class + Site_code  + sample_Family+Stage, data = top5classdf, FUN = sum)
top5classdf

top5classdf$Class <- factor(top5classdf$Class, levels=c("Alphaproteobacteria", "Bacteroidia", "Gammaproteobacteria", "Bacilli", "Other", "Clostridia", "Cyanobacteriia"))

top5classdf$sample_Family<-factor(top5classdf$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Baetidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))

top5classplot <- ggplot(top5classdf, aes(x=Site_code, y=Abundance, fill=Class)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scales="free_x", nrow=1) + 
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=6)) +
  theme_bw()+
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title.x=element_text(size=22))+
  scale_fill_manual(name="Bacterial Phylum", values = c("#A6CEE3", "#1F78B4", "#B2DF8A", "#CC9966", "#43464B", "darkolivegreen4"))+
  scale_y_continuous(label = scales::percent)+
  rremove("grid")
top5classplot

#ggsave(filename="Microbiome_ED/Final Analysis/Relative abundance/All samples/Mean relative abundance of top 5 classes across invertebrates Bow only.png", height=10, width=22)


#### Family Level ####

sample_all_Bow<-subset_samples(sample_ps, Stream_Type=="Bow River")

rel_abun_fam_Bow <- tax_glom(sample_all_Bow, taxrank = "Family")
comp_rel_abun_fam_Bow <- transform_sample_counts(rel_abun_fam_Bow, function(x){x / sum(x)})

rel_abun_prune_sample_fam_Bow <- psmelt(comp_rel_abun_fam_Bow)

sample.df.agg_fam_Bow <- aggregate(Abundance ~ Family + Site_code + sample_Family+Stage, data = rel_abun_prune_sample_fam_Bow, FUN = mean) #aggregate to Phylum level, take the mean

sample.df.agg_fam_Bow$Site <- factor(sample.df.agg_fam_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

sample.df.agg_fam_Bow$Site_code <- factor(sample.df.agg_fam_Bow$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

rel_abun_plot_fam_Bow <- ggplot(sample.df.agg_fam_Bow, aes(x=Site_code, y=Abundance, fill=Family)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance \n >10% ASVs") +
  facet_grid(~sample_Family, scale="free_x") + 
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.2, "cm"),
        legend.text=element_text(size=8)) +
  guides(fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)

#Top ~22 families, all inverts included
top_fam_Bow <- sample.df.agg_fam_Bow %>%
    group_by(Site_code, Family) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top5fam_Bow <- top_fam_Bow$Family[1:75]
top5famdf_Bow <- sample.df.agg_fam_Bow %>%
    mutate(Family = fct_other(Family, top5fam_Bow))

top5famdf_Bow <- aggregate(Abundance ~ Family + Site_code + sample_Family+Stage, data = top5famdf_Bow, FUN = sum)

top5famdf_Bow$sample_Family<-factor(top5famdf_Bow$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))


top5famplotBow <- ggplot(top5famdf_Bow, aes(x=factor(Site_code, labels = c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=Abundance, fill=Family)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1) + 
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=22))+
  scale_fill_manual(name="Family", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
top5famplotBow 

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/All samples/Top 22 families larvae, adults, spiders separated by invertebrate taxa type Bow only.png", height=10, width=22)

#### Genus level ####

rel_abun_genus_Bow <- tax_glom(Bow_ps, taxrank = "Genus")
comp_rel_abun_genus_Bow <- transform_sample_counts(rel_abun_genus_Bow, function(x) x/sum(x))

rel_abun_prune_sample_genus_Bow <- psmelt(comp_rel_abun_genus_Bow)

sample.df.agg_genus_Bow <- aggregate(Abundance ~ Genus + Site_code + sample_Family+Stage, data = rel_abun_prune_sample_genus_Bow, FUN = mean) #aggregate to Phylum level, take the mean

sample.df.agg_genus_Bow$Site <- factor(sample.df.agg_genus_Bow$Site, levels=c("Cochrane", "Sunalta", "Cushing Bridge", "Graves Bridge", "Policeman Flats"))

sample.df.agg_genus_Bow$Site_code <- factor(sample.df.agg_genus_Bow$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

sample.df.agg_genus_Bow$Stage<-factor(sample.df.agg_genus_Bow$Stage, levels=c("Larvae", "Adults", "Spiders"))

rel_abun_plot_genus_Bow <- ggplot(sample.df.agg_genus_Bow, aes(x=Site_code, y=Abundance, fill=Genus)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance \n >10% ASVs") +
  facet_grid(~sample_Family, scale="free_x") + 
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.2, "cm"),
        legend.text=element_text(size=8)) +
  guides(fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)

#Top ~22 genus, all inverts included
top_genus_Bow <- sample.df.agg_genus_Bow %>%
    group_by(Site_code, Genus) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top5genus_Bow <- top_genus_Bow$Genus[1:63]
top5genusdf_Bow <- sample.df.agg_genus_Bow %>%
    mutate(Genus = fct_other(Genus, top5genus_Bow))

top5genusdf_Bow <- aggregate(Abundance ~ Genus + Site_code + sample_Family+Stage, data = top5genusdf_Bow, FUN = sum)

top5genusdf_Bow$sample_Family<-factor(top5genusdf_Bow$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Chironomidae ", "Araneidae", "Tetragnathidae"))


top5genusplotBow <- ggplot(top5genusdf_Bow, aes(x=factor(Site_code, labels = c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1) + 
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 22, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=20, face="italic"), legend.title=element_text(size=20)) +
  guides (fill=guide_legend(nrow=24)) +
  theme(axis.title.y=element_text(size=26),
        axis.text.y=element_text(size=22, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=22, color="black"),
                        axis.title=element_text(size=26))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
top5genusplotBow 

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/All samples/Top 22 genera separated by invertebrate taxa type Bow only, caddis PMF included.png", height=16, width=26)


#Decontaminated data:

sample_all_Bow_decontam<-subset_samples(decontam_ps, Stream_Type=="Bow River")

rel_abun_genus_Bow_decontam <- tax_glom(sample_all_Bow_decontam, taxrank = "Genus")
comp_rel_abun_genus_Bow_decontam <- microbiome::transform(rel_abun_genus_Bow_decontam, "compositional")

rel_abun_prune_sample_genus_Bow_decontam <- psmelt(comp_rel_abun_genus_Bow_decontam)

sample.df.agg_genus_Bow_decontam <- aggregate(Abundance ~ Genus + Site_code + sample_Family+Stage, data = rel_abun_prune_sample_genus_Bow_decontam, FUN = mean) #aggregate to Phylum level, take the mean

#Top ~22 genera, all inverts included
top_genus_Bow_decontam <- sample.df.agg_genus_Bow_decontam %>%
    group_by(Site_code, Genus) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top5genus_Bow_decontam<- top_genus_Bow_decontam$Genus[1:60]
top5genusdf_Bow_decontam <- sample.df.agg_genus_Bow_decontam %>%
    mutate(Genus = fct_other(Genus, top5genus_Bow_decontam))
top5genusdf_Bow_decontam<-aggregate(Abundance~ Genus + Site_code + sample_Family+Stage, data = top5genusdf_Bow_decontam, FUN = sum)

top5genusdf_Bow_decontam$Site_code <- factor(top5genusdf_Bow_decontam$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

top5genusdf_Bow_decontam$sample_Family<-factor(top5genusdf_Bow_decontam$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Baetidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Hydropsychidae", "Heptageniidae", "Baetidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Chironomidae ", "Araneidae", "Tetragnathidae"))

top5genusdf_Bow_decontam$Stage<-factor(top5genusdf_Bow_decontam$Stage, levels=c("Larvae", "Adults", "Spiders"))

top5genusplot_Bow_decontam <- ggplot(top5genusdf_Bow_decontam, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1) + 
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title.x=element_text(size=22))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
top5genusplot_Bow_decontam

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/All samples/Top 22 genera separated by invertebrate taxa type Bow and ACWA decontaminated caddis PMF included.png", height=10, width=24)


#Both Bow River graphs combined

top5genusplotBow_1<- top5genusplotBow + rremove("xlab") +rremove("ylab")
top5genusplotBow_decontam_1<- top5genusplot_Bow_decontam + rremove("xlab") +rremove("ylab")

Bow_arrange<- ggarrange(top5genusplotBow_1, top5genusplotBow_decontam_1, ncol=1, nrow=2, align="v")

annotate_figure(Bow_arrange, left = textGrob("Mean Relative Abundance", rot = 90, vjust = 1, gp = gpar(cex = 2.5)), bottom = textGrob("Site", gp = gpar(cex = 2.5)), bgcolor("white"))

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/All samples/Bow decontam vs non decontam caddis PMF included.png", height=12, width=20, bg="white")

```

#### ACWA - faceted across taxa and sites
```{r}
#### Phylum ####
#ACWA only
ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River")
rel_abun_phylum_ACWA <- speedyseq::tax_glom(ACWA_ps, taxrank = "Phylum")
comp_rel_abun_phylum_ACWA <- transform_sample_counts(rel_abun_phylum_ACWA, function(x) x/sum(x))

rel_abun_prune_sample_ACWA <- psmelt(comp_rel_abun_phylum_ACWA)

sample.df.agg.ACWA <- aggregate(Abundance ~ Phylum + Site_code + sample_Family + Stage , data = rel_abun_prune_sample_ACWA, FUN = mean) #aggregate to Phylum level, take the mean
sample.df.agg.ACWA$Site_code <- factor(sample.df.agg.ACWA$Site_code, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))
sample.df.agg.ACWA$sample_Family<-factor(sample.df.agg.ACWA$sample_Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"))

#Top 5 phyla relative abundance, all inverts included (Bow River and ACWA combined)
top_phyla_ACWA <- sample.df.agg.ACWA %>%
    group_by(Site_code, Phylum) %>%
    summarise(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_phyla_ACWA
top5_ACWA <- top_phyla_ACWA$Phylum[1:13]
df0_ACWA <- sample.df.agg.ACWA %>%
    mutate(Phylum = fct_other(Phylum, top5_ACWA))
df0_ACWA<-aggregate(Abundance~Phylum+sample_Family+Site_code+Stage, data=df0_ACWA, FUN="sum")

df0_ACWA$Phylum <- factor(df0_ACWA$Phylum, levels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Deferribacterota", "Other", "Proteobacteria"), labels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Deferribacterota", "Other", "Proteobacteria"))

top5phylumplot_ACWA <- ggplot(df0_ACWA, aes(x=Site_code, y=Abundance, fill=Phylum)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  facet_nested_wrap(~Stage+sample_Family, scales="free_x", nrow=1)+ 
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(1, "cm"),
        legend.text=element_text(size=16), legend.title=element_text(size=16), legend.position = "bottom") +
  guides (fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_markdown(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=22))+
  scale_fill_manual(name="Phylum", values = c("#A6CEE3", "#1F78B4", "#B2DF8A", "#CC9966", "#43464B", "darkolivegreen4"))+
  scale_y_continuous(label = scales::percent)+
  rremove("grid")+
  xlab("ACWA Stream")
top5phylumplot_ACWA

#ggsave(filename="Microbiome_ED/Final Analysis/Relative abundance/All samples/Mean relative abundance of top 5 phyla across invertebrate taxa ACWA only.png", height=10, width=22)
#### Family ####

sample_all_ACWA<-subset_samples(sample_ps, Stream_Type!="Bow River")

rel_abun_fam_ACWA <- tax_glom(sample_all_ACWA, taxrank = "Family")
comp_rel_abun_fam_ACWA <- transform_sample_counts(rel_abun_fam_ACWA, function(x) x/sum(x))

rel_abun_prune_sample_fam_ACWA <- psmelt(comp_rel_abun_fam_ACWA)

sample.df.agg_fam_ACWA <- aggregate(Abundance ~ Family + Site_code + sample_Family+Stage, data = rel_abun_prune_sample_fam_ACWA, FUN = mean) #aggregate to Phylum level, take the mean
sample.df.agg_fam_ACWA$Site <- factor(sample.df.agg_fam_ACWA$Site, levels=c("BRR2", "PCR1", "PCR3"))
sample.df.agg_fam_ACWA$sample_Family<-factor(sample.df.agg_fam_ACWA$sample_Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"))

rel_abun_plot_fam_ACWA <- ggplot(sample.df.agg_fam_ACWA, aes(x=Site_code, y=Abundance, fill=Family)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance \n >10% ASVs") +
  facet_grid(~sample_Family, scale="free_x") + 
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.2, "cm"),
        legend.text=element_text(size=8)) +
  guides(fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)

#Top ~22 families, all inverts included
top_fam_ACWA <- sample.df.agg_fam_ACWA %>%
    group_by(Site_code, Family) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_fam_ACWA
top5fam_ACWA <- top_fam_ACWA$Family[1:53]
top5famdf_ACWA <- sample.df.agg_fam_ACWA %>%
    mutate(Family = fct_other(Family, top5fam_ACWA))


top5famdf_ACWA <- aggregate(Abundance ~ Family + Site_code + sample_Family+Stage, data = top5famdf_ACWA, FUN = sum)


top5famplotACWA<- ggplot(top5famdf_ACWA, aes(x=factor(Site_code, labels = c("BRR2", "PCR1", "PCR3")), y=Abundance, fill=Family)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1) + 
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=22))+
  scale_fill_manual(name="Family", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
top5famplotACWA

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/All samples/Top 22 families Hydropsychidae, Baetidae ACWA.png", height=10, width=22)

#### Genus ####
ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River")
rel_abun_genus_ACWA <- tax_glom(ACWA_ps, taxrank = "Genus")
comp_rel_abun_genus_ACWA <- microbiome::transform(rel_abun_genus_ACWA, "compositional")

rel_abun_prune_sample_genus_ACWA <- psmelt(comp_rel_abun_genus_ACWA)

sample.df.agg_genus_ACWA <- aggregate(Abundance ~ Genus + Site + sample_Family+Stage, data = rel_abun_prune_sample_genus_ACWA, FUN = mean) #aggregate to Phylum level, take the mean

sample.df.agg_genus_ACWA$sample_Family<-factor(sample.df.agg_genus_ACWA$sample_Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"))

sample.df.agg_genus_ACWA$Site<-factor(sample.df.agg_genus_ACWA$Site, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))

#Top ~23 genera
top_genus_ACWA <- sample.df.agg_genus_ACWA %>%
    group_by(Site, Genus) %>% #groups together the abundances by genera of bacteria
    summarize(Mean = mean(Abundance)) %>% #takes the mean abundance of each genus per sample
    arrange(-Mean) #arrange by decreasing mean abundance per genus of bacteria
top_genus_ACWA
top5genus_ACWA <- top_genus_ACWA$Genus[1:44] #Specifies the number of lines of data to take
top5genus_ACWA
top5genusdf_ACWA <- sample.df.agg_genus_ACWA %>%
    mutate(Genus = fct_other(Genus, top5genus_ACWA)) 
top5genusdf_ACWA <- aggregate(Abundance ~ Genus + Site + sample_Family+Stage, data = top5genusdf_ACWA, FUN = sum)
    

top5genusplotACWA <- ggplot(top5genusdf_ACWA, aes(x=Site, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1) + 
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=16, face="italic"), legend.title=element_text(size=16)) +
  guides (fill=guide_legend(nrow=24)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=20, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, vjust=1, size=20, color="black"),
        axis.title.x=element_text(size=22, vjust= -1))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("ACWA Stream")+
  rremove("grid")
top5genusplotACWA

ggsave(filename="microbiome_analysis/Final analysis/Relative abundance/All samples/Top 22 genera ACWA across inverts.png", height=10, width=22)

#ACWA decontam

ACWA_ps_decontam<-subset_samples(decontam_ps, Stream_Type!="Bow River")
rel_abun_genus_ACWA_decontam <- tax_glom(ACWA_ps_decontam, taxrank = "Genus")
comp_rel_abun_genus_ACWA_decontam <- microbiome::transform(rel_abun_genus_ACWA_decontam, "compositional")

rel_abun_prune_sample_genus_ACWA_decontam <- psmelt(comp_rel_abun_genus_ACWA_decontam)

sample.df.agg_genus_ACWA_decontam <- aggregate(Abundance ~ Genus + Site + sample_Family+Stage, data = rel_abun_prune_sample_genus_ACWA_decontam, FUN = mean) #aggregate to Phylum level, take the mean

sample.df.agg_genus_ACWA_decontam$sample_Family<-factor(sample.df.agg_genus_ACWA_decontam$sample_Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"), labels=c("Hydropsychidae", "Baetidae", "Baetidae "))

sample.df.agg_genus_ACWA_decontam$Site<-factor(sample.df.agg_genus_ACWA_decontam$Site, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))


sample.df.agg_genus_ACWA_decontam$Stage<-factor(sample.df.agg_genus_ACWA_decontam$Stage, levels=c("Larvae", "Adults"))

#Top ~23 genera
top_genus_ACWA_decontam <- sample.df.agg_genus_ACWA_decontam %>%
    group_by(Site, Genus) %>% #groups together the abundances by genera of bacteria
    summarize(Mean = mean(Abundance)) %>% #takes the mean abundance of each genus per sample
    arrange(-Mean) #arrange by decreasing mean abundance per genus of bacteria
top5genus_ACWA_decontam <- top_genus_ACWA_decontam$Genus[1:44] #Specifies the number of lines of data to take
top5genusdf_ACWA_decontam <- sample.df.agg_genus_ACWA_decontam %>%
    mutate(Genus = fct_other(Genus, top5genus_ACWA_decontam)) 
top5genusdf_ACWA_decontam <- aggregate(Abundance ~ Genus + Site + sample_Family+Stage, data = top5genusdf_ACWA_decontam, FUN = sum)
    

top5genusplotACWA_decontam <- ggplot(top5genusdf_ACWA_decontam, aes(x=Site, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1) + 
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=16, face="italic"), legend.title=element_text(size=16)) +
  guides (fill=guide_legend(nrow=24)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=20, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, vjust=1, size=20, color="black"),
        axis.title.x=element_text(size=22, vjust= -1))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("ACWA Stream")+
  rremove("grid")
top5genusplotACWA_decontam

#Both ACWA graphs combined

top5genusplotACWA_1<- top5genusplotACWA + rremove("xlab") +rremove("ylab")
top5genusplotACWA_decontam_1<- top5genusplotACWA_decontam + rremove("xlab") +rremove("ylab")

ACWA_arrange<- ggarrange(top5genusplotACWA_1, top5genusplotACWA_decontam_1, ncol=1, nrow=2, align="v", common.legend = TRUE, legend = "right")

annotate_figure(ACWA_arrange, left = textGrob("Mean Relative Abundance", rot = 90, vjust = 0.5, gp = gpar(cex = 2.5)), bottom = textGrob("ACWA Stream", gp = gpar(cex = 2.5), hjust=0.7), bgcolor("white"))

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/All samples/ACWA decontam vs non decontam.png", height=10, width=18, bg="white")
```

#### Cyanobacteria
```{r}
Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")
ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River")

cyano_Bow<-subset_taxa(Bow_ps, Phylum=="Cyanobacteria")
cyano_Bow<-prune_taxa(taxa_sums(cyano_Bow)>0, cyano_Bow)
cyano_Bow #248 taxa, 284 samples
cyano_ACWA<-subset_taxa(ACWA_ps, Phylum=="Cyanobacteria")
cyano_ACWA<-prune_taxa(taxa_sums(cyano_ACWA)>0, cyano_ACWA)
cyano_ACWA #148 taxa, 55 samples

## Filtering for the cyanotoxin producing genera (Gugger et al., 2023 ; Millar et al., 2020; Zanchett and Oliveira-Filho, 2013) ##

cyanotox_Bow<-subset_taxa(Bow_ps, Genus=="Dolichospermum" | Genus=="Anabaena" | Genus=="Planktothrix NIVA-CYA 15" | Genus=="Synechocytis" | Genus=="Synechococcus" | Genus=="Microcystis PCC-7914" | Genus=="Aphanizomenon MDT14a" | Genus=="Schizothrix LEGE 07164" | Genus=="Chroococus" | Genus=="Hydrocoleum" | Genus=="Aphanizomenon flos-aquae" | Genus=="Aphanizomenon" | Genus=="Fischerella" | Genus=="Planktothrix" | Genus=="Nostoc" | Genus=="Anabaenopsis" | Genus=="Nodularia" | Genus=="Cylindrospermopsis raciborskii" | Genus=="Aphanizomenon ovalisporum" | Genus=="Aphanizomenon zflos-aquae" | Genus=="Alexandrium" | Genus=="Pyrodinium" | Genus=="Gymnodinium" | Genus=="Lyngbya wollei" | Genus=="Lyngbya")
cyanotox_Bow<-prune_taxa(taxa_sums(cyanotox_Bow) > 0, cyanotox_Bow)
cyanotox_Bow #2 taxa, 284 samples
sort(table(tax_table(cyanotox_Bow)[,6])) #1 genera: Planktothrix NIVA-CYA 15

cyanotox_ACWA<-subset_taxa(ACWA_ps, Genus=="Dolichospermum" | Genus=="Anabaena" | Genus=="Planktothrix NIVA-CYA 15" | Genus=="Synechocytis" | Genus=="Synechococcus" | Genus=="Microcystis PCC-7914" | Genus=="Aphanizomenon MDT14a" | Genus=="Schizothrix LEGE 07164" | Genus=="Chroococus" | Genus=="Hydrocoleum" | Genus=="Aphanizomenon flos-aquae" | Genus=="Aphanizomenon" | Genus=="Fischerella" | Genus=="Planktothrix" | Genus=="Nostoc" | Genus=="Anabaenopsis" | Genus=="Nodularia" | Genus=="Cylindrospermopsis raciborskii" | Genus=="Aphanizomenon ovalisporum" | Genus=="Aphanizomenon zflos-aquae" | Genus=="Alexandrium" | Genus=="Pyrodinium" | Genus=="Gymnodinium" | Genus=="Lyngbya wollei" | Genus=="Lyngbya")
cyanotox_ACWA<-prune_taxa(taxa_sums(cyanotox_ACWA) > 0, cyanotox_ACWA)
cyanotox_ACWA #3 taxa, 55 samples
sort(table(tax_table(cyanotox_ACWA)[,6])) #1 genera: Planktothrix NIVA-CYA 15

#### Bow River only ####

cyano_genus_Bow <- tax_glom(cyano_Bow, taxrank = "Genus")
cyano_genus_Bow #16 genera

rel_abun_cyano_genus_Bow <- transform_sample_counts(cyano_genus_Bow, function(x){x / sum(x)})

cyano_genus_Bow_df <- psmelt(rel_abun_cyano_genus_Bow)

cyano_genus_Bow_agg <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = cyano_genus_Bow_df, FUN = mean) 


cyano_genus_Bow_agg$Site_code <- factor(cyano_genus_Bow_agg$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

cyano_genus_Bow_agg$Stage<-factor(cyano_genus_Bow_agg$Stage, levels=c("Larvae", "Adults", "Spiders"))

cyano_genus_Bow_agg$sample_Family<-factor(cyano_genus_Bow_agg$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Chironomidae ", "Araneidae", "Tetragnathidae"))

ggplot(cyano_genus_Bow_agg, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage + sample_Family, scales="free_x", nrow=1) +  
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 22, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=24, face="italic"), legend.title=element_text(size=24)) +
  guides (fill=guide_legend(nrow=24)) +
  theme(axis.title.y=element_text(size=26),
        axis.text.y=element_text(size=22, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=22, color="black"),
                        axis.title=element_text(size=26))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")

#ggsave(filename="microbiome_analysis/Final analysis/Relative abundance/Cyanobacteria/Cyanobacteria genera across taxa and sites.png", height=12, width=26)

cyano_Bow_df = data.frame(Genus = tax_table(cyano_genus_Bow)[,"Genus"], Mean = rowMeans(otu_table(cyano_genus_Bow)), row.names = NULL)
cyano_Bow_df = cyano_Bow_df[order(-cyano_Bow_df$Mean),]

cyano_Bow_df$percentage <- (cyano_Bow_df$Mean/sum(cyano_Bow_df$Mean)*100)


#### ACWA streams only ####
cyano_genus_ACWA <- tax_glom(cyano_ACWA, taxrank = "Genus")
cyano_genus_ACWA #12 genera
rel_abun_cyano_genus_ACWA <- transform_sample_counts(cyano_genus_ACWA, function(x){x / sum(x)})

cyano_genus_ACWA_df <- psmelt(rel_abun_cyano_genus_ACWA)

cyano_genus_ACWA_agg <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = cyano_genus_ACWA_df, FUN = mean) 


cyano_genus_ACWA_agg$Site_code <- factor(cyano_genus_ACWA_agg$Site_code, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))

cyano_genus_ACWA_agg$Stage<-factor(cyano_genus_ACWA_agg$Stage, levels=c("Larvae", "Adults"))

cyano_genus_ACWA_agg$sample_Family<-factor(cyano_genus_ACWA_agg$sample_Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"))

ggplot(cyano_genus_ACWA_agg, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1) + 
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 22, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=24, face="italic"), legend.title=element_text(size=24)) +
  guides (fill=guide_legend(nrow=24)) +
  theme(axis.title.y=element_text(size=26),
        axis.text.y=element_text(size=22, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=22, color="black"),
                        axis.title=element_text(size=26))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")

#ggsave(filename="microbiome_analysis/Final analysis/Relative abundance/Cyanobacteria/Cyanobacteria genera ACWA across taxa and sites.png", height=14, width=26)

cyano_ACWA_df = data.frame(Genus = tax_table(cyano_genus_ACWA)[,"Genus"], Mean = rowMeans(otu_table(cyano_genus_ACWA)), row.names = NULL)
cyano_ACWA_df = cyano_ACWA_df[order(-cyano_ACWA_df$Mean),]

cyano_ACWA_df$percentage <- (cyano_ACWA_df$Mean/sum(cyano_ACWA_df$Mean)*100)
```

# Rarefying the data

Rarefying is done to allow comparisons between samples with high versus low sequencing depth. It involves subsampling the samples to an even number of reads for diversity comparisons. The sequencing depth has to be large enough that most samples retain their diversity, otherwise results can become biased. Some people don't agree with rarefying because it removes a lot of the data and can bias results. I will try diversity analyses with and without rarefying to see if there is a difference to the interpretation of results. 

Papers that support rarefying/repeated rarefying: 
-Cameron et al., 2021. Scientific reports.

Papers that do not support rarefaction:
-McCurdie & Holmes, 2014. PLOS Computational Biology.
-Willis, 2019. Frontiers in Microbiology. 


``` {r Rarefying the data}
#Rarefying to the minimum sequencing depth
#Rarefies to an even sequencing depth (usually the minimum read so that no sequences are removed)
(ps_rare <- phyloseq::rarefy_even_depth(sample_ps, rngseed = 123, replace = FALSE)) 
#4420 taxa, 339 samples
#Rarefying to the minimum sample depth removed 102 ASVs (not many) because we already filtered out the rare bacteria.

head(phyloseq::sample_sums(ps_rare)) #2283 bacterial taxa subsampled per sample. Cuts a lot of sequencing depth but some people argue it is better to retain more samples rather than a larger sequencing depth. 
```

# Alpha Diversity 

Observed richness is the number of unique ASVs per sample (species richness). Count data ranging from 0 - infinity.

Shannon diversity is a measure of the richness and relative abundance (evenness) of bacteria in a sample (H=[(pi)log(pi)]). Usually ranges between 1.5 - 3.5, rarely above 4.5.

Simpson diversity is a measure of the richness and relative abundance (evenness) of bacteria in a sample (D=n i(ni1)/N(N1)). Ranges between 0-1 (1 being the most diverse, 0 being not diverse). 

## Non-rarefied alpha diversity {.tabset}

From Paul McCurdie on GitHub: You do not want to transform or filter your data before estimating richness, other than quality assurance filtering that would remove non-target sequences. Usually that sort of filtering would be done on the sequence data before it is in the form of a contingency table (table of counts). Basically, the very first table of counts that you have in your workflow is probably the one that you want to use for estimate_richness and plot_richness. There are several different alpha diversity estimators supported in the estimate_richness function, and they all incorporate library size into their estimates in different ways... Except for the "Observed" option, which is simply showing you graphically the OTUs that were observed at least once in each sample. To be clear, the other methods require that you use raw counts. Do not use rarefied counts for the Chao-I estimate, or the Shannon index, for example. The "Observed" option is not a method at all, just showing you what is in your data as you provided. If you transform your data, especially if you rarefy, and then you want to estimate richness, the "Observed" result is now the only one still available to you at all. Rarefying reduces the precision with which you would estimate the diversity in the first place, and so this generally shouldn't be done. All alpha-diversity indices/estimates are aware of differences in sample size (library size, number of reads in this case), because this has always been a problem when attempting to count things, even trees in a forest (see Sanders original paper describing rarefaction, a different technique than rarefying, if rarefying can be called a technique).

### Bow River - Shannon index faceted by taxa and sites

```{r}
Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")

adiv_Bow <- data.frame(
  "Shannon" = phyloseq::estimate_richness(Bow_ps, measures = "Shannon"),
  "Family" = phyloseq::sample_data(Bow_ps)$Family,
  "Stage" = phyloseq::sample_data(Bow_ps)$Stage,
  "Site" = phyloseq::sample_data(Bow_ps)$Site)
head(adiv_Bow)


#Shannon diversity across taxa
shan.plot.taxa<-ggplot(adiv_Bow, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=Shannon, fill=Site))+
  facet_nested_wrap(~Stage+ factor(Family, levels=c("Hydropsychidae", "Heptageniidae", "Baetidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae")), scales= "free_x", nrow=1)+
  geom_boxplot() +
  labs(x = "Site", y = "Shannon Diversity") +
  theme_bw()+
  theme(legend.position="none", axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
        strip.text.x = element_text(size=20), 
        axis.text.y = element_text(size=16, color="black"), axis.title.x = element_text(size=18), axis.title.y = element_text(size=18))+
  rremove("grid")+
  scale_fill_brewer(palette="Accent")

shan.plot.taxa

#ggsave(filename="Microbiome_ED/Final analysis/Alpha Diversity Graphs/Non rarefied shannon diversity Bow River.png", height=12, width=22)

#Shannon diversity is slightly higher at PMF in most taxa. 
#Spiders have a lower Shannon diversity than insects. Larvae have the highest, adults are more variable. 


                                    ### Statistical tests ###


#Shannon diversity

shapiro.test(adiv_Bow$Shannon) #Not normal, use Kruskal-Wallis tests. 

#Kruskal-Wallis tests:

#Life stage (larvae, adults, spiders)
kruskal.test(Shannon~Stage, data=adiv_Bow) #p<0.001
dunnTest(Shannon~Stage, data=adiv_Bow) #All diff from each other

#Invertebrate Taxa
kruskal.test(Shannon~Family, data=adiv_Bow) #p<0.001
dunnTest(Shannon~Family, data=adiv_Bow)
#Chironomidae - Ephemeroptera  
#Araneidae - Heptageniidae
#Diptera - Heptageniidae
#Ephemeroptera - Heptageniidae 
#Araneidae - Hydropsychidae 
#Chironomidae - Hydropsychidae 
#Diptera - Hydropsychidae 
#Ephemeroptera - Hydropsychidae 
#Araneidae - Perlidae 
#Diptera - Perlidae 
#Ephemeroptera - Perlidae 
#Chironomidae - Tetragnathidae
#Heptageniidae - Tetragnathidae  
#Hydropsychidae - Tetragnathidae 
#Perlidae - Tetragnathidae 
#Heptageniidae - Trichoptera  
#Hydropsychidae - Trichoptera  
#Tetragnathidae - Trichoptera 


#Difference across sites: (have to separate by invert taxa)

#Larval Hydropsychidae 
adiv_hydro_Bow<-subset(adiv_Bow, Family=="Hydropsychidae")
shapiro.test(adiv_hydro_Bow$Shannon) #Normal dist. p = 0.069
leveneTest(Shannon~Site, data=adiv_hydro_Bow) #Homogeneity. p = 0.257.
#Use ANOVA
summary(hydro_aov<-aov(Shannon~Site, data=adiv_hydro_Bow)) #p<0.001
TukeyHSD(hydro_aov)
#GRVBR - COCH
#PMF - COCH
#GRVBR - SUN
#PMF - SUN
#GRVBR - CUSH
#PMF - CUSH

#Might be an effect of effluent exposure on the alpha diversity in larval Hydropsychidae because effluent impacted sites tend to have higher alpha diversity than all upstream comparisons. 

#Adult Trichoptera
div.df.Bow.Tricho<-subset(adiv_Bow, Family=="Trichoptera")
shapiro.test(div.df.Bow.Tricho$Shannon) #Not normal
leveneTest(Shannon~Site, data=div.df.Bow.Tricho) #Heterogeneity
#Use Kruskal-Wallis
kruskal.test(Shannon~Site, data=div.df.Bow.Tricho) #p= 0.753
dunnTest(Shannon~Site, data=div.df.Bow.Tricho) #no significant diff. across sites.

#Larval Heptageniidae (order Ephemeroptera)
div.df.Bow.Hep<-subset(adiv_Bow, Family=="Heptageniidae")
shapiro.test(div.df.Bow.Hep$Shannon) #Normal dist. p = 0.286
leveneTest(Shannon~Site, data=div.df.Bow.Hep) #Homogeneity
#Use ANOVA
summary(hep_aov<-aov(Shannon~Site, data=div.df.Bow.Hep)) #p=0.037
TukeyHSD(hep_aov)
#COCH - PMF

#Adult Ephemeroptera
div.df.Bow.Ephem<-subset(adiv_Bow, Family=="Ephemeroptera")
shapiro.test(div.df.Bow.Ephem$Shannon) #p=0.012, not normal
leveneTest(Shannon~Site, data=div.df.Bow.Ephem) #Homogeneity p = 0.49
#Use Kruskal-Wallis
kruskal.test(Shannon~Site, data=div.df.Bow.Ephem) #p=0.129
dunnTest(Shannon~Site, data=div.df.Bow.Ephem) #No sig diff across sites

#Larval Chironomidae (Order Diptera)
div.df.Bow.chiro<-subset(adiv_Bow, Family=="Chironomidae")
shapiro.test(div.df.Bow.chiro$Shannon) #0.366 Normal
leveneTest(Shannon~Site, data=div.df.Bow.chiro) #Homogeneity. 
#Use AnOVA
summary(chiro_aov<-aov(Shannon~Site, data=div.df.Bow.chiro)) #p=0.261
TukeyHSD(chiro_aov)
#No differences across sites

#Adult Chironomidae (Order Diptera)
div.df.Bow.dip<-subset(adiv_Bow, Family=="Diptera")
shapiro.test(div.df.Bow.dip$Shannon) #p=0.166 Normal
leveneTest(Shannon~Site, data=div.df.Bow.dip) #0.605. Homogeneity.
#Use ANOVA
summary(dip_aov<-aov(Shannon~Site, data=div.df.Bow.dip)) #p=0.652
TukeyHSD(dip_aov)
#No differences across sites

#Larval Perlidae (Order Plecoptera)
div.df.Bow.perl<-subset(adiv_Bow, Family=="Perlidae")
shapiro.test(div.df.Bow.perl$Shannon) #0.089 normal
leveneTest(Shannon~Site, data=div.df.Bow.perl) #0.04. Heterogeneity
#Use Kruskal-Wallis
kruskal.test(Shannon~Site, data=div.df.Bow.perl) #p=0.211
dunnTest(Shannon~Site, data=div.df.Bow.perl) #No sig diff across sites

summary(perl_aov<-aov(Shannon~Site, data=div.df.Bow.perl)) #p=0.106
TukeyHSD(perl_aov) #ANOVA also indicates no differences. 

#Araneidae
div.df.Bow.aran<-subset(adiv_Bow, Family=="Araneidae")
shapiro.test(div.df.Bow.aran$Shannon) #0.407. Normal
leveneTest(Shannon~Site, data=div.df.Bow.aran) #0.75 homogeneity
#Use ANOVA
summary(aran_aov<-aov(Shannon~Site, data=div.df.Bow.aran)) #p=0.365
TukeyHSD(aran_aov)
#No differences across sites

#Tetragnathidae
div.df.Bow.tetra<-subset(adiv_Bow, Family=="Tetragnathidae")
shapiro.test(div.df.Bow.tetra$Shannon) #P<0.001 not normal
#Use KW
kruskal.test(Shannon~Site, data=div.df.Bow.tetra) #p=0.26
dunnTest(Shannon~Site, data=div.df.Bow.tetra) #No differences across sites 
```

### ACWA - Shannon index faceted by taxa and sites

```{r}
ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River")

adiv_ACWA <- data.frame(
  "Shannon" = phyloseq::estimate_richness(ACWA_ps, measures = "Shannon"),
  "Family" = phyloseq::sample_data(ACWA_ps)$Family,
  "Stage" = phyloseq::sample_data(ACWA_ps)$Stage,
  "Site" = phyloseq::sample_data(ACWA_ps)$Site)
head(adiv_ACWA)

#Shannon index
shan.plot.taxa.ACWA<-ggplot(adiv_ACWA, aes(x=factor(Site, labels=c("REF", "EXP5", "EXP15")), y=Shannon, fill=Site))+
  facet_nested_wrap(~Stage+ factor(Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera")), scales= "free_x", nrow=1)+
  geom_boxplot() +
  labs(x = "Site", y = "Shannon Diversity") +
  theme_bw()+
  theme(legend.position="none", axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
        strip.text.x = element_text(size=20), 
        axis.text.y = element_text(size=16, color="black"), axis.title.x = element_text(size=18), axis.title.y = element_text(size=18))+
  rremove("grid")+
  scale_fill_manual(values=c("#7E8071", "#EDBC81", "#A76B56"))

shan.plot.taxa.ACWA

#ggsave(filename="Microbiome_ED/Final analysis/Alpha Diversity Graphs/Non rarefied shannon diversity ACWA.png", height=12, width=22)


                                    ### Statistical tests ###

#Shannon diversity

shapiro.test(adiv_ACWA$Shannon) #Not normal

#Kruskal-Wallis tests:

#Test diff btw larvae and adults
wilcox.test(Shannon~Stage, data=adiv_ACWA) #W = 594, p < 0.001
kruskal.test(Shannon~Stage, data=adiv_ACWA) #p<0.001
#Significant difference in Shannon index btw larvae and adults 

#Diff btw families
kruskal.test(Shannon~Family, data=adiv_ACWA)#p<0.001
dunnTest(Shannon~Family, data=adiv_ACWA) #All diff from each other

#Hydropsychidae
hydro_ACWA<-subset(adiv_ACWA, Family=="Hydropsychidae")
shapiro.test(hydro_ACWA$Shannon) # normal
leveneTest(data=hydro_ACWA, Shannon~Site) #0.197. homogeneity
#Use ANOVA
summary(hydro_ACWA_aov<-aov(data=hydro_ACWA, Shannon~Site)) #0.313 no diff
#No difference between streams

#Baetidae
baetid_ACWA<-subset(adiv_ACWA, Family=="Baetidae")
shapiro.test(baetid_ACWA$Shannon) # normal
leveneTest(data=baetid_ACWA, Shannon~Site) #0.683. homogeneity
#Use t test
t.test(data=baetid_ACWA, Shannon~Site) #p=0.791
#No difference between streams

#Ephemeroptera
ephem_ACWA<-subset(adiv_ACWA, Family=="Ephemeroptera")
shapiro.test(ephem_ACWA$Shannon) #Not normal
#Use Wilcoxon test
wilcox.test(data=ephem_ACWA, Shannon~Site) # W = 19, p = 0.195
#No difference between streams
```

### Calculating median +/- IQR Shannon Index

```{r Calculating median +/- IQR Shannon diversity for each taxa at each site}

adiv_Bow <- data.frame(
  "Shannon" = phyloseq::estimate_richness(Bow_ps, measures = "Shannon"),
  "Observed" = phyloseq::estimate_richness(Bow_ps, measures = "Observed"),
  "Family" = phyloseq::sample_data(Bow_ps)$Family,
  "Stage" = phyloseq::sample_data(Bow_ps)$Stage,
  "Site" = phyloseq::sample_data(Bow_ps)$Site)
head(adiv_Bow)

#All Bow River larvae combined
lar_ps_Bow<-subset_samples(sample_ps, Stream_Type=="Bow River" & Stage=="Larvae")

adiv_lar_Bow <- data.frame(
  "Shannon" = phyloseq::estimate_richness(lar_ps_Bow, measures = "Shannon"),
  "Stream_Type" = phyloseq::sample_data(lar_ps_Bow)$Stream_Type,
  "Site" = phyloseq::sample_data(lar_ps_bow)$Site)

adiv_lar_Bow %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_lar_Bow %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

#All Bow River adults combined
ad_Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River" & Stage=="Adults")

adiv_ad_Bow <- data.frame(
  "Shannon" = phyloseq::estimate_richness(ad_Bow_ps, measures = "Shannon"),
  "Stream_Type" = phyloseq::sample_data(ad_Bow_ps)$Stream_Type,
  "Site" = phyloseq::sample_data(ad_Bow_ps)$Site)

adiv_ad_Bow %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_ad_Bow %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

#All Bow River spiders combined
spiders_ps<-subset_samples(sample_ps, Stage=="Spiders" & Stream_Type=="Bow River")

adiv_spiders <- data.frame(
  "Shannon" = phyloseq::estimate_richness(spiders_ps, measures = "Shannon"),
  "Stream_Type" = phyloseq::sample_data(spiders_ps)$Stream_Type,
  "Site" = phyloseq::sample_data(spiders_ps)$Site)

adiv_spiders %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_ad_Bow %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

## Larval Hydropsychidae ##

hydro_lar<-subset_samples(sample_ps, Family=="Hydropsychidae")

adiv_hydro <- data.frame(
  "Shannon" = phyloseq::estimate_richness(hydro_lar, measures = "Shannon"),
  "Stream_Type" = phyloseq::sample_data(hydro_lar)$Stream_Type,
  "Site" = phyloseq::sample_data(hydro_lar)$Site)
head(adiv_hydro)

adiv_hydro %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_hydro %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

#Bow River
hydro_Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River" & Family=="Hydropsychidae")

adiv_hydro_Bow <- data.frame(
  "Shannon" = phyloseq::estimate_richness(hydro_Bow_ps, measures = "Shannon"),
  "Stream_Type" = phyloseq::sample_data(hydro_Bow_ps)$Stream_Type,
  "Site" = phyloseq::sample_data(hydro_Bow_ps)$Site)
head(adiv_hydro_Bow)

adiv_hydro_Bow %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_hydro_Bow %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))


#ACWA

hydro_ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River" & Family=="Hydropsychidae")

adiv_hydro_ACWA <- data.frame(
  "Shannon" = phyloseq::estimate_richness(hydro_ACWA_ps, measures = "Shannon"),
  "Stream_Type" = phyloseq::sample_data(hydro_ACWA_ps)$Stream_Type,
  "Site" = phyloseq::sample_data(hydro_ACWA_ps)$Site)

adiv_hydro_ACWA %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_hydro_Bow %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))


## Larval Heptageniidae ##

hep_lar<-subset_samples(sample_ps, Family=="Heptageniidae")

adiv_hep <- data.frame(
  "Shannon" = phyloseq::estimate_richness(hep_lar, measures = "Shannon"),
  "Site" = phyloseq::sample_data(hep_lar)$Site)

adiv_hep %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_hep %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

## Larval Chironomidae ##

chiro_lar<-subset_samples(sample_ps, Family=="Chironomidae")

adiv_chiro <- data.frame(
  "Shannon" = phyloseq::estimate_richness(chiro_lar, measures = "Shannon"),
  "Site" = phyloseq::sample_data(chiro_lar)$Site)

adiv_chiro %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_chiro %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

## Larval Perlidae ##

perl_lar<-subset_samples(sample_ps, Family=="Perlidae")

adiv_perl <- data.frame(
  "Shannon" = phyloseq::estimate_richness(perl_lar, measures = "Shannon"),
  "Site" = phyloseq::sample_data(perl_lar)$Site)

adiv_perl %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_perl %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

## Larval Baetidae ##

baetid_lar<-subset_samples(sample_ps, Family=="Baetidae")

adiv_baetid <- data.frame(
  "Shannon" = phyloseq::estimate_richness(baetid_lar, measures = "Shannon"),
  "Site" = phyloseq::sample_data(baetid_lar)$Site)

adiv_baetid %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_baetid %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))


## Adult Trichoptera ##

trichop_ad<-subset_samples(sample_ps, Family=="Trichoptera")

adiv_trichop <- data.frame(
  "Shannon" = phyloseq::estimate_richness(trichop_ad, measures = "Shannon"),
  "Site" = phyloseq::sample_data(trichop_ad)$Site)

adiv_trichop %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_trichop %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

## Adult Ephemeroptera ##

ephem_ad_Bow<-subset_samples(sample_ps, Family=="Ephemeroptera" & Stream_Type=="Bow River")

adiv_ephem_Bow <- data.frame(
  "Shannon" = phyloseq::estimate_richness(ephem_ad_Bow, measures = "Shannon"),
  "Site" = phyloseq::sample_data(ephem_ad_Bow)$Site)

adiv_ephem_Bow %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_ephem_Bow %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

# ACWA #

ephem_ad_ACWA<-subset_samples(sample_ps, Family=="Ephemeroptera" & Stream_Type!="Bow River")

adiv_ephem_ACWA <- data.frame(
  "Shannon" = phyloseq::estimate_richness(ephem_ad_ACWA, measures = "Shannon"),
  "Site" = phyloseq::sample_data(ephem_ad_ACWA)$Site)

adiv_ephem_ACWA %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_ephem_ACWA %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))



## Adult Diptera ##

dip_ad<-subset_samples(sample_ps, Family=="Diptera")

adiv_dip <- data.frame(
  "Shannon" = phyloseq::estimate_richness(dip_ad, measures = "Shannon"),
  "Site" = phyloseq::sample_data(dip_ad)$Site)

adiv_dip %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_dip %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

## Araneidae ##

aran<-subset_samples(sample_ps, Family=="Araneidae")

adiv_aran <- data.frame(
  "Shannon" = phyloseq::estimate_richness(aran, measures = "Shannon"),
  "Site" = phyloseq::sample_data(aran)$Site)

adiv_aran %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))


adiv_aran %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

## Tetragnathidae ##

tetra<-subset_samples(sample_ps, Family=="Tetragnathidae")

adiv_tetra <- data.frame(
  "Shannon" = phyloseq::estimate_richness(tetra, measures = "Shannon"),
  "Site" = phyloseq::sample_data(tetra)$Site)

adiv_tetra %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))

adiv_tetra %>%
  group_by(Site) %>%
  dplyr::summarise(median_shannon = median(Shannon),
            IQR_Shannon= IQR(Shannon))
```

## Rarefied alpha diversity {.tabset}

### Bow River - separated by site and invertebrate taxa type 

```{r}
Bow_ps_rare<-subset_samples(ps_rare, Stream_Type=="Bow River")

adiv_Bow_rare <- data.frame(
  "Shannon" = phyloseq::estimate_richness(Bow_ps_rare, measures = "Shannon"),
  "Family" = phyloseq::sample_data(Bow_ps_rare)$Family,
  "Stage" = phyloseq::sample_data(Bow_ps_rare)$Stage,
  "Site" = phyloseq::sample_data(Bow_ps_rare)$Site)
head(adiv_Bow_rare)


#Shannon diversity across taxa
shan.plot.taxa.rare<-ggplot(adiv_Bow_rare, aes(x=factor(Site, labels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF")), y=Shannon, fill=Site))+
  facet_nested_wrap(~Stage+ factor(Family, levels=c("Hydropsychidae", "Heptageniidae", "Baetidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae")), scales= "free_x", nrow=1)+
  geom_boxplot() +
  labs(x = "Site", y = "Shannon Diversity") +
  theme_bw()+
  theme(legend.position="none", axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
        strip.text.x = element_text(size=20), 
        axis.text.y = element_text(size=16, color="black"), axis.title.x = element_text(size=18), axis.title.y = element_text(size=18))+
  rremove("grid")+
  scale_fill_brewer(palette="Accent")

shan.plot.taxa.rare

#ggsave(filename="Microbiome_ED/Final analysis/Alpha Diversity Graphs/Rarefied shannon diversity Bow River.png", height=12, width=22)

#Looks the same as the non-rarefied plot


                                    ### Statistical tests ###


#Shannon diversity

shapiro.test(adiv_Bow_rare$Shannon) #Not normal, use Kruskal-Wallis tests. 

#Kruskal-Wallis tests:

#Life stage (larvae, adults, spiders)
kruskal.test(Shannon~Stage, data=adiv_Bow_rare) #p<0.001
dunnTest(Shannon~Stage, data=adiv_Bow_rare) #All diff from each other

#Difference across sites: (have to separate by invert taxa)

#Larval Hydropsychidae 
adiv_hydro_Bow_rare<-subset(adiv_Bow_rare, Family=="Hydropsychidae")
shapiro.test(adiv_hydro_Bow_rare$Shannon) #Normal dist. p = 0.09
leveneTest(Shannon~Site, data=adiv_hydro_Bow_rare) #Homogeneity. p = 0.276.
#Use ANOVA
summary(hydro_aov_rare<-aov(Shannon~Site, data=adiv_hydro_Bow_rare)) #p<0.001
TukeyHSD(hydro_aov_rare)
#GRVBR - COCH
#PMF - COCH
#GRVBR - SUN
#PMF - SUN
#GRVBR - CUSH
#PMF - CUSH
#PMF - GRVBR

#One extra difference with rarefied data (between GRVBR and PMF)

#Adult Trichoptera
div.df.Bow.Tricho.rare<-subset(adiv_Bow_rare, Family=="Trichoptera")
shapiro.test(div.df.Bow.Tricho.rare$Shannon) #Not normal
leveneTest(Shannon~Site, data=div.df.Bow.Tricho.rare) #Heterogeneity
#Use Kruskal-Wallis
kruskal.test(Shannon~Site, data=div.df.Bow.Tricho.rare) #p= 0.709
dunnTest(Shannon~Site, data=div.df.Bow.Tricho.rare) #no significant diff. across sites.

#Larval Heptageniidae (order Ephemeroptera)
div.df.Bow.Hep.rare<-subset(adiv_Bow_rare, Family=="Heptageniidae")
shapiro.test(div.df.Bow.Hep.rare$Shannon) #Normal dist. p = 0.2118
leveneTest(Shannon~Site, data=div.df.Bow.Hep.rare) #Homogeneity
#Use ANOVA
summary(hep_aov_rare<-aov(Shannon~Site, data=div.df.Bow.Hep.rare)) #p=0.0435
TukeyHSD(hep_aov_rare)
#COCH - PMF

#Adult Ephemeroptera
div.df.Bow.Ephem.rare<-subset(adiv_Bow_rare, Family=="Ephemeroptera")
shapiro.test(div.df.Bow.Ephem.rare$Shannon) #p=0.012, not normal
leveneTest(Shannon~Site, data=div.df.Bow.Ephem.rare) #Homogeneity p = 0.49
#Use Kruskal-Wallis
kruskal.test(Shannon~Site, data=div.df.Bow.Ephem.rare) #p=0.135
dunnTest(Shannon~Site, data=div.df.Bow.Ephem.rare) #No sig diff across sites

#Larval Chironomidae (Order Diptera)
div.df.Bow.chiro.rare<-subset(adiv_Bow_rare, Family=="Chironomidae")
shapiro.test(div.df.Bow.chiro.rare$Shannon) #0.308 Normal
leveneTest(Shannon~Site, data=div.df.Bow.chiro.rare) #Homogeneity. 
#Use AnOVA
summary(chiro_aov_rare<-aov(Shannon~Site, data=div.df.Bow.chiro.rare)) #p=0.257
TukeyHSD(chiro_aov_rare)
#No differences across sites

#Adult Chironomidae (Order Diptera)
div.df.Bow.dip.rare<-subset(adiv_Bow_rare, Family=="Diptera")
shapiro.test(div.df.Bow.dip.rare$Shannon) #p=0.166 Normal
leveneTest(Shannon~Site, data=div.df.Bow.dip.rare) #0.605. Homogeneity.
#Use ANOVA
summary(dip_aov_rare<-aov(Shannon~Site, data=div.df.Bow.dip.rare)) #p=0.652
TukeyHSD(dip_aov_rare)
#No differences across sites

#Larval Perlidae (Order Plecoptera)
div.df.Bow.perl.rare<-subset(adiv_Bow_rare, Family=="Perlidae")
shapiro.test(div.df.Bow.perl.rare$Shannon) #0.089 normal
leveneTest(Shannon~Site, data=div.df.Bow.perl.rare) #0.04. Heterogeneity
#Use Kruskal-Wallis
kruskal.test(Shannon~Site, data=div.df.Bow.perl.rare) #p=0.216
dunnTest(Shannon~Site, data=div.df.Bow.perl.rare) #No sig diff across sites

summary(perl_aov_rare<-aov(Shannon~Site, data=div.df.Bow.perl.rare)) #p=0.106
TukeyHSD(perl_aov_rare) #ANOVA also indicates no differences. 

#Araneidae
div.df.Bow.aran.rare<-subset(adiv_Bow_rare, Family=="Araneidae")
shapiro.test(div.df.Bow.aran.rare$Shannon) #0.532. Normal
leveneTest(Shannon~Site, data=div.df.Bow.aran.rare) #0.75 homogeneity
#Use ANOVA
summary(aran_aov_rare<-aov(Shannon~Site, data=div.df.Bow.aran.rare)) #p=0.404
TukeyHSD(aran_aov_rare)
#No differences across sites

#Tetragnathidae
div.df.Bow.tetra.rare<-subset(adiv_Bow_rare, Family=="Tetragnathidae")
shapiro.test(div.df.Bow.tetra.rare$Shannon) #P<0.001 not normal
#Use KW
kruskal.test(Shannon~Site, data=div.df.Bow.tetra.rare) #p=0.25
dunnTest(Shannon~Site, data=div.df.Bow.tetra.rare) #No differences across sites 

#Rarefied data resulted in only one extra difference in larval hydropsychidae. Pretty much the same as non rarefied data.

```

### ACWA - faceted by stream and invertebrate type 

```{r}
ACWA_ps_rare<-subset_samples(ps_rare, Stream_Type!="Bow River")

adiv_ACWA_rare <- data.frame(
  "Shannon" = phyloseq::estimate_richness(ACWA_ps_rare, measures = "Shannon"),
  "Family" = phyloseq::sample_data(ACWA_ps_rare)$Family,
  "Stage" = phyloseq::sample_data(ACWA_ps_rare)$Stage,
  "Site" = phyloseq::sample_data(ACWA_ps_rare)$Site)

#Shannon index
shan.plot.taxa.ACWA.rare<-ggplot(adiv_ACWA_rare, aes(x=factor(Site, labels=c("REF", "EXP5", "EXP15")), y=Shannon, fill=Site))+
  facet_nested_wrap(~Stage+ factor(Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera")), scales= "free_x", nrow=1)+
  geom_boxplot() +
  labs(x = "Site", y = "Shannon Diversity") +
  theme_bw()+
  theme(legend.position="none", axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
        strip.text.x = element_text(size=20), 
        axis.text.y = element_text(size=16, color="black"), axis.title.x = element_text(size=18), axis.title.y = element_text(size=18))+
  rremove("grid")+
  scale_fill_manual(values=c("#7E8071", "#EDBC81", "#A76B56"))

shan.plot.taxa.ACWA.rare

#ggsave(filename="Microbiome_ED/Final analysis/Alpha Diversity Graphs/Non rarefied shannon diversity ACWA.png", height=12, width=22)


                                    ### Statistical tests ###

#Shannon diversity

shapiro.test(adiv_ACWA_rare$Shannon) #Not normal

#Kruskal-Wallis tests:

#Test diff btw larvae and adults
wilcox.test(Shannon~Stage, data=adiv_ACWA_rare) #W = 0.84, p < 0.001

#Diff btw families
kruskal.test(Shannon~Family, data=adiv_ACWA_rare)#p<0.001
dunnTest(Shannon~Family, data=adiv_ACWA_rare) #All diff from each other

#Hydropsychidae
hydro_ACWA_rare<-subset(adiv_ACWA_rare, Family=="Hydropsychidae")
shapiro.test(hydro_ACWA_rare$Shannon) # normal
leveneTest(data=hydro_ACWA_rare, Shannon~Site) #0.3. homogeneity
#Use ANOVA
summary(hydro_ACWA_aov_rare<-aov(data=hydro_ACWA_rare, Shannon~Site)) #0.326 no diff
#No difference between streams

#Baetidae
baetid_ACWA_rare<-subset(adiv_ACWA_rare, Family=="Baetidae")
shapiro.test(baetid_ACWA_rare$Shannon) # normal
leveneTest(data=baetid_ACWA, Shannon~Site) #0.683. homogeneity
#Use t test
t.test(data=baetid_ACWA_rare, Shannon~Site) #p=0.809
#No difference between streams

#Ephemeroptera
ephem_ACWA_rare<-subset(adiv_ACWA_rare, Family=="Ephemeroptera")
shapiro.test(ephem_ACWA_rare$Shannon) #Not normal
#Use Wilcoxon test
wilcox.test(data=ephem_ACWA_rare, Shannon~Site) # W = 18, p = 0.195
#No difference between streams

#Same results as non rarefied data
```

# Beta Diversity

Beta diversity is a measure of dissimilarity between communities. It is useful to see how the bacterial community changes across sites/invertebrate families/exposures/etc. This analysis was split by invertebrate taxa to tease out some variability in the data. A PERMANOVA (function 'adonis') was used to calculate significant differences across sites and beta dispersion (measure of variance within groups) was also tested to determine if there was a location or dispersion effect. The results were ordinated with an NMDS using Bray-Curtis dissimilarity matrices. 

Transforming the data to proportions (relative abundance) is the best method of normalizing the data prior to beta diversity analysis according to McCurdie & Holmes, 2014; Weiss et al., 2017; McKnight et al., 2019. 


## Blanks and experimental samples 
```{r}
#Combine filtered experimental samples with blanks
blank_ps<-subset_samples(ps, Sample_Type=="Blank")

exp_bl_ps<-merge_phyloseq(blank_ps, sample_ps)
nsamples(exp_bl_ps) #362 (339 samples, 23 blanks)

#Ordinating blanks with experimental samples to see how closely related they are

#PCoA with Bray Curtis distance matrix
ps_rel_abun = transform_sample_counts(exp_bl_ps, function(x) x/sum(x))

dist_all = phyloseq::distance(ps_rel_abun, method="bray") #Bray Curtis distance matrix
ordination_all = ordinate(ps_rel_abun, method="PCoA", distance=dist_all) #Ordinate using PCoA

plot_ordination(ps_rel_abun, ordination_all, shape="Blank_collection_method", color="Sample_Type") +
  theme_classic() +
  theme(strip.background = element_blank())+
  xlab("PC1[12.9%]")+
  ylab("PC2[10.7%]")
#Doesn't explain much of the data, need to do an NMDS
 
set.seed(1)
ord_NMDS_blanks = ordinate(ps_rel_abun, method="NMDS", distance=dist_all)
ord_NMDS_blanks #stress=0.213


blank_nmds<-plot_ordination(ps_rel_abun, ord_NMDS_blanks, color="Sample_Type", shape="Blank_Type") + 
  theme_classic() +
  theme(strip.background = element_blank())+
  theme(legend.key.size = unit(0.5, 'cm'), 
        legend.title = element_text(size=10), 
        legend.text = element_text(size=8), 
        legend.position = "bottom")+
  scale_shape_manual(name="Blank type", values=c(1:7))+
  scale_color_manual(name="Sample type", values=c("red", "blue"))

newtab$Blank_Type <- factor(newtab$Blank_Type, levels = c("Tweezer water rinse","Bedsheet","Floating emergence trap","Buffer tube","DNA extraction reagent","Nested PCR negative"))
blank_nmds$Blank_Type <- newtab
print(blank_nmds)

#ggsave(filename="Microbiome_ED/Final analysis/Beta Diversity Graphs/blank and experimental samples.png", height=10, width=12)

metadata_blanks <- data.frame(sample_data(ps_rel_abun))

adonis.blanks <- adonis2(dist_all ~ Sample_Type, data = metadata_blanks)
adonis.blanks #p<0.001. Significant dissimilarity between blank samples and invertebrate samples
#F(1, 360) = 6.91, P < 0.001

#Testing variance (beta dispersion) differences between samples and blanks:
bd_blanks<-betadisper(dist_all, metadata_blanks$Sample_Type)
anova(bd_blanks) #Sig. dispersion F(1,360) = 17.7, p<0.001

## Separating out respective blanks for each sample type ##

#Water July (larvae and blanks from July)
water_July<-subset_samples(ps_rel_abun, Blank_collection_method=="Water July")
dist_wat_July<-phyloseq::distance(water_July, method="bray")
metadata_wat_July<-data.frame(sample_data(water_July))
adonis.blank.lar.July<-adonis2(dist_wat_July ~ Sample_Type, data = metadata_wat_July)
adonis.blank.lar.July #p=0.001 sig. diff. 

bd_wat_July<-betadisper(dist_wat_July, metadata_wat_July$Sample_Type)
anova(bd_wat_July) #Sig. dispersion

#Water September (larvae and blanks from September)
water_Sept<-subset_samples(ps_rel_abun, Blank_collection_method=="Water September")
dist_wat_Sept<-phyloseq::distance(water_Sept, method="bray")
metadata_wat_Sept<-data.frame(sample_data(water_Sept))
adonis.blank.lar.Sept<-adonis2(dist_wat_Sept ~ Sample_Type, data = metadata_wat_Sept)
adonis.blank.lar.Sept #p=0.001 sig. diff. 

bd_wat_Sept<-betadisper(dist_wat_Sept, metadata_wat_Sept$Sample_Type)
anova(bd_wat_Sept) #Sig. dispersion

#Bedsheet 
bedsheet_ps<-subset_samples(ps_rel_abun, Blank_collection_method=="Sheet")
bedsheet_bray<-phyloseq::distance(bedsheet_ps, method="bray")
metadata_bedsheet<-data.frame(sample_data(bedsheet_ps))
adonis.blank.bedsheet<-adonis2(bedsheet_bray ~ Sample_Type, data = metadata_bedsheet)
adonis.blank.bedsheet #p=0.001 sig. diff. 

bd_bedsheet<-betadisper(bedsheet_bray, metadata_bedsheet$Sample_Type)
anova(bd_bedsheet) #Sig. dispersion

#Floating emergence traps
emerg_trap_ps<-subset_samples(ps_rel_abun, Blank_collection_method=="Mesh")
emerg_trap_bray<-phyloseq::distance(emerg_trap_ps, method="bray")
metadata_emerg_trap<-data.frame(sample_data(emerg_trap_ps))
adonis.blank.emerg_trap<-adonis2(emerg_trap_bray ~ Sample_Type, data = metadata_emerg_trap)
adonis.blank.emerg_trap #p=0.043 sig. diff. 

bd_emerg_trap<-betadisper(emerg_trap_bray, metadata_emerg_trap$Sample_Type)
anova(bd_emerg_trap) #no sig. dispersion


#Pairwise comparisons between all blank collection methods
pairwise.adonis2(dist_all~ Blank_collection_method, data = metadata_blanks) 
#Difference between all blanks and samples

#Testing variance (beta dispersion) differences between samples and blanks:
bd_blanks_type<-betadisper(dist_all, metadata_blanks$Blank_collection_method)
anova(bd_blanks_type) #Sig. dispersion

#Seems like the blank community composition differs from that of the invertebrate samples however, there is significant beta dispersion so we can't be entirely sure. We can compare the results with and without prior decontamination steps to be cautious. 
```

## Experimental samples {.tabset}

### Non-rarefied 

#### Bow River 
```{r}
#### Beta Diversity Graphs + PERMANOVA ####
#Normalize the filtered data by relative abundance 
Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")
Bow_rel_abun  = transform_sample_counts(Bow_ps, function(x) x/sum(x)) 
#transform to relative abundance. Seems to be the best method of normalizing.

Bow_bray = phyloseq::distance(Bow_rel_abun, method="bray") #Bray Curtis distance matrix
ord_Bow = ordinate(Bow_rel_abun, method="PCoA", distance=Bow_bray) #Ordinate using PCoA

#Scree plot of PCoA
scree <- plot_scree(ord_Bow)
scree + theme(axis.text.x=element_text(size=8, color="black"), axis.text.y=element_text(size=18, color="black"), 
        axis.text=element_text(size=18, color="black"), axis.title=element_text(size=18)) 
#axis 1, 2, and 3 account for most variation explained (mostly axis 1)

metadata_Bow <- data.frame(sample_data(Bow_rel_abun))

#All together
plot_ordination(Bow_rel_abun, ord_Bow, shape="Site", color="Family") + #Plots the ordination
  theme_classic() +
  theme(strip.background = element_blank())+
  xlab("PC1 [12.8%]")+
  ylab("PC2 [10.9%]")

#Faceted by stage (larvae, adults, spiders)
plot_ordination(Bow_rel_abun, ord_Bow, shape="Site", color="Family") + 
  theme_classic() +
  theme(strip.background = element_blank())+
  facet_wrap(~Stage)+
  xlab("PC1 [12.8%]")+
  ylab("PC2 [10.9%]")

#Axes don't explain a ton of variation so I will try ordinating with an NMDS as well. 

#ggsave(filename="microbiome_analysis/Final analysis/Beta Diversity Graphs/PCoA by site and invert Bow River.png", height = 7, width=8)


# NMDS 
set.seed(1)
ord_NMDS_Bow = ordinate(Bow_rel_abun, method="NMDS", distance=Bow_bray)
ord_NMDS_Bow #Stress=0.197

plotNMDS1<-plot_ordination(Bow_rel_abun, ord_NMDS_Bow, shape="Site", color = "Family") + 
  theme_classic() +
  geom_point(size=3)+
  theme(strip.background = element_blank())+
  theme(legend.key.size = unit(0.3, 'cm'), 
        legend.title = element_text(size=20), 
        legend.text = element_text(size=18), 
        axis.text = element_text(size=16, color="black"),
        axis.title = element_text(size=18, color="black"),
        legend.position = "right")+
  guides(color=guide_legend(title="Invertebrate Taxa")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))+
  ylim(-0.5, 0.5)+
  xlim(-0.5, 0.5)

newtab1 = data.table(plotNMDS1$data)
newtab1$Family <- ordered(newtab1$Family,
levels = c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Larval Hydropsychidae", "Larval Heptageniidae", "Larval Chironomidae", "Larval Perlidae", "Adult Trichoptera", "Adult Ephemeroptera", "Adult Chironomidae", "Araneidae", "Tetragnathidae"))
plotNMDS1$data <- newtab1
print(plotNMDS1)

#ggsave(filename="microbiome_analysis/Final analysis/Beta Diversity Graphs/NMDS across sites Bow only relative abundance normalized.png", height=10, width=14)

#Ellipses by taxa
plotNMDStaxa<-plot_ordination(Bow_rel_abun, ord_NMDS_Bow, color = "Family", shape="Site") + 
  theme_classic() +
  geom_point(size=3)+
  theme(strip.background = element_blank())+
  theme(legend.key.size = unit(0.3, 'cm'), 
        legend.title = element_text(size=20), 
        legend.text = element_text(size=18), 
        axis.text = element_text(size=16, color="black"),
        axis.title = element_text(size=18, color="black"),
        legend.position = "right")+
  guides(color=guide_legend(title="Invertebrate Taxa")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))+
  stat_ellipse(type="norm", alpha=1, aes(group=Family, color=Family))+
  ylim(-0.5, 0.5)+
  xlim(-0.5, 0.5)

newtabtaxa = data.table(plotNMDStaxa$data)
newtabtaxa$Family <- ordered(newtabtaxa$Family,
levels = c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Larval Hydropsychidae", "Larval Heptageniidae", "Larval Chironomidae", "Larval Perlidae", "Adult Trichoptera", "Adult Ephemeroptera", "Adult Chironomidae", "Araneidae", "Tetragnathidae"))
plotNMDStaxa$data <- newtabtaxa
print(plotNMDStaxa)

#ggsave(filename="microbiome_analysis/Final analysis/Beta Diversity Graphs/NMDS across taxa Bow.png", height=10, width=14)


#Ellipses by Site
plotNMDSsite<-plot_ordination(Bow_rel_abun, ord_NMDS_Bow, color = "Family", shape="Site") + 
  theme_classic() +
  geom_point(size=3)+
  theme(strip.background = element_blank())+
  theme(legend.key.size = unit(0.3, 'cm'), 
        legend.title = element_text(size=20), 
        legend.text = element_text(size=18), 
        axis.text = element_text(size=16, color="black"),
        axis.title = element_text(size=18, color="black"),
        legend.position = "right")+
  guides(color=guide_legend(title="Invertebrate Taxa")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))+
  stat_ellipse(type="norm", alpha=1, aes(group=Site))+
   ylim(-0.5, 0.5)+
  xlim(-0.5, 0.5)

newtabtaxa = data.table(plotNMDSsite$data)
newtabtaxa$Family <- ordered(newtabtaxa$Family,
levels = c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Larval Hydropsychidae", "Larval Heptageniidae", "Larval Chironomidae", "Larval Perlidae", "Adult Trichoptera", "Adult Ephemeroptera", "Adult Chironomidae", "Araneidae", "Tetragnathidae"))
plotNMDSsite$data <- newtabtaxa
print(plotNMDSsite)

#ggsave(filename="microbiome_analysis/Final analysis/Beta Diversity Graphs/NMDS across sites Bow.png", height=10, width=14)



#Faceted by invertebrate taxa and life Stage
p<-plot_ordination(Bow_rel_abun, ord_NMDS_Bow, color = "Site") + 
  theme_classic() +
  geom_point(size=2)+
  facet_wrap(vars(Stage, Family), scales="free", nrow=1)+
  theme_bw()+
  rremove("grid")+
  theme(legend.key.size = unit(0.7, 'cm'), 
        legend.title = element_text(size=20), 
        legend.text = element_text(size=20), 
        legend.position = "bottom", 
        axis.text.x=element_text(size=16, color="black", angle=90, hjust=0.5, vjust=0.5),
        axis.text.y=element_text(size=16, color="black"),
        axis.title = element_text(size=18),
        strip.text.x = element_text(size=20))+
  facet_nested_wrap(~Stage + Family, scale="free_x", nrow=1)+
  stat_ellipse()

newtab = data.table(p$data)
newtab$Family <- ordered(newtab$Family,
levels = c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))
p$data <- newtab
print(p)

#ggsave(filename="microbiome_analysis/Final Analysis/Beta Diversity Graphs/All samples combined/NMDS across Bow River invertebrates and sites.png", height=10, width=20)

#Faceted by site
p1<-plot_ordination(Bow_rel_abun, ord_NMDS_Bow, color = "Family") + 
  theme_classic() +
  geom_point(size=2)+
  facet_grid(~Site, scales="free")+
  theme_bw()+
  rremove("grid")+
  theme(legend.key.size = unit(0.7, 'cm'), 
        legend.title = element_text(size=20), 
        legend.text = element_text(size=20), 
        legend.position = "bottom", 
        axis.text=element_text(size=18, color="black", angle=90, hjust=1, vjust=1),
        axis.title = element_text(size=18, color="black"),
        strip.text.x = element_text(size=20))+
  stat_ellipse(linetype=1, type="norm")+
  guides(color=guide_legend(nrow=3, byrow=TRUE, title="Invertebrate Taxa")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))
 

newtab2 = data.table(p1$data)
newtab2$Family <- ordered(newtab2$Family,
levels = c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Larval Hydropsychidae", "Larval Heptageniidae", "Larval Chironomidae", "Larval Perlidae", "Adult Trichoptera", "Adult Ephemeroptera", "Adult Diptera", "Araneidae", "Tetragnathidae"))
p1$data <- newtab2
print(p1)


#ggsave(filename="microbiome_analysis/Final analysis/Beta Diversity Graphs/NMDS across sites faceted by invertebrate taxa non-rarefied Bow only.png", height=10, width=16)


#Faceted by life stage (Larvae, Adults, Spiders)
plot_ordination(Bow_rel_abun, ord_NMDS_Bow, shape="Site", color = "Family") + 
  theme_classic() +
  geom_point(size=2)+
  facet_grid(~Stage, scales="free")+
  theme_bw()+
  rremove("grid")+
  theme(legend.key.size = unit(0.7, 'cm'), 
        legend.title = element_text(size=14), 
        legend.text = element_text(size=12), 
        legend.position = "right")+
  stat_ellipse()

#ggsave(filename="Microbiome_ED/Final analysis/Beta Diversity Graphs/All samples combined/NMDS across sites faceted by life stage rarefied Bow only.png", height=8, width=16)


#PERMANOVA by Site and invertebrate taxa

test.adonis.Bow <- adonis2(Bow_bray ~ Site*Family, data = metadata_Bow)
test.adonis.Bow #p<0.001. Significant dissimilarity between sites, families and significant interaction between the two.

#Pairwise comparisons
pairwise.adonis2(Bow_bray ~ Site, data = metadata_Bow)  
#All sites except COCH-SUN are sig diff when invertebrate taxa are combined

pairwise.adonis2(Bow_bray ~ Family, data = metadata_Bow)
#All invertebrate taxa are sig diff when sites are combined

#Testing variance (beta dispersion) differences between sites, and sample families:
bd_all_site_Bow<-betadisper(Bow_bray, metadata_Bow$Site)
anova(bd_all_site_Bow) #No significant beta dispersion (p=0.193)
permutest(bd_all_site_Bow) #Gives the same result but based on a permutation test. 
#PERMANOVA results could be more driven by the spread in the variance of samples rather than the means if it was significant. (p=0.201)

bd_all_fam_Bow<-betadisper(Bow_bray, metadata_Bow$Family) 
anova(bd_all_fam_Bow) #significantly different p=0.0014
permutest(bd_all_fam_Bow) #sig. different (same result)
#Significant PERMANOVA could just be because of the variance within groups rather than between groups (groups = invertebrate taxa type)


## Hydropsychidae ##

hydro_Bow<-subset_samples(Bow_ps, Family=="Hydropsychidae")
Bow_rel_abun_hydro  = transform_sample_counts(hydro_Bow, function(x) x/sum(x)) 
Bow_bray_hydro = phyloseq::distance(Bow_rel_abun_hydro, method="bray") 

metadata_Bow_hydro <- data.frame(sample_data(Bow_rel_abun_hydro))

test.adonis.Bow.hydro <- adonis2(Bow_bray_hydro ~ Site, data = metadata_Bow_hydro)
test.adonis.Bow.hydro #p<0.001. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_hydro ~ Site, data = metadata_Bow_hydro)
#All sites except CUSHBR - SUN are sig diff

bd_all_fam_Bow_hydro<-betadisper(Bow_bray_hydro, metadata_Bow_hydro$Site) 
anova(bd_all_fam_Bow_hydro) #no beta dispersion p = 0.063

## Heptageniidae ##

hep_Bow<-subset_samples(ps_Bow, Family=="Heptageniidae")
Bow_rel_abun_hep  = transform_sample_counts(hep_Bow, function(x) x/sum(x)) 
Bow_bray_hep = phyloseq::distance(Bow_rel_abun_hep, method="bray") 

metadata_Bow_hep <- data.frame(sample_data(Bow_rel_abun_hep))

test.adonis.Bow.hep <- adonis2(Bow_bray_hep ~ Site, data = metadata_Bow_hep)
test.adonis.Bow.hep #p<0.001. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_hep ~ Site, data = metadata_Bow_hep)
#All sites are sig. diff from each other

bd_all_fam_Bow_hep<-betadisper(Bow_bray_hep, metadata_Bow_hep$Site) 
anova(bd_all_fam_Bow_hep) #sig beta dispersion p = 0.0126


## Chironomidae ##

chiro_Bow<-subset_samples(ps_Bow, Family=="Chironomidae")
Bow_rel_abun_chiro  = transform_sample_counts(chiro_Bow, function(x) x/sum(x)) 
Bow_bray_chiro = phyloseq::distance(Bow_rel_abun_chiro, method="bray") 

metadata_Bow_chiro <- data.frame(sample_data(Bow_rel_abun_chiro))

test.adonis.Bow.chiro <- adonis2(Bow_bray_chiro ~ Site, data = metadata_Bow_chiro)
test.adonis.Bow.chiro #p=0.002. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_chiro ~ Site, data = metadata_Bow_chiro)
#Cochrane - Policeman Flats are not diff from each other

bd_all_fam_Bow_chiro<-betadisper(Bow_bray_chiro, metadata_Bow_chiro$Site) 
anova(bd_all_fam_Bow_chiro) #no beta dispersion p = 0.34

## Perlidae ##

perl_Bow<-subset_samples(ps_Bow, Family=="Perlidae")
Bow_rel_abun_perl  = transform_sample_counts(perl_Bow, function(x) x/sum(x)) 
Bow_bray_perl = phyloseq::distance(Bow_rel_abun_perl, method="bray") 

metadata_Bow_perl <- data.frame(sample_data(Bow_rel_abun_perl))

test.adonis.Bow.perl <- adonis2(Bow_bray_perl ~ Site, data = metadata_Bow_perl)
test.adonis.Bow.perl #p<0.001. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_perl ~ Site, data = metadata_Bow_perl)
#All sites were significantly different from each other

bd_all_fam_Bow_perl<-betadisper(Bow_bray_perl, metadata_Bow_perl$Site) 
anova(bd_all_fam_Bow_perl) #sig beta dispersion p = 0.0048

## Trichoptera (adult caddis) ##

trichop_Bow<-subset_samples(ps_Bow, Family=="Trichoptera")
Bow_rel_abun_trichop  = transform_sample_counts(trichop_Bow, function(x) x/sum(x)) 
Bow_bray_trichop = phyloseq::distance(Bow_rel_abun_trichop, method="bray") 

metadata_Bow_trichop <- data.frame(sample_data(Bow_rel_abun_trichop))

test.adonis.Bow.trichop <- adonis2(Bow_bray_trichop ~ Site, data = metadata_Bow_trichop)
test.adonis.Bow.trichop #p = 0.016 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_trichop ~ Site, data = metadata_Bow_trichop)
#Only COCH - GRVBR and CUSHBR - GRVBR were different from each other (not all upstream sites were different from GRVBR)

bd_all_fam_Bow_trichop<-betadisper(Bow_bray_trichop, metadata_Bow_trichop$Site) 
anova(bd_all_fam_Bow_trichop) #beta dispersion p = 0.034

## Ephemeroptera (adult mayfly) ##

ephem_Bow<-subset_samples(ps_Bow, Family=="Ephemeroptera")
Bow_rel_abun_ephem = transform_sample_counts(ephem_Bow, function(x) x/sum(x)) 
Bow_bray_ephem = phyloseq::distance(Bow_rel_abun_ephem, method="bray") 

metadata_Bow_ephem <- data.frame(sample_data(Bow_rel_abun_ephem))

test.adonis.Bow.ephem <- adonis2(Bow_bray_ephem ~ Site, data = metadata_Bow_ephem)
test.adonis.Bow.ephem #p < 0.001 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_ephem ~ Site, data = metadata_Bow_ephem)
#Sig diff btw sites include:
#COCH - GRVBR
#COCH - CUSHBR
#COCH - PMF
#GRVBR - CUSHBR
#SUN - CUSHBR
#CUSHBR - PMF

bd_all_fam_Bow_ephem<-betadisper(Bow_bray_ephem, metadata_Bow_ephem$Site) 
anova(bd_all_fam_Bow_ephem) #no beta dispersion p = 0.064


## Diptera (adult chironomidae) ##
dip_Bow<-subset_samples(ps_Bow, Family=="Diptera")
Bow_rel_abun_dip = transform_sample_counts(dip_Bow, function(x) x/sum(x)) 
Bow_bray_dip = phyloseq::distance(Bow_rel_abun_dip, method="bray") 

metadata_Bow_dip <- data.frame(sample_data(Bow_rel_abun_dip))

test.adonis.Bow.dip <- adonis2(Bow_bray_dip ~ Site, data = metadata_Bow_dip)
test.adonis.Bow.dip #p = 0.122

#Pairwise comparisons
pairwise.adonis2(Bow_bray_dip ~ Site, data = metadata_Bow_dip)
#sig diff between COCH - CUSHBR

bd_all_fam_Bow_dip<-betadisper(Bow_bray_dip, metadata_Bow_dip$Site) 
anova(bd_all_fam_Bow_dip) #no beta dispersion p = 0.593


## Araneidae ##

aran_Bow<-subset_samples(ps_Bow, Family=="Araneidae")
Bow_rel_abun_aran = transform_sample_counts(aran_Bow, function(x) x/sum(x)) 
Bow_bray_aran = phyloseq::distance(Bow_rel_abun_aran, method="bray") 

metadata_Bow_aran <- data.frame(sample_data(Bow_rel_abun_aran))

test.adonis.Bow.aran <- adonis2(Bow_bray_aran ~ Site, data = metadata_Bow_aran)
test.adonis.Bow.aran #p < 0.001 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_aran ~ Site, data = metadata_Bow_aran)
#Sig diff btw sites include:
#COCH - SUN
#COCH - PMF
#GRVBR - SUN
#GRVBR - PMF
#CUSHBR - SUN
#CUSHBR - PMF

bd_all_fam_Bow_aran<-betadisper(Bow_bray_aran, metadata_Bow_aran$Site) 
anova(bd_all_fam_Bow_aran) #no beta dispersion p = 0.825

## Tetragnathidae ##

tetra_Bow<-subset_samples(ps_Bow, Family=="Tetragnathidae")
Bow_rel_abun_tetra = transform_sample_counts(tetra_Bow, function(x) x/sum(x)) 
Bow_bray_tetra = phyloseq::distance(Bow_rel_abun_tetra, method="bray") 

metadata_Bow_tetra <- data.frame(sample_data(Bow_rel_abun_tetra))

test.adonis.Bow.tetra <- adonis2(Bow_bray_tetra ~ Site, data = metadata_Bow_tetra)
test.adonis.Bow.tetra #p = 0.541

#Pairwise comparisons
pairwise.adonis2(Bow_bray_tetra ~ Site, data = metadata_Bow_tetra)
#No significant differences between any of the sites


bd_all_fam_Bow_tetra<-betadisper(Bow_bray_tetra, metadata_Bow_tetra$Site) 
anova(bd_all_fam_Bow_tetra) #no beta dispersion p = 0.510

## Cochrane ##

coch_Bow<-subset_samples(Bow_ps, Site=="Cochrane")
coch_rel_abun = transform_sample_counts(coch_Bow, function(x) x/sum(x)) 
coch_bray = phyloseq::distance(coch_rel_abun, method="bray") 

metadata_coch <- data.frame(sample_data(coch_rel_abun))

test.adonis.Bow.coch <- adonis2(coch_bray ~ Family, data = metadata_coch)
test.adonis.Bow.coch #p < 0.001

#Pairwise comparisons
pairwise.adonis2(coch_bray ~ Family, data = metadata_coch)
#Most inverts are diff. from each other

bd_all_fam_Bow_coch<-betadisper(coch_bray, metadata_coch$Family) 
anova(bd_all_fam_Bow_coch) #no beta dispersion p = 0.1559.

## Sunalta ##

sun_Bow<-subset_samples(Bow_ps, Site=="Sunalta")
sun_rel_abun = transform_sample_counts(sun_Bow, function(x) x/sum(x)) 
sun_bray = phyloseq::distance(sun_rel_abun, method="bray") 

metadata_sun <- data.frame(sample_data(sun_rel_abun))

test.adonis.Bow.sun <- adonis2(sun_bray ~ Family, data = metadata_sun)
test.adonis.Bow.sun #p < 0.001

#Pairwise comparisons
pairwise.adonis2(sun_bray ~ Family, data = metadata_sun)
#Most inverts are diff. from each other

bd_all_fam_Bow_sun<-betadisper(sun_bray, metadata_sun$Family) 
anova(bd_all_fam_Bow_sun) #yes beta dispersion p = 0.0057.


## Cushing Bridge ##

cush_Bow<-subset_samples(Bow_ps, Site=="Cushing Bridge")
cush_rel_abun = transform_sample_counts(cush_Bow, function(x) x/sum(x)) 
cush_bray = phyloseq::distance(cush_rel_abun, method="bray") 

metadata_cush <- data.frame(sample_data(cush_rel_abun))

test.adonis.Bow.cush <- adonis2(cush_bray ~ Family, data = metadata_cush)
test.adonis.Bow.cush #p < 0.001

#Pairwise comparisons
pairwise.adonis2(cush_bray ~ Family, data = metadata_cush)
#Most inverts are diff. from each other

bd_all_fam_Bow_cush<-betadisper(cush_bray, metadata_cush$Family) 
anova(bd_all_fam_Bow_cush) #yes beta dispersion p = 0.0068.


## Graves Bridge ##

grv_Bow<-subset_samples(Bow_ps, Site=="Graves Bridge")
grv_rel_abun = transform_sample_counts(grv_Bow, function(x) x/sum(x)) 
grv_bray = phyloseq::distance(grv_rel_abun, method="bray") 

metadata_grv <- data.frame(sample_data(grv_rel_abun))

test.adonis.Bow.grv <- adonis2(grv_bray ~ Family, data = metadata_grv)
test.adonis.Bow.grv #p < 0.001

#Pairwise comparisons
pairwise.adonis2(grv_bray ~ Family, data = metadata_grv)
#Most inverts are diff. from each other

bd_all_fam_Bow_grv<-betadisper(grv_bray, metadata_grv$Family) 
anova(bd_all_fam_Bow_grv) #no beta dispersion p = 0.335.


## Policeman Flats ##

pmf_Bow<-subset_samples(Bow_ps, Site=="Policeman Flats")
pmf_rel_abun = transform_sample_counts(pmf_Bow, function(x) x/sum(x)) 
pmf_bray = phyloseq::distance(pmf_rel_abun, method="bray") 

metadata_pmf <- data.frame(sample_data(pmf_rel_abun))

test.adonis.Bow.pmf <- adonis2(pmf_bray ~ Family, data = metadata_pmf)
test.adonis.Bow.pmf #p < 0.001

#Pairwise comparisons
pairwise.adonis2(pmf_bray ~ Family, data = metadata_pmf)
#Most inverts are diff. from each other

bd_all_fam_Bow_pmf<-betadisper(pmf_bray, metadata_pmf$Family) 
anova(bd_all_fam_Bow_pmf) #no beta dispersion p = 0.0797.


#### Water quality variables Bow ####

## EnvFit function ##

#Graves Bridge does not have water quality info so we have to get rid of this site so that the NAs don't mess up the rest of the analysis.
ps_Bow_no_grvbr<-subset_samples(sample_ps, Stream_Type=="Bow River" & Site!="Graves Bridge")

#Transform to relative abundances to standardize
Bow_rel_abun_no_grvbr  = transform_sample_counts(ps_Bow_no_grvbr, function(x) x/sum(x)) 

env_Bow_no_grvbr<-data.frame(sample_data(Bow_rel_abun_no_grvbr))
env_Bow_no_grvbr_2<-env_Bow_no_grvbr[ ,c("Water_Temp", "Dissolved_oxygen", "Conductivity", "Total_Phosphorus", "Total_Dissolved_Solids", "Total_Suspended_Solids", "Total_Organic_Carbon", "pH", "Nitrate")] #Selects only the numerical variables (water temp, conductivity, dissolved oxygen, etc). Ammonia and nitrite weren't selected since they did not differ at all between sites.

env_Bow_no_grvbr_3<-as.data.frame(scale(env_Bow_no_grvbr_2))

#All environmental data isn't normally distributed. Use Spearman correlations. 
shapiro.test(env_Bow_no_grvbr_3$Water_Temp) #Non normal
shapiro.test(env_Bow_no_grvbr_3$Dissolved_oxygen) #non normal
shapiro.test(env_Bow_no_grvbr_3$Conductivity) #non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Phosphorus) #non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Dissolved_Solids) #Non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Suspended_Solids) #Non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Organic_Carbon) #Non normal
shapiro.test(env_Bow_no_grvbr_3$pH) #non normal
shapiro.test(env_Bow_no_grvbr_3$Nitrate) #non normal


correlation_matrix_env<-as.data.frame(cor(env_Bow_no_grvbr_3), method="spearman") #Some variables are highly correlated. Test with all of them to see if any are significant then get rid of the correlated variable that is less significant based on p value. 

#Transform to Bray Curtis distance
Bow_bray_no_grvbr = phyloseq::distance(Bow_rel_abun_no_grvbr, method="bray") #Bray Curtis distance matrix

#Convert to data frame so it can be used in vegan
Bow_bray_df_no_grvbr<-as.matrix(Bow_bray_no_grvbr)
Bow_bray_df_no_grvbr<-as.data.frame(Bow_bray_df_no_grvbr)

#Ordinate with the bray curtis distance matrix
set.seed(123)
ord_Bow_mds_no_grvbr<-metaMDS(Bow_bray_df_no_grvbr) 
ord_Bow_mds_no_grvbr #stress=0.198

#install.packages("ggordiplots")
library(ggordiplots)

gg_envfit(ord = ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_3, perm = 9999, pt.size = 2, alpha = 0.05)
#Determines that TOC, pH, Conductivity, TDS, and TSS are significant predictors of microbiome composition. But some of these variables are highly correlated.

envfit(ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_3, permutations = 9999)
#Same conclusions here as above.

#Check correlations between significant variables:
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$Total_Dissolved_Solids) #0.998 Highly correlated. One variable must be removed. 
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$Total_Suspended_Solids) #0.733 Correlated
cor(env_Bow_no_grvbr_3$Total_Dissolved_Solids, env_Bow_no_grvbr_3$Total_Suspended_Solids) #0.763 Correlated. 
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$Total_Organic_Carbon) #0.0944. Not correlated. These can both stay.
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$pH) #-0.692 #Somewhat correlated
cor(env_Bow_no_grvbr_3$pH, env_Bow_no_grvbr_3$Total_Organic_Carbon) #0.276. Not correlated
#Remove Total dissolved solids and total suspended solids

env_Bow_no_grvbr_4<-env_Bow_no_grvbr_3[ , c("Conductivity", "pH", "Total_Organic_Carbon")]

envfit_2<-envfit(ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_4, permutations = 9999)
envfit_2 #All significant but have low R squared.

#Plotting ordination with sites as colours
ggenvfit_Bow_Sites<-gg_envfit(ord = ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_4, perm = 9999, groups = env_Bow_no_grvbr$Site, pt.size = 2, alpha = 0.05, len=0.05, unit="cm")
ggenvfit_Bow_Sites

#ggsave(file="microbiome_analysis/Final analysis/Beta Diversity Graphs/Envfit water quality Bow River sites.png", height=8, width=12)

#Plotting ordination with invertebrate taxa as colours
ggenvfit_Bow_taxa<-gg_envfit(ord = ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_4, perm = 9999, groups = env_Bow_no_grvbr$Family, pt.size = 2, alpha = 0.2)

#ggsave(file="Microbiome_ED/Final analysis/Beta Diversity Graphs/Envfit water quality Bow River invert taxa.png", height=8, width=12)

ggarrange(ggenvfit_Bow_Sites, ggenvfit_Bow_taxa, nrow=1, ncool=2)


## Mantel correlations ##

#Abundance distance matrix
#Bow River without GRVBR
#Subset out Graves Bridge because there was no environmental data for that site
ps_Bow_no_grvbr<-subset_samples(sample_ps, Stream_Type=="Bow River" & Site!="Graves Bridge")

#Transform to relative abundances to standardize
Bow_rel_abun_no_grvbr  = transform_sample_counts(ps_Bow_no_grvbr, function(x) x/sum(x)) 

#Convert to Bray-Curtis distance
Bow_bray_no_grvbr = phyloseq::distance(Bow_rel_abun_no_grvbr, method="bray")
#Convert to data frame so it can be used in vegan
Bow_bray_df_no_grvbr<-as.matrix(Bow_bray_no_grvbr)
Bow_bray_df_no_grvbr<-as.data.frame(Bow_bray_df_no_grvbr)


#Bow River with GRVBR included for geographic matrix
#Transform to relative abundances to standardize
Bow_rel_abun  = transform_sample_counts(Bow_ps, function(x) x/sum(x)) 

#Convert to Bray-Curtis distance
Bow_bray = phyloseq::distance(Bow_rel_abun, method="bray")
#Convert to data frame so it can be used in vegan
Bow_bray_df<-as.matrix(Bow_bray)
Bow_bray_df<-as.data.frame(Bow_bray_df)

#Geographic variable distance matrix
geo_Bow<-sample_data(Bow_rel_abun)
geo_loc_Bow<-geo_Bow[ ,4:5]

geo_Bow_mat<-as.matrix(geo_loc_Bow)
geo_Bow_df<-as.data.frame(geo_Bow_mat)

#longitude and latitude 
geo_coord_Bow = data.frame(geo_loc_Bow$Long, geo_loc_Bow$Lat) 

d.geo.Bow = distm(geo_coord_Bow, fun = distHaversine)
dist.geo.Bow = as.dist(d.geo.Bow)

abund_geo  = mantel(Bow_bray_df, dist.geo.Bow, method = "spearman", permutations = 999, na.rm = TRUE)
abund_geo #r = -0.00207, p = 0.842


#Make environmental variable distance matrix
env<-sample_data(Bow_rel_abun_no_grvbr)
env_data<-env[,16:29]

# Environmental data all together # 

env_scale<-scale(env_data)
env_dist<-dist(env_scale, method="euclidean")

abund_env = mantel(Bow_bray_df_no_grvbr, env_dist, method = "spearman", permutations = 999, na.rm = TRUE)
abund_env #r = -0.0004722, p = 0.481. Environment not selecting for the microbiome composition

# Environmental data separated #

#Water temperature
temp <-env_data$Water_Temp
dist.temp = dist(temp, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_temp = mantel(Bow_bray_df_no_grvbr, dist.temp, method = "spearman", permutations = 999, na.rm = TRUE)
abund_temp # Mantel r=0.00564, p=0.342

#Dissolved oxygen
DO<-env_data$Dissolved_oxygen

dist.DO = dist(DO, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DO = mantel(Bow_bray_df_no_grvbr, dist.DO, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DO # Mantel r=-0.01185, p=0.718

#Conductivity
cond<-env_data$Conductivity

dist.cond = dist(cond, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_cond = mantel(Bow_bray_df_no_grvbr, dist.cond, method = "spearman", permutations = 999, na.rm = TRUE)
abund_cond # Mantel r=0.00988, p=0.213

#Total Phosphorus
TP<-env_data$Total_Phosphorus

dist.TP = dist(TP, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TP = mantel(Bow_bray_df_no_grvbr, dist.TP, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TP # Mantel r=0.00502, p=0.381

#Total Dissolved Solids
TDS<-env_data$Total_Dissolved_Solids

dist.TDS = dist(TDS, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TDS = mantel(Bow_bray_df_no_grvbr, dist.TDS, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TDS # Mantel r=0.00988, p=0.197

#Total Suspended Solids
TSS<-env_data$Total_Suspended_Solids

dist.TSS = dist(TSS, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TSS = mantel(Bow_bray_df_no_grvbr, dist.TSS, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TSS # Mantel r=0.01127, p=0.22

#Total Organic Carbon
TOC<-env_data$Total_Organic_Carbon

dist.TOC = dist(TOC, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TOC = mantel(Bow_bray_df_no_grvbr, dist.TOC, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TOC # Mantel r=0.0503, p=0.023

#pH
pH<-env_data$pH

dist.pH = dist(pH, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_pH = mantel(Bow_bray_df_no_grvbr, dist.pH, method = "spearman", permutations = 999, na.rm = TRUE)
abund_pH # Mantel r=0.0102, p=0.346

#NO3
NO3<-env_data$Nitrate

dist.NO3 = dist(NO3, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NO3 = mantel(Bow_bray_df_no_grvbr, dist.NO3, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NO3 # Mantel r=0.01127, p=0.221

#Total organic carbon was a significant predictor of microbiome composition in the Bow River


#Plot scatterplot of abundance Bray Curtis dissimilarity matrix and environmental variables

#Abundance variable distance matrix
Bow_rel_abun  = transform_sample_counts(Bow_ps, function(x) x/sum(x)) 
Bow_bray = phyloseq::distance(Bow_rel_abun, method="bray")
Bow_bray_mat<-as.matrix(Bow_bray)
Bow_bray_df<-as.data.frame(Bow_bray_mat)

#Geographic variable distance matrix
geo_Bow<-sample_data(Bow_rel_abun)
geo_loc_Bow<-geo_Bow[ ,4:5]
geo_Bow_df<-as.data.frame(geo_loc_Bow)

d.geo.Bow = distm(geo_Bow_df, fun = distHaversine)


#temperature - Euclidean
temp_Bow<-sample_data[ ,16]
temp_Bow_df<-as.data.frame(temp_Bow)

dist.temp = dist(temp_Bow_df, method = "euclidean")


#Combine distances matricies into vectors in one combined matrix
aa = as.vector(Bow_bray)
tt = as.vector(dist.temp)
gg = as.vector(d.geo.Bow)

#new data frame with vectorized distance matrices
mat = data.frame(aa,tt)

#Plotting difference in temp with dissimilarity matrix
mm = ggplot(mat, aes(y = aa, x = tt)) + 
    geom_point(size = 3, alpha = 0.5) + 
    labs(x = "Difference in Temperature (C)", y = "Bray-Curtis Dissimilarity") + 
    theme( axis.text.x = element_text(face = "bold",colour = "black", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11, colour = "black"), 
        axis.title= element_text(face = "bold", size = 14, colour = "black"), 
        panel.background = element_blank(), 
        panel.border = element_rect(fill = NA, colour = "black"))
mm


```

#### ACWA
```{r}
#### Beta Diversity Graphs + PERMANOVA ####

ACWA_ps<-subset_samples(sample_ps, Stream_Type=="ACWA Streams")

#Transform to relative abundance to standardize data
ACWA_rel_abun  = transform_sample_counts(ACWA_ps, function(x) x/sum(x)) #log transforming the data 

#Bray Curtis distance matrix
ACWA_bray = phyloseq::distance(ACWA_rel_abun, method="bray") #Bray Curtis distance matrix

ord_ACWA = ordinate(ACWA_rel_abun, method="PCoA", distance="ACWA_bray")

#Scree plot of PCoA
scree <- plot_scree(ord_ACWA)
scree + theme(axis.text.x=element_text(size=8, color="black"), axis.text.y=element_text(size=18, color="black"), 
        axis.text=element_text(size=18, color="black"), axis.title=element_text(size=18)) 
#axis 1, 2, and 3 account for most variation explained (mostly axis 1 and 2)

metadata_ACWA <- data.frame(sample_data(ACWA_rel_abun))

#All together
plot_ordination(ACWA_rel_abun, ord_ACWA, color="Family", shape="Site") + #Plots the ordination
  theme_classic() +
  theme(strip.background = element_blank())+
  xlab("PC1 [32.8%]")+
  ylab("PC2 [17.9%]")

#Faceted by family and stage (larvae, adults)
plot_ordination(ACWA_rel_abun, ord_ACWA, color="Site", shape="Family") + #Plots the ordination
  theme_bw() +
  rremove("grid")+
  facet_nested_wrap(~Stage+factor(Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera")), scale="free_x", nrow=1)+
  xlab("PC1 [32.8%]")+
  ylab("PC2 [17.9%]")+
  stat_ellipse()

#ggsave(filename="Microbiome_ED/Final analysis/Beta Diversity Graphs/All samples combined/PCoA by site and invertebrate family faceted by life stage ACWA Streams.png", height = 7, width=8)


# NMDS 
set.seed(1)
ord_NMDS_ACWA = ordinate(ACWA_rel_abun, method="NMDS", distance=ACWA_bray)
ord_NMDS_ACWA #Stress=0.111


plot_ACWA<-plot_ordination(ACWA_rel_abun, ord_NMDS_ACWA, shape = "Site", color="Family") + 
  theme_bw() +
  rremove("grid")+
  geom_point(size=3)+
  theme(legend.key.size = unit(0.5, 'cm'), 
        legend.title = element_text(size=16), 
        legend.text = element_text(size=16), 
        legend.position = "right")+
  labs(color="Family")+
  guides(color=guide_legend(nrow=3, byrow=TRUE, title="Invertebrate Taxa")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))+
  ylim(-0.65, 0.45)+
  xlim(-0.85, 0.95)
  
newtab3 = data.table(plot_ACWA$data)
newtab3$Family <- ordered(newtab3$Family,
levels = c("Hydropsychidae", "Baetidae", "Ephemeroptera"), labels=c("Larval Hydropsychidae", "Larval Baetidae", "Adult Baetidae"))
plot_ACWA$data <- newtab3
print(plot_ACWA)

#ggsave(filename="Microbiome_ED/Final analysis/Beta Diversity Graphs/All samples combined/NMDS across sites and taxa ACWA only.png", height=8, width=10)


plot_ACWA_sites<-plot_ordination(ACWA_rel_abun, ord_NMDS_ACWA, shape = "Site", color="Family") + 
  theme_bw() +
  rremove("grid")+
  geom_point(size=3)+
  theme(legend.key.size = unit(0.5, 'cm'), 
        legend.title = element_text(size=16), 
        legend.text = element_text(size=16), 
        legend.position = "right")+
  labs(color="Family")+
  guides(color=guide_legend(nrow=3, byrow=TRUE, title="Invertebrate Taxa")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))+
  stat_ellipse(type="norm", alpha=1, aes(group=Site))+
  ylim(-0.65, 0.45)+
   xlim(-0.85, 0.95)
  
newtab3 = data.table(plot_ACWA_sites$data)
newtab3$Family <- ordered(newtab3$Family,
levels = c("Hydropsychidae", "Baetidae", "Ephemeroptera"), labels=c("Larval Hydropsychidae", "Larval Baetidae", "Adult Baetidae"))
plot_ACWA_sites$data <- newtab3
print(plot_ACWA_sites)

#ggsave(filename="Microbiome_ED/Final analysis/Beta Diversity Graphs/All samples combined/NMDS across sites ACWA only.png", height=8, width=10)

plot_ACWA_taxa<-plot_ordination(ACWA_rel_abun, ord_NMDS_ACWA, color="Site") +
  theme_bw() +
  rremove("grid")+
  facet_nested_wrap(~Stage+Family, scales="free_x")+
  geom_point(size=3)+
  theme(legend.key.size = unit(0.5, 'cm'), 
        legend.title = element_text(size=16), 
        legend.text = element_text(size=16), 
        legend.position = "right")+
  labs(color="Family")+
  guides(color=guide_legend(nrow=3, byrow=TRUE, title="ACWA Stream")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))+
 stat_ellipse(type="norm", alpha=1, aes(group=Site))

plot_ACWA_taxa
  

newtab5 = data.table(plot_ACWA_taxa$data)
newtab5$Site <- ordered(newtab5$Site,
levels = c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))
newtab5$Family <- ordered(newtab5$Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"))
plot_ACWA_taxa$data <- newtab5
print(plot_ACWA_taxa)
#ggsave(filename="Microbiome_ED/Final analysis/Beta Diversity Graphs/All samples combined/NMDS across taxa and sites with ellipses ACWA only.png", height=8, width=10)

#ggsave(filename="Microbiome_ED/Final analysis/Beta Diversity Graphs/All samples combined/NMDS across taxa ACWA only.png", height=8, width=10)


#PERMANOVA by Site and invertebrate taxa
test.adonis.ACWA <- adonis2(ACWA_bray ~ Site*Family, data = metadata_ACWA)
test.adonis.ACWA #p<0.001. Significant dissimilarity between sites and families but no significant interaction between the two (p=0.088).

#Pairwise comparisons
pairwise.adonis2(ACWA_bray ~ Family, data = metadata_ACWA) 
#All invertebrate types are different from one another when all sites are combined

pairwise.adonis2(ACWA_bray ~ Site, data = metadata_ACWA)
#PCR1 - PCR3 are not significantly different from each other but they are both different from BRR2 (control)

bd_sites_ACWA<-betadisper(ACWA_bray, metadata_ACWA$Site)
anova(bd_sites_ACWA) #p<0.001, F (2, 52) = 23.7

bd_fam_ACWA<-betadisper(ACWA_bray, metadata_ACWA$Family)
anova(bd_fam_ACWA) #p<0.001, F (2, 52) = 16.4


# Hydropsychidae larvae 

hydro_ACWA_ps<-subset_samples(ACWA_ps, Family=="Hydropsychidae")
hydro_ACWA_rel_abun  = transform_sample_counts(hydro_ACWA_ps, function(x) x/sum(x)) 
hydro_ACWA_bray = phyloseq::distance(hydro_ACWA_rel_abun, method="bray") #Bray Curtis distance matrix
metadata_hydro_ACWA <- data.frame(sample_data(hydro_ACWA_rel_abun))

hydro.sites.ACWA <- adonis2(hydro_ACWA_bray ~ Site, data = metadata_hydro_ACWA)
hydro.sites.ACWA #F(2,21)=1.91, P<0.001

pairwise.adonis2(hydro_ACWA_bray ~ Site, data = metadata_hydro_ACWA) 
#All streams are significantly different from each other
bd_hydro_ACWA<-betadisper(hydro_ACWA_bray, metadata_hydro_ACWA$Site)
anova(bd_hydro_ACWA) #p=0.035, F (2, 21) = 3.94

# Baetidae larvae 

baetid_ACWA_ps<-subset_samples(ACWA_ps, Family=="Baetidae")
baetid_ACWA_rel_abun  = transform_sample_counts(baetid_ACWA_ps, function(x) x/sum(x)) 
baetid_ACWA_bray = phyloseq::distance(baetid_ACWA_rel_abun, method="bray") #Bray Curtis distance matrix
metadata_baetid_ACWA <- data.frame(sample_data(baetid_ACWA_rel_abun))

pairwise.adonis2(baetid_ACWA_bray ~ Site, data = metadata_baetid_ACWA) 
#No differences
bd_baetid_ACWA<-betadisper(baetid_ACWA_bray, metadata_baetid_ACWA$Site)
anova(bd_baetid_ACWA) #p=0.98

#Ephemeroptera

ephem_ACWA_ps<-subset_samples(ACWA_ps, Family=="Ephemeroptera")
ephem_ACWA_rel_abun  = transform_sample_counts(ephem_ACWA_ps, function(x) x/sum(x)) 
ephem_ACWA_bray = phyloseq::distance(ephem_ACWA_rel_abun, method="bray") #Bray Curtis distance matrix
metadata_ephem_ACWA <- data.frame(sample_data(ephem_ACWA_rel_abun))

pairwise.adonis2(ephem_ACWA_bray ~ Site, data = metadata_ephem_ACWA) 
#No differences
bd_ephem_ACWA<-betadisper(ephem_ACWA_bray, metadata_ephem_ACWA$Site)
anova(bd_ephem_ACWA) #p=0.07


#### Water quality variables ACWA ####

ACWA_ps<-subset_samples(sample_ps, Stream_Type=="ACWA Streams")

#Transform to relative abundance to standardize data
ACWA_rel_abun  = transform_sample_counts(ACWA_ps, function(x) x/sum(x)) #log transforming the data 

#Bray Curtis distance matrix
ACWA_bray = phyloseq::distance(ACWA_rel_abun, method="bray") #Bray Curtis distance matrix
#Convert to dataframe
ACWA_bray_df<-as.matrix(ACWA_bray)
ACWA_bray_df<-as.data.frame(ACWA_bray_df)

set.seed(1)
ord_ACWA_mds = metaMDS(ACWA_bray_df) #Ordinate using NDMS
ord_ACWA_mds #0.111

#Extract environmental variables to correlate with
env_ACWA<-data.frame(sample_data(ACWA_rel_abun))
env_ACWA_2<-env_ACWA[ ,c("Water_Temp", "Dissolved_oxygen", "Conductivity", "Ammonia", "pH", "Dissolved_Nitrogen", "Nitrate", "Nitrite", "Dissolved_Organic_Carbon", "Orthophosphate")] #Selects only the numerical variables (water temp, conductivity, dissolved oxygen, etc)

correlation_matrix_env_ACWA<-as.data.frame(cor(env_ACWA_2), method="spearman") #Some variables are highly correlated. Test with all of them to see if any are significant then get rid of the correlated variable that is less significant based on p value. 

#Sites as colours

env_ACWA$Site<-factor(env_ACWA$Site, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))

gg_envfit(ord = ord_ACWA_mds, env = env_ACWA_2, perm = 9999, pt.size = 2, alpha = 0.05, groups=env_ACWA$Site)
#ggsave(file="Microbiome_ED/Final analysis/Beta Diversity Graphs/Envfit water quality ACWA sites.png", height=8, width=12)

#Invertebrate type as colours
gg_envfit(ord = ord_ACWA_mds, env = env_ACWA_2, perm = 9999, pt.size = 2, alpha = 0.05, groups=env_ACWA$Family)

#ggsave(file="Microbiome_ED/Final analysis/Beta Diversity Graphs/Envfit water quality ACWA invert taxa.png", height=8, width=12)

#Fits all environmental variables together
envfit(ord_ACWA_mds, env = env_ACWA_2, permutations = 9999)

#Fitting environmental variables individually (dropping non significant terms)
fit_all_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + Ammonia + pH + Dissolved_Nitrogen + Nitrate + Nitrite + Dissolved_Organic_Carbon + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_all_ACWA

fit_1_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + Ammonia + pH + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_1_ACWA

fit_2_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + pH + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_2_ACWA

fit_3_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_3_ACWA

fit_4_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_4_ACWA

fit_5_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Dissolved_Nitrogen + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_5_ACWA

fit_6_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Dissolved_Nitrogen + Nitrite, data = env_ACWA_2, perm = 999)
fit_6_ACWA

fit_7_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Nitrite, data = env_ACWA_2, perm = 999)
fit_7_ACWA

fit_8_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity, data = env_ACWA_2, perm = 999)
fit_8_ACWA

fit_9_ACWA <- envfit(ord_ACWA_mds ~ Conductivity, data = env_ACWA_2, perm = 999)
fit_9_ACWA 


#Conductivity is a significant predictor of microbiome community structure (p=0.005, r^2=0.184)

#Plotting conductivity on microbiome ordination

plot(fit_9_ACWA)

NMDS_ACWA <- metaMDS(ACWA_bray_df, k = 2, trymax = 100, trace = F, autotransform = FALSE, distance="bray")
NMDS_ACWA

arrowmat <- vegan::scores(fit_9_ACWA, display = "bp")
arrowmat #NMDS1 (0.339), NDMS2(-0.262)

arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map = aes(xend = NMDS1, yend = NMDS2, x = 0, y = 0, shape = NULL, color = NULL, 
    label = labels)
label_map = aes(x = 0.339 * NMDS1, y = -0.262 * NMDS2, shape = NULL, color = NULL, 
    label = labels)
# Make a new graphic
arrowhead = arrow(length = unit(0.05, "npc"))
p1 = NMDS_ACWA + geom_segment(arrow_map, linewidth = 0.5, data = arrowdf, color = "gray", 
    arrow = arrowhead) + geom_text(label_map, size = 2, data = arrowdf)
p1

## Mantel correlations ##

#Bray Curtis distance matrix
ACWA_bray = phyloseq::distance(ACWA_rel_abun, method="bray") #Bray Curtis distance matrix
#Convert to dataframe
ACWA_bray_df<-as.matrix(ACWA_bray)
ACWA_bray_df<-as.data.frame(ACWA_bray_df)

#Make environmental variable distance matrix
env_ACWA<-sample_data(ACWA_rel_abun)

#Water temperature
temp_ACWA <-env_ACWA$Water_Temp
dist.temp.ACWA = dist(temp_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_temp_ACWA = mantel(ACWA_bray_df, dist.temp.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_temp_ACWA # Mantel r=0.0282, p=0.146

#Dissolved oxygen
DO_ACWA <-env_ACWA$Dissolved_oxygen
dist.DO.ACWA = dist(DO_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DO_ACWA = mantel(ACWA_bray_df, dist.DO.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DO_ACWA # Mantel r=0.0282, p=0.139

#Conductivity
cond_ACWA <-env_ACWA$Conductivity
dist.cond.ACWA = dist(cond_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_cond_ACWA = mantel(ACWA_bray_df, dist.cond.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_cond_ACWA # Mantel r=0.0554, p=0.088

#Ammonia
NH3_ACWA <-env_ACWA$Ammonia
dist.NH3.ACWA = dist(NH3_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NH3_ACWA = mantel(ACWA_bray_df, dist.NH3.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NH3_ACWA # Mantel r=0.0282, p=0.173

#pH
pH_ACWA <-env_ACWA$pH
dist.pH.ACWA = dist(pH_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_pH_ACWA = mantel(ACWA_bray_df, dist.pH.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_pH_ACWA # Mantel r=0.00598, p=0.314


#Dissolved nitrogen
DN_ACWA <-env_ACWA$Dissolved_Nitrogen
dist.DN.ACWA = dist(DN_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DN_ACWA = mantel(ACWA_bray_df, dist.DN.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DN_ACWA # Mantel r=0.0282, p=0.152


#Nitrate
NO3_ACWA <-env_ACWA$Nitrate
dist.NO3.ACWA = dist(NO3_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NO3_ACWA = mantel(ACWA_bray_df, dist.NO3.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NO3_ACWA # Mantel r=0.0282, p=0.149


#Nitrite
NO2_ACWA <-env_ACWA$Nitrite
dist.NO2.ACWA = dist(NO2_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NO2_ACWA = mantel(ACWA_bray_df, dist.NO2.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NO2_ACWA # Mantel r=0.0282, p=0.142


#Dissolved organic carbon
DOC_ACWA <-env_ACWA$Dissolved_Organic_Carbon
dist.DOC.ACWA = dist(DOC_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DOC_ACWA = mantel(ACWA_bray_df, dist.DOC.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DOC_ACWA # Mantel r=0.0195, p=0.161


#Orthophosphate
PO4_ACWA <-env_ACWA$Orthophosphate
dist.PO4.ACWA = dist(PO4_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_PO4_ACWA = mantel(ACWA_bray_df, dist.PO4.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_PO4_ACWA # Mantel r=0.0282, p=0.147

# Plotting Spearman correlations

ACWA_rel_abun_df <- psmelt(ACWA_rel_abun)

ACWA_rel_abun_df_subset<-subset(ACWA_rel_abun_df, select = -c(Total_Phosphorus, Total_Dissolved_Solids, Total_Suspended_Solids, Total_Organic_Carbon))

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Water_Temp, method="spearman")
#-0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Dissolved_oxygen, method="spearman")
#0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Conductivity, method="spearman")
#-0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Ammonia, method="spearman")
#0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Dissolved_Organic_Carbon, method="spearman")
#-0.0107

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Orthophosphate, method="spearman")
#-0.044

library(GGally)

ACWA_cor_plot<-ggcorr(ACWA_rel_abun_df_subset, method =c("everything" ,"spearman"), label=TRUE, hjust = 0.9, size = 3, layout.exp=1)
ACWA_cor_plot
```

### Rarefied

#### Bow River 
```{r}
#Normalize the filtered data by relative abundance 
Bow_ps_rare<-subset_samples(ps_rare, Stream_Type=="Bow River")
Bow_rel_abun_rare  = transform_sample_counts(Bow_ps_rare, function(x) x/sum(x)) 
#transform to relative abundance. Seems to be the best method of normalizing.

Bow_bray_rare = phyloseq::distance(Bow_rel_abun_rare, method="bray") #Bray Curtis distance matrix
ord_Bow_rare = ordinate(Bow_rel_abun_rare, method="PCoA", distance=Bow_bray_rare) #Ordinate using PCoA

#Scree plot of PCoA
scree <- plot_scree(ord_Bow_rare)
scree + theme(axis.text.x=element_text(size=8, color="black"), axis.text.y=element_text(size=18, color="black"), 
        axis.text=element_text(size=18, color="black"), axis.title=element_text(size=18)) 
#axis 1, 2, and 3 account for most variation explained (mostly axis 1)

metadata_Bow_rare <- data.frame(sample_data(Bow_rel_abun_rare))

#All together
plot_ordination(Bow_rel_abun_rare, ord_Bow_rare, shape="Site", color="Family") + #Plots the ordination
  theme_classic() +
  theme(strip.background = element_blank())+
  xlab("PC1 [11.4%]")+
  ylab("PC2 [8.6%]")

#Faceted by stage (larvae, adults, spiders)
plot_ordination(Bow_rel_abun_rare, ord_Bow_rare, shape="Site", color="Family") + 
  theme_classic() +
  theme(strip.background = element_blank())+
  facet_wrap(~Stage)+
  xlab("PC1 [11.4%]")+
  ylab("PC2 [8.6%]")


# NMDS 
set.seed(1)
ord_NMDS_Bow_rare = ordinate(Bow_rel_abun_rare, method="NMDS", distance=Bow_bray_rare)
ord_NMDS_Bow_rare #Stress=0.177

plotNMDS1_rare<-plot_ordination(Bow_rel_abun_rare, ord_NMDS_Bow_rare, shape="Site", color = "Family") + 
  theme_classic() +
  geom_point(size=3)+
  theme(strip.background = element_blank())+
  theme(legend.key.size = unit(0.3, 'cm'), 
        legend.title = element_text(size=20), 
        legend.text = element_text(size=18), 
        axis.text = element_text(size=16, color="black"),
        axis.title = element_text(size=18, color="black"),
        legend.position = "right")+
  guides(color=guide_legend(title="Invertebrate Taxa")) +
  scale_color_discrete(palette(c("orange","blue","red","black","magenta","peachpuff")))+
  ylim(-0.5, 0.5)+
  xlim(-0.5, 0.5)

newtab1_rare = data.table(plotNMDS1_rare$data)
newtab1_rare$Family <- ordered(newtab1_rare$Family,
levels = c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"), labels=c("Larval Hydropsychidae", "Larval Heptageniidae", "Larval Chironomidae", "Larval Perlidae", "Adult Trichoptera", "Adult Ephemeroptera", "Adult Chironomidae", "Araneidae", "Tetragnathidae"))
plotNMDS1_rare$data <- newtab1_rare
print(plotNMDS1_rare)

#PERMANOVA by Site and invertebrate taxa

test.adonis.Bow.rare <- adonis2(Bow_bray_rare ~ Site*Family, data = metadata_Bow_rare)
test.adonis.Bow.rare #p<0.001. Significant dissimilarity between sites, families and significant interaction between the two.

#Pairwise comparisons
pairwise.adonis2(Bow_bray_rare ~ Site, data = metadata_Bow_rare) 
#All sites are diff from eachother, slightly different from the non-rarefied results

pairwise.adonis2(Bow_bray_rare ~ Family, data = metadata_Bow_rare)
#All invertebrate taxa except for Diptera - Ephemeroptera are sig diff when sites are combined. Slightly different from non rarefied data

#Testing variance (beta dispersion) differences between sites, and sample families:
bd_all_site_Bow_rare<-betadisper(Bow_bray_rare, metadata_Bow_rare$Site)
anova(bd_all_site_Bow_rare) #No significant beta dispersion (p=0.204)

bd_all_fam_Bow_rare<-betadisper(Bow_bray_rare, metadata_Bow_rare$Family) 
anova(bd_all_fam_Bow_rare) #significantly different p=0.0036

## Hydropsychidae ##

hydro_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Hydropsychidae")
Bow_rel_abun_hydro_rare  = transform_sample_counts(hydro_Bow_rare, function(x) x/sum(x)) 
Bow_bray_hydro_rare = phyloseq::distance(Bow_rel_abun_hydro_rare, method="bray") 

metadata_Bow_hydro_rare <- data.frame(sample_data(Bow_rel_abun_hydro_rare))

test.adonis.Bow.hydro.rare <- adonis2(Bow_bray_hydro_rare ~ Site, data = metadata_Bow_hydro_rare)
test.adonis.Bow.hydro.rare #p<0.001. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_hydro_rare ~ Site, data = metadata_Bow_hydro_rare)
#All sites except CUSHBR - SUN are sig diff. Same as non rarefied

bd_all_fam_Bow_hydro_rare<-betadisper(Bow_bray_hydro_rare, metadata_Bow_hydro_rare$Site) 
anova(bd_all_fam_Bow_hydro_rare) #no beta dispersion p = 0.15

## Heptageniidae ##

hep_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Heptageniidae")
Bow_rel_abun_hep_rare  = transform_sample_counts(hep_Bow_rare, function(x) x/sum(x)) 
Bow_bray_hep_rare = phyloseq::distance(Bow_rel_abun_hep_rare, method="bray") 

metadata_Bow_hep_rare <- data.frame(sample_data(Bow_rel_abun_hep_rare))

test.adonis.Bow.hep.rare <- adonis2(Bow_bray_hep_rare ~ Site, data = metadata_Bow_hep_rare)
test.adonis.Bow.hep.rare #p<0.001. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_hep_rare ~ Site, data = metadata_Bow_hep_rare)
#All sites are sig. diff from each other. Same as non rarefied

bd_all_fam_Bow_hep_rare<-betadisper(Bow_bray_hep_rare, metadata_Bow_hep_rare$Site) 
anova(bd_all_fam_Bow_hep_rare) #sig beta dispersion p = 0.0074


## Chironomidae ##

chiro_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Chironomidae")
Bow_rel_abun_chiro_rare  = transform_sample_counts(chiro_Bow_rare, function(x) x/sum(x)) 
Bow_bray_chiro_rare = phyloseq::distance(Bow_rel_abun_chiro_rare, method="bray") 

metadata_Bow_chiro_rare <- data.frame(sample_data(Bow_rel_abun_chiro_rare))

test.adonis.Bow.chiro.rare <- adonis2(Bow_bray_chiro_rare ~ Site, data = metadata_Bow_chiro_rare)
test.adonis.Bow.chiro.rare #p=0.003. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_chiro_rare ~ Site, data = metadata_Bow_chiro_rare)
#Cochrane - Policeman Flats are not diff from each other

bd_all_fam_Bow_chiro_rare<-betadisper(Bow_bray_chiro_rare, metadata_Bow_chiro_rare$Site) 
anova(bd_all_fam_Bow_chiro_rare) #no beta dispersion p = 0.28

## Perlidae ##

perl_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Perlidae")
Bow_rel_abun_perl_rare  = transform_sample_counts(perl_Bow_rare, function(x) x/sum(x)) 
Bow_bray_perl_rare = phyloseq::distance(Bow_rel_abun_perl_rare, method="bray") 

metadata_Bow_perl_rare <- data.frame(sample_data(Bow_rel_abun_perl_rare))

test.adonis.Bow.perl.rare <- adonis2(Bow_bray_perl_rare ~ Site, data = metadata_Bow_perl_rare)
test.adonis.Bow.perl.rare #p<0.001. 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_perl_rare ~ Site, data = metadata_Bow_perl_rare)
#All sites were significantly different from each other

bd_all_fam_Bow_perl_rare<-betadisper(Bow_bray_perl_rare, metadata_Bow_perl_rare$Site) 
anova(bd_all_fam_Bow_perl_rare) #sig beta dispersion p = 0.0050

## Trichoptera (adult caddis) ##

trichop_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Trichoptera")
Bow_rel_abun_trichop_rare  = transform_sample_counts(trichop_Bow_rare, function(x) x/sum(x)) 
Bow_bray_trichop_rare = phyloseq::distance(Bow_rel_abun_trichop_rare, method="bray") 

metadata_Bow_trichop_rare <- data.frame(sample_data(Bow_rel_abun_trichop_rare))

test.adonis.Bow.trichop.rare <- adonis2(Bow_bray_trichop_rare ~ Site, data = metadata_Bow_trichop_rare)
test.adonis.Bow.trichop.rare #p = 0.015

#Pairwise comparisons
pairwise.adonis2(Bow_bray_trichop_rare ~ Site, data = metadata_Bow_trichop_rare)
#Only COCH - GRVBR and CUSHBR - GRVBR were different from each other (not all upstream sites were different from GRVBR)

bd_all_fam_Bow_trichop_rare<-betadisper(Bow_bray_trichop_rare, metadata_Bow_trichop_rare$Site) 
anova(bd_all_fam_Bow_trichop_rare) #beta dispersion p = 0.035

## Ephemeroptera (adult mayfly) ##

ephem_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Ephemeroptera")
Bow_rel_abun_ephem_rare = transform_sample_counts(ephem_Bow_rare, function(x) x/sum(x)) 
Bow_bray_ephem_rare = phyloseq::distance(Bow_rel_abun_ephem_rare, method="bray") 

metadata_Bow_ephem_rare <- data.frame(sample_data(Bow_rel_abun_ephem_rare))

test.adonis.Bow.ephem.rare <- adonis2(Bow_bray_ephem_rare ~ Site, data = metadata_Bow_ephem_rare)
test.adonis.Bow.ephem.rare #p < 0.001 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_ephem_rare ~ Site, data = metadata_Bow_ephem_rare)
#Sig diff btw sites include:
#COCH - GRVBR
#COCH - CUSHBR
#COCH - PMF
#GRVBR - CUSHBR
#SUN - CUSHBR
#CUSHBR - PMF

bd_all_fam_Bow_ephem_rare<-betadisper(Bow_bray_ephem_rare, metadata_Bow_ephem_rare$Site) 
anova(bd_all_fam_Bow_ephem_rare) #no beta dispersion p = 0.067


## Diptera (adult chironomidae) ##
dip_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Diptera")
Bow_rel_abun_dip_rare = transform_sample_counts(dip_Bow_rare, function(x) x/sum(x)) 
Bow_bray_dip_rare = phyloseq::distance(Bow_rel_abun_dip_rare, method="bray") 

metadata_Bow_dip_rare <- data.frame(sample_data(Bow_rel_abun_dip_rare))

test.adonis.Bow.dip.rare <- adonis2(Bow_bray_dip_rare ~ Site, data = metadata_Bow_dip_rare)
test.adonis.Bow.dip.rare #p = 0.157

#Pairwise comparisons
pairwise.adonis2(Bow_bray_dip_rare ~ Site, data = metadata_Bow_dip_rare)
#no diff. Slightly different from the non rarefied dataset

bd_all_fam_Bow_dip_rare<-betadisper(Bow_bray_dip_rare, metadata_Bow_dip_rare$Site) 
anova(bd_all_fam_Bow_dip_rare) #no beta dispersion p = 0.589


## Araneidae ##

aran_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Araneidae")
Bow_rel_abun_aran_rare = transform_sample_counts(aran_Bow_rare, function(x) x/sum(x)) 
Bow_bray_aran_rare = phyloseq::distance(Bow_rel_abun_aran_rare, method="bray") 

metadata_Bow_aran_rare <- data.frame(sample_data(Bow_rel_abun_aran_rare))

test.adonis.Bow.aran.rare <- adonis2(Bow_bray_aran_rare ~ Site, data = metadata_Bow_aran_rare)
test.adonis.Bow.aran.rare #p < 0.001 

#Pairwise comparisons
pairwise.adonis2(Bow_bray_aran_rare ~ Site, data = metadata_Bow_aran_rare)
#Sig diff btw sites include:
#COCH - SUN
#COCH - PMF
#GRVBR - SUN
#GRVBR - PMF
#CUSHBR - SUN
#CUSHBR - PMF

bd_all_fam_Bow_aran_rare<-betadisper(Bow_bray_aran_rare, metadata_Bow_aran_rare$Site) 
anova(bd_all_fam_Bow_aran_rare) #no beta dispersion p = 0.85

## Tetragnathidae ##

tetra_Bow_rare<-subset_samples(Bow_ps_rare, Family=="Tetragnathidae")
Bow_rel_abun_tetra_rare = transform_sample_counts(tetra_Bow_rare, function(x) x/sum(x)) 
Bow_bray_tetra_rare = phyloseq::distance(Bow_rel_abun_tetra_rare, method="bray") 

metadata_Bow_tetra_rare <- data.frame(sample_data(Bow_rel_abun_tetra_rare))

test.adonis.Bow.tetra.rare <- adonis2(Bow_bray_tetra_rare ~ Site, data = metadata_Bow_tetra_rare)
test.adonis.Bow.tetra.rare #p = 0.55

#Pairwise comparisons
pairwise.adonis2(Bow_bray_tetra_rare ~ Site, data = metadata_Bow_tetra_rare)
#No significant differences between any of the sites


bd_all_fam_Bow_tetra_rare<-betadisper(Bow_bray_tetra_rare, metadata_Bow_tetra_rare$Site) 
anova(bd_all_fam_Bow_tetra_rare) #no beta dispersion p = 0.503

## Cochrane ##

coch_Bow_rare<-subset_samples(Bow_ps_rare, Site=="Cochrane")
coch_rel_abun_rare = transform_sample_counts(coch_Bow_rare, function(x) x/sum(x)) 
coch_bray_rare = phyloseq::distance(coch_rel_abun_rare, method="bray") 

metadata_coch_rare <- data.frame(sample_data(coch_rel_abun_rare))

test.adonis.Bow.coch.rare <- adonis2(coch_bray_rare ~ Family, data = metadata_coch_rare)
test.adonis.Bow.coch.rare #p < 0.001

#Pairwise comparisons
pairwise.adonis2(coch_bray_rare ~ Family, data = metadata_coch_rare)
#Diptera - Ephemeroptera
#Diptera - Trichoptera
#Ephemeroptera - Trichoptera
#All not sig. diff. Similar to non rarefied

bd_all_fam_Bow_coch_rare<-betadisper(coch_bray_rare, metadata_coch_rare$Family) 
anova(bd_all_fam_Bow_coch_rare) #no beta dispersion p = 0.17.

## Sunalta ##

sun_Bow_rare<-subset_samples(Bow_ps_rare, Site=="Sunalta")
sun_rel_abun_rare = transform_sample_counts(sun_Bow_rare, function(x) x/sum(x)) 
sun_bray_rare = phyloseq::distance(sun_rel_abun_rare, method="bray") 

metadata_sun_rare <- data.frame(sample_data(sun_rel_abun_rare))

test.adonis.Bow.sun.rare <- adonis2(sun_bray_rare ~ Family, data = metadata_sun_rare)
test.adonis.Bow.sun.rare #p < 0.001

#Pairwise comparisons
pairwise.adonis2(sun_bray_rare ~ Family, data = metadata_sun_rare)
#Only Ephemeroptera - Trichoptera not diff from each other

bd_all_fam_Bow_sun_rare<-betadisper(sun_bray_rare, metadata_sun_rare$Family) 
anova(bd_all_fam_Bow_sun_rare) #yes beta dispersion p = 0.0059.


## Cushing Bridge ##

cush_Bow_rare<-subset_samples(Bow_ps_rare, Site=="Cushing Bridge")
cush_rel_abun_rare = transform_sample_counts(cush_Bow_rare, function(x) x/sum(x)) 
cush_bray_rare = phyloseq::distance(cush_rel_abun_rare, method="bray") 

metadata_cush_rare <- data.frame(sample_data(cush_rel_abun_rare))

test.adonis.Bow.cush.rare <- adonis2(cush_bray_rare ~ Family, data = metadata_cush_rare)
test.adonis.Bow.cush.rare #p < 0.001

#Pairwise comparisons
pairwise.adonis2(cush_bray_rare ~ Family, data = metadata_cush_rare)
#Only Trichoptera - Diptera not diff from each other

bd_all_fam_Bow_cush_rare<-betadisper(cush_bray_rare, metadata_cush_rare$Family) 
anova(bd_all_fam_Bow_cush_rare) #yes beta dispersion p = 0.0079.


## Graves Bridge ##

grv_Bow_rare<-subset_samples(Bow_ps_rare, Site=="Graves Bridge")
grv_rel_abun_rare = transform_sample_counts(grv_Bow_rare, function(x) x/sum(x)) 
grv_bray_rare = phyloseq::distance(grv_rel_abun_rare, method="bray") 

metadata_grv_rare <- data.frame(sample_data(grv_rel_abun_rare))

test.adonis.Bow.grv.rare <- adonis2(grv_bray_rare ~ Family, data = metadata_grv_rare)
test.adonis.Bow.grv.rare #p < 0.001

#Pairwise comparisons
pairwise.adonis2(grv_bray_rare ~ Family, data = metadata_grv_rare)
#Only Ephemeroptera - Trichoptera not diff from each other

bd_all_fam_Bow_grv_rare<-betadisper(grv_bray_rare, metadata_grv_rare$Family) 
anova(bd_all_fam_Bow_grv_rare) #no beta dispersion p = 0.396.


## Policeman Flats ##

pmf_Bow_rare<-subset_samples(Bow_ps_rare, Site=="Policeman Flats")
pmf_rel_abun_rare = transform_sample_counts(pmf_Bow_rare, function(x) x/sum(x)) 
pmf_bray_rare = phyloseq::distance(pmf_rel_abun_rare, method="bray") 

metadata_pmf_rare <- data.frame(sample_data(pmf_rel_abun_rare))

test.adonis.Bow.pmf.rare <- adonis2(pmf_bray_rare ~ Family, data = metadata_pmf_rare)
test.adonis.Bow.pmf.rare #p < 0.001

#Pairwise comparisons
pairwise.adonis2(pmf_bray_rare ~ Family, data = metadata_pmf_rare)
#Araneidae - Diptera, Araneidae - Ephemeroptera, and Diptera - Ephemeroptera not diff from each other

bd_all_fam_Bow_pmf_rare<-betadisper(pmf_bray_rare, metadata_pmf_rare$Family) 
anova(bd_all_fam_Bow_pmf_rare) #no beta dispersion p = 0.163.

#A bit different from non rarefied data


#### Water quality variables Bow ####

## EnvFit function ##

#Graves Bridge does not have water quality info so we have to get rid of this site so that the NAs don't mess up the rest of the analysis.
ps_Bow_no_grvbr<-subset_samples(sample_ps, Stream_Type=="Bow River" & Site!="Graves Bridge")

#Transform to relative abundances to standardize
Bow_rel_abun_no_grvbr  = transform_sample_counts(ps_Bow_no_grvbr, function(x) x/sum(x)) 

env_Bow_no_grvbr<-data.frame(sample_data(Bow_rel_abun_no_grvbr))
env_Bow_no_grvbr_2<-env_Bow_no_grvbr[ ,c("Water_Temp", "Dissolved_oxygen", "Conductivity", "Total_Phosphorus", "Total_Dissolved_Solids", "Total_Suspended_Solids", "Total_Organic_Carbon", "pH", "Nitrate")] #Selects only the numerical variables (water temp, conductivity, dissolved oxygen, etc). Ammonia and nitrite weren't selected since they did not differ at all between sites.

env_Bow_no_grvbr_3<-as.data.frame(scale(env_Bow_no_grvbr_2))

#All environmental data isn't normally distributed. Use Spearman correlations. 
shapiro.test(env_Bow_no_grvbr_3$Water_Temp) #Non normal
shapiro.test(env_Bow_no_grvbr_3$Dissolved_oxygen) #non normal
shapiro.test(env_Bow_no_grvbr_3$Conductivity) #non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Phosphorus) #non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Dissolved_Solids) #Non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Suspended_Solids) #Non normal
shapiro.test(env_Bow_no_grvbr_3$Total_Organic_Carbon) #Non normal
shapiro.test(env_Bow_no_grvbr_3$pH) #non normal
shapiro.test(env_Bow_no_grvbr_3$Nitrate) #non normal


correlation_matrix_env<-as.data.frame(cor(env_Bow_no_grvbr_3), method="spearman") #Some variables are highly correlated. Test with all of them to see if any are significant then get rid of the correlated variable that is less significant based on p value. 

#Transform to Bray Curtis distance
Bow_bray_no_grvbr = phyloseq::distance(Bow_rel_abun_no_grvbr, method="bray") #Bray Curtis distance matrix

#Convert to data frame so it can be used in vegan
Bow_bray_df_no_grvbr<-as.matrix(Bow_bray_no_grvbr)
Bow_bray_df_no_grvbr<-as.data.frame(Bow_bray_df_no_grvbr)

#Ordinate with the bray curtis distance matrix
set.seed(123)
ord_Bow_mds_no_grvbr<-metaMDS(Bow_bray_df_no_grvbr) 
ord_Bow_mds_no_grvbr #stress=0.198

#install.packages("ggordiplots")
library(ggordiplots)

gg_envfit(ord = ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_3, perm = 9999, pt.size = 2, alpha = 0.05)
#Determines that TOC, pH, Conductivity, TDS, and TSS are significant predictors of microbiome composition. But some of these variables are highly correlated.

envfit(ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_3, permutations = 9999)
#Same conclusions here as above.

#Check correlations between significant variables:
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$Total_Dissolved_Solids) #0.998 Highly correlated. One variable must be removed. 
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$Total_Suspended_Solids) #0.733 Correlated
cor(env_Bow_no_grvbr_3$Total_Dissolved_Solids, env_Bow_no_grvbr_3$Total_Suspended_Solids) #0.763 Correlated. 
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$Total_Organic_Carbon) #0.0944. Not correlated. These can both stay.
cor(env_Bow_no_grvbr_3$Conductivity, env_Bow_no_grvbr_3$pH) #-0.692 #Somewhat correlated
cor(env_Bow_no_grvbr_3$pH, env_Bow_no_grvbr_3$Total_Organic_Carbon) #0.276. Not correlated
#Remove Total dissolved solids and total suspended solids

env_Bow_no_grvbr_4<-env_Bow_no_grvbr_3[ , c("Conductivity", "pH", "Total_Organic_Carbon")]

envfit_2<-envfit(ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_4, permutations = 9999)
envfit_2 #All significant but have low R squared.

#Plotting ordination with sites as colours
ggenvfit_Bow_Sites<-gg_envfit(ord = ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_4, perm = 9999, groups = env_Bow_no_grvbr$Site, pt.size = 2, alpha = 0.05, len=0.05, unit="cm")
ggenvfit_Bow_Sites

#ggsave(file="microbiome_analysis/Final analysis/Beta Diversity Graphs/Envfit water quality Bow River sites.png", height=8, width=12)

#Plotting ordination with invertebrate taxa as colours
ggenvfit_Bow_taxa<-gg_envfit(ord = ord_Bow_mds_no_grvbr, env = env_Bow_no_grvbr_4, perm = 9999, groups = env_Bow_no_grvbr$Family, pt.size = 2, alpha = 0.2)

#ggsave(file="Microbiome_ED/Final analysis/Beta Diversity Graphs/Envfit water quality Bow River invert taxa.png", height=8, width=12)

ggarrange(ggenvfit_Bow_Sites, ggenvfit_Bow_taxa, nrow=1, ncool=2)


## Mantel correlations ##

#Abundance distance matrix
#Bow River without GRVBR
#Subset out Graves Bridge because there was no environmental data for that site
ps_Bow_no_grvbr<-subset_samples(sample_ps, Stream_Type=="Bow River" & Site!="Graves Bridge")

#Transform to relative abundances to standardize
Bow_rel_abun_no_grvbr  = transform_sample_counts(ps_Bow_no_grvbr, function(x) x/sum(x)) 

#Convert to Bray-Curtis distance
Bow_bray_no_grvbr = phyloseq::distance(Bow_rel_abun_no_grvbr, method="bray")
#Convert to data frame so it can be used in vegan
Bow_bray_df_no_grvbr<-as.matrix(Bow_bray_no_grvbr)
Bow_bray_df_no_grvbr<-as.data.frame(Bow_bray_df_no_grvbr)


#Bow River with GRVBR included for geographic matrix
#Transform to relative abundances to standardize
Bow_rel_abun  = transform_sample_counts(Bow_ps, function(x) x/sum(x)) 

#Convert to Bray-Curtis distance
Bow_bray = phyloseq::distance(Bow_rel_abun, method="bray")
#Convert to data frame so it can be used in vegan
Bow_bray_df<-as.matrix(Bow_bray)
Bow_bray_df<-as.data.frame(Bow_bray_df)

#Geographic variable distance matrix
geo_Bow<-sample_data(Bow_rel_abun)
geo_loc_Bow<-geo_Bow[ ,4:5]

geo_Bow_mat<-as.matrix(geo_loc_Bow)
geo_Bow_df<-as.data.frame(geo_Bow_mat)

#longitude and latitude 
geo_coord_Bow = data.frame(geo_loc_Bow$Long, geo_loc_Bow$Lat) 

d.geo.Bow = distm(geo_coord_Bow, fun = distHaversine)
dist.geo.Bow = as.dist(d.geo.Bow)

abund_geo  = mantel(Bow_bray_df, dist.geo.Bow, method = "spearman", permutations = 999, na.rm = TRUE)
abund_geo #r = -0.00207, p = 0.842


#Make environmental variable distance matrix
env<-sample_data(Bow_rel_abun_no_grvbr)
env_data<-env[,16:29]

# Environmental data all together # 

env_scale<-scale(env_data)
env_dist<-dist(env_scale, method="euclidean")

abund_env = mantel(Bow_bray_df_no_grvbr, env_dist, method = "spearman", permutations = 999, na.rm = TRUE)
abund_env #r = -0.0004722, p = 0.481. Environment not selecting for the microbiome composition

# Environmental data separated #

#Water temperature
temp <-env_data$Water_Temp
dist.temp = dist(temp, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_temp = mantel(Bow_bray_df_no_grvbr, dist.temp, method = "spearman", permutations = 999, na.rm = TRUE)
abund_temp # Mantel r=0.00564, p=0.342

#Dissolved oxygen
DO<-env_data$Dissolved_oxygen

dist.DO = dist(DO, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DO = mantel(Bow_bray_df_no_grvbr, dist.DO, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DO # Mantel r=-0.01185, p=0.718

#Conductivity
cond<-env_data$Conductivity

dist.cond = dist(cond, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_cond = mantel(Bow_bray_df_no_grvbr, dist.cond, method = "spearman", permutations = 999, na.rm = TRUE)
abund_cond # Mantel r=0.00988, p=0.213

#Total Phosphorus
TP<-env_data$Total_Phosphorus

dist.TP = dist(TP, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TP = mantel(Bow_bray_df_no_grvbr, dist.TP, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TP # Mantel r=0.00502, p=0.381

#Total Dissolved Solids
TDS<-env_data$Total_Dissolved_Solids

dist.TDS = dist(TDS, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TDS = mantel(Bow_bray_df_no_grvbr, dist.TDS, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TDS # Mantel r=0.00988, p=0.197

#Total Suspended Solids
TSS<-env_data$Total_Suspended_Solids

dist.TSS = dist(TSS, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TSS = mantel(Bow_bray_df_no_grvbr, dist.TSS, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TSS # Mantel r=0.01127, p=0.22

#Total Organic Carbon
TOC<-env_data$Total_Organic_Carbon

dist.TOC = dist(TOC, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_TOC = mantel(Bow_bray_df_no_grvbr, dist.TOC, method = "spearman", permutations = 999, na.rm = TRUE)
abund_TOC # Mantel r=0.0503, p=0.023

#pH
pH<-env_data$pH

dist.pH = dist(pH, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_pH = mantel(Bow_bray_df_no_grvbr, dist.pH, method = "spearman", permutations = 999, na.rm = TRUE)
abund_pH # Mantel r=0.0102, p=0.346

#NO3
NO3<-env_data$Nitrate

dist.NO3 = dist(NO3, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NO3 = mantel(Bow_bray_df_no_grvbr, dist.NO3, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NO3 # Mantel r=0.01127, p=0.221

#Total organic carbon was a significant predictor of microbiome composition in the Bow River


#Plot scatterplot of abundance Bray Curtis dissimilarity matrix and environmental variables

#Abundance variable distance matrix
Bow_rel_abun  = transform_sample_counts(Bow_ps, function(x) x/sum(x)) 
Bow_bray = phyloseq::distance(Bow_rel_abun, method="bray")
Bow_bray_mat<-as.matrix(Bow_bray)
Bow_bray_df<-as.data.frame(Bow_bray_mat)

#Geographic variable distance matrix
geo_Bow<-sample_data(Bow_rel_abun)
geo_loc_Bow<-geo_Bow[ ,4:5]
geo_Bow_df<-as.data.frame(geo_loc_Bow)

d.geo.Bow = distm(geo_Bow_df, fun = distHaversine)


#temperature - Euclidean
temp_Bow<-sample_data[ ,16]
temp_Bow_df<-as.data.frame(temp_Bow)

dist.temp = dist(temp_Bow_df, method = "euclidean")


#Combine distances matricies into vectors in one combined matrix
aa = as.vector(Bow_bray)
tt = as.vector(dist.temp)
gg = as.vector(d.geo.Bow)

#new data frame with vectorized distance matrices
mat = data.frame(aa,tt)

#Plotting difference in temp with dissimilarity matrix
mm = ggplot(mat, aes(y = aa, x = tt)) + 
    geom_point(size = 3, alpha = 0.5) + 
    labs(x = "Difference in Temperature (C)", y = "Bray-Curtis Dissimilarity") + 
    theme( axis.text.x = element_text(face = "bold",colour = "black", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11, colour = "black"), 
        axis.title= element_text(face = "bold", size = 14, colour = "black"), 
        panel.background = element_blank(), 
        panel.border = element_rect(fill = NA, colour = "black"))
mm


```

#### ACWA
```{r}
#### ACWA streams ####

ACWA_ps_rare<-subset_samples(ps_rare, Stream_Type=="ACWA Streams")

#Transform to relative abundance to standardize data
ACWA_rel_abun_rare  = transform_sample_counts(ACWA_ps_rare, function(x) x/sum(x)) #log transforming the data 

#Bray Curtis distance matrix
ACWA_bray_rare = phyloseq::distance(ACWA_rel_abun_rare, method="bray") #Bray Curtis distance matrix

ord_ACWA_rare = ordinate(ACWA_rel_abun_rare, method="PCoA", distance="ACWA_bray_rare")

metadata_ACWA_rare <- data.frame(sample_data(ACWA_rel_abun_rare))

#All together
plot_ordination(ACWA_rel_abun_rare, ord_ACWA_rare, color="Family", shape="Site") + #Plots the ordination
  theme_classic() +
  theme(strip.background = element_blank())+
  xlab("PC1 [31.5%]")+
  ylab("PC2 [17.1%]")


# NMDS 
set.seed(1)
ord_NMDS_ACWA_rare = ordinate(ACWA_rel_abun_rare, method="NMDS", distance=ACWA_bray_rare)
ord_NMDS_ACWA_rare #Stress=0.11

#PERMANOVA by Site and invertebrate taxa
test.adonis.ACWA.rare <- adonis2(ACWA_bray_rare ~ Site*Family, data = metadata_ACWA_rare)
test.adonis.ACWA.rare #p<0.001. Significant dissimilarity between sites and families but no significant interaction between the two (p=0.099).

#Pairwise comparisons
pairwise.adonis2(ACWA_bray_rare ~ Family, data = metadata_ACWA_rare) 
#All invertebrate types are different from one another when all sites are combined

pairwise.adonis2(ACWA_bray_rare ~ Site, data = metadata_ACWA_rare)
#PCR1 - PCR3 are not significantly different from each other but they are both different from BRR2 (control)

bd_sites_ACWA_rare<-betadisper(ACWA_bray_rare, metadata_ACWA_rare$Site)
anova(bd_sites_ACWA_rare) #p<0.001, F (2, 52) = 17.7

bd_fam_ACWA_rare<-betadisper(ACWA_bray_rare, metadata_ACWA_rare$Family)
anova(bd_fam_ACWA_rare) #p<0.001, F (2, 52) = 17.7


# Hydropsychidae larvae 

hydro_ACWA_ps_rare<-subset_samples(ACWA_ps_rare, Family=="Hydropsychidae")
hydro_ACWA_rel_abun_rare  = transform_sample_counts(hydro_ACWA_ps_rare, function(x) x/sum(x)) 
hydro_ACWA_bray_rare = phyloseq::distance(hydro_ACWA_rel_abun_rare, method="bray") #Bray Curtis distance matrix
metadata_hydro_ACWA_rare <- data.frame(sample_data(hydro_ACWA_rel_abun_rare))

hydro.sites.ACWA.rare <- adonis2(hydro_ACWA_bray_rare ~ Site, data = metadata_hydro_ACWA_rare)
hydro.sites.ACWA.rare #F(2,21)=1.85, P<0.001

pairwise.adonis2(hydro_ACWA_bray_rare ~ Site, data = metadata_hydro_ACWA_rare) 
#All streams are significantly different from each other
bd_hydro_ACWA_rare<-betadisper(hydro_ACWA_bray_rare, metadata_hydro_ACWA_rare$Site)
anova(bd_hydro_ACWA_rare) #p=0.020

# Baetidae larvae 

baetid_ACWA_ps_rare<-subset_samples(ACWA_ps_rare, Family=="Baetidae")
baetid_ACWA_rel_abun_rare  = transform_sample_counts(baetid_ACWA_ps_rare, function(x) x/sum(x)) 
baetid_ACWA_bray_rare = phyloseq::distance(baetid_ACWA_rel_abun_rare, method="bray") #Bray Curtis distance matrix
metadata_baetid_ACWA_rare <- data.frame(sample_data(baetid_ACWA_rel_abun_rare))

pairwise.adonis2(baetid_ACWA_bray_rare ~ Site, data = metadata_baetid_ACWA_rare) 
#No differences
bd_baetid_ACWA_rare<-betadisper(baetid_ACWA_bray_rare, metadata_baetid_ACWA_rare$Site)
anova(bd_baetid_ACWA_rare) #p=0.99

#Ephemeroptera

ephem_ACWA_ps_rare<-subset_samples(ACWA_ps_rare, Family=="Ephemeroptera")
ephem_ACWA_rel_abun_rare  = transform_sample_counts(ephem_ACWA_ps_rare, function(x) x/sum(x)) 
ephem_ACWA_bray_rare = phyloseq::distance(ephem_ACWA_rel_abun_rare, method="bray") #Bray Curtis distance matrix
metadata_ephem_ACWA_rare <- data.frame(sample_data(ephem_ACWA_rel_abun_rare))

pairwise.adonis2(ephem_ACWA_bray_rare ~ Site, data = metadata_ephem_ACWA_rare) 
#No differences
bd_ephem_ACWA_rare<-betadisper(ephem_ACWA_bray_rare, metadata_ephem_ACWA_rare$Site)
anova(bd_ephem_ACWA_rare) #p=0.072

#Same as non rarefied results


#### Water quality variables ACWA ####

ACWA_ps<-subset_samples(sample_ps, Stream_Type=="ACWA Streams")

#Transform to relative abundance to standardize data
ACWA_rel_abun  = transform_sample_counts(ACWA_ps, function(x) x/sum(x)) #log transforming the data 

#Bray Curtis distance matrix
ACWA_bray = phyloseq::distance(ACWA_rel_abun, method="bray") #Bray Curtis distance matrix
#Convert to dataframe
ACWA_bray_df<-as.matrix(ACWA_bray)
ACWA_bray_df<-as.data.frame(ACWA_bray_df)

set.seed(1)
ord_ACWA_mds = metaMDS(ACWA_bray_df) #Ordinate using NDMS
ord_ACWA_mds #0.111

#Extract environmental variables to correlate with
env_ACWA<-data.frame(sample_data(ACWA_rel_abun))
env_ACWA_2<-env_ACWA[ ,c("Water_Temp", "Dissolved_oxygen", "Conductivity", "Ammonia", "pH", "Dissolved_Nitrogen", "Nitrate", "Nitrite", "Dissolved_Organic_Carbon", "Orthophosphate")] #Selects only the numerical variables (water temp, conductivity, dissolved oxygen, etc)

correlation_matrix_env_ACWA<-as.data.frame(cor(env_ACWA_2), method="spearman") #Some variables are highly correlated. Test with all of them to see if any are significant then get rid of the correlated variable that is less significant based on p value. 

#Sites as colours

env_ACWA$Site<-factor(env_ACWA$Site, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))

gg_envfit(ord = ord_ACWA_mds, env = env_ACWA_2, perm = 9999, pt.size = 2, alpha = 0.05, groups=env_ACWA$Site)
#ggsave(file="Microbiome_ED/Final analysis/Beta Diversity Graphs/Envfit water quality ACWA sites.png", height=8, width=12)

#Invertebrate type as colours
gg_envfit(ord = ord_ACWA_mds, env = env_ACWA_2, perm = 9999, pt.size = 2, alpha = 0.05, groups=env_ACWA$Family)

#ggsave(file="Microbiome_ED/Final analysis/Beta Diversity Graphs/Envfit water quality ACWA invert taxa.png", height=8, width=12)

#Fits all environmental variables together
envfit(ord_ACWA_mds, env = env_ACWA_2, permutations = 9999)

#Fitting environmental variables individually (dropping non significant terms)
fit_all_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + Ammonia + pH + Dissolved_Nitrogen + Nitrate + Nitrite + Dissolved_Organic_Carbon + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_all_ACWA

fit_1_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + Ammonia + pH + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_1_ACWA

fit_2_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + pH + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_2_ACWA

fit_3_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Dissolved_oxygen + Conductivity + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_3_ACWA

fit_4_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Dissolved_Nitrogen + Nitrate + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_4_ACWA

fit_5_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Dissolved_Nitrogen + Nitrite + Orthophosphate, data = env_ACWA_2, perm = 999)
fit_5_ACWA

fit_6_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Dissolved_Nitrogen + Nitrite, data = env_ACWA_2, perm = 999)
fit_6_ACWA

fit_7_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity + Nitrite, data = env_ACWA_2, perm = 999)
fit_7_ACWA

fit_8_ACWA <- envfit(ord_ACWA_mds ~ Water_Temp + Conductivity, data = env_ACWA_2, perm = 999)
fit_8_ACWA

fit_9_ACWA <- envfit(ord_ACWA_mds ~ Conductivity, data = env_ACWA_2, perm = 999)
fit_9_ACWA 


#Conductivity is a significant predictor of microbiome community structure (p=0.005, r^2=0.184)

#Plotting conductivity on microbiome ordination

plot(fit_9_ACWA)

NMDS_ACWA <- metaMDS(ACWA_bray_df, k = 2, trymax = 100, trace = F, autotransform = FALSE, distance="bray")
NMDS_ACWA

arrowmat <- vegan::scores(fit_9_ACWA, display = "bp")
arrowmat #NMDS1 (0.339), NDMS2(-0.262)

arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map = aes(xend = NMDS1, yend = NMDS2, x = 0, y = 0, shape = NULL, color = NULL, 
    label = labels)
label_map = aes(x = 0.339 * NMDS1, y = -0.262 * NMDS2, shape = NULL, color = NULL, 
    label = labels)
# Make a new graphic
arrowhead = arrow(length = unit(0.05, "npc"))
p1 = NMDS_ACWA + geom_segment(arrow_map, linewidth = 0.5, data = arrowdf, color = "gray", 
    arrow = arrowhead) + geom_text(label_map, size = 2, data = arrowdf)
p1

## Mantel correlations ##

#Bray Curtis distance matrix
ACWA_bray = phyloseq::distance(ACWA_rel_abun, method="bray") #Bray Curtis distance matrix
#Convert to dataframe
ACWA_bray_df<-as.matrix(ACWA_bray)
ACWA_bray_df<-as.data.frame(ACWA_bray_df)

#Make environmental variable distance matrix
env_ACWA<-sample_data(ACWA_rel_abun)

#Water temperature
temp_ACWA <-env_ACWA$Water_Temp
dist.temp.ACWA = dist(temp_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_temp_ACWA = mantel(ACWA_bray_df, dist.temp.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_temp_ACWA # Mantel r=0.0282, p=0.146

#Dissolved oxygen
DO_ACWA <-env_ACWA$Dissolved_oxygen
dist.DO.ACWA = dist(DO_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DO_ACWA = mantel(ACWA_bray_df, dist.DO.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DO_ACWA # Mantel r=0.0282, p=0.139

#Conductivity
cond_ACWA <-env_ACWA$Conductivity
dist.cond.ACWA = dist(cond_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_cond_ACWA = mantel(ACWA_bray_df, dist.cond.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_cond_ACWA # Mantel r=0.0554, p=0.088

#Ammonia
NH3_ACWA <-env_ACWA$Ammonia
dist.NH3.ACWA = dist(NH3_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NH3_ACWA = mantel(ACWA_bray_df, dist.NH3.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NH3_ACWA # Mantel r=0.0282, p=0.173

#pH
pH_ACWA <-env_ACWA$pH
dist.pH.ACWA = dist(pH_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_pH_ACWA = mantel(ACWA_bray_df, dist.pH.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_pH_ACWA # Mantel r=0.00598, p=0.314


#Dissolved nitrogen
DN_ACWA <-env_ACWA$Dissolved_Nitrogen
dist.DN.ACWA = dist(DN_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DN_ACWA = mantel(ACWA_bray_df, dist.DN.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DN_ACWA # Mantel r=0.0282, p=0.152


#Nitrate
NO3_ACWA <-env_ACWA$Nitrate
dist.NO3.ACWA = dist(NO3_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NO3_ACWA = mantel(ACWA_bray_df, dist.NO3.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NO3_ACWA # Mantel r=0.0282, p=0.149


#Nitrite
NO2_ACWA <-env_ACWA$Nitrite
dist.NO2.ACWA = dist(NO2_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_NO2_ACWA = mantel(ACWA_bray_df, dist.NO2.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_NO2_ACWA # Mantel r=0.0282, p=0.142


#Dissolved organic carbon
DOC_ACWA <-env_ACWA$Dissolved_Organic_Carbon
dist.DOC.ACWA = dist(DOC_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_DOC_ACWA = mantel(ACWA_bray_df, dist.DOC.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_DOC_ACWA # Mantel r=0.0195, p=0.161


#Orthophosphate
PO4_ACWA <-env_ACWA$Orthophosphate
dist.PO4.ACWA = dist(PO4_ACWA, method = "euclidean")

#Mantel test with Spearman non parametric correlations
abund_PO4_ACWA = mantel(ACWA_bray_df, dist.PO4.ACWA, method = "spearman", permutations = 999, na.rm = TRUE)
abund_PO4_ACWA # Mantel r=0.0282, p=0.147

# Plotting Spearman correlations

ACWA_rel_abun_df <- psmelt(ACWA_rel_abun)

ACWA_rel_abun_df_subset<-subset(ACWA_rel_abun_df, select = -c(Total_Phosphorus, Total_Dissolved_Solids, Total_Suspended_Solids, Total_Organic_Carbon))

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Water_Temp, method="spearman")
#-0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Dissolved_oxygen, method="spearman")
#0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Conductivity, method="spearman")
#-0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Ammonia, method="spearman")
#0.044

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Dissolved_Organic_Carbon, method="spearman")
#-0.0107

cor(ACWA_rel_abun_df$Abundance, ACWA_rel_abun_df$Orthophosphate, method="spearman")
#-0.044

library(GGally)

ACWA_cor_plot<-ggcorr(ACWA_rel_abun_df_subset, method =c("everything" ,"spearman"), label=TRUE, hjust = 0.9, size = 3, layout.exp=1)
ACWA_cor_plot
```


# Differential Abundance

Done on non-rarefied data to compare the mean absolute abundance between two ecosystems/samples/sites. The DESeq2 model internally corrects for library size, so transformed or normalized values such as counts scaled by library size should not be used as input. It is absolutely critical that the columns of the count matrix and the rows of the column data (information about samples) are in the same order.

Ignoring excess zeros in zero inflated data can lead to overestimation of dispersion and subsequent reduction in statistical power to detect differentially abundant features. To correct for this I used 'poscounts' which calculates a modified geometric mean by taking the nth root of the product of the non-zero counts. The prevalence threshold was increased to 3% to reduce the chance of false positives. Adjusted p-values using Benjamini-Hochberg correction were used to determine significance with an alpha of 0.001.

Most supported DA tests:
ANCOM-BC (Lin & Peddada, 2020. Biofilms and Microbiomes.) (Nearing et al., 2022. Nature Communications.) (Yang & Chen, 2022. Microbiome.)

ALDEX2 (Nearing et al., 2022. Nature Communications.) (Yang & Chen, 2022. Microbiome.)

## Comparing un-exposed sites to exposed sites - Bow River (inverts separated)
```{r}
#### All invertebrate taxa ####
#Wastewater exposed sites include Policeman Flats and Graves Bridge whereas unexposed sites are Cochrane, Sunalta, and Cushing Bridge.

deseq_exposed <- phyloseq_to_deseq2(sample_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed$Exposure <-relevel(deseq_exposed$Exposure, "Unexposed")

deseq_exposed <- DESeq(deseq_exposed, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed <- results(deseq_exposed, cooksCutoff = FALSE)
res_deseq_exposed
alpha = 0.001
sigtab_exposed = res_deseq_exposed[which(res_deseq_exposed$padj < alpha), ]
sigtab_exposed = cbind(as(sigtab_exposed, "data.frame"), as(tax_table(sample_ps)[rownames(sigtab_exposed), ], "matrix"))

#write.csv(as.data.frame(sigtab_exposed), file="Microbiome_ED/Final analysis/Differential Abundance Results/deseq_Wastewater_Exposed_vs_Unexposed_Sites.csv")


x_exposed = tapply(sigtab_exposed$log2FoldChange, sigtab_exposed$Phylum, function(x) max(x))
x_exposed = sort(x_exposed, TRUE)
sigtab_exposed$Phylum = factor(as.character(sigtab_exposed$Phylum), levels=names(x_exposed))
# Genus
x_exposed = tapply(sigtab_exposed$log2FoldChange, sigtab_exposed$Genus, function(x) max(x))
x_exposed = sort(x_exposed, TRUE)
sigtab_exposed$Genus = factor(as.character(sigtab_exposed$Genus), levels=sort(names(x_exposed)))

sigtab_exposed$Phylum<-factor(sigtab_exposed$Phylum, levels=c("Proteobacteria", "Bacteroidota", "Firmicutes", "Cyanobacteria", "Myxococcota", "Actinobacteriota", "Chloroflexi", "Synergistota"))

sigtab_exposed_2<-subset(sigtab_exposed, Genus=="AAP99" | Genus=="Candidatus Bacilloplasma"| Genus=="Ellin6067" | Genus=="Emticicia" | Genus=="Flavobacterium" | Genus=="Fluviicola" | Genus=="Gemmobacter" | Genus=="Haliangium" | Genus=="Hydrogenophaga" | Genus=="Methylotenera" | Genus=="Nitrosomonas" | Genus=="Nocardioides" | Genus=="Pseudorhodobacter" | Genus=="Rhizorhapis" | Genus=="Rhodobacter" | Genus=="Rhodoferax" | Genus=="Rurimicrobium" | Genus=="Serratia" | Genus=="Sphingorhabdus" | Genus=="Tyzzerella")

#All differentially abundant bacteria
ggplot(sigtab_exposed, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple", "pink", "lightcoral", "grey"))

#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites.png", height=15, width=22)

# Exposed sites contain many of the same effluent bacteria from the ACWA streams. Could indicate that these sites are affected by wastewater to some extent.


#Only wastewater associated bacteria subsetted

ggplot(sigtab_exposed_2, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple", "pink", "lightcoral", "grey"))

#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites effluent associated bacteria subset.png", height=15, width=22)

#### Spiders ####

spider_ps<-subset_samples(sample_ps, Stage=="Spiders")

deseq_exposed_spi <- phyloseq_to_deseq2(spider_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_spi$Exposure <-relevel(deseq_exposed_spi$Exposure, "Unexposed")

deseq_exposed_spi <- DESeq(deseq_exposed_spi, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_spi <- results(deseq_exposed_spi, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_spi = res_deseq_exposed_spi[which(res_deseq_exposed_spi$padj < alpha), ]
sigtab_exposed_spi = cbind(as(sigtab_exposed_spi, "data.frame"), as(tax_table(spider_ps)[rownames(sigtab_exposed_spi), ], "matrix"))

x_exposed_spi = tapply(sigtab_exposed_spi$log2FoldChange, sigtab_exposed_spi$Phylum, function(x) max(x))
x_exposed_spi = sort(x_exposed_spi, TRUE)
sigtab_exposed_spi$Phylum = factor(as.character(sigtab_exposed_spi$Phylum), levels=names(x_exposed_spi))
# Genus
x_exposed_spi = tapply(sigtab_exposed_spi$log2FoldChange, sigtab_exposed_spi$Genus, function(x) max(x))
x_exposed_spi = sort(x_exposed_spi, TRUE)
sigtab_exposed_spi$Genus = factor(as.character(sigtab_exposed_spi$Genus), levels=sort(names(x_exposed_spi)))


ggplot(sigtab_exposed_spi, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple", "pink", "lightcoral", "grey"))

#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites spiders only.png", height=15, width=22)


#### Aquatic adults ####

aq_ad_ps<-subset_samples(sample_ps, Stage=="Adults")

deseq_exposed_ad <- phyloseq_to_deseq2(aq_ad_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_ad$Exposure <-relevel(deseq_exposed_ad$Exposure, "Unexposed")

deseq_exposed_ad <- DESeq(deseq_exposed_ad, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_ad <- results(deseq_exposed_ad, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_ad = res_deseq_exposed_ad[which(res_deseq_exposed_ad$padj < alpha), ]
sigtab_exposed_ad = cbind(as(sigtab_exposed_ad, "data.frame"), as(tax_table(aq_ad_ps)[rownames(sigtab_exposed_ad), ], "matrix"))

x_exposed_ad = tapply(sigtab_exposed_ad$log2FoldChange, sigtab_exposed_ad$Phylum, function(x) max(x))
x_exposed_ad = sort(x_exposed_ad, TRUE)
sigtab_exposed_ad$Phylum = factor(as.character(sigtab_exposed_ad$Phylum), levels=names(x_exposed_ad))
# Genus
x_exposed_ad = tapply(sigtab_exposed_ad$log2FoldChange, sigtab_exposed_ad$Genus, function(x) max(x))
x_exposed_ad = sort(x_exposed_ad, TRUE)
sigtab_exposed_ad$Genus = factor(as.character(sigtab_exposed_ad$Genus), levels=sort(names(x_exposed_ad)))


ggplot(sigtab_exposed_ad, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple", "pink", "lightcoral", "grey"))

#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites aquatic adults only.png", height=15, width=22)


#### Aquatic larvae ####

aq_lar_ps<-subset_samples(sample_ps, Stage=="Larvae")

deseq_exposed_lar <- phyloseq_to_deseq2(aq_lar_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_lar$Exposure <-relevel(deseq_exposed_lar$Exposure, "Unexposed")

deseq_exposed_lar <- DESeq(deseq_exposed_lar, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_lar <- results(deseq_exposed_lar, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_lar = res_deseq_exposed_lar[which(res_deseq_exposed_lar$padj < alpha), ]
sigtab_exposed_lar = cbind(as(sigtab_exposed_lar, "data.frame"), as(tax_table(aq_lar_ps)[rownames(sigtab_exposed_lar), ], "matrix"))

x_exposed_lar = tapply(sigtab_exposed_lar$log2FoldChange, sigtab_exposed_lar$Phylum, function(x) max(x))
x_exposed_lar = sort(x_exposed_lar, TRUE)
sigtab_exposed_lar$Phylum = factor(as.character(sigtab_exposed_lar$Phylum), levels=names(x_exposed_lar))
# Genus
x_exposed_lar = tapply(sigtab_exposed_lar$log2FoldChange, sigtab_exposed_lar$Genus, function(x) max(x))
x_exposed_lar = sort(x_exposed_lar, TRUE)
sigtab_exposed_lar$Genus = factor(as.character(sigtab_exposed_lar$Genus), levels=sort(names(x_exposed_lar)))
#170 differentially abundant taxa

ggplot(sigtab_exposed_lar, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple", "pink", "lightcoral", "grey"))

#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites aquatic larvae only.png", height=15, width=22)


#### Hydropsychidae larvae ####

#Exposed vs non wastewater exposed sites

hydro_ps<-subset_samples(sample_ps, Family=="Hydropsychidae" & Stream_Type=="Bow River")

deseq_exposed_hydro <- phyloseq_to_deseq2(hydro_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_hydro$Exposure <-relevel(deseq_exposed_hydro$Exposure, "Unexposed")

deseq_exposed_hydro <- DESeq(deseq_exposed_hydro, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_hydro <- results(deseq_exposed_hydro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_hydro = res_deseq_exposed_hydro[which(res_deseq_exposed_hydro$padj < alpha), ]
sigtab_exposed_hydro = cbind(as(sigtab_exposed_hydro, "data.frame"), as(tax_table(hydro_ps)[rownames(sigtab_exposed_hydro), ], "matrix"))

x_exposed_hydro = tapply(sigtab_exposed_hydro$log2FoldChange, sigtab_exposed_hydro$Phylum, function(x) max(x))
x_exposed_hydro = sort(x_exposed_hydro, TRUE)
sigtab_exposed_hydro$Phylum = factor(as.character(sigtab_exposed_hydro$Phylum), levels=names(x_exposed_hydro))
# Genus
x_exposed_hydro = tapply(sigtab_exposed_hydro$log2FoldChange, sigtab_exposed_hydro$Genus, function(x) max(x))
x_exposed_hydro = sort(x_exposed_hydro, TRUE)
sigtab_exposed_hydro$Genus = factor(as.character(sigtab_exposed_hydro$Genus), levels=sort(names(x_exposed_hydro)))
#110 differentially abundant taxa

diff_abund_hydro_plot<-ggplot(sigtab_exposed_hydro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hydro_plot

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites hydropsychidae larvae only.png", height=15, width=22)


#COCH - SUN

hydro_sun_coch<-subset_samples(hydro_ps, Site=="Cochrane" | Site=="Sunalta")

deseq_sun_coch_hydro <- phyloseq_to_deseq2(hydro_sun_coch, ~ Site)

deseq_sun_coch_hydro <- DESeq(deseq_sun_coch_hydro, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_sun_coch_hydro <- results(deseq_sun_coch_hydro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_sun_coch_hydro = res_deseq_sun_coch_hydro[which(res_deseq_sun_coch_hydro$padj < alpha), ]
sigtab_sun_coch_hydro = cbind(as(sigtab_sun_coch_hydro, "data.frame"), as(tax_table(hydro_sun_coch)[rownames(sigtab_sun_coch_hydro), ], "matrix"))

x_sun_coch_hydro = tapply(sigtab_sun_coch_hydro$log2FoldChange, sigtab_sun_coch_hydro$Phylum, function(x) max(x))
x_sun_coch_hydro = sort(x_sun_coch_hydro, TRUE)
sigtab_sun_coch_hydro$Phylum = factor(as.character(sigtab_sun_coch_hydro$Phylum), levels=names(x_sun_coch_hydro))
# Genus
x_sun_coch_hydro = tapply(sigtab_sun_coch_hydro$log2FoldChange, sigtab_sun_coch_hydro$Genus, function(x) max(x))
x_sun_coch_hydro = sort(x_sun_coch_hydro, TRUE)
sigtab_sun_coch_hydro$Genus = factor(as.character(sigtab_sun_coch_hydro$Genus), levels=sort(names(x_sun_coch_hydro)))
#6 observations

diff_abund_hydro_sun_coch_plot<-ggplot(sigtab_sun_coch_hydro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hydro_sun_coch_plot

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River Sunalta vs Cochrane hydropsychidae larvae only.png", height=15, width=22)


#CUSHBR - COCH

hydro_cush_coch<-subset_samples(hydro_ps, Site=="Cushing Bridge" | Site=="Cochrane")

deseq_cush_coch_hydro <- phyloseq_to_deseq2(hydro_cush_coch, ~ Site)

deseq_cush_coch_hydro <- DESeq(deseq_cush_coch_hydro, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_cush_coch_hydro <- results(deseq_cush_coch_hydro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_hydro = res_deseq_cush_coch_hydro[which(res_deseq_cush_coch_hydro$padj < alpha), ]
sigtab_cush_coch_hydro = cbind(as(sigtab_cush_coch_hydro, "data.frame"), as(tax_table(hydro_cush_coch)[rownames(sigtab_cush_coch_hydro), ], "matrix"))

x_cush_coch_hydro = tapply(sigtab_cush_coch_hydro$log2FoldChange, sigtab_cush_coch_hydro$Phylum, function(x) max(x))
x_cush_coch_hydro = sort(x_cush_coch_hydro, TRUE)
sigtab_cush_coch_hydro$Phylum = factor(as.character(sigtab_cush_coch_hydro$Phylum), levels=names(x_cush_coch_hydro))
# Genus
x_cush_coch_hydro = tapply(sigtab_cush_coch_hydro$log2FoldChange, sigtab_cush_coch_hydro$Genus, function(x) max(x))
x_cush_coch_hydro = sort(x_cush_coch_hydro, TRUE)
sigtab_cush_coch_hydro$Genus = factor(as.character(sigtab_cush_coch_hydro$Genus), levels=sort(names(x_cush_coch_hydro)))
#11 observations

diff_abund_hydro_cush_coch_plot<-ggplot(sigtab_cush_coch_hydro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hydro_cush_coch_plot

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River Cushing Bridge vs Cochrane hydropsychidae larvae only.png", height=15, width=22)

#GRVBR - COCH

hydro_grvbr_coch<-subset_samples(hydro_ps, Site=="Graves Bridge" | Site=="Cochrane")

deseq_grvbr_coch_hydro <- phyloseq_to_deseq2(hydro_grvbr_coch, ~ Site)

deseq_grvbr_coch_hydro <- DESeq(deseq_grvbr_coch_hydro, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_grvbr_coch_hydro <- results(deseq_grvbr_coch_hydro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_grvbr_coch_hydro = res_deseq_grvbr_coch_hydro[which(res_deseq_grvbr_coch_hydro$padj < alpha), ]
sigtab_grvbr_coch_hydro = cbind(as(sigtab_grvbr_coch_hydro, "data.frame"), as(tax_table(hydro_grvbr_coch)[rownames(sigtab_grvbr_coch_hydro), ], "matrix"))

x_grvbr_coch_hydro = tapply(sigtab_grvbr_coch_hydro$log2FoldChange, sigtab_grvbr_coch_hydro$Phylum, function(x) max(x))
x_grvbr_coch_hydro = sort(x_grvbr_coch_hydro, TRUE)
sigtab_grvbr_coch_hydro$Phylum = factor(as.character(sigtab_grvbr_coch_hydro$Phylum), levels=names(x_grvbr_coch_hydro))
# Genus
x_grvbr_coch_hydro = tapply(sigtab_grvbr_coch_hydro$log2FoldChange, sigtab_grvbr_coch_hydro$Genus, function(x) max(x))
x_grvbr_coch_hydro = sort(x_grvbr_coch_hydro, TRUE)
sigtab_grvbr_coch_hydro$Genus = factor(as.character(sigtab_grvbr_coch_hydro$Genus), levels=sort(names(x_grvbr_coch_hydro)))
#19 observations

diff_abund_hydro_grvbr_coch_plot<-ggplot(sigtab_grvbr_coch_hydro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hydro_grvbr_coch_plot

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River Graves Bridge vs Cochrane hydropsychidae larvae only.png", height=15, width=22)


#PMF - COCH

hydro_pmf_coch<-subset_samples(hydro_ps, Site=="Policeman Flats" | Site=="Cochrane")

deseq_pmf_coch_hydro <- phyloseq_to_deseq2(hydro_pmf_coch, ~ Site)

deseq_pmf_coch_hydro <- DESeq(deseq_pmf_coch_hydro, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_pmf_coch_hydro <- results(deseq_pmf_coch_hydro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_hydro = res_deseq_pmf_coch_hydro[which(res_deseq_pmf_coch_hydro$padj < alpha), ]
sigtab_pmf_coch_hydro = cbind(as(sigtab_pmf_coch_hydro, "data.frame"), as(tax_table(hydro_pmf_coch)[rownames(sigtab_pmf_coch_hydro), ], "matrix"))

x_pmf_coch_hydro = tapply(sigtab_pmf_coch_hydro$log2FoldChange, sigtab_pmf_coch_hydro$Phylum, function(x) max(x))
x_pmf_coch_hydro = sort(x_pmf_coch_hydro, TRUE)
sigtab_pmf_coch_hydro$Phylum = factor(as.character(sigtab_pmf_coch_hydro$Phylum), levels=names(x_pmf_coch_hydro))
# Genus
x_pmf_coch_hydro = tapply(sigtab_pmf_coch_hydro$log2FoldChange, sigtab_pmf_coch_hydro$Genus, function(x) max(x))
x_pmf_coch_hydro = sort(x_pmf_coch_hydro, TRUE)
sigtab_pmf_coch_hydro$Genus = factor(as.character(sigtab_pmf_coch_hydro$Genus), levels=sort(names(x_pmf_coch_hydro)))
#156 observations

diff_abund_hydro_pmf_coch_plot<-ggplot(sigtab_pmf_coch_hydro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hydro_pmf_coch_plot

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River PMF vs Cochrane hydropsychidae larvae only.png", height=15, width=22)


#### Adult Trichoptera ####

trichop_ps<-subset_samples(sample_ps, Family=="Trichoptera")

deseq_exposed_trichop <- phyloseq_to_deseq2(trichop_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_trichop$Exposure <-relevel(deseq_exposed_trichop$Exposure, "Unexposed")

deseq_exposed_trichop <- DESeq(deseq_exposed_trichop, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_trichop <- results(deseq_exposed_trichop, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_trichop = res_deseq_exposed_trichop[which(res_deseq_exposed_trichop$padj < alpha), ]
sigtab_exposed_trichop = cbind(as(sigtab_exposed_trichop, "data.frame"), as(tax_table(trichop_ps)[rownames(sigtab_exposed_trichop), ], "matrix"))

x_exposed_trichop = tapply(sigtab_exposed_trichop$log2FoldChange, sigtab_exposed_trichop$Phylum, function(x) max(x))
x_exposed_trichop = sort(x_exposed_trichop, TRUE)
sigtab_exposed_trichop$Phylum = factor(as.character(sigtab_exposed_trichop$Phylum), levels=names(x_exposed_trichop))
# Genus
x_exposed_trichop = tapply(sigtab_exposed_trichop$log2FoldChange, sigtab_exposed_trichop$Genus, function(x) max(x))
x_exposed_trichop = sort(x_exposed_trichop, TRUE)
sigtab_exposed_trichop$Genus = factor(as.character(sigtab_exposed_trichop$Genus), levels=sort(names(x_exposed_trichop)))
#23 differentially abundant taxa

diff_abund_trichop_plot<-ggplot(sigtab_exposed_trichop, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")

diff_abund_trichop_plot

#COCH - SUN

trichop_sun_coch<-subset_samples(trichop_ps, Site=="Cochrane" | Site=="Sunalta")

deseq_sun_coch_trichop <- phyloseq_to_deseq2(trichop_sun_coch, ~ Site)

deseq_sun_coch_trichop <- DESeq(deseq_sun_coch_trichop, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_sun_coch_trichop <- results(deseq_sun_coch_trichop, cooksCutoff = FALSE)
alpha = 0.001
sigtab_sun_coch_trichop = res_deseq_sun_coch_trichop[which(res_deseq_sun_coch_trichop$padj < alpha), ]
sigtab_sun_coch_trichop = cbind(as(sigtab_sun_coch_trichop, "data.frame"), as(tax_table(trichop_sun_coch)[rownames(sigtab_sun_coch_trichop), ], "matrix"))

x_sun_coch_trichop = tapply(sigtab_sun_coch_trichop$log2FoldChange, sigtab_sun_coch_trichop$Phylum, function(x) max(x))
x_sun_coch_trichop = sort(x_sun_coch_trichop, TRUE)
sigtab_sun_coch_trichop$Phylum = factor(as.character(sigtab_sun_coch_trichop$Phylum), levels=names(x_sun_coch_trichop))
# Genus
x_sun_coch_trichop = tapply(sigtab_sun_coch_trichop$log2FoldChange, sigtab_sun_coch_trichop$Genus, function(x) max(x))
x_sun_coch_trichop = sort(x_sun_coch_trichop, TRUE)
sigtab_sun_coch_trichop$Genus = factor(as.character(sigtab_sun_coch_trichop$Genus), levels=sort(names(x_sun_coch_trichop)))
#3 observations

diff_abund_trichop_sun_coch_plot<-ggplot(sigtab_sun_coch_trichop, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_trichop_sun_coch_plot


#COCH - CUSHBR

trichop_cush_coch<-subset_samples(trichop_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_trichop <- phyloseq_to_deseq2(trichop_cush_coch, ~ Site)

deseq_cush_coch_trichop <- DESeq(deseq_cush_coch_trichop, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_cush_coch_trichop <- results(deseq_cush_coch_trichop, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_trichop = res_deseq_cush_coch_trichop[which(res_deseq_cush_coch_trichop$padj < alpha), ]
sigtab_cush_coch_trichop = cbind(as(sigtab_cush_coch_trichop, "data.frame"), as(tax_table(trichop_cush_coch)[rownames(sigtab_cush_coch_trichop), ], "matrix"))

x_cush_coch_trichop = tapply(sigtab_cush_coch_trichop$log2FoldChange, sigtab_cush_coch_trichop$Phylum, function(x) max(x))
x_cush_coch_trichop = sort(x_cush_coch_trichop, TRUE)
sigtab_cush_coch_trichop$Phylum = factor(as.character(sigtab_cush_coch_trichop$Phylum), levels=names(x_cush_coch_trichop))
# Genus
x_cush_coch_trichop = tapply(sigtab_cush_coch_trichop$log2FoldChange, sigtab_cush_coch_trichop$Genus, function(x) max(x))
x_cush_coch_trichop = sort(x_cush_coch_trichop, TRUE)
sigtab_cush_coch_trichop$Genus = factor(as.character(sigtab_cush_coch_trichop$Genus), levels=sort(names(x_cush_coch_trichop)))
#3 observations

diff_abund_trichop_cush_coch_plot<-ggplot(sigtab_cush_coch_trichop, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_trichop_cush_coch_plot


#COCH - GRVBR

trichop_grvbr_coch<-subset_samples(trichop_ps, Site=="Cochrane" | Site=="Graves Bridge")

deseq_grvbr_coch_trichop <- phyloseq_to_deseq2(trichop_grvbr_coch, ~ Site)

deseq_grvbr_coch_trichop <- DESeq(deseq_grvbr_coch_trichop, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_grvbr_coch_trichop <- results(deseq_grvbr_coch_trichop, cooksCutoff = FALSE)
alpha = 0.001
sigtab_grvbr_coch_trichop = res_deseq_grvbr_coch_trichop[which(res_deseq_grvbr_coch_trichop$padj < alpha), ]
sigtab_grvbr_coch_trichop = cbind(as(sigtab_grvbr_coch_trichop, "data.frame"), as(tax_table(trichop_grvbr_coch)[rownames(sigtab_grvbr_coch_trichop), ], "matrix"))

x_grvbr_coch_trichop = tapply(sigtab_grvbr_coch_trichop$log2FoldChange, sigtab_grvbr_coch_trichop$Phylum, function(x) max(x))
x_grvbr_coch_trichop = sort(x_grvbr_coch_trichop, TRUE)
sigtab_grvbr_coch_trichop$Phylum = factor(as.character(sigtab_grvbr_coch_trichop$Phylum), levels=names(x_grvbr_coch_trichop))
# Genus
x_grvbr_coch_trichop = tapply(sigtab_grvbr_coch_trichop$log2FoldChange, sigtab_grvbr_coch_trichop$Genus, function(x) max(x))
x_grvbr_coch_trichop = sort(x_grvbr_coch_trichop, TRUE)
sigtab_grvbr_coch_trichop$Genus = factor(as.character(sigtab_grvbr_coch_trichop$Genus), levels=sort(names(x_grvbr_coch_trichop)))
#20 observations

diff_abund_trichop_grvbr_coch_plot<-ggplot(sigtab_grvbr_coch_trichop, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_trichop_grvbr_coch_plot


#### Larval Heptageniidae ####

hep_ps<-subset_samples(sample_ps, Family=="Heptageniidae")

deseq_exposed_hep <- phyloseq_to_deseq2(hep_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_hep$Exposure <-relevel(deseq_exposed_hep$Exposure, "Unexposed")

deseq_exposed_hep <- DESeq(deseq_exposed_hep, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_hep <- results(deseq_exposed_hep, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_hep = res_deseq_exposed_hep[which(res_deseq_exposed_hep$padj < alpha), ]
sigtab_exposed_hep = cbind(as(sigtab_exposed_hep, "data.frame"), as(tax_table(hep_ps)[rownames(sigtab_exposed_hep), ], "matrix"))

x_exposed_hep = tapply(sigtab_exposed_hep$log2FoldChange, sigtab_exposed_hep$Phylum, function(x) max(x))
x_exposed_hep = sort(x_exposed_hep, TRUE)
sigtab_exposed_hep$Phylum = factor(as.character(sigtab_exposed_hep$Phylum), levels=names(x_exposed_hep))
# Genus
x_exposed_hep = tapply(sigtab_exposed_hep$log2FoldChange, sigtab_exposed_hep$Genus, function(x) max(x))
x_exposed_hep = sort(x_exposed_hep, TRUE)
sigtab_exposed_hep$Genus = factor(as.character(sigtab_exposed_hep$Genus), levels=sort(names(x_exposed_hep)))
#45 differentially abundant taxa

diff_abund_hep_plot<-ggplot(sigtab_exposed_hep, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")
diff_abund_hep_plot

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites larval heptageniidae only.png", height=15, width=22)


#COCH - SUN

hep_sun_coch<-subset_samples(hep_ps, Site=="Cochrane" | Site=="Sunalta")

deseq_sun_coch_hep <- phyloseq_to_deseq2(hep_sun_coch, ~ Site)

deseq_sun_coch_hep <- DESeq(deseq_sun_coch_hep, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_sun_coch_hep <- results(deseq_sun_coch_hep, cooksCutoff = FALSE)
alpha = 0.001
sigtab_sun_coch_hep = res_deseq_sun_coch_hep[which(res_deseq_sun_coch_hep$padj < alpha), ]
sigtab_sun_coch_hep = cbind(as(sigtab_sun_coch_hep, "data.frame"), as(tax_table(hep_sun_coch)[rownames(sigtab_sun_coch_hep), ], "matrix"))

x_sun_coch_hep = tapply(sigtab_sun_coch_hep$log2FoldChange, sigtab_sun_coch_hep$Phylum, function(x) max(x))
x_sun_coch_hep = sort(x_sun_coch_hep, TRUE)
sigtab_sun_coch_hep$Phylum = factor(as.character(sigtab_sun_coch_hep$Phylum), levels=names(x_sun_coch_hep))
# Genus
x_sun_coch_hep = tapply(sigtab_sun_coch_hep$log2FoldChange, sigtab_sun_coch_hep$Genus, function(x) max(x))
x_sun_coch_hep = sort(x_sun_coch_hep, TRUE)
sigtab_sun_coch_hep$Genus = factor(as.character(sigtab_sun_coch_hep$Genus), levels=sort(names(x_sun_coch_hep)))
#2 observations

diff_abund_hep_sun_coch_plot<-ggplot(sigtab_sun_coch_hep, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hep_sun_coch_plot


#COCH - CUSHBR

hep_cush_coch<-subset_samples(hep_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_hep <- phyloseq_to_deseq2(hep_cush_coch, ~ Site)

deseq_cush_coch_hep <- DESeq(deseq_cush_coch_hep, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_cush_coch_hep <- results(deseq_cush_coch_hep, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_hep = res_deseq_cush_coch_hep[which(res_deseq_cush_coch_hep$padj < alpha), ]
sigtab_cush_coch_hep = cbind(as(sigtab_cush_coch_hep, "data.frame"), as(tax_table(hep_cush_coch)[rownames(sigtab_cush_coch_hep), ], "matrix"))

x_cush_coch_hep = tapply(sigtab_cush_coch_hep$log2FoldChange, sigtab_cush_coch_hep$Phylum, function(x) max(x))
x_cush_coch_hep = sort(x_cush_coch_hep, TRUE)
sigtab_cush_coch_hep$Phylum = factor(as.character(sigtab_cush_coch_hep$Phylum), levels=names(x_cush_coch_hep))
# Genus
x_cush_coch_hep = tapply(sigtab_cush_coch_hep$log2FoldChange, sigtab_cush_coch_hep$Genus, function(x) max(x))
x_cush_coch_hep = sort(x_cush_coch_hep, TRUE)
sigtab_cush_coch_hep$Genus = factor(as.character(sigtab_cush_coch_hep$Genus), levels=sort(names(x_cush_coch_hep)))
#3 observations

diff_abund_hep_cush_coch_plot<-ggplot(sigtab_cush_coch_hep, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hep_cush_coch_plot


#COCH - GRVBR

hep_grvbr_coch<-subset_samples(hep_ps, Site=="Cochrane" | Site=="Graves Bridge")

deseq_grvbr_coch_hep <- phyloseq_to_deseq2(hep_grvbr_coch, ~ Site)

deseq_grvbr_coch_hep <- DESeq(deseq_grvbr_coch_hep, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_grvbr_coch_hep <- results(deseq_grvbr_coch_hep, cooksCutoff = FALSE)
alpha = 0.001
sigtab_grvbr_coch_hep = res_deseq_grvbr_coch_hep[which(res_deseq_grvbr_coch_hep$padj < alpha), ]
sigtab_grvbr_coch_hep = cbind(as(sigtab_grvbr_coch_hep, "data.frame"), as(tax_table(hep_grvbr_coch)[rownames(sigtab_grvbr_coch_hep), ], "matrix"))

x_grvbr_coch_hep = tapply(sigtab_grvbr_coch_hep$log2FoldChange, sigtab_grvbr_coch_hep$Phylum, function(x) max(x))
x_grvbr_coch_hep = sort(x_grvbr_coch_hep, TRUE)
sigtab_grvbr_coch_hep$Phylum = factor(as.character(sigtab_grvbr_coch_hep$Phylum), levels=names(x_grvbr_coch_hep))
# Genus
x_grvbr_coch_hep = tapply(sigtab_grvbr_coch_hep$log2FoldChange, sigtab_grvbr_coch_hep$Genus, function(x) max(x))
x_grvbr_coch_hep = sort(x_grvbr_coch_hep, TRUE)
sigtab_grvbr_coch_hep$Genus = factor(as.character(sigtab_grvbr_coch_hep$Genus), levels=sort(names(x_grvbr_coch_hep)))
#35 observations

diff_abund_hep_grvbr_coch_plot<-ggplot(sigtab_grvbr_coch_hep, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hep_grvbr_coch_plot

#COCH - GRVBR

hep_grvbr_coch<-subset_samples(hep_ps, Site=="Cochrane" | Site=="Graves Bridge")

deseq_grvbr_coch_hep <- phyloseq_to_deseq2(hep_grvbr_coch, ~ Site)

deseq_grvbr_coch_hep <- DESeq(deseq_grvbr_coch_hep, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_grvbr_coch_hep <- results(deseq_grvbr_coch_hep, cooksCutoff = FALSE)
alpha = 0.001
sigtab_grvbr_coch_hep = res_deseq_grvbr_coch_hep[which(res_deseq_grvbr_coch_hep$padj < alpha), ]
sigtab_grvbr_coch_hep = cbind(as(sigtab_grvbr_coch_hep, "data.frame"), as(tax_table(hep_grvbr_coch)[rownames(sigtab_grvbr_coch_hep), ], "matrix"))

x_grvbr_coch_hep = tapply(sigtab_grvbr_coch_hep$log2FoldChange, sigtab_grvbr_coch_hep$Phylum, function(x) max(x))
x_grvbr_coch_hep = sort(x_grvbr_coch_hep, TRUE)
sigtab_grvbr_coch_hep$Phylum = factor(as.character(sigtab_grvbr_coch_hep$Phylum), levels=names(x_grvbr_coch_hep))
# Genus
x_grvbr_coch_hep = tapply(sigtab_grvbr_coch_hep$log2FoldChange, sigtab_grvbr_coch_hep$Genus, function(x) max(x))
x_grvbr_coch_hep = sort(x_grvbr_coch_hep, TRUE)
sigtab_grvbr_coch_hep$Genus = factor(as.character(sigtab_grvbr_coch_hep$Genus), levels=sort(names(x_grvbr_coch_hep)))
#35 observations

diff_abund_hep_grvbr_coch_plot<-ggplot(sigtab_grvbr_coch_hep, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hep_grvbr_coch_plot


#COCH - PMF

hep_pmf_coch<-subset_samples(hep_ps, Site=="Cochrane" | Site=="Policeman Flats")

deseq_pmf_coch_hep <- phyloseq_to_deseq2(hep_pmf_coch, ~ Site)

deseq_pmf_coch_hep <- DESeq(deseq_pmf_coch_hep, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_pmf_coch_hep <- results(deseq_pmf_coch_hep, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_hep = res_deseq_pmf_coch_hep[which(res_deseq_pmf_coch_hep$padj < alpha), ]
sigtab_pmf_coch_hep = cbind(as(sigtab_pmf_coch_hep, "data.frame"), as(tax_table(hep_pmf_coch)[rownames(sigtab_pmf_coch_hep), ], "matrix"))

x_pmf_coch_hep = tapply(sigtab_pmf_coch_hep$log2FoldChange, sigtab_pmf_coch_hep$Phylum, function(x) max(x))
x_pmf_coch_hep = sort(x_pmf_coch_hep, TRUE)
sigtab_pmf_coch_hep$Phylum = factor(as.character(sigtab_pmf_coch_hep$Phylum), levels=names(x_pmf_coch_hep))
# Genus
x_pmf_coch_hep = tapply(sigtab_pmf_coch_hep$log2FoldChange, sigtab_pmf_coch_hep$Genus, function(x) max(x))
x_pmf_coch_hep = sort(x_pmf_coch_hep, TRUE)
sigtab_pmf_coch_hep$Genus = factor(as.character(sigtab_pmf_coch_hep$Genus), levels=sort(names(x_pmf_coch_hep)))
#71 observations

diff_abund_hep_pmf_coch_plot<-ggplot(sigtab_pmf_coch_hep, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_hep_pmf_coch_plot

#### Adult Ephemeroptera ####

ephem_ps<-subset_samples(sample_ps, Family=="Ephemeroptera" & Stream_Type=="Bow River")

deseq_exposed_ephem <- phyloseq_to_deseq2(ephem_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_ephem$Exposure <-relevel(deseq_exposed_ephem$Exposure, "Unexposed")

deseq_exposed_ephem <- DESeq(deseq_exposed_ephem, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_ephem <- results(deseq_exposed_ephem, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_ephem = res_deseq_exposed_ephem[which(res_deseq_exposed_ephem$padj < alpha), ]
sigtab_exposed_ephem = cbind(as(sigtab_exposed_ephem, "data.frame"), as(tax_table(ephem_ps)[rownames(sigtab_exposed_ephem), ], "matrix"))

x_exposed_ephem = tapply(sigtab_exposed_ephem$log2FoldChange, sigtab_exposed_ephem$Phylum, function(x) max(x))
x_exposed_ephem = sort(x_exposed_ephem, TRUE)
sigtab_exposed_ephem$Phylum = factor(as.character(sigtab_exposed_ephem$Phylum), levels=names(x_exposed_ephem))
# Genus
x_exposed_ephem = tapply(sigtab_exposed_ephem$log2FoldChange, sigtab_exposed_ephem$Genus, function(x) max(x))
x_exposed_ephem = sort(x_exposed_ephem, TRUE)
sigtab_exposed_ephem$Genus = factor(as.character(sigtab_exposed_ephem$Genus), levels=sort(names(x_exposed_ephem)))
#8 differentially abundant taxa

diff_abund_ephem_plot<-ggplot(sigtab_exposed_ephem, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")


#COCH - SUN

ephem_sun_coch<-subset_samples(ephem_ps, Site=="Cochrane" | Site=="Sunalta")

deseq_sun_coch_ephem <- phyloseq_to_deseq2(ephem_sun_coch, ~ Site)

deseq_sun_coch_ephem <- DESeq(deseq_sun_coch_ephem, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_sun_coch_ephem <- results(deseq_sun_coch_ephem, cooksCutoff = FALSE)
alpha = 0.001
sigtab_sun_coch_ephem = res_deseq_sun_coch_ephem[which(res_deseq_sun_coch_ephem$padj < alpha), ]
sigtab_sun_coch_ephem = cbind(as(sigtab_sun_coch_ephem, "data.frame"), as(tax_table(ephem_sun_coch)[rownames(sigtab_sun_coch_ephem), ], "matrix"))

x_sun_coch_ephem = tapply(sigtab_sun_coch_ephem$log2FoldChange, sigtab_sun_coch_ephem$Phylum, function(x) max(x))
x_sun_coch_ephem = sort(x_sun_coch_ephem, TRUE)
sigtab_sun_coch_ephem$Phylum = factor(as.character(sigtab_sun_coch_ephem$Phylum), levels=names(x_sun_coch_ephem))
# Genus
x_sun_coch_ephem = tapply(sigtab_sun_coch_ephem$log2FoldChange, sigtab_sun_coch_ephem$Genus, function(x) max(x))
x_sun_coch_ephem = sort(x_sun_coch_ephem, TRUE)
sigtab_sun_coch_ephem$Genus = factor(as.character(sigtab_sun_coch_ephem$Genus), levels=sort(names(x_sun_coch_ephem)))
#12 observations

diff_abund_ephem_sun_coch_plot<-ggplot(sigtab_sun_coch_ephem, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_ephem_sun_coch_plot


#COCH - CUSHBR

ephem_cush_coch<-subset_samples(ephem_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_ephem <- phyloseq_to_deseq2(ephem_cush_coch, ~ Site)

deseq_cush_coch_ephem <- DESeq(deseq_cush_coch_ephem, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_cush_coch_ephem <- results(deseq_cush_coch_ephem, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_ephem = res_deseq_cush_coch_ephem[which(res_deseq_cush_coch_ephem$padj < alpha), ]
sigtab_cush_coch_ephem = cbind(as(sigtab_cush_coch_ephem, "data.frame"), as(tax_table(ephem_cush_coch)[rownames(sigtab_cush_coch_ephem), ], "matrix"))

x_cush_coch_ephem = tapply(sigtab_cush_coch_ephem$log2FoldChange, sigtab_cush_coch_ephem$Phylum, function(x) max(x))
x_cush_coch_ephem = sort(x_cush_coch_ephem, TRUE)
sigtab_cush_coch_ephem$Phylum = factor(as.character(sigtab_cush_coch_ephem$Phylum), levels=names(x_cush_coch_ephem))
# Genus
x_cush_coch_ephem = tapply(sigtab_cush_coch_ephem$log2FoldChange, sigtab_cush_coch_ephem$Genus, function(x) max(x))
x_cush_coch_ephem = sort(x_cush_coch_ephem, TRUE)
sigtab_cush_coch_ephem$Genus = factor(as.character(sigtab_cush_coch_ephem$Genus), levels=sort(names(x_cush_coch_ephem)))
#8 observations

diff_abund_ephem_cush_coch_plot<-ggplot(sigtab_cush_coch_ephem, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_ephem_cush_coch_plot


#COCH - GRVBR

ephem_grvbr_coch<-subset_samples(ephem_ps, Site=="Cochrane" | Site=="Graves Bridge")

deseq_grvbr_coch_ephem <- phyloseq_to_deseq2(ephem_grvbr_coch, ~ Site)

deseq_grvbr_coch_ephem <- DESeq(deseq_grvbr_coch_ephem, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_grvbr_coch_ephem <- results(deseq_grvbr_coch_ephem, cooksCutoff = FALSE)
alpha = 0.001
sigtab_grvbr_coch_ephem = res_deseq_grvbr_coch_ephem[which(res_deseq_grvbr_coch_ephem$padj < alpha), ]
sigtab_grvbr_coch_ephem = cbind(as(sigtab_grvbr_coch_ephem, "data.frame"), as(tax_table(ephem_grvbr_coch)[rownames(sigtab_grvbr_coch_ephem), ], "matrix"))

x_grvbr_coch_ephem = tapply(sigtab_grvbr_coch_ephem$log2FoldChange, sigtab_grvbr_coch_ephem$Phylum, function(x) max(x))
x_grvbr_coch_ephem = sort(x_grvbr_coch_ephem, TRUE)
sigtab_grvbr_coch_ephem$Phylum = factor(as.character(sigtab_grvbr_coch_ephem$Phylum), levels=names(x_grvbr_coch_ephem))
# Genus
x_grvbr_coch_ephem = tapply(sigtab_grvbr_coch_ephem$log2FoldChange, sigtab_grvbr_coch_ephem$Genus, function(x) max(x))
x_grvbr_coch_ephem = sort(x_grvbr_coch_ephem, TRUE)
sigtab_grvbr_coch_ephem$Genus = factor(as.character(sigtab_grvbr_coch_ephem$Genus), levels=sort(names(x_grvbr_coch_ephem)))
#10 observations

diff_abund_ephem_grvbr_coch_plot<-ggplot(sigtab_grvbr_coch_ephem, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_ephem_grvbr_coch_plot

#COCH - PMF

ephem_pmf_coch<-subset_samples(ephem_ps, Site=="Cochrane" | Site=="Policeman Flats")

deseq_pmf_coch_ephem <- phyloseq_to_deseq2(ephem_pmf_coch, ~ Site)

deseq_pmf_coch_ephem <- DESeq(deseq_pmf_coch_ephem, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_pmf_coch_ephem <- results(deseq_pmf_coch_ephem, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_ephem = res_deseq_pmf_coch_ephem[which(res_deseq_pmf_coch_ephem$padj < alpha), ]
sigtab_pmf_coch_ephem = cbind(as(sigtab_pmf_coch_ephem, "data.frame"), as(tax_table(ephem_pmf_coch)[rownames(sigtab_pmf_coch_ephem), ], "matrix"))

x_pmf_coch_ephem = tapply(sigtab_pmf_coch_ephem$log2FoldChange, sigtab_pmf_coch_ephem$Phylum, function(x) max(x))
x_pmf_coch_ephem = sort(x_pmf_coch_ephem, TRUE)
sigtab_pmf_coch_ephem$Phylum = factor(as.character(sigtab_pmf_coch_ephem$Phylum), levels=names(x_pmf_coch_ephem))
# Genus
x_pmf_coch_ephem = tapply(sigtab_pmf_coch_ephem$log2FoldChange, sigtab_pmf_coch_ephem$Genus, function(x) max(x))
x_pmf_coch_ephem = sort(x_pmf_coch_ephem, TRUE)
sigtab_pmf_coch_ephem$Genus = factor(as.character(sigtab_pmf_coch_ephem$Genus), levels=sort(names(x_pmf_coch_ephem)))
#1 observation

diff_abund_ephem_pmf_coch_plot<-ggplot(sigtab_pmf_coch_ephem, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_ephem_pmf_coch_plot

#### Larval Chironomidae ####

chiro_ps<-subset_samples(sample_ps, Family=="Chironomidae")

deseq_exposed_chiro <- phyloseq_to_deseq2(chiro_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_chiro$Exposure <-relevel(deseq_exposed_chiro$Exposure, "Unexposed")

deseq_exposed_chiro <- DESeq(deseq_exposed_chiro, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_chiro <- results(deseq_exposed_chiro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_chiro = res_deseq_exposed_chiro[which(res_deseq_exposed_chiro$padj < alpha), ]
sigtab_exposed_chiro = cbind(as(sigtab_exposed_chiro, "data.frame"), as(tax_table(chiro_ps)[rownames(sigtab_exposed_chiro), ], "matrix"))

x_exposed_chiro = tapply(sigtab_exposed_chiro$log2FoldChange, sigtab_exposed_chiro$Phylum, function(x) max(x))
x_exposed_chiro = sort(x_exposed_chiro, TRUE)
sigtab_exposed_chiro$Phylum = factor(as.character(sigtab_exposed_chiro$Phylum), levels=names(x_exposed_chiro))
# Genus
x_exposed_chiro = tapply(sigtab_exposed_chiro$log2FoldChange, sigtab_exposed_chiro$Genus, function(x) max(x))
x_exposed_chiro = sort(x_exposed_chiro, TRUE)
sigtab_exposed_chiro$Genus = factor(as.character(sigtab_exposed_chiro$Genus), levels=sort(names(x_exposed_chiro)))
#21 differentially abundant taxa

diff_abund_chiro_plot<-ggplot(sigtab_exposed_chiro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites chironomid larvae only.png", height=15, width=22)

#COCH - CUSHBR

chiro_cush_coch<-subset_samples(chiro_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_chiro <- phyloseq_to_deseq2(chiro_cush_coch, ~ Site)

deseq_cush_coch_chiro <- DESeq(deseq_cush_coch_chiro, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_cush_coch_chiro <- results(deseq_cush_coch_chiro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_chiro = res_deseq_cush_coch_chiro[which(res_deseq_cush_coch_chiro$padj < alpha), ]
sigtab_cush_coch_chiro = cbind(as(sigtab_cush_coch_chiro, "data.frame"), as(tax_table(chiro_cush_coch)[rownames(sigtab_cush_coch_chiro), ], "matrix"))

x_cush_coch_chiro = tapply(sigtab_cush_coch_chiro$log2FoldChange, sigtab_cush_coch_chiro$Phylum, function(x) max(x))
x_cush_coch_chiro = sort(x_cush_coch_chiro, TRUE)
sigtab_cush_coch_chiro$Phylum = factor(as.character(sigtab_cush_coch_chiro$Phylum), levels=names(x_cush_coch_chiro))
# Genus
x_cush_coch_chiro = tapply(sigtab_cush_coch_chiro$log2FoldChange, sigtab_cush_coch_chiro$Genus, function(x) max(x))
x_cush_coch_chiro = sort(x_cush_coch_chiro, TRUE)
sigtab_cush_coch_chiro$Genus = factor(as.character(sigtab_cush_coch_chiro$Genus), levels=sort(names(x_cush_coch_chiro)))
#20 observations

diff_abund_chiro_cush_coch_plot<-ggplot(sigtab_cush_coch_chiro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_chiro_cush_coch_plot


#COCH - PMF

chiro_pmf_coch<-subset_samples(chiro_ps, Site=="Cochrane" | Site=="Policeman Flats")

deseq_pmf_coch_chiro <- phyloseq_to_deseq2(chiro_pmf_coch, ~ Site)

deseq_pmf_coch_chiro <- DESeq(deseq_pmf_coch_chiro, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_pmf_coch_chiro <- results(deseq_pmf_coch_chiro, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_chiro = res_deseq_pmf_coch_chiro[which(res_deseq_pmf_coch_chiro$padj < alpha), ]
sigtab_pmf_coch_chiro = cbind(as(sigtab_pmf_coch_chiro, "data.frame"), as(tax_table(chiro_pmf_coch)[rownames(sigtab_pmf_coch_chiro), ], "matrix"))

x_pmf_coch_chiro = tapply(sigtab_pmf_coch_chiro$log2FoldChange, sigtab_pmf_coch_chiro$Phylum, function(x) max(x))
x_pmf_coch_chiro = sort(x_pmf_coch_chiro, TRUE)
sigtab_pmf_coch_chiro$Phylum = factor(as.character(sigtab_pmf_coch_chiro$Phylum), levels=names(x_pmf_coch_chiro))
# Genus
x_pmf_coch_chiro = tapply(sigtab_pmf_coch_chiro$log2FoldChange, sigtab_pmf_coch_chiro$Genus, function(x) max(x))
x_pmf_coch_chiro = sort(x_pmf_coch_chiro, TRUE)
sigtab_pmf_coch_chiro$Genus = factor(as.character(sigtab_pmf_coch_chiro$Genus), levels=sort(names(x_pmf_coch_chiro)))
#31 observations

diff_abund_chiro_pmf_coch_plot<-ggplot(sigtab_pmf_coch_chiro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_chiro_pmf_coch_plot


#### Adult Diptera ####

dip_ps<-subset_samples(sample_ps, Family=="Diptera")

deseq_exposed_dip <- phyloseq_to_deseq2(dip_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_dip$Exposure <-relevel(deseq_exposed_dip$Exposure, "Unexposed")

deseq_exposed_dip <- DESeq(deseq_exposed_dip, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_dip <- results(deseq_exposed_dip, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_dip = res_deseq_exposed_dip[which(res_deseq_exposed_dip$padj < alpha), ]
sigtab_exposed_dip = cbind(as(sigtab_exposed_dip, "data.frame"), as(tax_table(dip_ps)[rownames(sigtab_exposed_dip), ], "matrix"))

x_exposed_dip = tapply(sigtab_exposed_dip$log2FoldChange, sigtab_exposed_dip$Phylum, function(x) max(x))
x_exposed_dip = sort(x_exposed_dip, TRUE)
sigtab_exposed_dip$Phylum = factor(as.character(sigtab_exposed_dip$Phylum), levels=names(x_exposed_dip))
# Genus
x_exposed_dip = tapply(sigtab_exposed_dip$log2FoldChange, sigtab_exposed_dip$Genus, function(x) max(x))
x_exposed_dip = sort(x_exposed_dip, TRUE)
sigtab_exposed_dip$Genus = factor(as.character(sigtab_exposed_dip$Genus), levels=sort(names(x_exposed_dip)))
#8 differentially abundant taxa

diff_abund_dip_plot<-ggplot(sigtab_exposed_dip, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")
diff_abund_dip_plot

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites chironomidae adults only.png", height=15, width=22)

#COCH - CUSHBR

dip_cush_coch<-subset_samples(dip_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_dip <- phyloseq_to_deseq2(dip_cush_coch, ~ Site)

deseq_cush_coch_dip <- DESeq(deseq_cush_coch_dip, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_cush_coch_dip <- results(deseq_cush_coch_dip, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_dip = res_deseq_cush_coch_dip[which(res_deseq_cush_coch_dip$padj < alpha), ]
sigtab_cush_coch_dip = cbind(as(sigtab_cush_coch_dip, "data.frame"), as(tax_table(dip_cush_coch)[rownames(sigtab_cush_coch_dip), ], "matrix"))

x_cush_coch_dip = tapply(sigtab_cush_coch_dip$log2FoldChange, sigtab_cush_coch_dip$Phylum, function(x) max(x))
x_cush_coch_dip = sort(x_cush_coch_dip, TRUE)
sigtab_cush_coch_dip$Phylum = factor(as.character(sigtab_cush_coch_dip$Phylum), levels=names(x_cush_coch_dip))
# Genus
x_cush_coch_dip = tapply(sigtab_cush_coch_dip$log2FoldChange, sigtab_cush_coch_dip$Genus, function(x) max(x))
x_cush_coch_dip = sort(x_cush_coch_dip, TRUE)
sigtab_cush_coch_dip$Genus = factor(as.character(sigtab_cush_coch_dip$Genus), levels=sort(names(x_cush_coch_dip)))
#71 observations

diff_abund_dip_cush_coch_plot<-ggplot(sigtab_cush_coch_dip, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_dip_cush_coch_plot


#COCH - PMF

dip_pmf_coch<-subset_samples(dip_ps, Site=="Cochrane" | Site=="Policeman Flats")

deseq_pmf_coch_dip <- phyloseq_to_deseq2(dip_pmf_coch, ~ Site)

deseq_pmf_coch_dip <- DESeq(deseq_pmf_coch_dip, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_pmf_coch_dip <- results(deseq_pmf_coch_dip, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_dip = res_deseq_pmf_coch_dip[which(res_deseq_pmf_coch_dip$padj < alpha), ]
sigtab_pmf_coch_dip = cbind(as(sigtab_pmf_coch_dip, "data.frame"), as(tax_table(dip_pmf_coch)[rownames(sigtab_pmf_coch_dip), ], "matrix"))

x_pmf_coch_dip = tapply(sigtab_pmf_coch_dip$log2FoldChange, sigtab_pmf_coch_dip$Phylum, function(x) max(x))
x_pmf_coch_dip = sort(x_pmf_coch_dip, TRUE)
sigtab_pmf_coch_dip$Phylum = factor(as.character(sigtab_pmf_coch_dip$Phylum), levels=names(x_pmf_coch_dip))
# Genus
x_pmf_coch_dip = tapply(sigtab_pmf_coch_dip$log2FoldChange, sigtab_pmf_coch_dip$Genus, function(x) max(x))
x_pmf_coch_dip = sort(x_pmf_coch_dip, TRUE)
sigtab_pmf_coch_dip$Genus = factor(as.character(sigtab_pmf_coch_dip$Genus), levels=sort(names(x_pmf_coch_dip)))
#75 observations

diff_abund_dip_pmf_coch_plot<-ggplot(sigtab_pmf_coch_dip, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_dip_pmf_coch_plot


#### Larval Perlidae ####

perl_ps<-subset_samples(sample_ps, Family=="Perlidae")

deseq_exposed_perl <- phyloseq_to_deseq2(perl_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_perl$Exposure <-relevel(deseq_exposed_perl$Exposure, "Unexposed")

deseq_exposed_perl <- DESeq(deseq_exposed_perl, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_perl <- results(deseq_exposed_perl, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_perl = res_deseq_exposed_perl[which(res_deseq_exposed_perl$padj < alpha), ]
sigtab_exposed_perl = cbind(as(sigtab_exposed_perl, "data.frame"), as(tax_table(perl_ps)[rownames(sigtab_exposed_perl), ], "matrix"))

x_exposed_perl = tapply(sigtab_exposed_perl$log2FoldChange, sigtab_exposed_perl$Phylum, function(x) max(x))
x_exposed_perl = sort(x_exposed_perl, TRUE)
sigtab_exposed_perl$Phylum = factor(as.character(sigtab_exposed_perl$Phylum), levels=names(x_exposed_perl))
# Genus
x_exposed_perl = tapply(sigtab_exposed_perl$log2FoldChange, sigtab_exposed_perl$Genus, function(x) max(x))
x_exposed_perl = sort(x_exposed_perl, TRUE)
sigtab_exposed_perl$Genus = factor(as.character(sigtab_exposed_perl$Genus), levels=sort(names(x_exposed_perl)))
#17 differentially abundant taxa

diff_abund_perl_plot<-ggplot(sigtab_exposed_perl, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/Bow River exposed vs unexposed sites larval perlidae only.png", height=15, width=22)


#COCH - CUSHBR

perl_cush_coch<-subset_samples(perl_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_perl <- phyloseq_to_deseq2(perl_cush_coch, ~ Site)

deseq_cush_coch_perl <- DESeq(deseq_cush_coch_perl, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_cush_coch_perl <- results(deseq_cush_coch_perl, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_perl = res_deseq_cush_coch_perl[which(res_deseq_cush_coch_perl$padj < alpha), ]
sigtab_cush_coch_perl = cbind(as(sigtab_cush_coch_perl, "data.frame"), as(tax_table(perl_cush_coch)[rownames(sigtab_cush_coch_perl), ], "matrix"))

x_cush_coch_perl = tapply(sigtab_cush_coch_perl$log2FoldChange, sigtab_cush_coch_perl$Phylum, function(x) max(x))
x_cush_coch_perl = sort(x_cush_coch_perl, TRUE)
sigtab_cush_coch_perl$Phylum = factor(as.character(sigtab_cush_coch_perl$Phylum), levels=names(x_cush_coch_perl))
# Genus
x_cush_coch_perl = tapply(sigtab_cush_coch_perl$log2FoldChange, sigtab_cush_coch_perl$Genus, function(x) max(x))
x_cush_coch_perl = sort(x_cush_coch_perl, TRUE)
sigtab_cush_coch_perl$Genus = factor(as.character(sigtab_cush_coch_perl$Genus), levels=sort(names(x_cush_coch_perl)))
#31 observations

diff_abund_perl_cush_coch_plot<-ggplot(sigtab_cush_coch_perl, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_perl_cush_coch_plot

#COCH - PMF

perl_pmf_coch<-subset_samples(perl_ps, Site=="Cochrane" | Site=="Policeman Flats")

deseq_pmf_coch_perl <- phyloseq_to_deseq2(perl_pmf_coch, ~ Site)

deseq_pmf_coch_perl <- DESeq(deseq_pmf_coch_perl, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_pmf_coch_perl <- results(deseq_pmf_coch_perl, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_perl = res_deseq_pmf_coch_perl[which(res_deseq_pmf_coch_perl$padj < alpha), ]
sigtab_pmf_coch_perl = cbind(as(sigtab_pmf_coch_perl, "data.frame"), as(tax_table(perl_pmf_coch)[rownames(sigtab_pmf_coch_perl), ], "matrix"))

x_pmf_coch_perl = tapply(sigtab_pmf_coch_perl$log2FoldChange, sigtab_pmf_coch_perl$Phylum, function(x) max(x))
x_pmf_coch_perl = sort(x_pmf_coch_perl, TRUE)
sigtab_pmf_coch_perl$Phylum = factor(as.character(sigtab_pmf_coch_perl$Phylum), levels=names(x_pmf_coch_perl))
# Genus
x_pmf_coch_perl = tapply(sigtab_pmf_coch_perl$log2FoldChange, sigtab_pmf_coch_perl$Genus, function(x) max(x))
x_pmf_coch_perl = sort(x_pmf_coch_perl, TRUE)
sigtab_pmf_coch_perl$Genus = factor(as.character(sigtab_pmf_coch_perl$Genus), levels=sort(names(x_pmf_coch_perl)))
#12 observations

diff_abund_perl_pmf_coch_plot<-ggplot(sigtab_pmf_coch_perl, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette = "Set3")

diff_abund_perl_pmf_coch_plot

#### Araneidae ####

aran_ps<-subset_samples(sample_ps, Family=="Araneidae")

deseq_exposed_aran <- phyloseq_to_deseq2(aran_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_aran$Exposure <-relevel(deseq_exposed_aran$Exposure, "Unexposed")

deseq_exposed_aran <- DESeq(deseq_exposed_aran, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_aran <- results(deseq_exposed_aran, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_aran = res_deseq_exposed_aran[which(res_deseq_exposed_aran$padj < alpha), ]
sigtab_exposed_aran = cbind(as(sigtab_exposed_aran, "data.frame"), as(tax_table(aran_ps)[rownames(sigtab_exposed_aran), ], "matrix"))
#no differentially abundant taxa!

#COCH - SUN

aran_sun_coch<-subset_samples(aran_ps, Site=="Cochrane" | Site=="Sunalta")

deseq_sun_coch_aran <- phyloseq_to_deseq2(aran_sun_coch, ~ Site)

deseq_sun_coch_aran <- DESeq(deseq_sun_coch_aran, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_sun_coch_aran <- results(deseq_sun_coch_aran, cooksCutoff = FALSE)
alpha = 0.001
sigtab_sun_coch_aran = res_deseq_sun_coch_aran[which(res_deseq_sun_coch_aran$padj < alpha), ]
sigtab_sun_coch_aran = cbind(as(sigtab_sun_coch_aran, "data.frame"), as(tax_table(aran_sun_coch)[rownames(sigtab_sun_coch_aran), ], "matrix"))
#No diff abund taxa

#COCH - CUSHBR

aran_cush_coch<-subset_samples(aran_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_aran <- phyloseq_to_deseq2(aran_cush_coch, ~ Site)

deseq_cush_coch_aran <- DESeq(deseq_cush_coch_aran, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_cush_coch_aran <- results(deseq_cush_coch_aran, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_aran = res_deseq_cush_coch_aran[which(res_deseq_cush_coch_aran$padj < alpha), ]
sigtab_cush_coch_aran = cbind(as(sigtab_cush_coch_aran, "data.frame"), as(tax_table(aran_cush_coch)[rownames(sigtab_cush_coch_aran), ], "matrix"))
#1 obs

#COCH - GRVBR

aran_grvbr_coch<-subset_samples(aran_ps, Site=="Cochrane" | Site=="Graves Bridge")

deseq_grvbr_coch_aran <- phyloseq_to_deseq2(aran_grvbr_coch, ~ Site)

deseq_grvbr_coch_aran <- DESeq(deseq_grvbr_coch_aran, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_grvbr_coch_aran <- results(deseq_grvbr_coch_aran, cooksCutoff = FALSE)
alpha = 0.001
sigtab_grvbr_coch_aran = res_deseq_grvbr_coch_aran[which(res_deseq_grvbr_coch_aran$padj < alpha), ]
sigtab_grvbr_coch_aran = cbind(as(sigtab_grvbr_coch_aran, "data.frame"), as(tax_table(aran_grvbr_coch)[rownames(sigtab_grvbr_coch_aran), ], "matrix"))
#none

#COCH - PMF

aran_pmf_coch<-subset_samples(aran_ps, Site=="Cochrane" | Site=="Policeman Flats")

deseq_pmf_coch_aran <- phyloseq_to_deseq2(aran_pmf_coch, ~ Site)

deseq_pmf_coch_aran <- DESeq(deseq_pmf_coch_aran, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_pmf_coch_aran <- results(deseq_pmf_coch_aran, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_aran = res_deseq_pmf_coch_aran[which(res_deseq_pmf_coch_aran$padj < alpha), ]
sigtab_pmf_coch_aran = cbind(as(sigtab_pmf_coch_aran, "data.frame"), as(tax_table(aran_pmf_coch)[rownames(sigtab_pmf_coch_aran), ], "matrix"))
#6 obs



#### Tetragnathidae ####

tetra_ps<-subset_samples(sample_ps, Family=="Tetragnathidae")

deseq_exposed_tetra <- phyloseq_to_deseq2(tetra_ps, ~ Exposure)
#Re level the reference variable so that the comparison is exposed vs unexposed
deseq_exposed_tetra$Exposure <-relevel(deseq_exposed_tetra$Exposure, "Unexposed")

deseq_exposed_tetra <- DESeq(deseq_exposed_tetra, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_exposed_tetra <- results(deseq_exposed_tetra, cooksCutoff = FALSE)
alpha = 0.001
sigtab_exposed_tetra = res_deseq_exposed_tetra[which(res_deseq_exposed_tetra$padj < alpha), ]
sigtab_exposed_tetra = cbind(as(sigtab_exposed_tetra, "data.frame"), as(tax_table(tetra_ps)[rownames(sigtab_exposed_tetra), ], "matrix"))

x_exposed_tetra = tapply(sigtab_exposed_tetra$log2FoldChange, sigtab_exposed_tetra$Phylum, function(x) max(x))
x_exposed_tetra = sort(x_exposed_tetra, TRUE)
sigtab_exposed_tetra$Phylum = factor(as.character(sigtab_exposed_tetra$Phylum), levels=names(x_exposed_tetra))
# Genus
x_exposed_tetra = tapply(sigtab_exposed_tetra$log2FoldChange, sigtab_exposed_tetra$Genus, function(x) max(x))
x_exposed_tetra = sort(x_exposed_tetra, TRUE)
sigtab_exposed_tetra$Genus = factor(as.character(sigtab_exposed_tetra$Genus), levels=sort(names(x_exposed_tetra)))

diff_abund_tetra_plot<-ggplot(sigtab_exposed_tetra, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")

diff_abund_tetra_plot


#COCH - SUN

tetra_sun_coch<-subset_samples(tetra_ps, Site=="Cochrane" | Site=="Sunalta")

deseq_sun_coch_tetra <- phyloseq_to_deseq2(tetra_sun_coch, ~ Site)

deseq_sun_coch_tetra <- DESeq(deseq_sun_coch_tetra, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_sun_coch_tetra <- results(deseq_sun_coch_tetra, cooksCutoff = FALSE)
alpha = 0.001
sigtab_sun_coch_tetra = res_deseq_sun_coch_tetra[which(res_deseq_sun_coch_tetra$padj < alpha), ]
sigtab_sun_coch_tetra = cbind(as(sigtab_sun_coch_tetra, "data.frame"), as(tax_table(tetra_sun_coch)[rownames(sigtab_sun_coch_tetra), ], "matrix"))
#1

x_sun_coch_tetra = tapply(sigtab_sun_coch_tetra$log2FoldChange, sigtab_sun_coch_tetra$Phylum, function(x) max(x))
x_sun_coch_tetra = sort(x_sun_coch_tetra, TRUE)
sigtab_sun_coch_tetra$Phylum = factor(as.character(sigtab_sun_coch_tetra$Phylum), levels=names(x_sun_coch_tetra))
# Genus
x_sun_coch_tetra = tapply(sigtab_sun_coch_tetra$log2FoldChange, sigtab_sun_coch_tetra$Genus, function(x) max(x))
x_sun_coch_tetra = sort(x_sun_coch_tetra, TRUE)
sigtab_sun_coch_tetra$Genus = factor(as.character(sigtab_sun_coch_tetra$Genus), levels=sort(names(x_sun_coch_tetra)))

ggplot(sigtab_sun_coch_tetra, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")

#COCH - CUSHBR

tetra_cush_coch<-subset_samples(tetra_ps, Site=="Cochrane" | Site=="Cushing Bridge")

deseq_cush_coch_tetra <- phyloseq_to_deseq2(tetra_cush_coch, ~ Site)

deseq_cush_coch_tetra <- DESeq(deseq_cush_coch_tetra, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_cush_coch_tetra <- results(deseq_cush_coch_tetra, cooksCutoff = FALSE)
alpha = 0.001
sigtab_cush_coch_tetra = res_deseq_cush_coch_tetra[which(res_deseq_cush_coch_tetra$padj < alpha), ]
sigtab_cush_coch_tetra = cbind(as(sigtab_cush_coch_tetra, "data.frame"), as(tax_table(tetra_cush_coch)[rownames(sigtab_cush_coch_tetra), ], "matrix"))
#none

#COCH - GRVBR

tetra_grvbr_coch<-subset_samples(tetra_ps, Site=="Cochrane" | Site=="Graves Bridge")

deseq_grvbr_coch_tetra <- phyloseq_to_deseq2(tetra_grvbr_coch, ~ Site)

deseq_grvbr_coch_tetra <- DESeq(deseq_grvbr_coch_tetra, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_grvbr_coch_tetra <- results(deseq_grvbr_coch_tetra, cooksCutoff = FALSE)
alpha = 0.001
sigtab_grvbr_coch_tetra = res_deseq_grvbr_coch_tetra[which(res_deseq_grvbr_coch_tetra$padj < alpha), ]
sigtab_grvbr_coch_tetra = cbind(as(sigtab_grvbr_coch_tetra, "data.frame"), as(tax_table(tetra_grvbr_coch)[rownames(sigtab_grvbr_coch_tetra), ], "matrix"))
#none

#COCH - PMF

tetra_pmf_coch<-subset_samples(tetra_ps, Site=="Cochrane" | Site=="Policeman Flats")

deseq_pmf_coch_tetra <- phyloseq_to_deseq2(tetra_pmf_coch, ~ Site)

deseq_pmf_coch_tetra <- DESeq(deseq_pmf_coch_tetra, test = "Wald", fitType = "parametric", sfType = "poscounts")


res_deseq_pmf_coch_tetra <- results(deseq_pmf_coch_tetra, cooksCutoff = FALSE)
alpha = 0.001
sigtab_pmf_coch_tetra = res_deseq_pmf_coch_tetra[which(res_deseq_pmf_coch_tetra$padj < alpha), ]
sigtab_pmf_coch_tetra = cbind(as(sigtab_pmf_coch_tetra, "data.frame"), as(tax_table(tetra_pmf_coch)[rownames(sigtab_pmf_coch_tetra), ], "matrix"))
#none

x_pmf_coch_tetra = tapply(sigtab_pmf_coch_tetra$log2FoldChange, sigtab_pmf_coch_tetra$Phylum, function(x) max(x))
x_pmf_coch_tetra = sort(x_pmf_coch_tetra, TRUE)
sigtab_pmf_coch_tetra$Phylum = factor(as.character(sigtab_pmf_coch_tetra$Phylum), levels=names(x_pmf_coch_tetra))
# Genus
x_pmf_coch_tetra = tapply(sigtab_pmf_coch_tetra$log2FoldChange, sigtab_pmf_coch_tetra$Genus, function(x) max(x))
x_pmf_coch_tetra = sort(x_pmf_coch_tetra, TRUE)
sigtab_pmf_coch_tetra$Genus = factor(as.character(sigtab_pmf_coch_tetra$Genus), levels=sort(names(x_pmf_coch_tetra)))

ggplot(sigtab_pmf_coch_tetra, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_brewer(palette="Set3")



#### Arranging invert plots all together ####

#Hydropsychidae

sigtab_exposed_hydro$Phylum<-factor(sigtab_exposed_hydro$Phylum, levels=c("Acidobacteriota", "Actinobacteriota", "Bacteroidota", "Cyanobacteria", "Firmicutes", "Myxococcota", "Proteobacteria", "Rs-K70 termite group", "Synergistota"))

diff_abund_hydro_plot<-ggplot(sigtab_exposed_hydro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=10, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("#f22020", "#991919", "#e68f66", "#f47a22", "#fcff5d", "#ffc413", "#228c68", "#235b54", "#3998f5", "#2f2aa0"))
diff_abund_hydro_plot

#Acidobacteriota, Actinobacteriota, Bacteroidota, Cyanobacteria, Firmicutes, Myxococcota, Proteobacteria, Rs-K70 termite group, Synergistota

#Heptageniidae

sigtab_exposed_hep$Phylum<-factor(sigtab_exposed_hep$Phylum, levels=c("Actinobacteriota", "Bacteroidota", "Cyanobacteria", "Firmicutes", "Proteobacteria"))

diff_abund_hep_plot<-ggplot(sigtab_exposed_hep, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=16, face="italic")) + theme(axis.text=element_text(size=16, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=10, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("#991919", "#e68f66", "#f47a22", "#fcff5d", "#228c68"))
diff_abund_hep_plot

#Actinobacteriota, Bacteroidota, Cyanobacteria, Firmicutes, Proteobacteria

#Chironomidae

sigtab_exposed_chiro$Phylum<-factor(sigtab_exposed_chiro$Phylum, levels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Proteobacteria"))

diff_abund_chiro_plot<-ggplot(sigtab_exposed_chiro, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=10, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("#e68f66", "#f47a22", "#fcff5d", "#228c68"))
diff_abund_chiro_plot

#Bacteroidota, Cyanobacteria, Firmicutes, Proteobacteria

#Perlidae

sigtab_exposed_perl$Phylum<-factor(sigtab_exposed_perl$Phylum, levels=c("Bacteroidota", "Cyanobacteria", "Proteobacteria", "Verrucomicrobiota"))

diff_abund_perl_plot<-ggplot(sigtab_exposed_perl, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=10, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("#e68f66", "#f47a22", "#228c68", "#2f2aa0"))
diff_abund_perl_plot

#Bacteroidota, Cyanobacteria, Proteobacteria, Verrucomicrobiota

#Trichoptera

sigtab_exposed_trichop$Phylum<-factor(sigtab_exposed_trichop$Phylum, levels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Proteobacteria"))

diff_abund_trichop_plot<-ggplot(sigtab_exposed_trichop, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=18, face="italic")) + theme(axis.text=element_text(size=18, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=10, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("#e68f66", "#f47a22", "#fcff5d", "#228c68"))
diff_abund_trichop_plot

#Bacteroidota, Cyanobacteria, Firmicutes, Proteobacteria

#Ephemeroptera

sigtab_exposed_ephem$Phylum<-factor(sigtab_exposed_ephem$Phylum, levels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Proteobacteria"))

diff_abund_ephem_plot<-ggplot(sigtab_exposed_ephem, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=10, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("#e68f66", "#f47a22", "#fcff5d", "#228c68"))
diff_abund_ephem_plot

#Bacteroidota, Cyanobacteria, Firmicutes, Proteobacteria

#Diptera

sigtab_exposed_dip$Phylum<-factor(sigtab_exposed_dip$Phylum, levels=c("Cyanobacteria", "Firmicutes", "Proteobacteria"))

diff_abund_dip_plot<-ggplot(sigtab_exposed_dip, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=10, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values=c("#f47a22", "#fcff5d", "#228c68"))
diff_abund_dip_plot

#Cyanobacteria, Firmicutes, Proteobacteria

#Tetragnathidae

diff_abund_tetra_plot<-ggplot(sigtab_exposed_tetra, aes(x=Genus, y=log2FoldChange, color=Phylum))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=24, face="italic")) + theme(axis.text=element_text(size=24, color="black"), axis.title=element_text(size=28)) +
          theme(legend.text=element_text(size=24, color="black")) + 
          theme(legend.title = element_text(size=24, color="black"), legend.position="bottom")+
  guides(nrow=8)+
  rremove("grid")+
 labs(y = expression(Log[2]~ "Ratio of Absolute Abundance"))+
  scale_color_manual(values="#228c68")
diff_abund_tetra_plot


diff_abund_hydro_plot_1<- diff_abund_hydro_plot + rremove("axis.title") + rremove("legend")
diff_abund_hydro_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_hydro_exposed.png", height=12, width=30, bg="white")
diff_abund_hep_plot_1<- diff_abund_hep_plot + rremove("axis.title")+ rremove("legend")
diff_abund_hep_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_hep_exposed.png", height=16, width=18, bg="white")
diff_abund_chiro_plot_1<- diff_abund_chiro_plot + rremove("axis.title")+ rremove("legend")
diff_abund_chiro_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_chiro_exposed.png", height=12, width=10, bg="white")
diff_abund_perl_plot_1<- diff_abund_perl_plot + rremove("axis.title")+ rremove("legend")
diff_abund_perl_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_perl_exposed.png", height=10, width=8, bg="white")
diff_abund_trichop_plot_1<- diff_abund_trichop_plot + rremove("axis.title")+ rremove("legend")
diff_abund_trichop_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_trichop_exposed.png", height=14, width=26, bg="white")
diff_abund_ephem_plot_1<- diff_abund_ephem_plot + rremove("axis.title")+ rremove("legend")
diff_abund_ephem_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_ephem_exposed.png", height=6, width=8, bg="white")
diff_abund_dip_plot_1<- diff_abund_dip_plot + rremove("axis.title")+ rremove("legend")
diff_abund_dip_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_dip_exposed.png", height=10, width=16, bg="white")
diff_abund_tetra_plot_1<- diff_abund_tetra_plot + rremove("axis.title")+ rremove("legend")
diff_abund_tetra_plot_1
#ggsave("microbiome_analysis/Final analysis/Differential Abundance Results/diff_abund_tetra_exposed.png", height=6, width=8, bg="white")

ggarrange(diff_abund_hydro_plot_1, diff_abund_hep_plot_1, diff_abund_chiro_plot_1, diff_abund_perl_plot_1, diff_abund_trichop_plot_1, diff_abund_ephem_plot_1, diff_abund_dip_plot_1, diff_abund_tetra_plot_1, nrow=3, ncol=3, common.legend = T, legend="bottom")

#ggsave(filename="microbiome_analysis/Final analysis/Differential Abundance Results/diff abund across taxa Bow River faceted.png", height=20, width=26, bg="white")

```

## Differential abundance in ACWA streams, separated by invert taxa {.tabset}

### REF vs EXP5 
```{r}
#### DESeq2 ####
diff_abun_BRR2_PCR1 = subset_samples(sample_ps, Stream_Type=="ACWA Streams")
diff_abun_BRR2_PCR1 = subset_samples(diff_abun_BRR2_PCR1, Site != "PCR3")

deseq_BRR2_PCR1 <- phyloseq_to_deseq2(diff_abun_BRR2_PCR1, ~ Site)
deseq_BRR2_PCR1 <- DESeq(deseq_BRR2_PCR1, test = "Wald", fitType = "parametric", sfType = "poscounts")  

#Getting results of diff abund. estimates
res_deseq_BRR2_PCR1 <- results(deseq_BRR2_PCR1, cooksCutoff = FALSE)
res_deseq_BRR2_PCR1
alpha = 0.001
sigtab_BRR2_PCR1 = res_deseq_BRR2_PCR1[which(res_deseq_BRR2_PCR1$padj < alpha), ]
sigtab_BRR2_PCR1 = cbind(as(sigtab_BRR2_PCR1, "data.frame"), as(tax_table(sample_ps)[rownames(sigtab_BRR2_PCR1), ], "matrix"))

#write.csv(as.data.frame(sigtab_BRR2_PCR1), filename="Microbiome_ED/Final analysis/Differential Abundance Results/deseq_BRR2_PCR1.csv")

#Plotting the log2fold change in bacteria: PCR1 vs BRR2

x_BRR2_PCR1 = tapply(sigtab_BRR2_PCR1$log2FoldChange, sigtab_BRR2_PCR1$Phylum, function(x) max(x))
x_BRR2_PCR1 = sort(x_BRR2_PCR1, TRUE)
sigtab_BRR2_PCR1$Phylum = factor(as.character(sigtab_BRR2_PCR1$Phylum), levels=names(x_BRR2_PCR1))
# Genus order
x_BRR2_PCR1 = tapply(sigtab_BRR2_PCR1$log2FoldChange, sigtab_BRR2_PCR1$Genus, function(x) max(x))
x_BRR2_PCR1 = sort(x_BRR2_PCR1, TRUE)
sigtab_BRR2_PCR1$Genus = factor(as.character(sigtab_BRR2_PCR1$Genus), levels=sort(names(x_BRR2_PCR1)))

sigtab_BRR2_PCR1$Phylum<-factor(sigtab_BRR2_PCR1$Phylum, levels=c("Proteobacteria", "Bacteroidota", "Firmicutes", "Cyanobacteria", "Myxococcota"))

sigtab_BRR2_PCR1$Genus<-factor(sigtab_BRR2_PCR1$Genus, labels=c("Alistipes", "Rhizobium", "Flavobacterium", "Ideonella", "Limnohabitans", "Nevskia", "Novosphingobium", "Pajaroellobacter", "Rhodoferax", "Romboutsia", "Sediminibacterium", "Vibrionimonas"))

PCR1_BRR2<-ggplot(sigtab_BRR2_PCR1, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=30, face="italic")) + theme(axis.text=element_text(size=30, color="black"), axis.title.x=element_text(size=30, vjust=10)) +
          theme(legend.text=element_text(size=30, color="black")) + 
          theme(legend.title = element_text(size=30, color="black"), legend.position = "right")+
  ggtitle("Differential Abundance of PCR1/BRR2")+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple"))+
  rremove("grid")

PCR1_BRR2

#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/deseq_PCR1_compared_to_BRR2.png", height=6.5, width=7.5)


## Hydropsychidae ##
diff_abun_hydro_REF_EXP5 = subset_samples(diff_abun_BRR2_PCR1, Family == "Hydropsychidae")

deseq_hydro_REF_EXP5 <- phyloseq_to_deseq2(diff_abun_hydro_REF_EXP5, ~ Site)
deseq_hydro_REF_EXP5 <- DESeq(deseq_hydro_REF_EXP5, test = "Wald", fitType = "parametric", sfType = "poscounts")  

#Getting results of diff abund. estimates
res_deseq_hydro_REF_EXP5 <- results(deseq_hydro_REF_EXP5, cooksCutoff = FALSE)
res_deseq_hydro_REF_EXP5
alpha = 0.001
sigtab_hydro_REF_EXP5 = res_deseq_hydro_REF_EXP5[which(res_deseq_hydro_REF_EXP5$padj < alpha), ]
sigtab_hydro_REF_EXP5 = cbind(as(sigtab_hydro_REF_EXP5, "data.frame"), as(tax_table(diff_abun_hydro_REF_EXP5)[rownames(sigtab_hydro_REF_EXP5), ], "matrix"))


x_hydro_REF_EXP5 = tapply(sigtab_hydro_REF_EXP5$log2FoldChange, sigtab_hydro_REF_EXP5$Phylum, function(x) max(x))
x_hydro_REF_EXP5 = sort(x_hydro_REF_EXP5, TRUE)
sigtab_hydro_REF_EXP5$Phylum = factor(as.character(sigtab_hydro_REF_EXP5$Phylum), levels=names(x_hydro_REF_EXP5))
# Genus order
x_hydro_REF_EXP5 = tapply(sigtab_hydro_REF_EXP5$log2FoldChange, sigtab_hydro_REF_EXP5$Genus, function(x) max(x))
x_hydro_REF_EXP5 = sort(x_hydro_REF_EXP5, TRUE)
sigtab_hydro_REF_EXP5$Genus = factor(as.character(sigtab_hydro_REF_EXP5$Genus), levels=sort(names(x_hydro_REF_EXP5)))

ggplot(sigtab_hydro_REF_EXP5, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=30, face="italic")) + theme(axis.text=element_text(size=30, color="black"), axis.title.x=element_text(size=30, vjust=10)) +
          theme(legend.text=element_text(size=30, color="black")) + 
          theme(legend.title = element_text(size=30, color="black"), legend.position = "right")+
  ggtitle("Differential Abundance of PCR1/BRR2")+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple"))+
  rremove("grid")




#### ALDEx2 ####

diff_abun_BRR2_PCR1 = subset_samples(sample_ps, Stream_Type=="ACWA Streams")
diff_abun_BRR2_PCR1 = subset_samples(diff_abun_BRR2_PCR1, Site != "PCR3")

tax_names<-rownames_to_column(taxonomy, var="Sequences")


aldex2_BRR2_PCR1 <- ALDEx2::aldex(data.frame(phyloseq::otu_table(diff_abun_BRR2_PCR1)), phyloseq::sample_data(diff_abun_BRR2_PCR1)$Site, test="t", effect = TRUE, denom="iqlr")

sig_aldex2_BRR2_PCR1 <- aldex2_BRR2_PCR1 %>%
  rownames_to_column(var = "Sequences") %>%
  filter(wi.eBH < 0.01) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(Sequences, diff.btw, diff.win, effect, wi.ep, wi.eBH)
sig_aldex2_BRR2_PCR1 <- dplyr::inner_join(sig_aldex2_BRR2_PCR1, tax_names, by="Sequences")


aldex_BRR2_PCR1 = tapply(sig_aldex2_BRR2_PCR1$effect, sig_aldex2_BRR2_PCR1$Phylum, function(x) max(x))
aldex_BRR2_PCR1 = sort(aldex_BRR2_PCR1, TRUE)
sig_aldex2_BRR2_PCR1$Phylum = factor(as.character(sig_aldex2_BRR2_PCR1$Phylum), levels=names(aldex_BRR2_PCR1))
# Genus order
aldex_BRR2_PCR1 = tapply(sig_aldex2_BRR2_PCR1$effect, sig_aldex2_BRR2_PCR1$Genus, function(x) max(x))
aldex_BRR2_PCR1 = sort(aldex_BRR2_PCR1, TRUE)
sig_aldex2_BRR2_PCR1$Genus = factor(as.character(sig_aldex2_BRR2_PCR1$Genus), levels=sort(names(aldex_BRR2_PCR1)))


ggplot(sig_aldex2_BRR2_PCR1, aes(x=Genus, y=effect, color=Phylum))+
  geom_point(size=4) + 
  theme_bw()+
  theme(axis.text.x= element_text(angle = 45, hjust = 1, vjust=1, size=14, color="black"), axis.text.y = element_text(size=14, color="black"))+
  #theme(legend.text=element_text(size=6, color="black")) + 
  #theme(legend.key.size = unit(0.5, "cm"), legend.title = element_text(size=8, color="black"),  legend.position="right")+
  guides(color=guide_legend(nrow=30, byrow=TRUE, ncol=1))+
  rremove("grid")+
  labs(y = expression(Log[2]~Difference))+
  xlab("Metabolic Pathways")

#Finds different taxa that are differentially abundant

# Hydropsychidae #
diff_abun_hydro_REF_EXP5 = subset_samples(diff_abun_BRR2_PCR1, Family == "Hydropsychidae")
```

### REF vs EXP15
```{r}
diff_abun_BRR2_PCR3 = subset_samples(sample_ps, Stream_Type=="ACWA Streams")
diff_abun_BRR2_PCR3 = subset_samples(diff_abun_BRR2_PCR3, Site != "PCR1")

deseq_BRR2_PCR3 <- phyloseq_to_deseq2(diff_abun_BRR2_PCR3, ~ Site)
deseq_BRR2_PCR3 <- DESeq(deseq_BRR2_PCR3, test = "Wald", fitType = "parametric", sfType = "poscounts")  

#Getting results of diff abund. estimates
res_deseq_BRR2_PCR3 <- results(deseq_BRR2_PCR3, cooksCutoff = FALSE)
head(res_deseq_BRR2_PCR3)
alpha = 0.001
sigtab_BRR2_PCR3 = res_deseq_BRR2_PCR3[which(res_deseq_BRR2_PCR3$padj < alpha), ]
sigtab_BRR2_PCR3 = cbind(as(sigtab_BRR2_PCR3, "data.frame"), as(tax_table(sample_ps)[rownames(sigtab_BRR2_PCR3), ], "matrix"))

#write.csv(as.data.frame(sigtab_BRR2_PCR3), file="Microbiome_ED/Final analysis/Differential Abundance Results/deseq_BRR2_PCR3.csv")

#Plotting the log2fold change in bacteria: PCR3 vs BRR2

x_BRR2_PCR3 = tapply(sigtab_BRR2_PCR3$log2FoldChange, sigtab_BRR2_PCR3$Phylum, function(x) max(x))
x_BRR2_PCR3 = sort(x_BRR2_PCR3, TRUE)
sigtab_BRR2_PCR3$Phylum = factor(as.character(sigtab_BRR2_PCR3$Phylum), levels=names(x_BRR2_PCR3))
# Genus order
x_BRR2_PCR3 = tapply(sigtab_BRR2_PCR3$log2FoldChange, sigtab_BRR2_PCR3$Genus, function(x) max(x))
x_BRR2_PCR3 = sort(x_BRR2_PCR3, TRUE)
sigtab_BRR2_PCR3$Genus = factor(as.character(sigtab_BRR2_PCR3$Genus), levels=sort(names(x_BRR2_PCR3)))

sigtab_BRR2_PCR3$Phylum<-factor(sigtab_BRR2_PCR3$Phylum, levels=c("Proteobacteria", "Bacteroidota", "Firmicutes"))

PCR3_BRR2<-ggplot(sigtab_BRR2_PCR3, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, face="italic")) + theme(axis.text=element_text(size=30, color="black"), axis.title=element_text(size=30)) +
          theme(legend.text=element_text(size=30, color="black")) + 
          theme(legend.title = element_text(size=30, color="black"), legend.position="right")+
  ggtitle("Differential Abundance of PCR3/BRR2")+
  scale_color_manual(values=c("red", "#234F1E", "blue"))+
  rremove("grid")
PCR3_BRR2

#ggsave(filename="Microbiome_ED/Non decontaminated analysis/deseq_PCR3_BRR2.png", height=6.5, width=7.5)

## Hydropsychidae ##
diff_abun_hydro_REF_EXP15 = subset_samples(diff_abun_BRR2_PCR3, Family == "Hydropsychidae")

deseq_hydro_REF_EXP15 <- phyloseq_to_deseq2(diff_abun_hydro_REF_EXP15, ~ Site)
deseq_hydro_REF_EXP15 <- DESeq(deseq_hydro_REF_EXP15, test = "Wald", fitType = "parametric", sfType = "poscounts")  

res_deseq_hydro_REF_EXP15 <- results(deseq_hydro_REF_EXP15, cooksCutoff = FALSE)
res_deseq_hydro_REF_EXP15
alpha = 0.001
sigtab_hydro_REF_EXP15 = res_deseq_hydro_REF_EXP15[which(res_deseq_hydro_REF_EXP15$padj < alpha), ]
sigtab_hydro_REF_EXP15 = cbind(as(sigtab_hydro_REF_EXP15, "data.frame"), as(tax_table(diff_abun_hydro_REF_EXP15)[rownames(sigtab_hydro_REF_EXP15), ], "matrix"))


x_hydro_REF_EXP15 = tapply(sigtab_hydro_REF_EXP15$log2FoldChange, sigtab_hydro_REF_EXP15$Phylum, function(x) max(x))
x_hydro_REF_EXP15 = sort(x_hydro_REF_EXP15, TRUE)
sigtab_hydro_REF_EXP15$Phylum = factor(as.character(sigtab_hydro_REF_EXP15$Phylum), levels=names(x_hydro_REF_EXP15))
# Genus order
x_hydro_REF_EXP15 = tapply(sigtab_hydro_REF_EXP15$log2FoldChange, sigtab_hydro_REF_EXP15$Genus, function(x) max(x))
x_hydro_REF_EXP15 = sort(x_hydro_REF_EXP15, TRUE)
sigtab_hydro_REF_EXP15$Genus = factor(as.character(sigtab_hydro_REF_EXP15$Genus), levels=sort(names(x_hydro_REF_EXP15)))

ggplot(sigtab_hydro_REF_EXP15, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=30, face="italic")) + theme(axis.text=element_text(size=30, color="black"), axis.title.x=element_text(size=30, vjust=10)) +
          theme(legend.text=element_text(size=30, color="black")) + 
          theme(legend.title = element_text(size=30, color="black"), legend.position = "right")+
  ggtitle("Differential Abundance of EXP15/REF")+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple"))+
  rremove("grid")
#2 diff abund bacteria

```

### EXP5 vs EXP15
```{r}
diff_abun_PCR1_PCR3 = subset_samples(sample_ps, Stream_Type=="ACWA Streams")
diff_abun_PCR1_PCR3 = subset_samples(diff_abun_PCR1_PCR3, Site != "BRR2")

deseq_PCR1_PCR3 <- phyloseq_to_deseq2(diff_abun_PCR1_PCR3, ~ Site)
deseq_PCR1_PCR3 <- DESeq(deseq_PCR1_PCR3, test = "Wald", fitType = "parametric", sfType = "poscounts")  

#Getting results of diff abund. estimates
res_deseq_PCR1_PCR3 <- results(deseq_PCR1_PCR3, cooksCutoff = FALSE)
res_deseq_PCR1_PCR3 #PCR3/PCR1
alpha = 0.001
sigtab_PCR1_PCR3 = res_deseq_PCR1_PCR3[which(res_deseq_PCR1_PCR3$padj < alpha), ]
sigtab_PCR1_PCR3 = cbind(as(sigtab_PCR1_PCR3, "data.frame"), as(tax_table(sample_ps)[rownames(sigtab_PCR1_PCR3), ], "matrix"))

#write.csv(as.data.frame(sigtab_PCR1_PCR3), file="Microbiome_ED/Non decontaminated analysis/Differential Abundance Results/deseq_PCR1_PCR3.csv")

#Plotting the log2fold change in bacteria: PCR3 vs PCR1

x_PCR1_PCR3 = tapply(sigtab_PCR1_PCR3$log2FoldChange, sigtab_PCR1_PCR3$Phylum, function(x) max(x))
x_PCR1_PCR3 = sort(x_PCR1_PCR3, TRUE)
sigtab_PCR1_PCR3$Phylum = factor(as.character(sigtab_PCR1_PCR3$Phylum), levels=names(x_PCR1_PCR3))
# Family order
x_PCR1_PCR3 = tapply(sigtab_PCR1_PCR3$log2FoldChange, sigtab_PCR1_PCR3$Genus, function(x) max(x))
x_PCR1_PCR3 = sort(x_PCR1_PCR3, TRUE)
sigtab_PCR1_PCR3$Genus = factor(as.character(sigtab_PCR1_PCR3$Genus), levels=sort(names(x_PCR1_PCR3)))

sigtab_PCR1_PCR3$Phylum<-factor(sigtab_PCR1_PCR3$Phylum, levels=c("Proteobacteria", "Cyanobacteria", "Nitrospirota"))

PCR3_PCR1<-ggplot(sigtab_PCR1_PCR3, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  scale_color_manual(values=c("red", "#fdb915", "brown"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1)) + theme(axis.text=element_text(size=26, color="black"), axis.title=element_text(size=26)) +
          theme(legend.text=element_text(size=26, color="black")) + 
          theme(legend.title = element_text(size=26, color="black"), legend.position="right")+
  ggtitle("Differential Abundance of PCR3/PCR1")+
  rremove("grid")

PCR3_PCR1

#ggsave(filename="Differential Abundance Results/deseq_PCR3_PCR1.png", height=6.5, width=7.5)

## Hydropsychidae ##
diff_abun_hydro_EXP5_EXP15 = subset_samples(diff_abun_PCR1_PCR3, Family == "Hydropsychidae")

deseq_hydro_EXP5_EXP15 <- phyloseq_to_deseq2(diff_abun_hydro_EXP5_EXP15, ~ Site)
deseq_hydro_EXP5_EXP15 <- DESeq(deseq_hydro_EXP5_EXP15, test = "Wald", fitType = "parametric", sfType = "poscounts")  

res_deseq_hydro_EXP5_EXP15 <- results(deseq_hydro_EXP5_EXP15, cooksCutoff = FALSE)
res_deseq_hydro_EXP5_EXP15
alpha = 0.001
sigtab_hydro_EXP5_EXP15 = res_deseq_hydro_EXP5_EXP15[which(res_deseq_hydro_EXP5_EXP15$padj < alpha), ]
sigtab_hydro_EXP5_EXP15 = cbind(as(sigtab_hydro_EXP5_EXP15, "data.frame"), as(tax_table(diff_abun_hydro_EXP5_EXP15)[rownames(sigtab_hydro_EXP5_EXP15), ], "matrix"))


x_hydro_EXP5_EXP15 = tapply(sigtab_hydro_EXP5_EXP15$log2FoldChange, sigtab_hydro_EXP5_EXP15$Phylum, function(x) max(x))
x_hydro_EXP5_EXP15 = sort(x_hydro_EXP5_EXP15, TRUE)
sigtab_hydro_EXP5_EXP15$Phylum = factor(as.character(sigtab_hydro_EXP5_EXP15$Phylum), levels=names(x_hydro_EXP5_EXP15))
# Genus order
x_hydro_EXP5_EXP15 = tapply(sigtab_hydro_EXP5_EXP15$log2FoldChange, sigtab_hydro_EXP5_EXP15$Genus, function(x) max(x))
x_hydro_EXP5_EXP15 = sort(x_hydro_EXP5_EXP15, TRUE)
sigtab_hydro_EXP5_EXP15$Genus = factor(as.character(sigtab_hydro_EXP5_EXP15$Genus), levels=sort(names(x_hydro_EXP5_EXP15)))

ggplot(sigtab_hydro_EXP5_EXP15, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=30, face="italic")) + theme(axis.text=element_text(size=30, color="black"), axis.title.x=element_text(size=30, vjust=10)) +
          theme(legend.text=element_text(size=30, color="black")) + 
          theme(legend.title = element_text(size=30, color="black"), legend.position = "right")+
  ggtitle("Differential Abundance of EXP15/REF")+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple"))+
  rremove("grid")
#2 diff abund bacteria

## Baetidae ##
diff_abun_baetid_EXP5_EXP15 = subset_samples(diff_abun_PCR1_PCR3, Family == "Baetidae")

deseq_baetid_EXP5_EXP15 <- phyloseq_to_deseq2(diff_abun_baetid_EXP5_EXP15, ~ Site)
deseq_baetid_EXP5_EXP15 <- DESeq(deseq_baetid_EXP5_EXP15, test = "Wald", fitType = "parametric", sfType = "poscounts")  

res_deseq_baetid_EXP5_EXP15 <- results(deseq_baetid_EXP5_EXP15, cooksCutoff = FALSE)
res_deseq_baetid_EXP5_EXP15
alpha = 0.001
sigtab_baetid_EXP5_EXP15 = res_deseq_baetid_EXP5_EXP15[which(res_deseq_baetid_EXP5_EXP15$padj < alpha), ]
sigtab_baetid_EXP5_EXP15 = cbind(as(sigtab_baetid_EXP5_EXP15, "data.frame"), as(tax_table(diff_abun_baetid_EXP5_EXP15)[rownames(sigtab_baetid_EXP5_EXP15), ], "matrix"))


x_baetid_EXP5_EXP15 = tapply(sigtab_baetid_EXP5_EXP15$log2FoldChange, sigtab_baetid_EXP5_EXP15$Phylum, function(x) max(x))
x_baetid_EXP5_EXP15 = sort(x_baetid_EXP5_EXP15, TRUE)
sigtab_baetid_EXP5_EXP15$Phylum = factor(as.character(sigtab_baetid_EXP5_EXP15$Phylum), levels=names(x_baetid_EXP5_EXP15))
# Genus order
x_baetid_EXP5_EXP15 = tapply(sigtab_baetid_EXP5_EXP15$log2FoldChange, sigtab_baetid_EXP5_EXP15$Genus, function(x) max(x))
x_baetid_EXP5_EXP15 = sort(x_baetid_EXP5_EXP15, TRUE)
sigtab_baetid_EXP5_EXP15$Genus = factor(as.character(sigtab_baetid_EXP5_EXP15$Genus), levels=sort(names(x_baetid_EXP5_EXP15)))

ggplot(sigtab_baetid_EXP5_EXP15, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=30, face="italic")) + theme(axis.text=element_text(size=30, color="black"), axis.title.x=element_text(size=30, vjust=10)) +
          theme(legend.text=element_text(size=30, color="black")) + 
          theme(legend.title = element_text(size=30, color="black"), legend.position = "right")+
  ggtitle("Differential Abundance of EXP15/REF")+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple"))+
  rremove("grid")
#4 diff abund bacteria

## Ephemeroptera ##
diff_abun_ephem_EXP5_EXP15 = subset_samples(diff_abun_PCR1_PCR3, Family == "Ephemeroptera")

deseq_ephem_EXP5_EXP15 <- phyloseq_to_deseq2(diff_abun_ephem_EXP5_EXP15, ~ Site)
deseq_ephem_EXP5_EXP15 <- DESeq(deseq_ephem_EXP5_EXP15, test = "Wald", fitType = "parametric", sfType = "poscounts")  

res_deseq_ephem_EXP5_EXP15 <- results(deseq_ephem_EXP5_EXP15, cooksCutoff = FALSE)
res_deseq_ephem_EXP5_EXP15
alpha = 0.001
sigtab_ephem_EXP5_EXP15 = res_deseq_ephem_EXP5_EXP15[which(res_deseq_ephem_EXP5_EXP15$padj < alpha), ]
sigtab_ephem_EXP5_EXP15 = cbind(as(sigtab_ephem_EXP5_EXP15, "data.frame"), as(tax_table(diff_abun_ephem_EXP5_EXP15)[rownames(sigtab_ephem_EXP5_EXP15), ], "matrix"))


x_ephem_EXP5_EXP15 = tapply(sigtab_ephem_EXP5_EXP15$log2FoldChange, sigtab_ephem_EXP5_EXP15$Phylum, function(x) max(x))
x_ephem_EXP5_EXP15 = sort(x_ephem_EXP5_EXP15, TRUE)
sigtab_ephem_EXP5_EXP15$Phylum = factor(as.character(sigtab_ephem_EXP5_EXP15$Phylum), levels=names(x_ephem_EXP5_EXP15))
# Genus order
x_ephem_EXP5_EXP15 = tapply(sigtab_ephem_EXP5_EXP15$log2FoldChange, sigtab_ephem_EXP5_EXP15$Genus, function(x) max(x))
x_ephem_EXP5_EXP15 = sort(x_ephem_EXP5_EXP15, TRUE)
sigtab_ephem_EXP5_EXP15$Genus = factor(as.character(sigtab_ephem_EXP5_EXP15$Genus), levels=sort(names(x_ephem_EXP5_EXP15)))

ggplot(sigtab_ephem_EXP5_EXP15, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=30, face="italic")) + theme(axis.text=element_text(size=30, color="black"), axis.title.x=element_text(size=30, vjust=10)) +
          theme(legend.text=element_text(size=30, color="black")) + 
          theme(legend.title = element_text(size=30, color="black"), legend.position = "right")+
  ggtitle("Differential Abundance of EXP15/REF")+
  scale_color_manual(values=c("red", "#234F1E", "blue", "#fdb915", "purple"))+
  rremove("grid")
#2 diff abund bacteria
```

### ANCOMBC (All ACWA streams run together) ###
```{r}
#### Hydropsychidae ####
hydro_ACWA<-subset_samples(ACWA_ps, Family=="Hydropsychidae")
nsamples(hydro_ACWA) #24

# ancombc
hydro_ancom_out <- ancombc(phyloseq = hydro_ACWA, formula = "Site",
              p_adj_method = "holm", lib_cut = 1000, 
              group = "Site", struc_zero = TRUE, neg_lb = TRUE, tol = 1e-5, 
              max_iter = 100, conserve = TRUE, alpha = 0.01, global = TRUE)
hydro_ancom_res <- hydro_ancom_out$res

tab_lfc = hydro_ancom_res$lfc

hydro_tax<-as.data.frame(tax_table(hydro_ACWA))
hydro_tax<-rownames_to_column(hydro_tax, var="taxon")

hydro_ancom_res_combined<-dplyr::inner_join(hydro_tax, tab_lfc, by="taxon")



```

### Putting all ACWA graphs together ###
```{r}
PCR3_BRR2_2<-PCR3_BRR2 + theme(plot.title = element_blank(), axis.title.y = element_blank(), axis.title.x=element_blank())
PCR1_BRR2_2<-PCR1_BRR2 + theme(plot.title = element_blank(), axis.title.y = element_blank(), axis.title.x=element_blank())
PCR3_PCR1_2<-PCR3_PCR1 + theme(plot.title = element_blank(), axis.title.y = element_blank(), axis.title.x=element_blank())

ACWA_deseq<-ggarrange(PCR1_BRR2_2, NULL, PCR3_BRR2_2, NULL, PCR3_PCR1_2, nrow=5, ncol=1, align="v", labels=c("EXP 5 % - REF", "", "EXP 15 % - REF", "", "EXP 15 % - EXP 5 %"), font.label = list(size = 30), vjust=-0.3, hjust=0, heights=c(1, 0.05, 1, 0.05, 1))+theme(plot.margin = margin(1,1,1,1, "cm")) 

annotate_figure(ACWA_deseq, left = text_grob(bquote(""*~Log[2]~Ratio~of~Absolute~Abundance*""), size=36, rot = 90))

#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/deseq_all_ACWA.png", height=18, width=22, bg="white")

#Only treatment streams vs reference

ACWA_treat<-ggarrange(PCR1_BRR2_2, NULL, PCR3_BRR2_2, nrow=3, ncol=1, align="v", labels=c("EXP 5 % - REF", "", "EXP 15 % - REF"), font.label = list(size = 26), vjust=-0.3, hjust=0, heights=c(1, 0.05, 1, 0.05, 1))+theme(plot.margin = margin(1,1,1,1, "cm")) 

ACWA_treat

#annotate_figure(ACWA_treat, left = text_grob(bquote(""*~Log[2]~Ratio~of~Absolute~Abundance*""), size=40, rot = 90)) + theme(axis.title.y = element_text(vjust = -1))


#ggsave(filename="Microbiome_ED/Final analysis/Differential Abundance Results/deseq_treatment_vs_reference_ACWA.png", height=18, width=24, bg="white")

```

### Effluent bacteria in Bow River samples ###
```{r}

#Checking for Flavobacterium in Bow River samples
Bow_Flav<-subset_taxa(Bow, Genus=="Flavobacterium")
Bow_Flav<-prune_taxa(taxa_sums(Bow_Flav) > 0, Bow_Flav)
Bow_Flav_df<-psmelt(Bow_Flav)

Bow_Flav_agg<-aggregate(Abundance~Genus+Site, data=Bow_Flav_df, FUN=mean)

ggplot(Bow_Flav_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest at Sunalta but the mean total abundance is super low in Bow River sites. 

#Flavobacterium can sometimes be found in wastewater 
#Flavobacterium have a prominent role in freshwater bacterioplankton communities due to their high rates of substrate uptake and growth, growth on algal-derived substrates and high mortality rates from bacterivory.


#Limnohabitans
ACWA_Lim<-subset_taxa(ACWA, Genus=="Limnohabitans")
ACWA_Lim_df<-psmelt(ACWA_Lim)
ACWA_Lim_agg<-aggregate(Abundance~Genus+Site, data=ACWA_Lim_df, FUN=mean)

ggplot(ACWA_Lim_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest at PCR1 then PCR3. Low in BRR2. Overall mean total abundance is low for all 3 streams. 

#Checking for Limnohabitans in Bow River samples
Bow_Lim<-subset_taxa(Bow, Genus=="Limnohabitans")
Bow_Lim<-prune_taxa(taxa_sums(Bow_Lim) > 0, Bow_Lim)
Bow_Lim_df<-psmelt(Bow_Lim)

Bow_Lim_agg<-aggregate(Abundance~Genus+Site, data=Bow_Lim_df, FUN=mean)

ggplot(Bow_Lim_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest at Graves Bridge then Policeman Flats. 


#Ideonella
#Not sure of the species but probably is Ideonella dechloratans because it is perchlorate reducing and perchlorate is found in wastewater since it's commonly used to treat effluent. 
#Could also be Ideonella sakaiensis which able to break down plastic. Potentially has more plastic in the wastewater streams? 
#Or Ideonella azotifigens? It is nitrogen fixing

#PCR1 and PCR3 had a higher abundance of this bacteria compared to the control streams.
ACWA_Ideon<-subset_taxa(ACWA, Genus=="Ideonella")
table(tax_table(ACWA_Ideon)[,7])
ACWA_Ideon_df<-psmelt(ACWA_Ideon)
ACWA_Ideon_agg<-aggregate(Abundance~Genus+Site, data=ACWA_Ideon_df, FUN=mean)
ggplot(ACWA_Ideon_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")+
  ylab("Mean Total Abundance")
  #Much higher in PCR1 and PCR3 streams

#Checking for Ideonella in Bow River samples
Bow<-subset_samples(sample_ps2, Stream_Type=="Bow River")
Bow_Ideon<-subset_taxa(Bow, Genus=="Ideonella")
Bow_Ideon<-prune_taxa(taxa_sums(Bow_Ideon) > 0, Bow_Ideon)
Bow_Ideon_df<-psmelt(Bow_Ideon)

Bow_Ideon_agg<-aggregate(Abundance~Genus+Site, data=Bow_Ideon_df, FUN=mean)

ggplot(Bow_Ideon_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Cushing Bridge had the highest mean total abundance of Ideonella. Lowest at Cochrane and Sunalta.

#Rhodoferax
#Oxidizes acetate with with the reduction of Fe(3)
ACWA_Rhodo<-subset_taxa(ACWA, Genus=="Rhodoferax")
ACWA_Rhodo_df<-psmelt(ACWA_Rhodo)
ACWA_Rhodo_agg<-aggregate(Abundance~Genus+Site, data=ACWA_Rhodo_df, FUN=mean)
ggplot(ACWA_Rhodo_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest mean total abundance at PCR3. Could potentially indicate an anoxic environment.

#Checking for Rhodoferax in Bow River samples
Bow_Rhodo<-subset_taxa(Bow, Genus=="Rhodoferax")
Bow_Rhodo<-prune_taxa(taxa_sums(Bow_Rhodo) > 0, Bow_Rhodo)
Bow_Rhodo_df<-psmelt(Bow_Rhodo)

Bow_Rhodo_agg<-aggregate(Abundance~Genus+Site, data=Bow_Rhodo_df, FUN=mean)

ggplot(Bow_Rhodo_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest at Graves Bridge. Similar across all other sites. 


#Pajaroellobacter (abortibovis?) only one known species
#Is the agent for Epizootic bovine abortion (EBA), an arthropod-borne bacterial disease that causes significant economic loss for cattle producers in the western United States

ACWA_paja<-subset_taxa(ACWA, Genus=="Pajaroellobacter")
ACWA_paja_df<-psmelt(ACWA_paja)
ACWA_paja_agg<-aggregate(Abundance~Genus+Site, data=ACWA_paja_df, FUN=mean)
ggplot(ACWA_paja_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Mean total abundance was highest at PCR1 but the same between PCR3 and BRR2

#Checking for Paja in Bow River samples
Bow_paja<-subset_taxa(Bow, Genus=="Pajaroellobacter")
Bow_paja<-prune_taxa(taxa_sums(Bow_paja) > 0, Bow_paja)
Bow_paja_df<-psmelt(Bow_paja)

Bow_paja_agg<-aggregate(Abundance~Genus+Site, data=Bow_paja_df, FUN=mean)

ggplot(Bow_paja_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Mean abundance is much higher at Policeman Flats compared to other sites. Cochrane is virtually 0. 


#Novosphingobium
ACWA_novo<-subset_taxa(ACWA, Genus=="Novosphingobium")
ACWA_novo_df<-psmelt(ACWA_novo)
ACWA_novo_agg<-aggregate(Abundance~Genus+Site, data=ACWA_novo_df, FUN=mean)
ggplot(ACWA_novo_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest at BRR2... but the differential abundance test said the opposite.

#Checking for Novosphingobium in Bow River samples
Bow_novo<-subset_taxa(Bow, Genus=="Novosphingobium")
Bow_novo<-prune_taxa(taxa_sums(Bow_novo) > 0, Bow_novo)
Bow_novo_df<-psmelt(Bow_novo)

Bow_novo_agg<-aggregate(Abundance~Genus+Site, data=Bow_novo_df, FUN=mean)

ggplot(Bow_novo_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest at Policeman Flats


#Alistipes
ACWA_Ali<-subset_taxa(ACWA, Genus=="Alistipes")
ACWA_Ali_df<-psmelt(ACWA_Ali)

ACWA_Ali_agg<-aggregate(Abundance ~ Genus + Site, data = ACWA_Ali_df, FUN = mean)

ggplot(ACWA_Ali_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Lowest at PCR1. Same at BRR2 and PCR3. 

#Checking for Alistipes in Bow River samples
Bow_ali<-subset_taxa(Bow, Genus=="Alistipes")
Bow_ali<-prune_taxa(taxa_sums(Bow_ali) > 0, Bow_ali)
Bow_ali_df<-psmelt(Bow_ali)

Bow_ali_agg<-aggregate(Abundance~Genus+Site, data=Bow_ali_df, FUN=mean)

ggplot(Bow_ali_agg, aes(x=Site, y=Abundance))+
  geom_col()+
  rremove("grid")
#Highest at Graves Bridge and second highest at Policeman Flats.

#Alistipes is known to be pathogenic in colorectal cancer and is associated with mentalsigns of depression (Parker et al., 2020)

```

# Endosymbionts

```{r Percent of endosymbionts to total abundance}
#### Larval Hydropsychidae Bow River ####

hydro_lar_Bow<-subset_samples(sample_ps, Family=="Hydropsychidae" & Stream_Type=="Bow River")

endo<-subset_taxa(sample_ps, Genus=="Buchnera" | Genus=="Candidatus Cardinium" | Genus=="Rickettsia" | Genus =="Wolbachia" | Genus=="Spiroplasma" | Genus=="Diplorickettsia")
endo<-prune_taxa(taxa_sums(endo) > 0, endo) 
endo #31 taxa 

endo_lar_hydro_Bow<-subset_samples(endo, Family=="Hydropsychidae" & Stream_Type=="Bow River")
endo_lar_hydro_Bow<-prune_taxa(taxa_sums(endo_lar_hydro_Bow) > 0, endo_lar_hydro_Bow) 
sort((table(tax_table(endo_lar_hydro_Bow)[,6]))/sum(ntaxa(endo_lar_hydro_Bow))*100)
sum(sample_sums(endo_lar_hydro_Bow))/sum(sample_sums(hydro_lar_Bow))*100

#Endosymbionts comprise 3.59 % of the total microbiome in larval Hydropsychidae
#All Rickettsia (100%)

#Cochrane 

hydro_coch<-subset_samples(hydro_lar_Bow, Site=="Cochrane")

endo_lar_hydro_Bow_coch<-subset_samples(endo_lar_hydro_Bow, Site=="Cochrane")
endo_lar_hydro_Bow_coch<-prune_taxa(taxa_sums(endo_lar_hydro_Bow_coch) > 0, endo_lar_hydro_Bow_coch) 
sort((table(tax_table(endo_lar_hydro_Bow_coch)[,6]))/sum(ntaxa(endo_lar_hydro_Bow_coch))*100)
#Rickettsia: 100 %
sum(sample_sums(endo_lar_hydro_Bow_coch))/sum(sample_sums(hydro_coch))*100
#Ricketssia: 11.2%, non-endosymbionts: 88.8%



#Sunalta
hydro_sun<-subset_samples(hydro_lar_Bow, Site=="Sunalta")

endo_lar_hydro_Bow_sun<-subset_samples(endo_lar_hydro_Bow, Site=="Sunalta")
endo_lar_hydro_Bow_sun<-prune_taxa(taxa_sums(endo_lar_hydro_Bow_sun) > 0, endo_lar_hydro_Bow_sun) 
sort((table(tax_table(endo_lar_hydro_Bow_sun)[,6]))/sum(ntaxa(endo_lar_hydro_Bow_sun))*100)
#Rickettsia:100%
sum(sample_sums(endo_lar_hydro_Bow_sun))/sum(sample_sums(hydro_sun))*100
#Rickettsia: 6.29 %, Non-endo: 93.7%

#Cushing Bridge
hydro_cush<-subset_samples(hydro_lar_Bow, Site=="Cushing Bridge")

endo_lar_hydro_Bow_cush<-subset_samples(endo_lar_hydro_Bow, Site=="Cushing Bridge")
endo_lar_hydro_Bow_cush<-prune_taxa(taxa_sums(endo_lar_hydro_Bow_cush) > 0, endo_lar_hydro_Bow_cush) 
sort((table(tax_table(endo_lar_hydro_Bow_cush)[,6]))/sum(ntaxa(endo_lar_hydro_Bow_cush))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_hydro_Bow_cush))/sum(sample_sums(hydro_cush))*100
#Rickettsia: 3.79 %, Non-endo: 96.2%

#Graves Bridge
hydro_grv<-subset_samples(hydro_lar_Bow, Site=="Graves Bridge")

endo_lar_hydro_Bow_grv<-subset_samples(endo_lar_hydro_Bow, Site=="Graves Bridge")
endo_lar_hydro_Bow_grv<-prune_taxa(taxa_sums(endo_lar_hydro_Bow_grv) > 0, endo_lar_hydro_Bow_grv) 
sort((table(tax_table(endo_lar_hydro_Bow_grv)[,6]))/sum(ntaxa(endo_lar_hydro_Bow_grv))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_hydro_Bow_grv))/sum(sample_sums(hydro_grv))*100
#Rickettsia: 0.84 %, Non-endo: 99.2%

#Policeman Flats
hydro_pmf<-subset_samples(hydro_lar_Bow, Site=="Policeman Flats")

endo_lar_hydro_Bow_pmf<-subset_samples(endo_lar_hydro_Bow, Site=="Policeman Flats")
endo_lar_hydro_Bow_pmf<-prune_taxa(taxa_sums(endo_lar_hydro_Bow_pmf) > 0, endo_lar_hydro_Bow_pmf) 
sort((table(tax_table(endo_lar_hydro_Bow_pmf)[,6]))/sum(ntaxa(endo_lar_hydro_Bow_pmf))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_hydro_Bow_pmf))/sum(sample_sums(hydro_pmf))*100
#Rickettsia: 0.12%, non-endo: 99.9%

## Plotting relative abundance of endosymbionts versus non endosymbionts ##

hydro_Bow_genus <- tax_glom(hydro_lar_Bow, taxrank = "Genus")
comp_hydro_Bow_genus <- microbiome::transform(hydro_Bow_genus, "compositional")

hydro_Bow_genus_df <- psmelt(comp_hydro_Bow_genus)

hydro_agg <- aggregate(Abundance ~ Genus + Site_code, data = hydro_Bow_genus_df, FUN = mean) #aggregate to Phylum level, take the mean

#Sort abundance of each genus by mean at each site
sort_genus_hydro <- hydro_agg %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_hydro

endosymbionts <- sort_genus_hydro$Genus[1901:1905]

  
endo_df_hydro <- hydro_agg %>%
    mutate(Genus = fct_other(Genus, endosymbionts))
endo_df_hydro

endo_agg_df<-aggregate(Abundance ~ Genus + Site_code, data = endo_df_hydro, FUN = sum)

endo_agg_df$Genus<-factor(endo_agg_df$Genus, levels=c("Rickettsia", "Other"), labels=c("Rickettsia", "Non-endosymbionts"))

endo_plot_hydro <- ggplot(endo_agg_df, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title.x=element_text(size=22))+
  scale_fill_manual(name="Genus", values=c("lightgoldenrod1", "honeydew4"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
endo_plot_hydro

#### Larval Heptageniidae Bow River ####
hep_lar_Bow<-subset_samples(sample_ps, Family=="Heptageniidae" & Stream_Type=="Bow River")

endo_lar_hep_Bow<-subset_samples(endo, Family=="Heptageniidae" & Stream_Type=="Bow River")
endo_lar_hep_Bow<-prune_taxa(taxa_sums(endo_lar_hep_Bow) > 0, endo_lar_hep_Bow) 
sort((table(tax_table(endo_lar_hep_Bow)[,6]))/sum(ntaxa(endo_lar_hep_Bow))*100)
#Rickettsia 28.6%, Wolbachia 71.4%
sum(sample_sums(endo_lar_hep_Bow))/sum(sample_sums(hep_lar_Bow))*100
#0.012 %

#Cochrane 
hep_coch<-subset_samples(hep_lar_Bow, Site=="Cochrane")

endo_lar_hep_Bow_coch<-subset_samples(endo_lar_hep_Bow, Site=="Cochrane")
endo_lar_hep_Bow_coch<-prune_taxa(taxa_sums(endo_lar_hep_Bow_coch) > 0, endo_lar_hep_Bow_coch) 
sort((table(tax_table(endo_lar_hep_Bow_coch)[,6]))/sum(ntaxa(endo_lar_hep_Bow_coch))*100)
#Rickettsia: 20 %, Wolbachia: 80%
sum(sample_sums(endo_lar_hep_Bow_coch))/sum(sample_sums(hep_coch))*100
#0.024 % of total; Rickettsia: 0.005, Wolbachia: 0.02, Non-endo:100

#Sunalta
hep_sun<-subset_samples(hep_lar_Bow, Site=="Sunalta")

endo_lar_hep_Bow_sun<-subset_samples(endo_lar_hep_Bow, Site=="Sunalta")
endo_lar_hep_Bow_sun<-prune_taxa(taxa_sums(endo_lar_hep_Bow_sun) > 0, endo_lar_hep_Bow_sun) 
sort((table(tax_table(endo_lar_hep_Bow_sun)[,6]))/sum(ntaxa(endo_lar_hep_Bow_sun))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_hep_Bow_sun))/sum(sample_sums(hep_sun))*100
#0.018 % of total, non endo: 100

#Cushing Bridge
hep_cush<-subset_samples(hep_lar_Bow, Site=="Cushing Bridge")

endo_lar_hep_Bow_cush<-subset_samples(endo_lar_hep_Bow, Site=="Cushing Bridge")
endo_lar_hep_Bow_cush<-prune_taxa(taxa_sums(endo_lar_hep_Bow_cush) > 0, endo_lar_hep_Bow_cush) 
sort((table(tax_table(endo_lar_hep_Bow_cush)[,6]))/sum(ntaxa(endo_lar_hep_Bow_cush))*100)
#Rickettsia: 20%, Wolbachia: 80 %
sum(sample_sums(endo_lar_hep_Bow_cush))/sum(sample_sums(hep_cush))*100
#0.028 % of total; Rickettsia: 0.005, Wolbachia: 0.02, Non-endo: 100

#Graves Bridge
hep_grv<-subset_samples(hep_lar_Bow, Site=="Graves Bridge")

endo_lar_hep_Bow_grv<-subset_samples(endo_lar_hep_Bow, Site=="Graves Bridge")
endo_lar_hep_Bow_grv<-prune_taxa(taxa_sums(endo_lar_hep_Bow_grv) > 0, endo_lar_hep_Bow_grv) 
sort((table(tax_table(endo_lar_hep_Bow_grv)[,6]))/sum(ntaxa(endo_lar_hep_Bow_grv))*100)
#Rickettsia: 100 %
sum(sample_sums(endo_lar_hep_Bow_grv))/sum(sample_sums(hep_grv))*100
#0.001 % of total

#Policeman Flats
hep_pmf<-subset_samples(hep_lar_Bow, Site=="Policeman Flats")

endo_lar_hep_Bow_pmf<-subset_samples(endo_lar_hep_Bow, Site=="Policeman Flats")
endo_lar_hep_Bow_pmf<-prune_taxa(taxa_sums(endo_lar_hep_Bow_pmf) > 0, endo_lar_hep_Bow_pmf) 
#Error means none


## Plotting relative abundance of endosymbionts versus non endosymbionts ##

hep_Bow_genus <- tax_glom(hep_lar_Bow, taxrank = "Genus")
comp_hep_Bow_genus <- microbiome::transform(hep_Bow_genus, "compositional")

hep_Bow_genus_df <- psmelt(comp_hep_Bow_genus)

hep_agg <- aggregate(Abundance ~ Genus + Site_code, data = hep_Bow_genus_df, FUN = mean)

#Sort abundance of each genus by mean at each site
sort_genus_hep <- hep_agg %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_hep

endosymbionts_hep <- sort_genus_hep$Genus[c(1901:1905, 2346:2350)]
endosymbionts_hep
  
endo_df_hep <- hep_agg %>%
    mutate(Genus = fct_other(Genus, endosymbionts_hep))
endo_df_hep

endo_agg_df_hep<-aggregate(Abundance ~ Genus + Site_code, data = endo_df_hep, FUN = sum)

endo_agg_df_hep$Genus<-factor(endo_agg_df_hep$Genus, levels=c("Rickettsia", "Wolbachia", "Other"), labels=c("Rickettsia", "Wolbachia", "Non-endosymbionts"))

endo_plot_hep <- ggplot(endo_agg_df_hep, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title.x=element_text(size=22))+
  scale_fill_manual(name="Genus", values=c("lightgoldenrod1", "lightpink2", "honeydew4"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
endo_plot_hep

#### Larval Chironomidae Bow River ####
chiro_lar_Bow<-subset_samples(sample_ps, Family=="Chironomidae" & Stream_Type=="Bow River")

endo_lar_chiro_Bow<-subset_samples(endo, Family=="Chironomidae" & Stream_Type=="Bow River")
endo_lar_chiro_Bow<-prune_taxa(taxa_sums(endo_lar_chiro_Bow) > 0, endo_lar_chiro_Bow) 
#None

## Plotting relative abundance of endosymbionts versus non endosymbionts ##

chiro_Bow_genus <- tax_glom(chiro_lar_Bow, taxrank = "Genus")
comp_chiro_Bow_genus <- microbiome::transform(chiro_Bow_genus, "compositional")

chiro_Bow_genus_df <- psmelt(comp_chiro_Bow_genus)

chiro_agg <- aggregate(Abundance ~ Genus + Site_code, data = chiro_Bow_genus_df, FUN = mean)

#Sort abundance of each genus by mean at each site
sort_genus_chiro <- chiro_agg %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_chiro

endosymbionts_chiro <- sort_genus_chiro$Genus[1901:1905]

endo_df_chiro <- chiro_agg %>%
    mutate(Genus = fct_other(Genus, endosymbionts_chiro))
endo_df_chiro

endo_agg_df_chiro<-aggregate(Abundance ~ Genus + Site_code, data = endo_df_chiro, FUN = sum)

endo_agg_df_chiro$Genus<-factor(endo_agg_df_chiro$Genus, levels=c("Rickettsia", "Other"), labels=c("Rickettsia", "Non-endosymbionts"))

endo_plot_chiro <- ggplot(endo_agg_df_chiro, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title.x=element_text(size=22))+
  scale_fill_manual(name="Genus", values=c("honeydew4"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
endo_plot_chiro


#### Larval Perlidae Bow River ####
perl_lar_Bow<-subset_samples(sample_ps, Family=="Perlidae" & Stream_Type=="Bow River")

endo_lar_perl_Bow<-subset_samples(endo, Family=="Perlidae" & Stream_Type=="Bow River")

endo_lar_perl_Bow<-prune_taxa(taxa_sums(endo_lar_perl_Bow) > 0, endo_lar_perl_Bow) 
#None

## Plotting relative abundance of endosymbionts versus non endosymbionts ##

perl_Bow_genus <- tax_glom(perl_lar_Bow, taxrank = "Genus")
comp_perl_Bow_genus <- microbiome::transform(perl_Bow_genus, "compositional")

perl_Bow_genus_df <- psmelt(comp_perl_Bow_genus)

perl_agg <- aggregate(Abundance ~ Genus + Site_code, data = perl_Bow_genus_df, FUN = mean)

#Sort abundance of each genus by mean at each site
sort_genus_perl <- perl_agg %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_perl

endosymbionts_perl <- sort_genus_perl$Genus[1901:1905]

endo_df_perl <- perl_agg %>%
    mutate(Genus = fct_other(Genus, endosymbionts_perl))
endo_df_perl

endo_agg_df_perl<-aggregate(Abundance ~ Genus + Site_code, data = endo_df_perl, FUN = sum)

endo_agg_df_perl$Genus<-factor(endo_agg_df_perl$Genus, levels=c("Rickettsia", "Other"), labels=c("Rickettsia", "Non-endosymbionts"))

endo_plot_perl <- ggplot(endo_agg_df_perl, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=12)) +
  theme(axis.title.y=element_text(size=22),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title.x=element_text(size=22))+
  scale_fill_manual(name="Genus", values=c("honeydew4"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
endo_plot_perl

#### Adult Trichoptera Bow River ####
trichop_lar_Bow<-subset_samples(sample_ps, Family=="Trichoptera" & Stream_Type=="Bow River")

endo_lar_trichop_Bow<-subset_samples(endo, Family=="Trichoptera" & Stream_Type=="Bow River")

endo_lar_trichop_Bow<-prune_taxa(taxa_sums(endo_lar_trichop_Bow) > 0, endo_lar_trichop_Bow) 
sort((table(tax_table(endo_lar_trichop_Bow)[,6]))/sum(ntaxa(endo_lar_trichop_Bow))*100)
#Buchnera (16.7%) Spiroplasma (16.7) Rickettsia (66.7%)
sum(sample_sums(endo_lar_trichop_Bow))/sum(sample_sums(trichop_lar_Bow))*100
#36.7% 


#Cochrane 
trichop_coch<-subset_samples(trichop_lar_Bow, Site=="Cochrane")

endo_lar_trichop_Bow_coch<-subset_samples(endo_lar_trichop_Bow, Site=="Cochrane")
endo_lar_trichop_Bow_coch<-prune_taxa(taxa_sums(endo_lar_trichop_Bow_coch) > 0, endo_lar_trichop_Bow_coch) 
sort((table(tax_table(endo_lar_trichop_Bow_coch)[,6]))/sum(ntaxa(endo_lar_trichop_Bow_coch))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_trichop_Bow_coch))/sum(sample_sums(trichop_coch))*100
#37.4 % of total

#Sunalta
trichop_sun<-subset_samples(trichop_lar_Bow, Site=="Sunalta")

endo_lar_trichop_Bow_sun<-subset_samples(endo_lar_trichop_Bow, Site=="Sunalta")
endo_lar_trichop_Bow_sun<-prune_taxa(taxa_sums(endo_lar_trichop_Bow_sun) > 0, endo_lar_trichop_Bow_sun) 
sort((table(tax_table(endo_lar_trichop_Bow_sun)[,6]))/sum(ntaxa(endo_lar_trichop_Bow_sun))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_trichop_Bow_sun))/sum(sample_sums(trichop_sun))*100
#58.2 % of total

#Cushing Bridge
trichop_cush<-subset_samples(trichop_lar_Bow, Site=="Cushing Bridge")

endo_lar_trichop_Bow_cush<-subset_samples(endo_lar_trichop_Bow, Site=="Cushing Bridge")
endo_lar_trichop_Bow_cush<-prune_taxa(taxa_sums(endo_lar_trichop_Bow_cush) > 0, endo_lar_trichop_Bow_cush) 
sort((table(tax_table(endo_lar_trichop_Bow_cush)[,6]))/sum(ntaxa(endo_lar_trichop_Bow_cush))*100)
#Buchnera: 25%, Spiroplasma: 25%, Rickettsia: 50%
sum(sample_sums(endo_lar_trichop_Bow_cush))/sum(sample_sums(trichop_cush))*100
#28.1% of total

#Graves Bridge
trichop_grv<-subset_samples(trichop_lar_Bow, Site=="Graves Bridge")

endo_lar_trichop_Bow_grv<-subset_samples(endo_lar_trichop_Bow, Site=="Graves Bridge")
endo_lar_trichop_Bow_grv<-prune_taxa(taxa_sums(endo_lar_trichop_Bow_grv) > 0, endo_lar_trichop_Bow_grv) 
sort((table(tax_table(endo_lar_trichop_Bow_grv)[,6]))/sum(ntaxa(endo_lar_trichop_Bow_grv))*100)
#Rickettsia: 100 %
sum(sample_sums(endo_lar_trichop_Bow_grv))/sum(sample_sums(trichop_grv))*100
#0.053 % of total

#Policeman Flats
endo_lar_trichop_Bow_pmf<-subset_samples(endo_lar_trichop_Bow, Site=="Policeman Flats") #none


#### Adult Ephemeroptera Bow River ####

ephem_lar_Bow<-subset_samples(sample_ps, Family=="Ephemeroptera" & Stream_Type=="Bow River")

endo_lar_ephem_Bow<-subset_samples(endo, Family=="Ephemeroptera" & Stream_Type=="Bow River")

endo_lar_ephem_Bow<-prune_taxa(taxa_sums(endo_lar_ephem_Bow) > 0, endo_lar_ephem_Bow) 
sort((table(tax_table(endo_lar_ephem_Bow)[,6]))/sum(ntaxa(endo_lar_ephem_Bow))*100)
#Buchnera (14.3%) Spiroplasma (14.3) Wolbachia (14.3) Rickettsia (57.1%)
sum(sample_sums(endo_lar_ephem_Bow))/sum(sample_sums(ephem_lar_Bow))*100
#5.39% 


#Cochrane 
ephem_coch<-subset_samples(ephem_lar_Bow, Site=="Cochrane")

endo_lar_ephem_Bow_coch<-subset_samples(endo_lar_ephem_Bow, Site=="Cochrane")
endo_lar_ephem_Bow_coch<-prune_taxa(taxa_sums(endo_lar_ephem_Bow_coch) > 0, endo_lar_ephem_Bow_coch) 
sort((table(tax_table(endo_lar_ephem_Bow_coch)[,6]))/sum(ntaxa(endo_lar_ephem_Bow_coch))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_ephem_Bow_coch))/sum(sample_sums(ephem_coch))*100
#26.4 % of total

#Sunalta
ephem_sun<-subset_samples(ephem_lar_Bow, Site=="Sunalta")

endo_lar_ephem_Bow_sun<-subset_samples(endo_lar_ephem_Bow, Site=="Sunalta")
endo_lar_ephem_Bow_sun<-prune_taxa(taxa_sums(endo_lar_ephem_Bow_sun) > 0, endo_lar_ephem_Bow_sun) 
sort((table(tax_table(endo_lar_ephem_Bow_sun)[,6]))/sum(ntaxa(endo_lar_ephem_Bow_sun))*100)
#Rickettsia: 100%
sum(sample_sums(endo_lar_ephem_Bow_sun))/sum(sample_sums(ephem_sun))*100
#6.20 % of total

#Cushing Bridge
ephem_cush<-subset_samples(ephem_lar_Bow, Site=="Cushing Bridge")

endo_lar_ephem_Bow_cush<-subset_samples(endo_lar_ephem_Bow, Site=="Cushing Bridge")
endo_lar_ephem_Bow_cush<-prune_taxa(taxa_sums(endo_lar_ephem_Bow_cush) > 0, endo_lar_ephem_Bow_cush) 
sort((table(tax_table(endo_lar_ephem_Bow_cush)[,6]))/sum(ntaxa(endo_lar_ephem_Bow_cush))*100)
#Buchnera: 33.3%, Spiroplasma: 33.3%, Rickettsia: 33.3%
sum(sample_sums(endo_lar_ephem_Bow_cush))/sum(sample_sums(ephem_cush))*100
#0.085 % of total

#Graves Bridge
ephem_grv<-subset_samples(ephem_lar_Bow, Site=="Graves Bridge")

endo_lar_ephem_Bow_grv<-subset_samples(endo_lar_ephem_Bow, Site=="Graves Bridge")
endo_lar_ephem_Bow_grv<-prune_taxa(taxa_sums(endo_lar_ephem_Bow_grv) > 0, endo_lar_ephem_Bow_grv) 
sort((table(tax_table(endo_lar_ephem_Bow_grv)[,6]))/sum(ntaxa(endo_lar_ephem_Bow_grv))*100)
#Rickettsia: 50 % Wolbachia: 50 %
sum(sample_sums(endo_lar_ephem_Bow_grv))/sum(sample_sums(ephem_grv))*100
#0.085 % of total

#Policeman Flats
ephem_pmf<-subset_samples(ephem_lar_Bow, Site=="Policeman Flats")

endo_lar_ephem_Bow_pmf<-subset_samples(endo_lar_ephem_Bow, Site=="Policeman Flats")
endo_lar_ephem_Bow_pmf<-prune_taxa(taxa_sums(endo_lar_ephem_Bow_pmf) > 0, endo_lar_ephem_Bow_pmf) 
sort((table(tax_table(endo_lar_ephem_Bow_pmf)[,6]))/sum(ntaxa(endo_lar_ephem_Bow_pmf))*100)
#Rickettsia: 100
sum(sample_sums(endo_lar_ephem_Bow_pmf))/sum(sample_sums(ephem_pmf))*100
#0.0503 % of total

#### Adult Diptera Bow River ####

dip_lar_Bow<-subset_samples(sample_ps, Family=="Diptera" & Stream_Type=="Bow River")

endo_lar_dip_Bow<-subset_samples(endo, Family=="Diptera" & Stream_Type=="Bow River")

endo_lar_dip_Bow<-prune_taxa(taxa_sums(endo_lar_dip_Bow) > 0, endo_lar_dip_Bow) 
sort((table(tax_table(endo_lar_dip_Bow)[,6]))/sum(ntaxa(endo_lar_dip_Bow))*100)
#Buchnera (7.14%) Spiroplasma (21.4) Wolbachia (35.7) Rickettsia (35.7%)
sum(sample_sums(endo_lar_dip_Bow))/sum(sample_sums(dip_lar_Bow))*100
#9.60% 


#Cochrane 
dip_coch<-subset_samples(dip_lar_Bow, Site=="Cochrane")

endo_lar_dip_Bow_coch<-subset_samples(endo_lar_dip_Bow, Site=="Cochrane")
endo_lar_dip_Bow_coch<-prune_taxa(taxa_sums(endo_lar_dip_Bow_coch) > 0, endo_lar_dip_Bow_coch) 
sort((table(tax_table(endo_lar_dip_Bow_coch)[,6]))/sum(ntaxa(endo_lar_dip_Bow_coch))*100)
#Rickettsia: 33.3%, spiroplasma: 25, Wolbachia:41.7
sum(sample_sums(endo_lar_dip_Bow_coch))/sum(sample_sums(dip_coch))*100
#34.2 % of total

#Cushing Bridge
dip_cush<-subset_samples(dip_lar_Bow, Site=="Cushing Bridge")

endo_lar_dip_Bow_cush<-subset_samples(endo_lar_dip_Bow, Site=="Cushing Bridge")
endo_lar_dip_Bow_cush<-prune_taxa(taxa_sums(endo_lar_dip_Bow_cush) > 0, endo_lar_dip_Bow_cush) 
sort((table(tax_table(endo_lar_dip_Bow_cush)[,6]))/sum(ntaxa(endo_lar_dip_Bow_cush))*100)
#Buchnera: 50%, Rickettsia: 50%
sum(sample_sums(endo_lar_dip_Bow_cush))/sum(sample_sums(dip_cush))*100
#0.23 % of total

#Policeman Flats
dip_pmf<-subset_samples(dip_lar_Bow, Site=="Policeman Flats")

endo_lar_dip_Bow_pmf<-subset_samples(endo_lar_dip_Bow, Site=="Policeman Flats")
endo_lar_dip_Bow_pmf<-prune_taxa(taxa_sums(endo_lar_dip_Bow_pmf) > 0, endo_lar_dip_Bow_pmf) 
sort((table(tax_table(endo_lar_dip_Bow_pmf)[,6]))/sum(ntaxa(endo_lar_dip_Bow_pmf))*100)
#Rickettsia: 75, spiroplasma 25
sum(sample_sums(endo_lar_dip_Bow_pmf))/sum(sample_sums(dip_pmf))*100
#0.28 % of total


#### Araneidae ####

aran_Bow<-subset_samples(sample_ps, Family=="Araneidae" & Stream_Type=="Bow River")

endo_aran_Bow<-subset_samples(endo, Family=="Araneidae" & Stream_Type=="Bow River")

endo_aran_Bow<-prune_taxa(taxa_sums(endo_aran_Bow) > 0, endo_aran_Bow) 
sort((table(tax_table(endo_aran_Bow)[,6]))/sum(ntaxa(endo_aran_Bow))*100)
#Spiroplasma (45) Wolbachia (40) Rickettsia (15%)
sum(sample_sums(endo_aran_Bow))/sum(sample_sums(aran_Bow))*100
#10.21% 


#Cochrane 
aran_coch<-subset_samples(aran_Bow, Site=="Cochrane")

endo_aran_Bow_coch<-subset_samples(endo_aran_Bow, Site=="Cochrane")
endo_aran_Bow_coch<-prune_taxa(taxa_sums(endo_aran_Bow_coch) > 0, endo_aran_Bow_coch) 
sort((table(tax_table(endo_aran_Bow_coch)[,6]))/sum(ntaxa(endo_aran_Bow_coch))*100)
#Rickettsia: 10%, spiroplasma: 60, Wolbachia:30
mean(sample_sums(endo_aran_Bow_coch))/sum(sample_sums(aran_coch))*100
#34.0 % of total,  Rickettsia,  Spiroplasma,  Wolbachia

#Sunalta
aran_sun<-subset_samples(aran_Bow, Site=="Sunalta")

endo_aran_Bow_sun<-subset_samples(endo_aran_Bow, Site=="Sunalta")
endo_aran_Bow_sun<-prune_taxa(taxa_sums(endo_aran_Bow_sun) > 0, endo_aran_Bow_sun) 
sort((table(tax_table(endo_aran_Bow_sun)[,6]))/sum(ntaxa(endo_aran_Bow_sun))*100)
#Rickettsia: 16.7, Spiroplasma: 16.7, Wolbachia: 66.7
mean(sample_sums(endo_aran_Bow_sun))/sum(sample_sums(aran_sun))*100
#0.15 % of total. 0.03 Rickettsia, 0.03 Spiroplasma, 0.1 Wolbachia

#Cushing Bridge
aran_cush<-subset_samples(aran_Bow, Site=="Cushing Bridge")

endo_aran_Bow_cush<-subset_samples(endo_aran_Bow, Site=="Cushing Bridge")
endo_aran_Bow_cush<-prune_taxa(taxa_sums(endo_aran_Bow_cush) > 0, endo_aran_Bow_cush) 
sort((table(tax_table(endo_aran_Bow_cush)[,6]))/sum(ntaxa(endo_aran_Bow_cush))*100)
#Rickettsia: 25%, spiroplasma: 25, wolbachia: 50
mean(sample_sums(endo_aran_Bow_cush))/sum(sample_sums(aran_cush))*100
#0.035 % of total

#Graves Bridge
endo_aran_Bow_grv<-subset_samples(endo_aran_Bow, Site=="Graves Bridge")
endo_aran_Bow_grv<-prune_taxa(taxa_sums(endo_aran_Bow_grv) > 0, endo_aran_Bow_grv) 
sort((table(tax_table(endo_aran_Bow_grv)[,6]))/sum(ntaxa(endo_aran_Bow_grv))*100)
#Rickettsia: 11.11%, spiroplasma: 44.44, wolbachia: 44.44
sum(sample_sums(endo_aran_Bow_grv))/sum(sample_sums(aran_Bow))*100
#0.066 % of total

#Policeman Flats

endo_aran_Bow_pmf<-subset_samples(endo_aran_Bow, Site=="Policeman Flats")
endo_aran_Bow_pmf<-prune_taxa(taxa_sums(endo_aran_Bow_pmf) > 0, endo_aran_Bow_pmf) 
sort((table(tax_table(endo_aran_Bow_pmf)[,6]))/sum(ntaxa(endo_aran_Bow_pmf))*100)
#Rickettsia: 30, spiroplasma 50, wolbachia: 20
sum(sample_sums(endo_aran_Bow_pmf))/sum(sample_sums(aran_Bow))*100
#0.19 % of total

#### Tetragnathidae ####

tetra_Bow<-subset_samples(sample_ps, Family=="Tetragnathidae" & Stream_Type=="Bow River")

endo_tetra_Bow<-subset_samples(endo, Family=="Tetragnathidae" & Stream_Type=="Bow River")

endo_tetra_Bow<-prune_taxa(taxa_sums(endo_tetra_Bow) > 0, endo_tetra_Bow) 
sort((table(tax_table(endo_tetra_Bow)[,6]))/sum(ntaxa(endo_tetra_Bow))*100)
#Candidatus cardinium: 3.85, Rickettsia: 15.4, Spiroplasma: 42.3, Wolbachia: 38.5
sum(sample_sums(endo_tetra_Bow))/sum(sample_sums(tetra_Bow))*100
#90.7% 


#Cochrane 
endo_tetra_Bow_coch<-subset_samples(endo_tetra_Bow, Site=="Cochrane")
endo_tetra_Bow_coch<-prune_taxa(taxa_sums(endo_tetra_Bow_coch) > 0, endo_tetra_Bow_coch) 
sort((table(tax_table(endo_tetra_Bow_coch)[,6]))/sum(ntaxa(endo_tetra_Bow_coch))*100)
#Rickettsia: 26.7, spiroplasma: 46.7, Wolbachia:26.7
sum(sample_sums(endo_tetra_Bow_coch))/sum(sample_sums(tetra_Bow))*100
#17.1 % of total

#Sunalta
endo_aran_Bow_sun<-subset_samples(endo_aran_Bow, Site=="Sunalta")
endo_aran_Bow_sun<-prune_taxa(taxa_sums(endo_aran_Bow_sun) > 0, endo_aran_Bow_sun) 
sort((table(tax_table(endo_aran_Bow_sun)[,6]))/sum(ntaxa(endo_aran_Bow_sun))*100)
#Rickettsia: 16.7, Spiroplasma: 16.7, Wolbachia: 66.7
sum(sample_sums(endo_aran_Bow_sun))/sum(sample_sums(aran_Bow))*100
#0.027 % of total

#Cushing Bridge
endo_aran_Bow_cush<-subset_samples(endo_aran_Bow, Site=="Cushing Bridge")
endo_aran_Bow_cush<-prune_taxa(taxa_sums(endo_aran_Bow_cush) > 0, endo_aran_Bow_cush) 
sort((table(tax_table(endo_aran_Bow_cush)[,6]))/sum(ntaxa(endo_aran_Bow_cush))*100)
#Rickettsia: 25%, spiroplasma: 25, wolbachia: 50
sum(sample_sums(endo_aran_Bow_cush))/sum(sample_sums(aran_Bow))*100
#0.035 % of total

#Graves Bridge
endo_aran_Bow_grv<-subset_samples(endo_aran_Bow, Site=="Graves Bridge")
endo_aran_Bow_grv<-prune_taxa(taxa_sums(endo_aran_Bow_grv) > 0, endo_aran_Bow_grv) 
sort((table(tax_table(endo_aran_Bow_grv)[,6]))/sum(ntaxa(endo_aran_Bow_grv))*100)
#Rickettsia: 11.11%, spiroplasma: 44.44, wolbachia: 44.44
sum(sample_sums(endo_aran_Bow_grv))/sum(sample_sums(aran_Bow))*100
#0.066 % of total

#Policeman Flats

endo_aran_Bow_pmf<-subset_samples(endo_aran_Bow, Site=="Policeman Flats")
endo_aran_Bow_pmf<-prune_taxa(taxa_sums(endo_aran_Bow_pmf) > 0, endo_aran_Bow_pmf) 
sort((table(tax_table(endo_aran_Bow_pmf)[,6]))/sum(ntaxa(endo_aran_Bow_pmf))*100)
#Rickettsia: 30, spiroplasma 50, wolbachia: 20
sum(sample_sums(endo_aran_Bow_pmf))/sum(sample_sums(aran_Bow))*100
#0.19 % of total

#### Plotting all taxa faceted ####

#Bow River 

Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")

endo<-subset_taxa(sample_ps, Genus=="Buchnera" | Genus=="Candidatus Cardinium" | Genus=="Rickettsia" | Genus =="Wolbachia" | Genus=="Spiroplasma")
endo<-prune_taxa(taxa_sums(endo) > 0, endo) 
endo #31 taxa 

endo_Bow<-subset_samples(endo, Stream_Type=="Bow River")
endo_Bow<-prune_taxa(taxa_sums(endo_Bow) > 0, endo_Bow) 
sort((table(tax_table(endo_Bow)[,6]))/sum(ntaxa(endo_Bow))*100)
#Buchnera: 3.23%, Candidatus Cardinium: 3.23%, Rickettsia: 25.8%, Wolbachia: 32.3%, Spiroplasma: 35.5%
sum(sample_sums(endo_Bow))/sum(sample_sums(Bow_ps))*100
#Endosymbionts comprise 33.5% of the total microbiome in the Bow River (across all invertebrate types)

## Plotting relative abundance of endosymbionts versus non endosymbionts ##

Bow_genus <- tax_glom(Bow_ps, taxrank = "Genus")
comp_Bow_genus <- transform_sample_counts(Bow_genus, function(x) x/sum(x))

Bow_genus_df <- psmelt(comp_Bow_genus)

Bow_agg <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = Bow_genus_df, FUN = mean) #aggregate to Phylum level, take the mean

#Sort abundance of each genus by mean at each site
sort_genus_Bow <- Bow_agg %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_Bow

endosymbionts_Bow <- sort_genus_Bow$Genus[c(316:320, 391:395, 1901:1905, 2076:2080, 2346:2350)]
  
endo_df_Bow <- Bow_agg %>%
    mutate(Genus = fct_other(Genus, endosymbionts_Bow))

endo_agg_df_Bow<-aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = endo_df_Bow, FUN = sum)

endo_agg_df_Bow$Genus<-factor(endo_agg_df_Bow$Genus, levels=c("Other", "Buchnera", "Candidatus Cardinium", "Rickettsia", "Spiroplasma", "Wolbachia"), labels=c( "Non-endosymbionts", "Buchnera", "Candidatus Cardinium", "Rickettsia", "Spiroplasma", "Wolbachia"))

endo_agg_df_Bow$Site_code <- factor(endo_agg_df_Bow$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

endo_agg_df_Bow$sample_Family<-factor(endo_agg_df_Bow$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))

endo_plot_Bow <- ggplot(endo_agg_df_Bow, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1)+
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 22, color="black")) + 
  theme(legend.key.size = unit(0.8, "cm"),
        legend.text=element_text(size=28, face="italic"), legend.title=element_text(size=28), legend.position = "bottom") +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=30),
        axis.text.y=element_text(size=24, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=24, color="black"),
                        axis.title.x=element_text(size=30))+
  scale_fill_manual(name="Genus", values=c("honeydew4", "tan1","seagreen1", "skyblue1", "lightgoldenrod1","lightpink1"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
endo_plot_Bow


#ggsave(endo_plot_Bow, filename="Microbiome_ED/Final analysis/Relative abundance/Endosymbionts/Endosymbiont composition across sites and taxa Bow only.png", height=12, width=22)


#ACWA Streams

ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River")

endo<-subset_taxa(sample_ps, Genus=="Buchnera" | Genus=="Candidatus Cardinium" | Genus=="Rickettsia" | Genus =="Wolbachia" | Genus=="Spiroplasma")
endo<-prune_taxa(taxa_sums(endo) > 0, endo) 
endo #31 taxa 

endo_ACWA<-subset_samples(endo, Stream_Type!="Bow River")
endo_ACWA<-prune_taxa(taxa_sums(endo_ACWA) > 0, endo_ACWA) 
sort((table(tax_table(endo_ACWA)[,6]))/sum(ntaxa(endo_ACWA))*100)
#Rickettsia: 50, Wolbachia: 50
sum(sample_sums(endo_ACWA))/sum(sample_sums(ACWA_ps))*100
#Endosymbionts comprise 0.009% of the total microbiome in the Bow River (across all invertebrate types)

## Plotting relative abundance of endosymbionts versus non endosymbionts ##
ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River")

ACWA_genus <- tax_glom(ACWA_ps, taxrank = "Genus")
comp_ACWA_genus <- transform_sample_counts(ACWA_genus, function(x) x/sum(x))

ACWA_genus_df <- psmelt(comp_ACWA_genus)

ACWA_agg <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = ACWA_genus_df, FUN = mean) #aggregate to Phylum level, take the mean

#Sort abundance of each genus by mean at each site
sort_genus_ACWA <- ACWA_agg %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_ACWA

endosymbionts_ACWA <- sort_genus_ACWA$Genus[c(190:192, 235:237, 1141:1143, 1246:1248, 1408:1410)]
  
endo_df_ACWA <- ACWA_agg %>%
    mutate(Genus = fct_other(Genus, endosymbionts_ACWA))

endo_agg_df_ACWA<-aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = endo_df_ACWA, FUN = sum)

endo_agg_df_ACWA$Genus<-factor(endo_agg_df_ACWA$Genus, levels=c("Other", "Buchnera", "Candidatus Cardinium", "Rickettsia", "Spiroplasma", "Wolbachia"), labels=c("Non-endosymbionts", "Buchnera", "Candidatus Cardinium", "Rickettsia", "Spiroplasma", "Wolbachia"))

endo_agg_df_ACWA$Site_code <- factor(endo_agg_df_ACWA$Site_code, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))

endo_agg_df_ACWA$sample_Family<-factor(endo_agg_df_ACWA$sample_Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"))

endo_plot_ACWA <- ggplot(endo_agg_df_ACWA, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1)+
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 22, color="black")) + 
  theme(legend.key.size = unit(0.8, "cm"),
        legend.text=element_text(size=28, face="italic"), legend.title=element_text(size=28), legend.position = "bottom") +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=30),
        axis.text.y=element_text(size=24, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=24, color="black"),
                        axis.title.x=element_text(size=30))+
  scale_fill_manual(name="Genus", values=c("honeydew4", "tan1","seagreen1", "skyblue1", "lightgoldenrod1","lightpink1"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
endo_plot_ACWA


#ggsave(endo_plot_ACWA, filename="Microbiome_ED/Final analysis/Relative abundance/Endosymbionts/Endosymbiont composition across sites and taxa ACWA only.png", height=12, width=22)

```

```{r Endosymbiont Analysis}
#### Filtering for endosymbiont bacteria ####
tax_select(sample_ps, tax_list="Buchnera") #1 taxa.
tax_select(sample_ps, tax_list="Candidatus Cardinium") #1 taxa
tax_select(sample_ps, tax_list="Rickettsia") #58 taxa. 
tax_select(sample_ps, tax_list="Rickettsiella") #No taxa matched
tax_select(sample_ps, tax_list="Wolbachia") #10 taxa. 
tax_select(sample_ps, tax_list="Spiroplasma") #11 taxa 
tax_select(sample_ps, tax_list="Hamiltonella") #none matched
tax_select(sample_ps, tax_list="Arsenophonus") #none matched
tax_select(sample_ps, tax_list="Diplorickettsia") #1 taxa
tax_select(sample_ps, tax_list="Arsenophonus") #no taxa matched


endo<-subset_taxa(sample_ps, Genus=="Buchnera" | Genus=="Candidatus Cardinium" | Genus=="Rickettsia" | Genus =="Wolbachia" | Genus=="Spiroplasma" | Genus=="Diplorickettsia")
endo<-prune_taxa(taxa_sums(endo) > 0, endo) 
endo #31 taxa 

#Bow River

Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")

endo_Bow<-subset_taxa(Bow_ps, Genus=="Buchnera" | Genus=="Candidatus Cardinium" | Genus=="Hamiltonella" | Genus=="Rickettsia" | Genus=="Rickettsiella" | Genus =="Wolbachia" | Genus=="Spiroplasma" | Genus=="Arsenophonus"| Genus=="Diplorickettsia" | Genus=="Candidatus Hamiltonella")

endo_Bow<-prune_taxa(taxa_sums(endo_Bow) > 0, endo_Bow) 
endo_Bow #31 taxa, 284 samples

#Cochrane
endo_coch<-subset_samples(endo_Bow, Site=="Cochrane")
endo_coch<-prune_taxa(taxa_sums(endo_coch) > 0, endo_coch) 
endo_coch #23 taxa, 67 samples

sort((table(tax_table(endo_coch)[,6]))/sum(ntaxa(endo_coch))*100)


#Sunalta
endo_sun<-subset_samples(endo_Bow, Site=="Sunalta")
endo_sun<-prune_taxa(taxa_sums(endo_sun) > 0, endo_sun) 
endo_sun #23 taxa, 47 samples
#33/47 = 70.2%

sort((table(tax_table(endo_sun)[,6]))/sum(ntaxa(endo_sun))*100)

#Cushing Bridge
endo_cush<-subset_samples(endo_Bow, Site=="Cushing Bridge")
endo_cush<-prune_taxa(taxa_sums(endo_cush) > 0, endo_cush) 
endo_cush #18 taxa, 63 samples
#40/63 = 63.5

sort((table(tax_table(endo_cush)[,6]))/sum(ntaxa(endo_cush))*100)

#Graves Bridge
endo_grv<-subset_samples(endo_Bow, Site=="Graves Bridge")
endo_grv<-prune_taxa(taxa_sums(endo_grv) > 0, endo_grv) 
endo_grv #21 taxa, 47 samples
#25/47=53.2%

sort((table(tax_table(endo_grv)[,6]))/sum(ntaxa(endo_grv))*100)

#Policeman Flats
endo_pmf<-subset_samples(endo_Bow, Site=="Policeman Flats")
endo_pmf<-prune_taxa(taxa_sums(endo_pmf) > 0, endo_pmf) 
endo_pmf #20 taxa, 58 samples
#23/58=39.7%

sort((table(tax_table(endo_pmf)[,6]))/sum(ntaxa(endo_pmf))*100)


endo_agglom_Bow_all <- speedyseq::tax_glom(endo_Bow, taxrank = "Genus")
endo_rel_abun_Bow_all<- transform_sample_counts(endo_agglom_Bow_all, function(x) x/sum(x))
endo_df_Bow_all <- psmelt(endo_rel_abun_Bow_all)
sample.df.agg.endo_phy_Bow_all <- aggregate(Abundance ~ Genus + Site_code + sample_Family+Sample_ID, data = endo_df_Bow_all, FUN = mean)

#Faceted by site and invert family. Hard to see because there's not much going on.
ggplot(sample.df.agg.endo_phy_Bow_all, aes(x=Sample_ID , y=Abundance, fill=Genus)) + geom_bar(stat="identity") + 
  ylab("Mean relative abundance") +
  facet_wrap(vars(Site_code, sample_Family), scales = "free")+
  theme(strip.text = element_text(size = 8, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6, face="italic"), legend.title=element_text(size=8)) +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.text.x=element_blank(),
        #axis.text.x=element_text(angle=45, hjust=1, size=8, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Bacterial Genus", values = c(brewer.pal(12, "Paired"), "#43464B", "orange", "purple", "violetred2", "blue", "brown", "red"))+
  rremove("grid")


sample.df.agg.endo_phy_Bow_site <- aggregate(Abundance ~ Genus + Site_code +Stage, data = endo_df_Bow_all, FUN = mean)


#Just faceted by site and life stage
Bow_endoplot<-ggplot(sample.df.agg.endo_phy_Bow_site, aes(x=Site_code , y=Abundance, fill=Genus)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  facet_grid(~Stage, scales = "free_x")+
  theme(strip.text = element_text(size = 8, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6, face="italic"), legend.title=element_text(size=8)) +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=8, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=8, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Genus", values = c(brewer.pal(12, "Paired"), "#43464B", "orange", "purple", "violetred2", "blue", "brown", "red"))+
  xlab("Site")


endoplot<-ggarrange(Bow_endoplot, ACWA_endoplot, nrow=2, ncol=1, common.legend = TRUE, legend="bottom")

annotate_figure(endoplot, left = textGrob("Mean Relative Abundance", rot = 90, vjust = 1, gp = gpar(cex = 1.5)))

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/Endosymbionts/Bow River and ACWA stream endosymbionts.png", height=6, width=5, bg="white")


# Bow River insects

endo_Bow_insects<-subset_samples(endo, Stream_Type=="Bow River" & Order!="Araneae")

endo_agglom_Bow <- speedyseq::tax_glom(endo_Bow_insects, taxrank = "Genus")
endo_rel_abun_Bow<- transform_sample_counts(endo_agglom_Bow, function(x) x/sum(x))
endo_df_Bow <- psmelt(endo_rel_abun_Bow)
sample.df.agg.endo_phy_Bow <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Sample_ID, data = endo_df_Bow, FUN = mean)

#Endosymbiont genera
ggplot(sample.df.agg.endo_phy_Bow, aes(x=Sample_ID , y=Abundance, fill=Genus)) + geom_bar(stat="identity") + 
  ylab("Mean relative abundance") +
  facet_nested_wrap(~Site_code+ sample_Family, scales = "free")+
  theme(strip.text = element_text(size = 8, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6, face="italic"), legend.title=element_text(size=8)) +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.text.x=element_blank(),
        #axis.text.x=element_text(angle=45, hjust=1, size=8, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Bacterial Genus", values = c(brewer.pal(12, "Paired"), "#43464B", "orange", "purple", "violetred2", "blue", "brown", "red"))+
  rremove("grid")

#ggsave(filename="Microbiome_ED/Final analysis/Relative abundance/Endosymbionts/Relative abundance of endosymbionts across taxa type and Bow River sites.png", height=8, width=16)


#Bow River spiders
#Cochrane araneidae 
coch_aran_endo<-subset_samples(endo_Bow_spiders, Site=="Cochrane" & Family=="Araneidae")
sum(sample_sums(coch_aran_endo)) #134,417
ntaxa(coch_aran_endo) #27

sun_aran_endo<-subset_samples(endo_Bow_spiders, Site=="Sunalta" & Family=="Araneidae")
sum(sample_sums(sun_aran_endo)) #362
ntaxa(sun_aran_endo) #27

cushbr_aran_endo<-subset_samples(endo_Bow_spiders, Site=="Cushing Bridge" & Family=="Araneidae")
sum(sample_sums(cushbr_aran_endo)) #482
ntaxa(cushbr_aran_endo)

grvbr_aran_endo<-subset_samples(endo_Bow_spiders, Site=="Graves Bridge" & Family=="Araneidae")
sum(sample_sums(grvbr_aran_endo)) #895

pmf_aran_endo<-subset_samples(endo_Bow_spiders, Site=="Policeman Flats" & Family=="Araneidae")
sum(sample_sums(pmf_aran_endo)) #2583

endo_Bow_spiders<-subset_samples(endo_Bow, Stream_Type=="Bow River" & Order=="Araneae")
endo_Bow_spiders<-prune_taxa(taxa_sums(endo_Bow_spiders)>0, endo_Bow_spiders)

endo_agglom_spi <- speedyseq::tax_glom(endo_Bow_spiders, taxrank = "Genus")
endo_rel_abun_spi<- transform_sample_counts(endo_agglom_spi, function(x) x/sum(x))
endo_df_spi <- psmelt(endo_rel_abun_spi)
sample.df.agg.endo_phy_spi <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Sample_ID, data = endo_df_spi, FUN = mean)

#Endosymbiont genera
ggplot(sample.df.agg.endo_phy_spi, aes(x=Sample_ID , y=Abundance, fill=Genus)) + geom_bar(stat="identity") + 
  ylab("Mean relative abundance") +
  facet_wrap(vars(Site_code, sample_Family), scales = "free")+
  theme(strip.text = element_text(size = 8, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6, face="italic"), legend.title=element_text(size=8)) +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.text.x=element_blank(),
        #axis.text.x=element_text(angle=45, hjust=1, size=8, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Bacterial Genus", values = c(brewer.pal(12, "Paired"), "#43464B", "orange", "purple", "violetred2", "blue", "brown", "red"))+
  rremove("grid")+
  facet_nested_wrap(~Site_code + sample_Family, nrow=3, scales="free")



#Tetragnathidae
tetraendo<-subset_samples(endo, Family=="Tetragnathidae")
tetraendo<-prune_taxa(taxa_sums(tetraendo) > 0, tetraendo)
tetraendo #25 taxa, 40 samples

tetraagglom<-speedyseq::tax_glom(tetraendo, taxrank = "Genus")
tetraendo_rel_abun<- transform_sample_counts(tetraagglom, function(x) x/sum(x))
tetraendo_df <- psmelt(tetraendo_rel_abun)
sample.df.agg.tetraendo <- aggregate(Abundance ~ Phylum + Family+ Genus + Site  + Order, data = tetraendo_df, FUN = mean)

ggplot(sample.df.agg.tetraendo, aes(x=Site, y=Abundance, fill=Genus)) + geom_bar(stat="identity") + 
  ylab("Mean relative abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Bacterial Phylum", values = c(brewer.pal(12, "Paired"), "#43464B", "orange", "purple", "violetred2", "blue", "brown", "red"))+
  rremove("grid")
#Wolbachia is low at Cochrane and increases at Sunalta. Policeman Flats has increase in spiroplasma relative to other sites

#Araneidae
aranendo<-subset_samples(endo, Family=="Araneidae")
aranendo<-prune_taxa(taxa_sums(aranendo) > 0, aranendo)
aranendo #20 taxa, 37 samples

aranagglom<-speedyseq::tax_glom(aranendo, taxrank = "Genus")
aranendo_rel_abun<- transform_sample_counts(aranagglom, function(x) x/sum(x))
aranendo_df <- psmelt(aranendo_rel_abun)
sample.df.agg.aranendo <- aggregate(Abundance ~ Phylum + Family+ Genus + Site  + Order, data = aranendo_df, FUN = mean)

ggplot(sample.df.agg.aranendo, aes(x=Site, y=Abundance, fill=Genus)) + geom_bar(stat="identity") + 
  ylab("Mean relative abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Bacterial Phylum", values = c(brewer.pal(12, "Paired"), "#43464B", "orange", "purple", "violetred2", "blue", "brown", "red"))+
  rremove("grid")

#Sunalta has much lower Wolbachia and increase in Rickettsia. Graves Bridge has presence of Buchnera. Cochrane and Policeman Flats look very similar in endosymbiont composition. 



#ACWA

ACWA_ps<-subset_samples(sample_ps, Stream_Type!="Bow River")

endo_ACWA<-subset_taxa(ACWA_ps, Genus=="Buchnera" | Genus=="Candidatus Cardinium" | Genus=="Hamiltonella" | Genus=="Rickettsia" | Genus=="Rickettsiella" | Genus =="Wolbachia" | Genus=="Spiroplasma" | Genus=="Arsenophonus"| Genus=="Diplorickettsia")

endo_ACWA<-prune_taxa(taxa_sums(endo_ACWA) > 0, endo_ACWA) 
endo_ACWA #4 taxa, 55 samples

sort(table(tax_table(endo_ACWA)[,6])) #only Rickettsia and Wolbachia

endo_BRR2<-subset_samples(endo_ACWA, Site=="BRR2")
endo_BRR2<-prune_taxa(taxa_sums(endo_BRR2) > 0, endo_BRR2) 
endo_BRR2 #1 taxa

sort((table(tax_table(endo_BRR2)[,6]))/sum(ntaxa(endo_BRR2))*100)

endo_PCR1<-subset_samples(endo_ACWA, Site=="PCR1")
endo_PCR1<-prune_taxa(taxa_sums(endo_PCR1) > 0, endo_PCR1) 
endo_PCR1 #4 taxa

sort((table(tax_table(endo_PCR1)[,6]))/sum(ntaxa(endo_PCR1))*100)

endo_PCR3<-subset_samples(endo_ACWA, Site=="PCR3")
endo_PCR3<-prune_taxa(taxa_sums(endo_PCR3) > 0, endo_PCR3) 
endo_PCR3 #2 taxa

sort((table(tax_table(endo_PCR3)[,6]))/sum(ntaxa(endo_PCR3))*100)

endo_agglom_ACWA <- speedyseq::tax_glom(endo_ACWA, taxrank = "Genus")
endo_rel_abun_ACWA<- transform_sample_counts(endo_agglom_ACWA, function(x) x/sum(x))
endo_df_ACWA <- psmelt(endo_rel_abun_ACWA)
sample.df.agg.endo_phy_ACWA <- aggregate(Abundance ~ Genus + Site_code + Stage, data = endo_df_ACWA, FUN = mean)

#Endosymbiont genera
ACWA_endoplot<-ggplot(sample.df.agg.endo_phy_ACWA, aes(x=Site_code , y=Abundance, fill=Genus)) + geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  xlab("ACWA Stream")+
  theme_bw()+
  facet_grid(~Stage, scales="free_x")+
  #facet_wrap(vars(Stage, Site_code), scales = "free")+
  theme(strip.text = element_text(size = 8, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6, face="italic"), legend.title=element_text(size=8)) +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=8, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=8, color="black"),
                        axis.title=element_text(size=14))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Genus", values = c("#CBF0A6", "#FEA1B3"))+
  rremove("grid")



#ACWA streams

endo_ACWA<-subset_samples(endo, Stream_Type!="Bow River")
endo_ACWA<-prune_taxa(taxa_sums(endo_ACWA)>0, endo_ACWA)

endo_agglom_ACWA <- speedyseq::tax_glom(endo_ACWA, taxrank = "Genus")
endo_rel_abun_ACWA<- transform_sample_counts(endo_agglom_ACWA, function(x) x/sum(x))
endo_df_ACWA <- psmelt(endo_rel_abun_ACWA)
sample.df.agg.endo_phy_ACWA <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Sample_ID, data = endo_df_ACWA, FUN = mean)

#Endosymbiont genera
ggplot(sample.df.agg.endo_phy_ACWA, aes(x=Sample_ID , y=Abundance, fill=Genus)) + geom_bar(stat="identity") + 
  ylab("Mean relative abundance") +
  facet_wrap(vars(Site_code, sample_Family), scales = "free")+
  theme(strip.text = element_text(size = 8, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=6, face="italic"), legend.title=element_text(size=8)) +
  guides(fill=guide_legend(nrow=1)) +
  theme(axis.title.y=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.text.x=element_text(angle=45, hjust=1, size=8, color="black"),
                        axis.title=element_text(size=18))+
  scale_y_continuous(label = scales::percent)+
  scale_fill_manual(name="Bacterial Genus", values = c(brewer.pal(12, "Paired"), "#43464B", "orange", "purple", "violetred2", "blue", "brown", "red"))+
  rremove("grid")

```

```{r Statistically testing the difference in endosymbiont relative abundance}

#First transform the endosymbiont phyloseq data to a dataframe as we did with all the rel. abund. data

#Metadata

sample_data_endo<-as.data.frame(sample_data(endo))
row_names_endo<-row.names(sample_data_endo) 
sample_data_endo_1<-cbind(row_names_endo, sample_data_endo)
sample_data_endo_1<-sample_data_endo_1 %>% dplyr::rename(Study_ID = row_names_endo)
sample_data_endo_2<-sample_data_endo_1[ , c("Study_ID",  "Site", "Family", "Stream_Type")]
sample_data_endo_3<-sample_data_endo_2 %>% dplyr::rename(sample_Family = Family)
sample_data_endo_4<-sample_data_endo_3 %>% drop_na(Site, sample_Family)


#ASV table from filtered phyloseq
ASVseq_endo<- as.data.frame(otu_table(endo))
Sequences<-row.names(ASVseq_endo) 
ASVseq_endo_1<-cbind(Sequences, ASVseq_endo)
 
ASVseq_endo_2<-ASVseq_endo_1 %>% pivot_longer(-Sequences, names_to="Study_ID", values_to = "count")

#Taxonomy table
taxonomy_endo<-as.data.frame(tax_table(endo)) %>% rownames_to_column(var="Sequences")

nseqs_per_sample_endo <- ASVseq_endo_2 %>%
  dplyr::group_by(Study_ID) %>%
  dplyr::summarize(N = sum(count), .groups="drop") %>% 
  dplyr::count(N) %>%
  dplyr::pull(N)

lod_endo <- 100* 1/max(nseqs_per_sample_endo) #Determines the limit of detection (0.000449)

metadata_endo_Bow<-subset(sample_data_endo_4, Stream_Type=="Bow River")

otu_rel_abund_endo_Bow <- dplyr::inner_join(ASVseq_endo_2, metadata_endo_Bow, by="Study_ID") %>%
  dplyr::inner_join(., taxonomy_endo, by="Sequences") %>% #joins taxonomy, abundances, and metadata
  dplyr::group_by(Study_ID) %>%
  dplyr::mutate(rel_abund = count / sum(count)) %>% #transforms to relative abundance
  dplyr::ungroup() %>%
  dplyr::select(-count) %>%
  pivot_longer(
    c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "Sequences"),
    names_to="level",
    values_to="taxon") 

#Genus
taxon_rel_abund_Genus_endo_Bow <- otu_rel_abund_endo_Bow %>%
  dplyr::filter(level=="Genus") %>%
  dplyr::group_by(Site, sample_Family, Study_ID, taxon) %>%
  dplyr::summarize(rel_abund = 100*sum(rel_abund), .groups="drop") %>%
  drop_na(Site, sample_Family, taxon)

taxon_pool_Genus_endo_Bow <- taxon_rel_abund_Genus_endo_Bow %>%
  dplyr::group_by(Site, sample_Family, taxon) %>%
  dplyr::summarize(median=median(rel_abund), .groups="drop") %>%
  dplyr::group_by(taxon) %>%
  dplyr::summarize(pool = max(median) < 0,
            median = median(median),
            .groups="drop")

#Graphing pointrange plot with median and 50% quartiles
Genus_endo_Bow_graphing_df<- dplyr::inner_join(taxon_rel_abund_Genus_endo_Bow, taxon_pool_Genus_endo_Bow, by="taxon") %>%
 dplyr::mutate(taxon = if_else(pool, "Other", taxon)) %>%
  dplyr::group_by(Study_ID, Site, sample_Family, taxon) %>%
  dplyr::summarize(rel_abund = sum(rel_abund),
            median = min(median),
            .groups="drop") %>%
  dplyr::mutate(taxon = factor(taxon),
         taxon = fct_reorder(taxon, median, .desc=T)) %>%
  dplyr::mutate(rel_abund = if_else(rel_abund == 0,
                             2/3 * lod,
                             rel_abund))
Genus_endo_Bow_graphing_df



```

# Wastewater associated bacteria 

```{r}
#### Filtering for wastewater effluent-associated bacteria and potential pathogens ####

#First aggregate by genus and see how many we have. 
genus_all <- tax_glom(sample_ps, taxrank = "Genus")
genus_all #493 genera

rel_abun_genus_all <- transform_sample_counts(genus_all, function(x) x/sum(x))

genus_df_all <- psmelt(rel_abun_genus_all)

agg_all <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = genus_df_all, FUN = mean) #aggregate to Phylum level, take the mean

#Sort abundance of each genus by mean at each site
sort_genus_all <- agg_all %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_all

# Researched all genera on Google Scholar to see if they were wastewater associated #
# Achromobacter - Jin et al., (2015). Int. J. Environ. Res. Public Health. Kundu et al., (2011). Bioprocess and Biosystems Engineering. 
# Acidovorax - Wang et al., (2009). Water Science and Technology. Heylen et al., (2008). Int. J. Sys. Evol. Biology. 
# Acinetobacter - Higgins et al., (2018). Water Research. Liu et al., (2017). Bioresource Technology. 
# Aeromonas - Harnisz and Korzeniewska, (2018). Sci. Total Environ. Figueira et al., (2011). Water Research. 
# Afipia - Zhang et al., (2009). FEMS Microbiology. Kim et al., (2014). J. Microbiol. Biotechnol.
# Ahniella - Tang et al., (2023). Environ. Research. 
# Alcaligenes (faecalis or aquatilis) - Joo et al., (2006). Water Research. Cao et al., (2022). Bioresource Technol. 
# Amaricoccus - Maszenan et al., (2000). J Appl. Microbiology. Maszenan et al., (1997). INT. J. SYST. BACTERIology.
#Anaerocella - Yan et al., (2021). Environ. Science and Pollution Research. Abe et al., (2012). J Gen. Appl. Microbiol.
#Anaerovorax - Zhu et al., (2018). Biochem Engineering J. Chu et al., (2021). Environ. Science and Pollut. research. 
#	Arenimonas - Liu et al., (2018). Int J Microbiol. Research. Feng et al., (2022). J Water Process eng.
#Arthrobacter - Roh et al., (2008). J Microbiol. Agunbiade et al., (2017). BMC Biotechn. 
#Bacillus - Ertugrul et al., (2007). J Hazardous Mater. Deng et al., (2003). App. Microbiol. and biotech.
#Bacteroides - Srinivasan et al., (2011). Water Research. Niestpski et al., (2020). J Hazardous Mat. 
# Barnesiella - Morotomi et al., (2008). Int J Microbol. Research.
#Blastocatella - Ouyang et al., (2017). Environ. Technol. Huang et al., (2017). Bioresource Technol.
#	Blautia - Cai & Zhang (2014). Appl. Microbiol. and biotechnol.
#Bordetella - Sanuth et al., (2013). Indian J Microbiol. Awad et al., (2022). Sci total environ.
#Bosea - Lee et al., (2017). Kor. J. Fisheries. Aquat. Sci.
#Brevundimonas - Ryu et al., (2007). Int. J. Sys. Evol. Biology. Sforza et al., (2018). Bioresource Technol. 
#Candidatus Accumulibacter - He & McMahon, 2011. Microbial biotechnology. 
#Candidatus Competibacter - Rubio-Rincon et al., (2017). Water Research.
#Candidatus Contendobacter - Zhou et al., (2023). Int. Biodeterioration and biodegredation.
#Candidatus Microthrix - Blackall et al., (1996). Int J Sys Evol Microbiology
#Candidatus Nitrotoga - Zheng et al., (2021). Environ Sci Tech
#Cetobacterium - Wang et al., 2022. Ecotox.  Environ. safety
#Chitinivorax - Begmatov et al., (2022). Scientific reports. 
#Chryseobacterium - Kundu et al., (2014). Biomed research. Kamper et al., (2003). Int. J Sys. Evol Microbiology
#Chthoniobacter - Feng et al., (2020). Bioresource technol.
#Citrobacter - Owoseni and Okoh, (2017). Environ monitroing assessment. 
#	Cloacibacterium - Allen et al., (2006). Int J Sys Evol Microbiology
#Clostridium sensu stricto 1 - Wang et al., (2003). J Biotechnol. 
#	Clostridium sensu stricto 13 - Yin et al., (2021). Int J Hydro Energy
#Comamonas - Gumaelius et al., (2001). Int J Sys Evol biology
#Corynebacterium - Liu et al., (2023). Front. Bioengineer. biotechnol. 
#Curtobacterium - Li et al., (2021). Sci total environ.
#Curvibacter - Zielinska et al., 2016. Environ. technol.
#	Cytophaga - Manz et al., 1994. Water research.
#Dechloromonas - Mcllroy et al., (2016). Environ. Microbiology
#Defluviicoccus - Maszenan et al., (2022). Water Research. Burow et al., (2007). Microbiology research.
#Delftia - Shigematsu et al., (2003). Int. J Sys. Evol. Microbiology
#Desulfatirhabdium - Balk et al., (2008). Int. J Sys. Evol. Micro
#Desulfobacca - oude Elferink et al., (1999). Int. J Sys. Evol. Micro
#Desulfobulbus - Houari et al., (2017). Int. J Sys. Evol. Micro
#Desulfoprunum - Junghare et al., (2015). Int. J Sys. Evol. Micro
#Desulfosporosinus - Houari et al., (2020). Processes
#Ellin6067 - Feng et al., (2022). J Water Process engineering
#Enterococcus - Tauer-Kapteijn et al., (2017). Delft University of Technology.
#Erysipelothrix - Ma et al., (2023). J. Environ. Manage.
#	Escherichia-Shigella - Yang et al., (2021). J Cleaner Product.
#Faecalibacterium - Wery et al., (2010). Water research.
#Ferruginibacter - Wijaya et al., (2023). Environ. Research. 
#Flavobacterium sasangense - Yoon et al., (2009).  Int. J Sys. Evol. Micro.
#Flavobacterium anseonense - Chen et al., (2019). Water.
#Fusicatenibacter - Takada et al., (2013). Int. J. Sys. Evol. Micro.
#Haliangium - Mcllroy et al., (2016). Environ. Micro.
#Haliscomenobacter - Van Veen et al., (1973). Antonie van Leeuwenhoek
#Halomonas - Li et al., (2023). Environ. Sci. Pollut.
#Hydrogenophaga - Kampfer et al., (2005). Int. J. Sys. Evol. Micro
#Hyphomicrobium - Leyton et al., (2000). Appl. Environ. Microbiology
#Ideonella - Kraigher et al., (2008). Water Research
#Inhella - Zeng et al., (2019). Environ. Engin. research
#Intestinibacter - Major et al., (2022). Waste Management. 

effluent_bac<-subset_taxa(sample_ps, Genus=="Achromobacter" | Genus=="Acidovorax" | Genus=="Acinetobacter"| Genus=="Aeromonas" | Genus=="Ahniella" | Genus=="Alcaligenes" | Genus=="Amaricoccus" | Genus=="Anaerocella" | Genus=="Anaerovorax" | Genus=="Arenimonas" | Genus=="Arthrobacter" | Genus=="Bacillus" | Genus == "Barnesiella" | Genus=="Blastocatella" | Genus=="Blautia" | Genus=="Bordetella" | Genus=="Bosea" | Genus=="Brevundimonas" | Genus=="Candidatus Accumulibacter" | Genus=="Candidatus Competibacter" | Genus=="Candidatus Contendobacter" | Genus=="Candidatus Microthrix" | Genus=="Candidatus Nitrotoga" | Genus=="Cetobacterium" | Genus =="Chitinivorax" | Genus=="Chryseobacterium" | Genus=="Chthoniobacter" | Genus=="Citrobacter" | Genus=="Cloacibacterium" | Genus=="Clostridium sensu stricto 1" | Genus=="Clostridium sensu stricto 13" | Genus=="Clostridium sensu stricto 5" | Genus=="Corynebacterium" | Genus=="Curtobacterium" | Genus=="Curvibacter" | Genus=="Cytophaga" | Genus=="Dechloromonas" | Genus=="Defluviicoccus" | Genus=="Delftia" | Genus=="Desulfatirhabdium" | Genus=="Desulfobacca" | Genus=="Desulfobulbus" | Genus=="Desulfoprunum" | Genus=="Desulfosporosinus" | Genus=="Ellin6067" | Genus=="Enterococcus" | Genus=="Erysipelothrix" | Genus=="Escherichia-Shigella" | Genus=="Faecalibacterium" | Genus=="Ferruginibacter" | Species=="sasangense" | Species=="anseonense" | Genus=="Fusicatenibacter" | Genus=="Haliangium" | Genus=="Haliscomenobacter" | Genus=="Halomonas" | Genus=="Hydrogenophaga" | Genus=="Hyphomicrobium" | Genus=="Ideonella" | Genus=="Inhella" | Genus=="Intestinibacter")
effluent_bac<-prune_samples(sample_sums(effluent_bac) > 0, effluent_bac) 
effluent_bac #95 taxa 305 samples

sort(table(tax_table(effluent_bac)[,6])) #18 Genera
X<-subset_taxa(sample_ps, Genus=="Hyphomicrobium")
sort(table(tax_table(X)[,7])) #28 species

#Cochrane
effluent_coch<-subset_samples(effluent_bac, Site=="Cochrane")
effluent_coch<-prune_taxa(taxa_sums(effluent_coch) > 0, effluent_coch) 
effluent_coch #57 taxa, 61 samples 

sort((table(tax_table(effluent_coch)[,6]))/ntaxa(effluent_coch))*100
#Sphingomonas (17.5%), Blautia (17.5%), Streptococcus (12.3%)

#Hydropsychidae larvae

nsamples(hydro_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Hydropsychidae")) #8

eff_hydro_coch<-subset_samples(effluent_coch, Family=="Hydropsychidae")
eff_hydro_coch<-prune_taxa(taxa_sums(eff_hydro_coch) > 0, eff_hydro_coch) 
eff_hydro_coch #10 taxa, 8/8 samples = 100% prevalence

sample_sums(eff_hydro_coch) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_hydro_coch)[,6]))/ntaxa(eff_hydro_coch))*100
#Terrimonas (30%), Runella (20%), Sphingomonas (10%)

#Heptageniidae larvae
nsamples(hep_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Heptageniidae")) #8

eff_hep_coch<-subset_samples(effluent_coch, Family=="Heptageniidae")
eff_hep_coch<-prune_taxa(taxa_sums(eff_hep_coch) > 0, eff_hep_coch) 
eff_hep_coch #18 taxa, 8/8 samples = 100% prevalence

sample_sums(eff_hep_coch) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_hep_coch)[,6]))/ntaxa(eff_hep_coch))*100
#Sphingomonas (27.8%), Runella (16.7%), Terrimonas (11.1%)

#Chironomidae larvae 
nsamples(chiro_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Chironomidae")) #5

eff_chiro_coch<-subset_samples(effluent_coch, Family=="Chironomidae")
eff_chiro_coch<-prune_taxa(taxa_sums(eff_chiro_coch) > 0, eff_chiro_coch) 
eff_chiro_coch #6 taxa, 5/5 samples = 100% prevalence

sample_sums(eff_chiro_coch) #Present in all 5 samples (100% prevalence)

sort((table(tax_table(eff_chiro_coch)[,6]))/ntaxa(eff_chiro_coch))*100
#Sphingomonas (33.3%), Romboutsia (33.3%), Terrimonas (16.7%)

#Perlidae larvae 
nsamples(hydro_perl<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Perlidae")) #8

eff_perl_coch<-subset_samples(effluent_coch, Family=="Perlidae")
eff_perl_coch<-prune_taxa(taxa_sums(eff_perl_coch) > 0, eff_perl_coch) 
eff_perl_coch #10 taxa, 8 samples

sample_sums(eff_perl_coch) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_perl_coch)[,6]))/ntaxa(eff_perl_coch))*100
#Runella (50), Sphingomonas (20), Romboutsia (10)

#Trichoptera
nsamples(trichop_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Trichoptera")) #8

eff_trichop_coch<-subset_samples(effluent_coch, Family=="Trichoptera")
eff_trichop_coch<-prune_taxa(taxa_sums(eff_trichop_coch) > 0, eff_trichop_coch) 
eff_trichop_coch #13 taxa, 6 samples = 75 %

sample_sums(eff_trichop_coch) #Present in all 6 samples (100% prevalence)

sort((table(tax_table(eff_trichop_coch)[,6]))/ntaxa(eff_trichop_coch))*100
#Sphingomonas (53.8%), Terrimonas (15.4%), Streptococcus (7.69%)

#Ephemeroptera 
nsamples(ephem_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Ephemeroptera")) #8

eff_ephem_coch<-subset_samples(effluent_coch, Family=="Ephemeroptera")
eff_ephem_coch<-prune_taxa(taxa_sums(eff_ephem_coch) > 0, eff_ephem_coch) 
eff_ephem_coch #14 taxa, 8 samples

sample_sums(eff_ephem_coch) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_ephem_coch)[,6]))/ntaxa(eff_ephem_coch))*100
#Streptococcus (28.6), Sphingomonas (21.4%), Ruminococcus (14.3)

#Diptera
nsamples(dip_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Diptera")) #8

eff_dip_coch<-subset_samples(effluent_coch, Family=="Diptera")
eff_dip_coch<-prune_taxa(taxa_sums(eff_dip_coch) > 0, eff_dip_coch) 
eff_dip_coch #19 taxa, 6 samples= 75%

sample_sums(eff_dip_coch) #Present in all 6 samples (100% prevalence)

sort((table(tax_table(eff_dip_coch)[,6]))/ntaxa(eff_dip_coch))*100
#Blautia (42.1%), Ruminococcus (15.8%), Streptococcus (10.5%)

#Araneidae
nsamples(aran_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Araneidae")) #8

eff_aran_coch<-subset_samples(effluent_coch, Family=="Araneidae")
eff_aran_coch<-prune_taxa(taxa_sums(eff_aran_coch) > 0, eff_aran_coch) 
eff_aran_coch #22 taxa, 8 samples

sample_sums(eff_aran_coch) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_aran_coch)[,6]))/ntaxa(eff_aran_coch))*100
#Blautia (45.5%), Streptococcus (18.2%), Sphingomonas (13.6%)


#Tetragnathidae
nsamples(tetra_coch<-subset_samples(sample_ps, Site=="Cochrane" & Family=="Tetragnathidae")) #8

eff_tetra_coch<-subset_samples(effluent_coch, Family=="Tetragnathidae")
eff_tetra_coch<-prune_taxa(taxa_sums(eff_tetra_coch) > 0, eff_tetra_coch) 
eff_tetra_coch #14 taxa, 4 samples

sample_sums(eff_tetra_coch) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_tetra_coch)[,6]))/ntaxa(eff_tetra_coch))*100
#Blautia (35.7%), Streptococcus (21.4%), Ruminococcus (14.3)


## Sunalta ## 

effluent_sun<-subset_samples(effluent_bac, Site=="Sunalta")
effluent_sun<-prune_taxa(taxa_sums(effluent_sun) > 0, effluent_sun) 
effluent_sun #50 taxa, 39 samples/47 = 83.0 %

sort((table(tax_table(effluent_sun)[,6]))/sum(ntaxa(effluent_sun))*100)

#Hydropsychidae larvae

nsamples(hydro_sun<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Hydropsychidae")) #7

eff_hydro_sun<-subset_samples(effluent_sun, Family=="Hydropsychidae")
eff_hydro_sun<-prune_taxa(taxa_sums(eff_hydro_sun) > 0, eff_hydro_sun) 
eff_hydro_sun #5 taxa, 7 samples = 100% prevalence

sample_sums(eff_hydro_sun) #Present in all 7 samples (100% prevalence)

sort((table(tax_table(eff_hydro_sun)[,6]))/ntaxa(eff_hydro_sun))*100
#Runella (60), Romboutsia (20), Haliangium (20)

#Heptageniidae larvae
nsamples(hep_sun<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Heptageniidae")) #8


eff_hep_sun<-subset_samples(effluent_sun, Family=="Heptageniidae")
eff_hep_sun<-prune_taxa(taxa_sums(eff_hep_sun) > 0, eff_hep_sun) 
eff_hep_sun #21 taxa, 7 samples 

sort((table(tax_table(eff_hep_sun)[,6]))/ntaxa(eff_hep_sun))*100
#Blautia (28.6), Runella (19.0), Streptococcus (9.52)

#Trichoptera
nsamples(trichop_sun<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Trichoptera")) #8


eff_trichop_sun<-subset_samples(effluent_sun, Family=="Trichoptera")
eff_trichop_sun<-prune_taxa(taxa_sums(eff_trichop_sun) > 0, eff_trichop_coch) 
eff_trichop_sun #50 taxa, 7 samples

sample_sums(eff_trichop_coch) #Present in all 6 samples (100% prevalence)

sort((table(tax_table(eff_trichop_sun)[,6]))/ntaxa(eff_trichop_sun))*100
#Sphingomonas (18%), Blautia (18), Streptococcus (14%)

#Ephemeroptera 
nsamples(ephem_sun<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Ephemeroptera")) #8


eff_ephem_sun<-subset_samples(effluent_sun, Family=="Ephemeroptera")
eff_ephem_sun<-prune_taxa(taxa_sums(eff_ephem_sun) > 0, eff_ephem_sun) 
eff_ephem_sun #17 taxa, 7 samples

sample_sums(eff_ephem_coch) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_ephem_sun)[,6]))/ntaxa(eff_ephem_sun))*100
#Streptococcus (23.5), Sphingomonas (11.8), Sediminibacterium (11.8)

#Araneidae
nsamples(aran_sun<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Araneidae")) #8


eff_aran_sun<-subset_samples(effluent_sun, Family=="Araneidae")
eff_aran_sun<-prune_taxa(taxa_sums(eff_aran_sun) > 0, eff_aran_sun) 
eff_aran_sun #27 taxa, 8 samples

sample_sums(eff_aran_sun) #Present in all 8 samples (100% prevalence)

sort((table(tax_table(eff_aran_sun)[,6]))/ntaxa(eff_aran_sun))*100
#Blautia (29.6%), Sphingomonas (25.9%), Streptococcus (14.8)


#Tetragnathidae
nsamples(tetra_sun<-subset_samples(sample_ps, Site=="Sunalta" & Family=="Tetragnathidae")) #8


eff_tetra_sun<-subset_samples(effluent_sun, Family=="Tetragnathidae")
eff_tetra_sun<-prune_taxa(taxa_sums(eff_tetra_sun) > 0, eff_tetra_sun) 
eff_tetra_sun #4 taxa, 3 samples

sort((table(tax_table(eff_tetra_sun)[,6]))/ntaxa(eff_tetra_sun))*100
#Blautia (50%), Ruminococcus (25%), Romboutsia (25)


## Cushing Bridge ##
effluent_cush<-subset_samples(effluent_bac, Site=="Cushing Bridge")
effluent_cush<-prune_taxa(taxa_sums(effluent_cush) > 0, effluent_cush) 
effluent_cush #67 taxa, 52 samples/63 = 84.1 %

sort((table(tax_table(effluent_cush)[,6]))/sum(ntaxa(effluent_cush))*100)

#Hydropsychidae larvae
nsamples(hydro_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Hydropsychidae")) #5


eff_hydro_cush<-subset_samples(effluent_cush, Family=="Hydropsychidae")
eff_hydro_cush<-prune_taxa(taxa_sums(eff_hydro_cush) > 0, eff_hydro_cush) 
eff_hydro_cush #5 taxa, 5 samples = 100% prevalence

sort((table(tax_table(eff_hydro_cush)[,6]))/ntaxa(eff_hydro_cush))*100
#Terrimonas (20%), Runella (40%), Haliangium (20%)

#Heptageniidae larvae
nsamples(hep_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Heptageniidae")) #8


eff_hep_cush<-subset_samples(effluent_cush, Family=="Heptageniidae")
eff_hep_cush<-prune_taxa(taxa_sums(eff_hep_cush) > 0, eff_hep_cush) 
eff_hep_cush #14 taxa, 7 samples 

sort((table(tax_table(eff_hep_cush)[,6]))/ntaxa(eff_hep_cush))*100
#Sphingomonas (14.3%), Runella (14.3%), Romboutsia (14.3%)

#Chironomidae larvae 
nsamples(chiro_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Chironomidae")) #6


eff_chiro_cush<-subset_samples(effluent_cush, Family=="Chironomidae")
eff_chiro_cush<-prune_taxa(taxa_sums(eff_chiro_cush) > 0, eff_chiro_cush) 
eff_chiro_cush #7 taxa, 4 samples

sort((table(tax_table(eff_chiro_cush)[,6]))/ntaxa(eff_chiro_cush))*100
#Streptococcus (28.6), Zoogloea (14.3), Terrimonas (14.3). 

#Perlidae larvae 
nsamples(perl_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Perlidae")) #5


eff_perl_cush<-subset_samples(effluent_cush, Family=="Perlidae")
eff_perl_cush<-prune_taxa(taxa_sums(eff_perl_cush) > 0, eff_perl_cush) 
eff_perl_cush #14 taxa, 5 samples


sort((table(tax_table(eff_perl_cush)[,6]))/ntaxa(eff_perl_cush))*100
#Runella (35.7), Sphingomonas (28.6), Trichococcus (7.14)

#Trichoptera
nsamples(trichop_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Trichoptera")) #8


eff_trichop_cush<-subset_samples(effluent_cush, Family=="Trichoptera")
eff_trichop_cush<-prune_taxa(taxa_sums(eff_trichop_cush) > 0, eff_trichop_cush) 
eff_trichop_cush #26 taxa, 6 samples


sort((table(tax_table(eff_trichop_cush)[,6]))/ntaxa(eff_trichop_cush))*100
#Spingomonas (34.6), streptococcus (15.4), Pseudomonas (15.4)

#Ephemeroptera 
nsamples(ephem_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Ephemeroptera")) #8


eff_ephem_cush<-subset_samples(effluent_cush, Family=="Ephemeroptera")
eff_ephem_cush<-prune_taxa(taxa_sums(eff_ephem_cush) > 0, eff_ephem_cush) 
eff_ephem_cush #13 taxa, 3 samples

sort((table(tax_table(eff_ephem_cush)[,6]))/ntaxa(eff_ephem_cush))*100
#Streptococcus (23.1), Sphingomonas (23.1), Pseudomonas (23.1)

#Diptera
nsamples(dip_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Diptera")) #8


eff_dip_cush<-subset_samples(effluent_cush, Family=="Diptera")
eff_dip_cush<-prune_taxa(taxa_sums(eff_dip_cush) > 0, eff_dip_cush) 
eff_dip_cush #16 taxa, 8 samples

sort((table(tax_table(eff_dip_cush)[,6]))/ntaxa(eff_dip_cush))*100
#Pseudomonas (31.3), Blautia (25.0), Sphingomonas (18.8)

#Araneidae
nsamples(aran_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Araneidae")) #7


eff_aran_cush<-subset_samples(effluent_cush, Family=="Araneidae")
eff_aran_cush<-prune_taxa(taxa_sums(eff_aran_cush) > 0, eff_aran_cush) 
eff_aran_cush #26 taxa, 7 samples

sort((table(tax_table(eff_aran_cush)[,6]))/ntaxa(eff_aran_cush))*100
#Blautia (30.8%), Streptococcus (19.2%), Sphingomonas (15.4%)


#Tetragnathidae
nsamples(tetra_cush<-subset_samples(sample_ps, Site=="Cushing Bridge" & Family=="Tetragnathidae")) #8


eff_tetra_cush<-subset_samples(effluent_cush, Family=="Tetragnathidae")
eff_tetra_cush<-prune_taxa(taxa_sums(eff_tetra_cush) > 0, eff_tetra_cush) 
eff_tetra_cush #21 taxa, 7 samples

sort((table(tax_table(eff_tetra_cush)[,6]))/ntaxa(eff_tetra_cush))*100
#Sphingomonas (33.3), Blautia (33.3), Ruminococcus (14.3)

## Graves Bridge ##

effluent_grv<-subset_samples(effluent_bac, Site=="Graves Bridge")
effluent_grv<-prune_taxa(taxa_sums(effluent_grv) > 0, effluent_grv) 
effluent_grv #52 taxa, 40 samples/47 = 72.3 %

sort((table(tax_table(effluent_grv)[,6]))/sum(ntaxa(effluent_grv))*100)

#Hydropsychidae larvae
nsamples(hydro_grv<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Hydropsychidae")) #8


eff_hydro_grv<-subset_samples(effluent_grv, Family=="Hydropsychidae")
eff_hydro_grv<-prune_taxa(taxa_sums(eff_hydro_grv) > 0, eff_hydro_grv) 
eff_hydro_grv #10 taxa, 8 samples =100% prev

sort((table(tax_table(eff_hydro_grv)[,6]))/ntaxa(eff_hydro_grv))*100
#Terrimonas (50%), Runella (20%), Sphingomonas (10%)

#Heptageniidae larvae
nsamples(hep_grv<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Heptageniidae")) #8


eff_hep_grv<-subset_samples(effluent_grv, Family=="Heptageniidae")
eff_hep_grv<-prune_taxa(taxa_sums(eff_hep_grv) > 0, eff_hep_grv) 
eff_hep_grv #18 taxa, 8 samples 

sort((table(tax_table(eff_hep_grv)[,6]))/ntaxa(eff_hep_grv))*100
#Sphingomonas (16.7%), Sediminibacterium (16.7), Trichococcus (11.1)

#Trichoptera
nsamples(trichop_grv<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Trichoptera")) #7


eff_trichop_grv<-subset_samples(effluent_grv, Family=="Trichoptera")
eff_trichop_grv<-prune_taxa(taxa_sums(eff_trichop_grv) > 0, eff_trichop_grv) 
eff_trichop_grv #21 taxa, 7 samples


sort((table(tax_table(eff_trichop_grv)[,6]))/ntaxa(eff_trichop_grv))*100
#Streptococcus (23.8), Sphingomonas (23.8), Blautia (14.3)

#Ephemeroptera 
nsamples(ephem_grv<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Ephemeroptera")) #8


eff_ephem_grv<-subset_samples(effluent_grv, Family=="Ephemeroptera")
eff_ephem_grv<-prune_taxa(taxa_sums(eff_ephem_grv) > 0, eff_ephem_grv) 
eff_ephem_grv #8 taxa, 5 samples

sort((table(tax_table(eff_ephem_grv)[,6]))/ntaxa(eff_ephem_grv))*100
#Streptococcus (23.1), Sphingomonas (23.1), Pseudomonas (23.1)

#Araneidae
nsamples(aran_grv<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Araneidae")) #8


eff_aran_grv<-subset_samples(effluent_grv, Family=="Araneidae")
eff_aran_grv<-prune_taxa(taxa_sums(eff_aran_grv) > 0, eff_aran_grv) 
eff_aran_grv #21 taxa, 8 samples

sort((table(tax_table(eff_aran_grv)[,6]))/ntaxa(eff_aran_grv))*100
#Blautia (28.6%), Sphingomonas (23.8%), Ruminococcus (19.0)


#Tetragnathidae
nsamples(tetra_grv<-subset_samples(sample_ps, Site=="Graves Bridge" & Family=="Tetragnathidae")) #8


eff_tetra_grv<-subset_samples(effluent_grv, Family=="Tetragnathidae")
eff_tetra_grv<-prune_taxa(taxa_sums(eff_tetra_grv) > 0, eff_tetra_grv) 
eff_tetra_grv #7 taxa, 4 samples

sort((table(tax_table(eff_tetra_grv)[,6]))/ntaxa(eff_tetra_grv))*100
#Ruminococcus (28.6), Blautia (28.6), Streptococcus (14.3)

## Policeman Flats ##

effluent_pmf<-subset_samples(effluent_bac, Site=="Policeman Flats")
effluent_pmf<-prune_taxa(taxa_sums(effluent_pmf) > 0, effluent_pmf) 
effluent_pmf #70 taxa, 58 samples/60 

sort((table(tax_table(effluent_pmf)[,6]))/sum(ntaxa(effluent_pmf))*100)

#Hydropsychidae larvae
nsamples(hydro_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Hydropsychidae")) #8


eff_hydro_pmf<-subset_samples(effluent_pmf, Family=="Hydropsychidae")
eff_hydro_pmf<-prune_taxa(taxa_sums(eff_hydro_pmf) > 0, eff_hydro_pmf) 
eff_hydro_pmf #13 taxa, 8 samples = 100% prevalence

sort((table(tax_table(eff_hydro_pmf)[,6]))/ntaxa(eff_hydro_pmf))*100
#Terrimonas (30.8%), Runella (23.1%), Haliangium (23.1%)

#Heptageniidae larvae
nsamples(hep_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Heptageniidae")) #8

eff_hep_pmf<-subset_samples(effluent_pmf, Family=="Heptageniidae")
eff_hep_pmf<-prune_taxa(taxa_sums(eff_hep_pmf) > 0, eff_hep_pmf) 
eff_hep_pmf #23 taxa, 8 samples 

sort((table(tax_table(eff_hep_pmf)[,6]))/ntaxa(eff_hep_pmf))*100
#Terrimonas (21.7), Runella (17.4), Streptococcus (13.0)

#Chironomidae larvae 
nsamples(chiro_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Chironomidae")) #5

eff_chiro_pmf<-subset_samples(effluent_pmf, Family=="Chironomidae")
eff_chiro_pmf<-prune_taxa(taxa_sums(eff_chiro_pmf) > 0, eff_chiro_pmf) 
eff_chiro_pmf #13 taxa, 5 samples

sort((table(tax_table(eff_chiro_pmf)[,6]))/ntaxa(eff_chiro_pmf))*100
#Romboutsia (30.8), Terrimonas (15.4), Haliangium (15.4) 

#Perlidae larvae 
nsamples(perl_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Perlidae")) #8

eff_perl_pmf<-subset_samples(effluent_pmf, Family=="Perlidae")
eff_perl_pmf<-prune_taxa(taxa_sums(eff_perl_pmf) > 0, eff_perl_pmf) 
eff_perl_pmf #13 taxa, 8 samples


sort((table(tax_table(eff_perl_pmf)[,6]))/ntaxa(eff_perl_pmf))*100
#Haliangium (23.1), Terrimonas (15.4), Runella (15.4) 

#Ephemeroptera 
nsamples(ephem_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Ephemeroptera")) #8

eff_ephem_pmf<-subset_samples(effluent_pmf, Family=="Ephemeroptera")
eff_ephem_pmf<-prune_taxa(taxa_sums(eff_ephem_pmf) > 0, eff_ephem_pmf) 
eff_ephem_pmf #22 taxa, 7 samples

sort((table(tax_table(eff_ephem_pmf)[,6]))/ntaxa(eff_ephem_pmf))*100
#Sphingomonas (22.7), Streptococcus (18.2), Pseudomonas (18.2)

#Diptera
nsamples(dip_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Diptera")) #8

eff_dip_pmf<-subset_samples(effluent_pmf, Family=="Diptera")
eff_dip_pmf<-prune_taxa(taxa_sums(eff_dip_pmf) > 0, eff_dip_pmf) 
eff_dip_pmf #15 taxa, 8 samples

sort((table(tax_table(eff_dip_pmf)[,6]))/ntaxa(eff_dip_pmf))*100
#Sphingomonas (26.7), Streptococcus (20.0), Pseudomonas (20.0)

#Araneidae
nsamples(aran_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Araneidae")) #7

eff_aran_pmf<-subset_samples(effluent_pmf, Family=="Araneidae")
eff_aran_pmf<-prune_taxa(taxa_sums(eff_aran_pmf) > 0, eff_aran_pmf) 
eff_aran_pmf #16 taxa, 7 samples

sort((table(tax_table(eff_aran_pmf)[,6]))/ntaxa(eff_aran_pmf))*100
#Blautia (37.5%), Sphingomonas (18.8%), Ruminococcus (12.5)


#Tetragnathidae
nsamples(tetra_pmf<-subset_samples(sample_ps, Site=="Policeman Flats" & Family=="Tetragnathidae")) #8

eff_tetra_pmf<-subset_samples(effluent_pmf, Family=="Tetragnathidae")
eff_tetra_pmf<-prune_taxa(taxa_sums(eff_tetra_pmf) > 0, eff_tetra_pmf) 
eff_tetra_pmf #19 taxa, 7 samples

sort((table(tax_table(eff_tetra_pmf)[,6]))/ntaxa(eff_tetra_pmf))*100
#Blautia (42.1), Ruminococcus (15.8), Streptococcus (10.5)

## REF ACWA Stream ##

effluent_BRR2<-subset_samples(effluent_bac, Site=="BRR2")
effluent_BRR2<-prune_taxa(taxa_sums(effluent_BRR2) > 0, effluent_BRR2) 
effluent_BRR2 #19 taxa, 8 samples/8=100%

sort((table(tax_table(effluent_BRR2)[,6]))/sum(ntaxa(effluent_BRR2))*100)

## EXP5 ACWA Stream ##

effluent_PCR1<-subset_samples(effluent_bac, Site=="PCR1")
effluent_PCR1<-prune_taxa(taxa_sums(effluent_PCR1) > 0, effluent_PCR1) 
effluent_PCR1 #29 taxa, 24 samples=100%

sort((table(tax_table(effluent_PCR1)[,6]))/sum(ntaxa(effluent_PCR1))*100)

## EXP15 ACWA Stream ##

effluent_PCR3<-subset_samples(effluent_bac, Site=="PCR3")
effluent_PCR3<-prune_taxa(taxa_sums(effluent_PCR3) > 0, effluent_PCR3) 
effluent_PCR3 #28 taxa, 23 samples

sort((table(tax_table(effluent_PCR3)[,6]))/sum(ntaxa(effluent_PCR3))*100)

## Bow River ##

effluent_Bow<-subset_samples(effluent_bac, Stream_Type=="Bow River")

effluent_genus_Bow<-speedyseq::tax_glom(effluent_Bow, taxrank = "Genus")
effluent_rel_abun_genus_Bow <- transform_sample_counts(effluent_genus_Bow, function(x) x/sum(x))
effluent_genus_df_Bow <- psmelt(effluent_rel_abun_genus_Bow)
sample.df.agg.effluent.genus.Bow <- aggregate(Abundance ~ Site  + Genus, data = effluent_genus_df_Bow, FUN = mean)

ggplot(sample.df.agg.effluent.genus.Bow, aes(x=Site, y=Abundance, fill=Genus)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="right", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=17)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)


sample.df.agg.effluent.genus.Bow.invert <- aggregate(Abundance ~ Site  + Genus +sample_Family+Stage, data = effluent_genus_df_Bow, FUN = mean)

sample.df.agg.effluent.genus.Bow.invert$sample_Family<-factor(sample.df.agg.effluent.genus.Bow.invert$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))



ggplot(sample.df.agg.effluent.genus.Bow.invert, aes(x=Site, y=Abundance, fill=Genus)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  facet_nested_wrap(~Stage+sample_Family, nrow=1, scales="free_x")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="right", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=17)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)

## ACWA ##

effluent_ACWA<-subset_samples(effluent_bac, Stream_Type!="Bow River")

effluent_genus_ACWA<-speedyseq::tax_glom(effluent_ACWA, taxrank = "Genus")
effluent_rel_abun_genus_ACWA <- transform_sample_counts(effluent_genus_ACWA, function(x) x/sum(x))
effluent_genus_df_ACWA <- psmelt(effluent_rel_abun_genus_ACWA)
sample.df.agg.effluent.genus.ACWA <- aggregate(Abundance ~ Site  + Genus + sample_Family +Stage, data = effluent_genus_df_ACWA, FUN = mean)

sample.df.agg.effluent.genus.ACWA$sample_Family<-factor(sample.df.agg.effluent.genus.ACWA$sample_Family, levels=c("Hydropsychidae","Baetidae", "Ephemeroptera"))

ggplot(sample.df.agg.effluent.genus.ACWA, aes(x=Site, y=Abundance, fill=Genus)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  facet_nested_wrap(~Stage+sample_Family, nrow=1, scales="free_x")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="right", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=17)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_fill_manual(name="Genus", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#43464B"))+
  scale_y_continuous(label = scales::percent)




#The following graphs will be the mean total abundance (instead of sum) of each individual effluent-bacteria/pathogen to control for the sample size.

#Trichococcus
#Total abundance
tricho<-subset_taxa(sample_ps, Genus=="Trichococcus")
tricho_df <- psmelt(tricho)
tricho_agg <- aggregate(Abundance ~ Site, data = tricho_df, FUN = mean)

ggplot(tricho_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ggtitle("Trichococcus")

#Highest mean total abundance at PCR3 then Cushing Bridge. None at BRR2 or PCR1

ps_rare<-rarefy_even_depth(sample_ps)
head(sample_sums(ps_rare))

#Aeromonas
aero<-subset_taxa(ps_rare, Genus=="Aeromonas")
sort(table(tax_table(aero)[,7])) #Sobria and veronii are potential human pathogens causing nausea, vomiting, diarrhea 
aero_df <- psmelt(aero)
aero_agg <- aggregate(Abundance ~ Site, data = aero_df, FUN = sum)

ggplot(aero_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ggtitle("Aeromonas")
#High in Policeman Flats and Cushing Bridge. Low everywhere else. Not found in PCR3 effluent stream... possibly not due to wastewater effluent exposure.

#Ruminococcus
rumino<-subset_taxa(ps_rare, Genus=="Ruminococcus")
rumino_df <- psmelt(rumino)
rumino_agg <- aggregate(Abundance ~ Site, data = rumino_df, FUN = sum)

ggplot(rumino_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Ruminococcus")

#Ruminococcus decreased slightly with wastewater exposure (why would it be highest at Cochrane? Maybe agricultural runoff/ cabin septic tanks?)


#Enterococcus
entero<-subset_taxa(ps_rare, Genus=="Enterococcus")
entero_df <- psmelt(entero)
entero_agg <- aggregate(Abundance ~ Site, data = entero_df, FUN = sum)

ggplot(entero_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Enterococcus")

#Highest mean total abundance at Cochrane

#Blautia
blaut<-subset_taxa(ps_rare, Genus=="Blautia")
blaut_df <- psmelt(blaut)
blaut_agg <- aggregate(Abundance ~ Site, data = blaut_df, FUN = sum)

ggplot(blaut_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Blautia")

#Highest mean total abundance at Cochrane 

#Streptococcus
strep<-subset_taxa(ps_rare, Genus=="Streptococcus")
strep_df <- psmelt(strep)
strep_agg <- aggregate(Abundance ~ Site , data = strep_df, FUN = sum)

ggplot(strep_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid") + ggtitle("Streptococcus")
#Much lower at Graves Bridge and ACWA streams


#Streptococcus gallolyticus
strep_gallo<-subset_taxa(sample_ps, Species=="gallolyticus")
sgallo <- psmelt(strep_gallo)
agg_gallo <- aggregate(Abundance ~ Site, data = sgallo, FUN = mean)

ggplot(agg_gallo, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid") + ggtitle("Streptococcus gallolyticus")

#Highest at PCR1 in ACWA streams and Cochrane at Bow River sites

#Cloacibacterium
cloac<-subset_taxa(sample_ps, Genus=="Cloacibacterium")
cloac_df <- psmelt(cloac)
cloac_agg <- aggregate(Abundance ~ Site, data = cloac_df, FUN = mean)

ggplot(cloac_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Cloacibacterium")

#Highest at Policeman Flats

#Romboutsia
romb<-subset_taxa(sample_ps, Genus=="Romboutsia")
romb_df <- psmelt(romb)
romb_agg <- aggregate(Abundance ~ Site, data = romb_df, FUN = mean)

ggplot(romb_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Romboutsia")
#Higher at PCR1 and PCR3 in ACWA. A bit higher at Sunalta and Graves Bridge (doesn't seem to be wastewater exposure driving that in the Bow)

#Bacillus
bacillus<-subset_taxa(sample_ps, Genus=="Bacillus")
bacillus_df <- psmelt(bacillus)
bacillus_agg <- aggregate(Abundance ~ Site, data = bacillus_df, FUN = mean)

ggplot(bacillus_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Total Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Bacillus")

#Highest at Graves Bridge

#Pseudomonas
pseudo<-subset_taxa(sample_ps, Genus=="Pseudomonas")
pseudo_df <- psmelt(pseudo)
pseudo_agg <- aggregate(Abundance ~ Site, data = pseudo_df, FUN = mean)

ggplot(pseudo_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Pseudomonas")

#Highest at Cushing Bridge then Policeman Flats

aeru<-subset_taxa(effluent_bac, Species=="aeruginosa")

aeru_df <- psmelt(aeru)
aeru_agg <- aggregate(Abundance ~ Site, data = aeru_df, FUN = mean)

ggplot(aeru_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Pseudomonas")

#Yersinia pestis (plague causing bacteria in mammals)
pestis<-subset_taxa(sample_ps, Species=="pestis")
pestis<-prune_taxa(taxa_sums(pestis) > 0, pestis)
sample_sums(pestis)

pestis_df <- psmelt(pestis)
pestis_agg <- aggregate(Abundance ~ Site, data = pestis_df, FUN = mean)

ggplot(pestis_agg, aes(x=Site, y=Abundance)) + geom_bar(stat="identity") + 
  ylab("Mean Relative Abundance") +
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.position="bottom", legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=4)) +
  theme(axis.title.y=element_text(size=10),
        axis.text.y=element_text(size=6),
        axis.text.x=element_text(angle=45, hjust=1, size=6, color="black"),
                        axis.title=element_text(size=10))+
  rremove("grid")+ ggtitle("Yersinia pestis")
#Found at Cochrane mostly and a bit at Policeman Flats. Only found in stonefly. None found at Cushing Bridge.


#Top 5 effluent derived bacteria
top_eff_bac <- sample.df.agg.effluentbac.genus %>%
    group_by(Site, Genus) %>%
    summarise(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_eff_bac
top5effbac <- top_eff_bac$Genus[1:10]
top5effbac<- sample.df.agg.effluentbac.genus %>%
    mutate(Genus = fct_other(Genus, top5effbac))


top5effbac$Genus <- factor(top5effbac$Genus, levels=c("Bacillus", "Enterococcus", "Aeromonas", "Streptococcus", "Other", "Romboutsia")) #labels=c("Bacteroidota", "Cyanobacteria", "Firmicutes", "Other", "Proteobacteria"))

top5effbacplot <- ggplot(top5effbac, aes(x=Site, y=Abundance, fill=Genus)) + geom_bar(stat="identity") +
  ylab("Mean Relative Abundance") +
  #facet_grid(.~Taxa, scale="free_x", space = "free_x") + 
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=10, face="italic"), legend.title=element_text(size=10)) +
  guides (fill=guide_legend(nrow=6)) +
  theme(axis.title.y=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.text.x=element_text(angle=45, hjust=1, size=16, color="black"),
                        axis.title=element_text(size=18))+
  scale_fill_manual(name="Bacterial Genus", values = c(brewer.pal(4, "Paired"), "#43464B", "lightcoral"))+
  scale_y_continuous(label = scales::percent) + rremove("grid")

top5effbacplot

#Graves Bridge looks like it's the Bow River site with the most amount of change in the common effluent-associated bacteria (increase in Bacillus). However, the Bow River sites do not have much of the same bacteria as the ACWA streams (less Romboutsia, Aeromonas, and Enterococcus but more Bacillus). 
#### Plotting eff-assoc. bac. relative to non eff-assoc. bac. across sites + taxa ####

#Bow River 

Bow_ps<-subset_samples(sample_ps, Stream_Type=="Bow River")



effluent_Bow<-subset_samples(effluent_bac, Stream_Type=="Bow River")
effluent_Bow<-prune_taxa(taxa_sums(effluent_Bow) > 0, effluent_Bow) 
sort((table(tax_table(effluent_Bow)[,6]))/sum(ntaxa(effluent_Bow))*100) #17 genera
#Sphingomonas (14.3%), Terrimonas (11.0%), Blautia (11.0%)
sum(sample_sums(effluent_Bow))/sum(sample_sums(Bow_ps))*100
#Effluent bacteria comprises 1.01% of the total microbiome in the Bow River (across all invertebrate types). Very small amount.

## Plotting relative abundance of effluent bacteria versus non eff-assoc. bacteria ##

Bow_genus <- tax_glom(Bow_ps, taxrank = "Genus")
Bow_genus #493 genera
comp_Bow_genus <- microbiome::transform(Bow_genus, "compositional")

Bow_genus_df <- psmelt(comp_Bow_genus)

Bow_agg <- aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = Bow_genus_df, FUN = mean) #aggregate to Phylum level, take the mean

#Sort abundance of each genus by mean at each site
sort_genus_Bow <- Bow_agg %>%
    group_by(Genus, Site_code) %>%
    summarize(Mean = mean(Abundance)) %>%
    arrange()
sort_genus_Bow

effluents_Bow <- sort_genus_Bow$Genus[c(81:85, 276:280, 561:565, 686:690, 806:810, 1021:1025, 1736:1740, 1771:1775, 1791:1795, 1906:1910, 1966:1970, 1971:1975, 2016:2020, 2021:2025, 2051:2055, 2116:2120, 2201:2205, 2231:2235, 2381:2385)]
  
eff_df_Bow <- Bow_agg %>%
    mutate(Genus = fct_other(Genus, effluents_Bow))

eff_agg_df_Bow<-aggregate(Abundance ~ Genus + Site_code + sample_Family + Stage, data = eff_df_Bow, FUN = sum)

#endo_agg_df_Bow$Genus<-factor(endo_agg_df_Bow$Genus, levels=c("Other", "Buchnera", "Candidatus Cardinium", "Rickettsia", "Spiroplasma", "Wolbachia"), labels=c( "Non-endosymbionts", "Buchnera", "Candidatus Cardinium", "Rickettsia", "Spiroplasma", "Wolbachia"))

eff_agg_df_Bow$Site_code <- factor(eff_agg_df_Bow$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

eff_agg_df_Bow$sample_Family<-factor(eff_agg_df_Bow$sample_Family, levels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))

eff_plot_Bow <- ggplot(eff_agg_df_Bow, aes(x=Site_code, y=Abundance, fill=Genus)) +
  geom_bar(stat="identity", color="black") + 
  facet_nested_wrap(~Stage+sample_Family, scale="free_x", nrow=1)+
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 22, color="black")) + 
  theme(legend.key.size = unit(0.8, "cm"),
        legend.text=element_text(size=28, face="italic"), legend.title=element_text(size=28), legend.position = "right") +
  guides(fill=guide_legend(nrow=25)) +
  theme(axis.title.y=element_text(size=30),
        axis.text.y=element_text(size=24, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=24, color="black"),
                        axis.title.x=element_text(size=30))+
  #scale_fill_manual(name="Genus", values=c("honeydew4", "tan1","seagreen1", "skyblue1", "lightgoldenrod1","lightpink1"))+
  scale_y_continuous(label = scales::percent)+
  xlab("Site")+
  rremove("grid")
eff_plot_Bow


#ggsave(eff_plot_Bow, filename="Microbiome_ED/Final analysis/Relative abundance/Effluent /Endosymbiont composition across sites and taxa Bow only.png", height=12, width=22)

```

# Picrust2

## Data prep from PICRUSt2 output files

```{r}
#Need to create a fasta file which requires an ASV identifier in the first column (ex. 'ASV1', 'ASV2', etc.) and the bacterial DNA sequence in the second column.

#Also need a .biom file with the otu/asv table (ASVs are labeleld with a unique identifier that matches the fasta file)

#.biom file

taxa_names(sample_ps) <- paste0("ASV", seq(ntaxa(sample_ps)))
otu<-as(otu_table(sample_ps),"matrix")
otu_df<-as.data.frame(otu)
otu_df<- rownames_to_column(otu_df, "ASV")
otu_biom<-make_biom(data=otu_df)
write_biom(otu_biom,"Microbiome_ED/PICRUSt2 Data/otu_biom.biom")

#After filtering steps, convert the phyloseq object back into an ASV table and save as data frame. 

# Extract abundance matrix from the phyloseq object
OTU1 = as(otu_table(sample_ps), "matrix")
# Coerce to data.frame
OTUdf = as.data.frame(OTU1)
#Move row names into the first column and call it 'Sequences' so that it can be pulled into another data frame
OTUdf<- rownames_to_column(OTUdf, "Sequences")

#Take the first column of the filtered OTU table to retrieve bacterial DNA sequences for the fasta file. 
seq<-OTUdf[,1] #Makes a column of sequences

#Now we need to create a new column with an ASV identifer for those sequences that we pulled.
taxa_names(sample_ps) <- paste0("ASV", seq(ntaxa(sample_ps))) #this will change the sequences to a numbered ASV ID


# Extract abundance matrix from the phyloseq object
OTU2 = as(otu_table(sample_ps), "matrix")
# Coerce to data.frame
OTUdf2 = as.data.frame(OTU2)
#Change the rownames to a column called ASVs
OTUdf2<- rownames_to_column(OTUdf2, "ASV")

ASV<-OTUdf2[,1] #Makes a column of ASV identifiers

#Now we add the columns together to create the fasta dataframe
ASVfasta<-data.frame(c(rbind(ASV, seq))) #Combines the ASV IDs and the sequences in a dataframe
#Remove headers

#install_github("helixcn/seqRFLP")
library("seqRFLP") #Used to save files as .fasta

#Converts data frame to fasta file
ASV.fasta = dataframe2fas(ASVfasta, file="Microbiome_ED/PICRUSt2 Data/ASV_Sequences_4.fna")
asv_csv<-read.csv("C:\\Users\\Emilie\\OneDrive - McMaster University\\PICRUSt2 data\\ASV_Sequences.csv")
ASV_fasta = dataframe2fas(asv_csv, file="Microbiome_ED/PICRUSt2 Data/ASV_Sequences_2.fna")

ASV_table<-read.table("C:\\Users\\Emilie\\OneDrive - McMaster University\\PICRUSt2 data\\ASV_table.tsv")
ASV_table_df<-as.data.frame(ASV_table)

#### BIOM file/ tab separated values file (tsv) ####

#We also need a .biom file of the ASV table. The sequences have to turned into an ASV ID that matches the fasta file we just made. So I will use the same dataframe that we pulled the ASV IDs from.

#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")
#BiocManager::install("biomformat")

library(biomformat) #Need this package for converting to biom files
OTUbiom<-make_biom(OTUdf1) #Turns dataframe to biom format
write_biom(OTUbiom, biom_file="Microbiome_ED/PICRUSt2 Data/ASV_table.biom") #Saves biom format as file
write.table(OTUdf1, file="Microbiome_ED/PICRUSt2 Data/ASV_table.tsv", sep="\t") #Saves dataframe to text file (tab separated values)




#### Preparing taxa table, otu table, and metadata ####
# Export taxonomy table as "tax.txt"

sample_ps_1<-phyloseq_rm_na_tax(sample_ps)
tax<-as(tax_table(sample_ps),"matrix")
tax_cols <- colnames(tax)
tax<-as.data.frame(tax)
tax$taxonomy<-do.call(paste, c(tax[tax_cols], sep=";"))
for(co in tax_cols) tax[co]<-NULL

write.table(tax, "Microbiome_ED/PICRUSt2 Data/tax.txt", quote=FALSE, col.names=FALSE, sep="\t")
tax_fna<-dataframe2fas(tax, file="Microbiome_ED/PICRUSt2 Data/tax.fna")

# Export feature/OTU table

# As a biom file

library(biomformat);packageVersion("biomformat")
## [1] 1.6.0

#if taxa_are_rows=TRUE
otu<-as(otu_table(sample_ps),"matrix")
otu_biom<-make_biom(data=otu)
write_biom(otu_biom,"Microbiome_ED/PICRUSt2 Data/otu_biom.biom")

# As a text file

write.table(otu_table(sample_ps), "Microbiome_ED/PICRUSt2 Data/seqtab.tsv", sep="\t", row.names=TRUE, col.names=NA, quote=FALSE)

# Export metadata (if you have a properly formatted metadata file that you imported in your phyloseq pipeline, you can skip this step and just use that text file directly in QIIME 2)

write.table(sample_data(sample_ps),"Microbiome_ED/PICRUSt2 Data/sample-metadata.txt", sep="\t", row.names=FALSE, col.names=TRUE, quote=FALSE)

otu_matrix<-as.matrix(sample_ps@otu_table)
otu_df<-as.data.frame(otu_matrix)
print(FWD.orients)

uniquesToFasta(otu_matrix, ids=colnames(otu_matrix))

sample_ps %>%
      taxa_names(sample_ps) %>%
      Biostrings::writeXStringSet("Microbiome_ED/PICRUSt2 Data/~/asv.fna", append=FALSE,
                                  compress=FALSE, compression_level=NA, format="fasta")

```


## Load and modify data format

'description' is the description of the individual pathway and 'Pathway_type' is a higher order classification (pathway class). Multiple individual pathways can be cateogrized into a pathway class.

```{r}
#### Merge picrust data to phyloseq ####

#The MetaCyc abundance data acts as the "ASV" file
metacyc<-read.delim("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\microbiome_analysis\\PICRUSt2 Data\\Output files\\pathways_descrip.tsv")

#Rename column
metacyc<-rename(metacyc, "function." = "Pathways")

#Names of pathways and classification
metacyc_ont<-read.delim("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\microbiome_analysis\\PICRUSt2 Data\\MetaCyc_Ontology.txt")

metacyc_ont<-metacyc_ont[,-2]

#Combining metacyc abundance data with the higher order classifications
metacyc_combined<-dplyr::inner_join(metacyc, metacyc_ont, by="Pathways")

#Creating "otu" table
metacyc_only<-metacyc[,!names(metacyc) %in% c("description")] #Remove columns with descriptions so the values can be rounded for the "ASV" table

metacyc_only_column_to_row<-column_to_rownames(metacyc_only, "Pathways")

metacyc_rounded<-ceiling(metacyc_only_column_to_row) #Have to round it to nearest value for it to work
metacyc_rounded_mat<-as.matrix(metacyc_rounded) #Final table we will use for otu table

#Descriptions of the pathways acts as the taxonomy file
descriptions<-metacyc_combined[,names(metacyc_combined) %in% c("Pathways", "description", "Pathway_type")]
descriptions_1<-column_to_rownames(descriptions, "Pathways")
descriptions_mat<-as.matrix(descriptions_1)


#Metadata is treated the same
metadata_picrust<-read_delim("C:\\Users\\Emilie\\Documents\\GitHub\\Bow-River-Microbiome-2022\\microbiome_analysis\\PICRUSt2 Data\\sample-metadata-2.txt", delim="\t", escape_double = FALSE, trim_ws = TRUE)

metadata_picrust<-column_to_rownames(metadata_picrust, "Study_ID")

#Putting data together as phyloseq object
metacyc_table<-otu_table(metacyc_rounded_mat, taxa_are_rows = TRUE)
descrip_table = tax_table(descriptions_mat)

picrust_ps<-phyloseq(metacyc_table, sample_data(metadata_picrust), descrip_table)
```


## Relative abundance of top MetaCyc pathway classes across sites

```{r}
#### Bow River ####

Bow_ps_picrust<-subset_samples(picrust_ps, Stream_Type=="Bow River")

rel_abun_bow <- speedyseq::tax_glom(Bow_ps_picrust, taxrank = "Pathway_type")
comp_rel_abun_bow <- transform_sample_counts(rel_abun_bow, function(x) x/sum(x))

rel_abun_bow_df <- psmelt(comp_rel_abun_bow)

sample.df.agg_bow <- aggregate(Abundance ~ Pathway_type + Site_code + Family + Stage, data = rel_abun_bow_df, FUN = mean) 


#Top pathways
top_pathways_bow <- sample.df.agg_bow %>%
    group_by(Pathway_type, Site_code) %>%
    summarise(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_24_pathways_bow <- top_pathways_bow$Pathway_type[1:106]
df0_bow <- sample.df.agg_bow %>%
    mutate(Pathway_type = fct_other(Pathway_type, top_24_pathways_bow))
df0_bow

df0_bow<-aggregate(Abundance~Pathway_type + Site_code + Family + Stage, data=df0_bow, FUN="sum") #Aggregate again to combine all the 'Other' categories into a single bar on the graph.

length(unique(df0_bow$Pathway_type))

df0_bow$Site_code<-factor(df0_bow$Site_code, levels=c("COCH", "SUN", "CUSHBR", "GRVBR", "PMF"))

df0_bow$Stage<-factor(df0_bow$Stage, levels=c("Larvae", "Adults", "Spiders"))

df0_bow$Family<-factor(df0_bow$Family, levels=c("Hydropsychidae", "Heptageniidae", "Chironomidae", "Perlidae", "Trichoptera", "Ephemeroptera", "Diptera", "Araneidae", "Tetragnathidae"))

toppathwaysplot_bow <- ggplot(df0_bow, aes(x=Site_code, y=Abundance, fill=Pathway_type)) + 
  geom_bar(stat="identity", color="black") + 
  facet_nested_wrap(~Stage + Family, scales="free_x", nrow=1)+
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=14), legend.title=element_text(size=14), legend.position = "right") +
  guides (fill=guide_legend(nrow=25)) +
  theme(axis.title.y=element_text(size=24),
        axis.text.y=element_text(size=18, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=18, color="black"),
                        axis.title.x=element_text(size=24))+
  scale_fill_manual(name="MetaCyc Pathways", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#faf0e6", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  rremove("grid")+
  xlab("Site")
toppathwaysplot_bow

#ggsave(filename="microbiome_analysis/PICRUSt2 Data/Figures/Top 24 MetaCyc pathway classes across sites and taxa Bow.png", height=10, width=24)


#All taxa together 

bow_all_picrust_agg <- aggregate(Abundance ~ Pathway_type, data = rel_abun_bow_df, FUN = mean) 

ggplot(bow_all_picrust_agg, aes(x=Pathway_type, y=Abundance)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.01, "cm"),
        legend.text=element_text(size=1), legend.title=element_text(size=11), legend.position = "right") +
  guides (fill=guide_legend(nrow=25)) +
  theme(axis.title.y=element_text(size=24),
        axis.text.y=element_text(size=14, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=3, color="black"),
                        axis.title.x=element_text(size=24))+
  #scale_fill_manual(name="MetaCyc Pathways", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#faf0e6", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  rremove("grid")+
  xlab("Site")


df0_bow %>%
  group_by(Pathway_type) %>%
  dplyr::summarise(mean = mean(Abundance),
            sd = sd(Abundance))%>%
  arrange(desc(mean))


#### ACWA ####

ACWA_ps_picrust<-subset_samples(picrust_ps, Stream_Type!="Bow River")

rel_abun_ACWA<- speedyseq::tax_glom(ACWA_ps_picrust, taxrank = "Pathway_type")
comp_rel_abun_ACWA <- transform_sample_counts(rel_abun_ACWA, function(x) x/sum(x))

rel_abun_ACWA_df <- psmelt(comp_rel_abun_ACWA)

sample.df.agg_ACWA <- aggregate(Abundance ~ Pathway_type + Site_code + Family + Stage, data = rel_abun_ACWA_df, FUN = mean) 


#Top pathways
top_pathways_ACWA <- sample.df.agg_ACWA %>%
    group_by(Pathway_type, Site_code) %>%
    summarise(Mean = mean(Abundance)) %>%
    arrange(-Mean)
top_24_pathways_ACWA <- top_pathways_ACWA$Pathway_type[1:62]
df0_ACWA <- sample.df.agg_ACWA %>%
    mutate(Pathway_type = fct_other(Pathway_type, top_24_pathways_ACWA))
df0_ACWA

df0_ACWA<-aggregate(Abundance~Pathway_type + Site_code + Family + Stage, data=df0_ACWA, FUN="sum") #Aggregate again to combine all the 'Other' categories into a single bar on the graph.

length(unique(df0_ACWA$Pathway_type))

df0_ACWA$Site_code<-factor(df0_ACWA$Site_code, levels=c("BRR2", "PCR1", "PCR3"), labels=c("REF", "EXP5", "EXP15"))

df0_ACWA$Stage<-factor(df0_ACWA$Stage, levels=c("Larvae", "Adults"))

df0_ACWA$Family<-factor(df0_ACWA$Family, levels=c("Hydropsychidae", "Baetidae", "Ephemeroptera"))

toppathwaysplot_ACWA <- ggplot(df0_ACWA, aes(x=Site_code, y=Abundance, fill=Pathway_type)) + 
  geom_bar(stat="identity", color="black") + 
  facet_nested_wrap(~Stage + Family, scales="free_x", nrow=1)+
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.5, "cm"),
        legend.text=element_text(size=14), legend.title=element_text(size=14), legend.position = "right") +
  guides (fill=guide_legend(nrow=25)) +
  theme(axis.title.y=element_text(size=24),
        axis.text.y=element_text(size=18, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=18, color="black"),
                        axis.title.x=element_text(size=24))+
  scale_fill_manual(name="MetaCyc Pathways", values=c(as.vector(stepped(20)),"#C8BC78", "#D5CE9D", "#F7F2CE", "#faf0e6", "#43464B"))+
  scale_y_continuous(label = scales::percent)+
  rremove("grid")+
  xlab("Site")
toppathwaysplot_ACWA

#ggsave(filename="microbiome_analysis/PICRUSt2 Data/Figures/Top 24 MetaCyc pathway classes across sites and taxa ACWA.png", height=10, width=24)


#top pathways with all samples combined 

ACWA_all_picrust_agg <- aggregate(Abundance ~ Pathway_type, data = rel_abun_ACWA_df, FUN = mean) 

ggplot(ACWA_all_picrust_agg, aes(x=Pathway_type, y=Abundance)) + 
  geom_bar(stat="identity", color="black") + 
  ylab("Mean Relative Abundance") +
  theme_bw()+
  rremove("grid")+
  theme(strip.text = element_text(size = 16, color="black")) + 
  theme(legend.key.size = unit(0.01, "cm"),
        legend.text=element_text(size=1), legend.title=element_text(size=11), legend.position = "right") +
  guides (fill=guide_legend(nrow=25)) +
  theme(axis.title.y=element_text(size=24),
        axis.text.y=element_text(size=14, color="black"),
        axis.text.x=element_text(angle=45, hjust=1, size=3, color="black"),
                        axis.title.x=element_text(size=24))+
  scale_y_continuous(label = scales::percent)+
  rremove("grid")+
  xlab("Site")


df0_ACWA %>%
  group_by(Pathway_type) %>%
  dplyr::summarise(mean = mean(Abundance),
            sd = sd(Abundance))%>%
  arrange(desc(mean))

```

## Differential Abundance of individual MetaCyc pathways across sites 

```{r}
#### ACWA comparisons ####
### REF vs EXP5 ###

## Hydropyschidae ##

hydro_BRR2_PCR1<-subset_samples(picrust_ps, Site %in% c("BRR2", "PCR1"))
hydro_BRR2_PCR1<-subset_samples(hydro_BRR2_PCR1, Family=="Hydropsychidae")
nsamples(hydro_BRR2_PCR1) #16

dds_hydro_BRR2_PCR1 <- phyloseq_to_deseq2(hydro_BRR2_PCR1, ~ Site)

deseq_hydro_BRR2_PCR1 <- DESeq(dds_hydro_BRR2_PCR1, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_hydro_BRR2_PCR1 <- results(deseq_hydro_BRR2_PCR1, cooksCutoff = FALSE)
res_deseq_hydro_BRR2_PCR1
alpha = 0.001
sigtab_hydro_BRR2_PCR1 = res_deseq_hydro_BRR2_PCR1[which(res_deseq_hydro_BRR2_PCR1$padj < alpha), ]
sigtab_hydro_BRR2_PCR1 = cbind(as(sigtab_hydro_BRR2_PCR1, "data.frame"), as(tax_table(hydro_BRR2_PCR1)[rownames(sigtab_hydro_BRR2_PCR1), ], "matrix"))

# Adding colours as classes
x_hydro_BRR2_PCR1 = tapply(sigtab_hydro_BRR2_PCR1$log2FoldChange, sigtab_hydro_BRR2_PCR1$Pathway_type, function(x) max(x))
x_hydro_BRR2_PCR1 = sort(x_hydro_BRR2_PCR1, TRUE)
sigtab_hydro_BRR2_PCR1$Pathway_type = factor(as.character(sigtab_hydro_BRR2_PCR1$Pathway_type), levels=sort(names(x_hydro_BRR2_PCR1)))
#Points as descriptions
x_hydro_BRR2_PCR1 = tapply(sigtab_hydro_BRR2_PCR1$log2FoldChange, sigtab_hydro_BRR2_PCR1$description, function(x) max(x))
x_hydro_BRR2_PCR1 = sort(x_hydro_BRR2_PCR1, TRUE)
sigtab_hydro_BRR2_PCR1$description = factor(as.character(sigtab_hydro_BRR2_PCR1$description), levels=names(x_hydro_BRR2_PCR1))


diff_abun_hydro_EXP5_REF<-ggplot(sigtab_hydro_BRR2_PCR1, aes(x=description, y=log2FoldChange, color=Pathway_type))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=12, face="italic")) + theme(axis.text=element_text(size=12, color="black"), axis.title=element_text(size=16)) +
  rremove("grid")+
  ylab("Log2 Fold Change")+
  xlab("Metabolic Pathways")+
  scale_color_brewer(name = "Pathway Class", palette = "Pastel1")+
   labs(y = expression(Log[2]~ "Ratio of Differential Expression"))
diff_abun_hydro_EXP5_REF

#ggsave(filename="microbiome_analysis/Final analysis/PICRUSt2 Data/Figures/diff abun pathways hydro PCR1-BRR2.png", height=10, width=12)


#BRR2 vs PCR3

hydro_BRR2_PCR3<-subset_samples(picrust_ps, Site %in% c("BRR2", "PCR3"))
hydro_BRR2_PCR3<-subset_samples(hydro_BRR2_PCR3, Family=="Hydropsychidae")
nsamples(hydro_BRR2_PCR3) #16

dds_hydro_BRR2_PCR3 <- phyloseq_to_deseq2(hydro_BRR2_PCR3, ~ Site)

deseq_hydro_BRR2_PCR3 <- DESeq(dds_hydro_BRR2_PCR3, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_hydro_BRR2_PCR3 <- results(deseq_hydro_BRR2_PCR3, cooksCutoff = FALSE)
res_deseq_hydro_BRR2_PCR3
alpha = 0.001
sigtab_hydro_BRR2_PCR3 = res_deseq_hydro_BRR2_PCR3[which(res_deseq_hydro_BRR2_PCR3$padj < alpha), ]
sigtab_hydro_BRR2_PCR3 = cbind(as(sigtab_hydro_BRR2_PCR3, "data.frame"), as(tax_table(hydro_BRR2_PCR3)[rownames(sigtab_hydro_BRR2_PCR3), ], "matrix"))

# Adding colours as classes
x_hydro_BRR2_PCR3 = tapply(sigtab_hydro_BRR2_PCR3$log2FoldChange, sigtab_hydro_BRR2_PCR3$Pathway_type, function(x) max(x))
x_hydro_BRR2_PCR3 = sort(x_hydro_BRR2_PCR3, TRUE)
sigtab_hydro_BRR2_PCR3$Pathway_type = factor(as.character(sigtab_hydro_BRR2_PCR3$Pathway_type), levels=sort(names(x_hydro_BRR2_PCR3)))
#Points as descriptions
x_hydro_BRR2_PCR3 = tapply(sigtab_hydro_BRR2_PCR3$log2FoldChange, sigtab_hydro_BRR2_PCR3$description, function(x) max(x))
x_hydro_BRR2_PCR3 = sort(x_hydro_BRR2_PCR3, TRUE)
sigtab_hydro_BRR2_PCR3$description = factor(as.character(sigtab_hydro_BRR2_PCR3$description), levels=names(x_hydro_BRR2_PCR3))

diff_abun_hydro_EXP15_REF<-ggplot(sigtab_hydro_BRR2_PCR3, aes(x=description, y=log2FoldChange, color=Pathway_type))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=12, face="italic")) + theme(axis.text=element_text(size=12, color="black"), axis.title=element_text(size=16)) +
  rremove("grid")+
  ylab("Log2 Fold Change")+
  xlab("Metabolic Pathways")+
  scale_color_brewer(name = "Pathway Class", palette = "Pastel1")+
   labs(y = expression(Log[2]~ "Ratio of Differential Expression"))
diff_abun_hydro_EXP15_REF

#ggsave(filename="microbiome_analysis/Final analysis/PICRUSt2 Data/Figures/diff abun pathways hydro PCR3-BRR2.png", height=10, width=12)

#PCR1 vs PCR3

hydro_PCR1_PCR3<-subset_samples(picrust_ps, Site %in% c("PCR1", "PCR3"))
hydro_PCR1_PCR3<-subset_samples(hydro_PCR1_PCR3, Family=="Hydropsychidae")
nsamples(hydro_PCR1_PCR3) #16

dds_hydro_PCR1_PCR3 <- phyloseq_to_deseq2(hydro_PCR1_PCR3, ~ Site)

deseq_hydro_PCR1_PCR3 <- DESeq(dds_hydro_PCR1_PCR3, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_hydro_PCR1_PCR3 <- results(deseq_hydro_PCR1_PCR3, cooksCutoff = FALSE)
res_deseq_hydro_PCR1_PCR3
alpha = 0.001
sigtab_hydro_PCR1_PCR3 = res_deseq_hydro_PCR1_PCR3[which(res_deseq_hydro_PCR1_PCR3$padj < alpha), ]
sigtab_hydro_PCR1_PCR3 = cbind(as(sigtab_hydro_PCR1_PCR3, "data.frame"), as(tax_table(hydro_PCR1_PCR3)[rownames(sigtab_hydro_PCR1_PCR3), ], "matrix"))

# Adding colours as classes
x_hydro_PCR1_PCR3 = tapply(sigtab_hydro_PCR1_PCR3$log2FoldChange, sigtab_hydro_PCR1_PCR3$Pathway_type, function(x) max(x))
x_hydro_PCR1_PCR3 = sort(x_hydro_PCR1_PCR3, TRUE)
sigtab_hydro_PCR1_PCR3$Pathway_type = factor(as.character(sigtab_hydro_PCR1_PCR3$Pathway_type), levels=sort(names(x_hydro_PCR1_PCR3)))
#Points as descriptions
x_hydro_PCR1_PCR3 = tapply(sigtab_hydro_PCR1_PCR3$log2FoldChange, sigtab_hydro_PCR1_PCR3$description, function(x) max(x))
x_hydro_PCR1_PCR3 = sort(x_hydro_PCR1_PCR3, TRUE)
sigtab_hydro_PCR1_PCR3$description = factor(as.character(sigtab_hydro_PCR1_PCR3$description), levels=names(x_hydro_PCR1_PCR3))

diff_abun_hydro_EXP15_EXP5<-ggplot(sigtab_hydro_PCR1_PCR3, aes(x=description, y=log2FoldChange, color=Pathway_type))+
  geom_point(size=6) + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=12, face="italic")) + theme(axis.text=element_text(size=12, color="black"), axis.title=element_text(size=16)) +
  rremove("grid")+
  ylab("Log2 Fold Change")+
  xlab("Metabolic Pathways")+
  scale_color_brewer(name = "Pathway Class", palette = "Pastel1")+
   labs(y = expression(Log[2]~ "Ratio of Differential Expression"))
diff_abun_hydro_EXP15_EXP5

#ggsave(filename="microbiome_analysis/Final analysis/PICRUSt2 Data/Figures/diff abun pathways hydro PCR3-PCR1.png", height=10, width=12)


# Combining hydro graphs #

a<-diff_abun_hydro_EXP5_REF + rremove("axis.title")
b<-diff_abun_hydro_EXP15_REF + rremove("axis.title")
c<-diff_abun_hydro_EXP15_EXP5 + rremove("axis.title")

ggarrange(a, b, c, nrow=1)

#ggsave(filename="microbiome_analysis/PICRUSt2 Data/Figures/ACWA diff abun pathways taxa facets.png", height=10, width=18)


#### Comparing between Bow River wastewater exposed sites vs non exposed sites ####

#ALDEx2

bow<-subset_samples(picrust_ps, Stream_Type=="Bow River")

aldex2_exposure <- ALDEx2::aldex(data.frame(phyloseq::otu_table(bow)), phyloseq::sample_data(bow)$Exposure, test="t", effect = TRUE, denom="iqlr")

sig_aldex2_exposure <- aldex2_exposure %>%
  rownames_to_column(var = "Pathways") %>%
  filter(wi.eBH < 0.05) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(Pathways, diff.btw, diff.win, effect, wi.ep, wi.eBH)
sig_aldex2_exposure <- inner_join(sig_aldex2_exposure, descriptions, by="Pathways")
#No differentially abundant pathways when alpha is 0.01 but 86 when alpha is 0.05. 

sig_aldex2_exposure_1<-inner_join(sig_aldex2_exposure, metacyc_ont, by="Pathways")


aldex_bow = tapply(sig_aldex2_exposure_1$effect, sig_aldex2_exposure_1$description, function(x) max(x))
aldex_bow = sort(aldex_bow, TRUE)
sig_aldex2_exposure_1$description = factor(as.character(sig_aldex2_exposure_1$description), levels=names(aldex_bow))

aldex_bow = tapply(sig_aldex2_exposure_1$effect, sig_aldex2_exposure_1$Pathway_type, function(x) max(x))
aldex_bow = sort(aldex_bow, TRUE)
sig_aldex2_exposure_1$Pathway_type = factor(as.character(sig_aldex2_exposure_1$Pathway_type), levels=sort(names(aldex_bow)))


ggplot(sig_aldex2_exposure_1, aes(x=description, y=effect))+
  geom_point(size=4) + 
  theme_bw()+
  theme(axis.text.x= sort(element_text(angle = 45, hjust = 1, vjust=1, size=14, color="black")), axis.text.y = element_text(size=14, color="black"))+
  #theme(legend.text=element_text(size=6, color="black")) + 
  #theme(legend.key.size = unit(0.5, "cm"), legend.title = element_text(size=8, color="black"),  legend.position="right")+
  guides(color=guide_legend(nrow=30, byrow=TRUE, ncol=1))+
  rremove("grid")+
  labs(y = expression(Log[2]~Difference))+
  xlab("Metabolic Pathways")

#ggsave(filename="Microbiome_ED/PICRUSt2 Data/Figures/ALDEx2 log2 fold changes Bow River Unexposed vs exposed.png", height=14, width=24)


#DESeq2

bow<-subset_samples(picrust_ps, Stream_Type=="Bow River")

dds_bow <- phyloseq_to_deseq2(bow, ~ Exposure)
dds_bow$Exposure <-relevel(dds_bow$Exposure, "Unexposed")

deseq_bow <- DESeq(dds_bow, test = "Wald", fitType = "parametric", sfType = "poscounts")

res_deseq_bow <- results(deseq_bow, cooksCutoff = FALSE)
res_deseq_bow
alpha = 0.001
sigtab_bow = res_deseq_bow[which(res_deseq_bow$padj < alpha), ]
sigtab_bow = cbind(as(sigtab_bow, "data.frame"), as(tax_table(bow)[rownames(sigtab_bow), ], "matrix"))

sigtab_bow_class<-rownames_to_column(sigtab_bow, "Pathways")

sigtab_bow_combined<-inner_join(sigtab_bow_class, metacyc_ont, by="Pathways")


x_bow = tapply(sigtab_bow_combined$log2FoldChange, sigtab_bow_combined$description, function(x) max(x))
x_bow = sort(x_bow, TRUE)
sigtab_bow_combined$description = factor(as.character(sigtab_bow_combined$description), levels=names(x_bow))

x_bow = tapply(sigtab_bow_combined$log2FoldChange, sigtab_bow_combined$Pathway_type, function(x) max(x))
x_bow = sort(x_bow, TRUE)
sigtab_bow_combined$Pathway_type = factor(as.character(sigtab_bow_combined$Pathway_type), levels=sort(names(x_bow)))

ggplot(sigtab_bow_combined, aes(x=description, y=log2FoldChange, color=Pathway_type))+
  geom_point(size=6) + 
  theme_bw()+
   guides(fill=guide_legend(nrow=29))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1, size=12, face="italic"))+
  theme(legend.text=element_text(size=10, color="black")) + 
  theme(legend.title = element_text(size=12, color="black"), legend.position="right")+
  scale_fill_discrete(name="Phylum")+
  rremove("grid")+
  labs(y = expression(Log[2]~Difference))+
  xlab("Metabolic Pathways")

#ggsave(filename="Microbiome_ED/PICRUSt2 Data/Figures/DESeq2 log2 fold changes Bow River Unexposed vs exposed.png", height=12, width=22)


```

We are getting different results when using ALDEx2 and DESeq2. It's hard to tell which one is better because DESeq2 is prone to false positives but ALDEx2 doesn't have strong statistical power (Nearing et al., 2022; Yang & Chen, 2022). Because we are using a low alpha threshold for DESeq2, I think we can be confident that these are true results and continue to use this method. 